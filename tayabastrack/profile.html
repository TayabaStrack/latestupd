<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Super Admin Profile | TayabaStrack</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333;overflow:hidden}
    .sidebar{width:250px;min-width:250px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;height:100vh;overflow-y:auto}
    .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem}
    .sidebar-header img{width:40px}
    .sidebar-header h2{font-size:1.2rem;margin:0}
    .sidebar-menu{list-style:none;padding-left:0}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;color:#fff;text-decoration:none;transition:background .2s;border-left:4px solid transparent}
    .sidebar-menu a:hover,.sidebar-menu li.active a{background:#0756cc;border-left:4px solid #042f68}
    .sidebar-footer{text-align:center;padding:1rem;border-top:1px solid rgba(255,255,255,0.2)}
    .logout-btn{background-color:#d9534f;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
    .logout-btn:hover{background-color:#c9302c}
    .navbar{position:fixed;top:0;left:250px;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);z-index:40}
    .navbar h1{font-size:1.4rem;color:#004aad}
    .profile{display:flex;align-items:center;gap:1rem}
    .fa-bell{font-size:1.2rem;position:relative;cursor:pointer;color:#333}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px;display:none;min-width:18px;text-align:center}
    .badge.show{display:flex;align-items:center;justify-content:center}
    .notification-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.15);width:340px;max-height:420px;overflow:hidden;z-index:1000;font-family:"Segoe UI",Tahoma,sans-serif;animation:fadeIn 0.2s ease-in-out}
    .notification-menu.show{display:block}
    .notification-header{padding:0.9rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9}
    .notification-header h3{font-size:1rem;color:#333;margin:0;font-weight:600}
    .notification-actions{display:flex;gap:0.5rem;align-items:center}
    .action-icon-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1rem;padding:0.3rem;transition:color 0.2s ease;display:flex;align-items:center;justify-content:center}
    .action-icon-btn:hover{color:#004aad}
    .action-icon-btn i{font-size:0.95rem}
    .notification-filters{display:flex;justify-content:space-between;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid #eee;background:#fafafa}
    .filter-btn{flex:1;padding:0.4rem 0.6rem;font-size:0.8rem;background:#f2f2f2;border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all 0.25s ease;color:#333}
    .filter-btn:hover{background:#004aad;color:#fff}
    .filter-btn.active{background:#004aad;color:#fff;border-color:#004aad}
    .notification-list{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#ccc transparent}
    .notification-list::-webkit-scrollbar{width:6px}
    .notification-list::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
    .notification-list::-webkit-scrollbar-track{background:transparent}
    .notification-item{padding:0.8rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;align-items:flex-start;transition:background 0.2s;position:relative}
    .notification-item:hover{background:#f5f7ff}
    .notification-item.unread{background:#f0f7ff}
    .notification-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:#004aad;border-radius:0 4px 4px 0}
    .notification-icon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem}
    .notification-icon.user{background:#e3f2fd;color:#1976d2}
    .notification-icon.report{background:#fff3e0;color:#f57c00}
    .notification-content{flex:1}
    .notification-content p{margin:0;font-size:0.86rem;color:#333;line-height:1.3}
    .notification-content .time{color:#999;font-size:0.75rem;margin-top:0.25rem}
    .notification-empty{padding:2rem;text-align:center;color:#999;font-size:0.9rem}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:0.5rem;border-radius:8px;transition:background 0.2s}
    .profile-dropdown:hover{background:#f5f7fb}
    .avatar{width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #004aad}
    .username{font-weight:500;color:#333}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
    .dropdown-menu.show{display:block}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem;transition:background 0.2s}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}
    .dropdown-menu a i{margin-right:8px;width:20px;text-align:center}
    .main{margin-left:250px;margin-top:74px;flex:1;display:block;min-width:0;height:calc(100vh - 74px);overflow-y:auto;overflow-x:hidden}
    .content{flex:1;padding:1.5rem;overflow-y:auto;height:100%}
    .page{padding:28px;display:flex;justify-content:center;width:100%}
    .profile-section{max-width:1100px;width:100%;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
    .card{background:white;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(13,34,85,0.06)}
    .profile-card .top{display:flex;gap:18px;align-items:center}
    .profile-card img.profile-main{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid #004aad}
    .profile-info{margin-top:12px}
    .profile-info label{display:block;font-weight:700;font-size:13px;margin-top:10px}
    .profile-info input{width:100%;padding:8px;border-radius:8px;border:1px solid #d7dce6;margin-top:6px;font-size:14px;background:#fbfdff}
    .btn{background:#004aad;color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;margin-top:12px}
    .btn:hover{opacity:0.95}
    .account-card h2{color:#0b3e89;margin-bottom:8px}
    .account-meta p{margin:6px 0;font-size:14px}
    .calendar-container{margin-top:20px;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);background:#fff;position:relative;max-width:100%}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .calendar-header h3{color:#0b3e89;font-size:1.1rem;margin:0}
    .sync-status{font-size:0.75rem;color:#666;margin-top:8px;text-align:center;padding:8px;background:#f0f8ff;border-radius:6px}
    .calendar-view{background:#fff;border-radius:8px;overflow:hidden;width:100%}
    .calendar-nav{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#004aad;color:#fff}
    .calendar-nav button{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:13px}
    .calendar-nav button:hover{background:rgba(255,255,255,0.3)}
    .calendar-nav h3{margin:0;font-size:1rem}
    .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#f5f7fb;border-bottom:2px solid #e0e0e0}
    .calendar-weekdays div{padding:6px;text-align:center;font-weight:600;font-size:11px;color:#666}
    .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e0e0e0}
    .calendar-day{background:#fff;min-height:55px;padding:4px;position:relative;cursor:pointer;transition:background 0.2s;display:flex;flex-direction:column}
    .calendar-day:hover{background:#f9f9f9}
    .calendar-day.other-month{background:#fafafa;color:#999}
    .calendar-day.today{background:#e3f2fd;font-weight:700}
    .calendar-day-number{font-size:11px;font-weight:600;color:#333;margin-bottom:2px}
    .calendar-day.other-month .calendar-day-number{color:#999}
    .event-indicators{display:flex;gap:2px;flex-wrap:wrap;margin-top:auto;padding-top:2px}
    .event-dot{width:7px;height:7px;border-radius:50%;cursor:pointer;transition:transform 0.2s}
    .event-dot:hover{transform:scale(1.4)}
    .event-dot.start{background:#1cc88a}
    .event-dot.end{background:#f6c23e}
    .event-dot.ongoing{background:#004aad}
    .event-tooltip{position:fixed;background:white;border:2px solid #004aad;border-radius:8px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:10000;min-width:320px;max-width:400px;font-size:13px;display:none;pointer-events:none}
    .event-tooltip.show{display:block}
    .event-tooltip-title{font-weight:700;color:#004aad;margin-bottom:12px;font-size:16px;border-bottom:2px solid #004aad;padding-bottom:8px}
    .event-tooltip-section{margin:10px 0;line-height:1.6}
    .event-tooltip-label{font-weight:600;color:#666;display:block;margin-bottom:4px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
    .event-tooltip-value{color:#222;font-size:14px;display:block}
    .event-tooltip-image{width:100%;max-height:180px;object-fit:cover;border-radius:6px;margin-top:12px;border:2px solid #e0e0e0}
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal-content{background:white;border-radius:12px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;animation:modalSlideIn 0.3s ease-out}
    @keyframes modalSlideIn{from{opacity:0;transform:translateY(-30px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}
    .modal-header{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);color:#fff;padding:20px 24px;border-radius:12px 12px 0 0;position:relative}
    .modal-header h2{color:#fff;margin:0;font-size:1.3rem;font-weight:600}
    .modal-close{position:absolute;top:20px;right:24px;background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:1.5rem;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background 0.2s}
    .modal-close:hover{background:rgba(255,255,255,0.3)}
    .modal-body{padding:24px}
    .photo-upload-section{text-align:center;margin-bottom:24px;padding:20px;background:linear-gradient(135deg,#f0f7ff 0%,#e3f2fd 100%);border-radius:10px;border:2px dashed #004aad}
    .photo-upload-section .preview{display:block;margin:0 auto 16px;border-radius:50%;width:100px;height:100px;object-fit:cover;border:4px solid #004aad;box-shadow:0 4px 12px rgba(0,74,173,0.2)}
    .upload-btn-wrapper{position:relative;display:inline-block}
    .upload-btn-wrapper input[type=file]{display:none}
    .upload-btn{background:#004aad;color:white;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;display:inline-flex;align-items:center;gap:8px;transition:all 0.3s;border:none}
    .upload-btn:hover{background:#00327a;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,74,173,0.3)}
    .upload-hint{font-size:12px;color:#666;margin-top:10px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-field{display:flex;flex-direction:column}
    .form-field.full-width{grid-column:1 / -1}
    .form-field label{font-weight:600;margin-bottom:6px;font-size:13px;color:#333;display:flex;align-items:center;gap:6px}
    .form-field label i{color:#004aad;font-size:14px}
    .form-field input{padding:10px 12px;border-radius:8px;border:1px solid #d7dce6;font-size:14px;transition:all 0.2s;background:#fff}
    .form-field input:focus{outline:none;border-color:#004aad;box-shadow:0 0 0 3px rgba(0,74,173,0.1)}
    .modal-footer{padding:20px 24px;background:#f9fafb;border-radius:0 0 12px 12px;display:flex;gap:12px;justify-content:flex-end;border-top:1px solid #e0e0e0}
    .modal-footer .btn{margin:0;min-width:100px;padding:10px 20px;font-weight:600;font-size:14px;transition:all 0.3s}
    .btn-cancel{background:#6c757d;color:#fff}
    .btn-cancel:hover{background:#5a6268;transform:translateY(-2px)}
    .btn-save{background:#004aad;color:#fff}
    .btn-save:hover{background:#00327a;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,74,173,0.3)}
    @media (max-width:980px){
      .profile-section{grid-template-columns:1fr;padding-bottom:40px}
      .sidebar{left:-250px;transition:left 0.3s}
      .sidebar.mobile-open{left:0}
      .navbar{left:0}
      .main{margin-left:0}
      .mobile-menu-btn{display:block !important}
      .calendar-day{min-height:45px}
      .event-dot{width:6px;height:6px}
      .form-grid{grid-template-columns:1fr}
      .modal-content{max-width:95%}
    }
    .mobile-menu-btn{display:none;background:none;border:none;color:#004aad;font-size:1.5rem;cursor:pointer;padding:0.5rem}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logu.png" alt="Logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
        <li><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
        <li><a href="reports.html"><i class="fa fa-tasks"></i>&nbsp; Manage Reports</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:1rem;">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa fa-bars"></i></button>
      <h1>User Profile</h1>
    </div>
    <div class="profile">
      <div style="position:relative">
        <i class="fa fa-bell" id="notificationBell" aria-hidden="true"></i>
        <span class="badge" id="notificationBadge">0</span>
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <div class="notification-actions">
              <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read">
                <i class="fa fa-check-double"></i>
              </button>
              <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all">
                <i class="fa fa-trash-alt"></i>
              </button>
            </div>
          </div>
          <div class="notification-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="report">Reports</button>
            <button class="filter-btn" data-filter="user">Users</button>
            <button class="filter-btn" data-filter="24h">Last 24h</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>
      <div class="profile-dropdown" id="profileToggle" aria-haspopup="true">
        <img src="image.png" alt="avatar" class="avatar" id="navAvatar">
        <span class="username" id="navUsername">Loading...</span>
        <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-hidden="true">
          <a href="profile.html"><i class="fa fa-user"></i>&nbsp; Profile</a>
          <a href="#" id="navLogoutBtn"><i class="fa fa-sign-out-alt"></i>&nbsp; Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="main">
    <div class="page">
      <div class="profile-section">
        <section class="card profile-card">
          <div class="top">
            <img src="image.png" id="profilePic" alt="profile" class="profile-main">
            <div>
              <div style="font-size:18px;font-weight:700;color:#0b3e89" id="displayName">Loading...</div>
              <div style="margin-top:6px;color:#6b7380" id="displayRole">Administrator</div>
            </div>
          </div>
          <div class="profile-info">
            <label>Full Name</label>
            <input id="cardName" readonly>
            <label>ID</label>
            <input id="cardID" readonly>
            <label>Email</label>
            <input id="cardEmail" readonly>
            <label>Phone</label>
            <input id="cardPhone" readonly>
            <label>Address</label>
            <input id="cardAddress" readonly>
            <label>Gender</label>
            <input id="cardGender" readonly>
          </div>
          <button class="btn" onclick="openEditModal()">Edit Profile</button>
        </section>

        <aside class="card account-card">
          <h2>Account Info</h2>
          <div class="account-meta">
            <p><strong>Type:</strong> <span id="accountType">Loading...</span></p>
            <p><strong>Registered:</strong> <span id="registeredAt">—</span></p>
            <p><strong>Last Login:</strong> <span id="lastLogin">—</span></p>
          </div>

          <div style="margin-top:24px;">
            <div class="calendar-header">
              <h3><i class="fa fa-calendar"></i> Inspection Calendar</h3>
            </div>
            <div class="calendar-container">
              <div class="calendar-view">
                <div class="calendar-nav">
                  <button onclick="previousMonth()"><i class="fa fa-chevron-left"></i></button>
                  <h3 id="currentMonthYear"></h3>
                  <button onclick="nextMonth()"><i class="fa fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
              </div>
            </div>
            <div class="sync-status" id="syncStatus">
              <i class="fa fa-check-circle" style="color:#1cc88a"></i> Auto-syncing ongoing reports...
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <div class="event-tooltip" id="eventTooltip">
    <div class="event-tooltip-title" id="tooltipTitle"></div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Project Name</span>
      <span class="event-tooltip-value" id="tooltipProjectName"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Barangay</span>
      <span class="event-tooltip-value" id="tooltipBarangay"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Contractor & Supplier</span>
      <span class="event-tooltip-value" id="tooltipContractorSupplier"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Allocated Budget</span>
      <span class="event-tooltip-value" id="tooltipBudget"></span>
    </div>
    <img id="tooltipImage" class="event-tooltip-image" style="display:none;" alt="Project">
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fa fa-user-edit"></i> Edit Profile</h2>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="photo-upload-section">
          <img id="previewImg" class="preview" src="image.png" alt="Profile Preview">
          <div class="upload-btn-wrapper">
            <label class="upload-btn">
              <i class="fa fa-camera"></i>
              <span>Choose Photo</span>
              <input type="file" id="editPhoto" accept="image/*">
            </label>
          </div>
          <div class="upload-hint">JPG, PNG • Max 5MB</div>
        </div>

        <div class="form-grid">
          <div class="form-field full-width">
            <label><i class="fa fa-user"></i> Full Name</label>
            <input type="text" id="editName" placeholder="Enter full name">
          </div>

          <div class="form-field">
            <label><i class="fa fa-id-card"></i> ID Number</label>
            <input type="text" id="editID" placeholder="Enter ID">
          </div>

          <div class="form-field">
            <label><i class="fa fa-venus-mars"></i> Gender</label>
            <input type="text" id="editGender" placeholder="Enter gender">
          </div>

          <div class="form-field full-width">
            <label><i class="fa fa-envelope"></i> Email Address</label>
            <input type="email" id="editEmail" placeholder="Enter email">
          </div>

          <div class="form-field full-width">
            <label><i class="fa fa-phone"></i> Phone Number</label>
            <input type="tel" id="editPhone" placeholder="Enter phone number">
          </div>

          <div class="form-field full-width">
            <label><i class="fa fa-map-marker-alt"></i> Address</label>
            <input type="text" id="editAddress" placeholder="Enter address">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeEditModal()">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button class="btn btn-save" onclick="saveEdit()" id="saveBtn">
          <i class="fa fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>

  <script>
    function toggleMobileMenu(){document.querySelector('.sidebar').classList.toggle('mobile-open')}
    document.addEventListener('click',function(e){const sidebar=document.querySelector('.sidebar');const menuBtn=document.querySelector('.mobile-menu-btn');if(window.innerWidth<=980&&!sidebar.contains(e.target)&&!menuBtn.contains(e.target)){sidebar.classList.remove('mobile-open')}});

    let currentUser=null;
    let ongoingReports=[];
    let currentDate=new Date();
    let selectedMonth=currentDate.getMonth();
    let selectedYear=currentDate.getFullYear();

    let notificationsList = [];
    let seenNotificationIds = new Set();
    let trackedUserStatuses = {};
    let trackedReportIds = new Set();
    let currentFilter = "all";

    function normalizeStatus(status) {
      return (status || "").toLowerCase().trim();
    }

    function isBarangayPosition(position) {
      if (!position) return false;
      const pos = position.toLowerCase().trim();
      return pos.includes("barangay captain") || pos.includes("brgy captain") || pos.includes("brgy. captain") || pos.includes("barangay official") || pos.includes("brgy official") || pos.includes("brgy. official");
    }

    function addNotification(type, message, detail) {
      const cleanMsg = (message || "").trim();
      const cleanDetail = (detail || "").trim();
      const timestamp = new Date();
      const id = `${type}-${cleanMsg}-${cleanDetail}-${timestamp.getTime()}`;
      
      if (seenNotificationIds.has(id)) return;
      seenNotificationIds.add(id);
      
      notificationsList.unshift({
        id,
        type,
        message: cleanMsg,
        detail: cleanDetail,
        timestamp: timestamp,
        read: false
      });
      updateNotificationUI();
    }

    function updateNotificationUI() {
      let filtered = [...notificationsList];
      
      if (currentFilter === "report") {
        filtered = filtered.filter((n) => n.type === "report");
      } else if (currentFilter === "user") {
        filtered = filtered.filter((n) => n.type === "user");
      } else if (currentFilter === "24h") {
        const ago = Date.now() - 24 * 60 * 60 * 1000;
        filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
      }

      filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

      const unreadCount = notificationsList.filter(n => !n.read).length;
      const notificationBadge = document.getElementById("notificationBadge");
      if (unreadCount > 0) {
        notificationBadge.textContent = unreadCount;
        notificationBadge.classList.add("show");
      } else {
        notificationBadge.textContent = "";
        notificationBadge.classList.remove("show");
      }

      const notificationList = document.getElementById("notificationList");
      if (filtered.length === 0) {
        notificationList.innerHTML = `<div class="notification-empty">No notifications</div>`;
      } else {
        notificationList.innerHTML = filtered
          .map(
            (n) => `
          <div class="notification-item ${n.read ? '' : 'unread'}">
            <div class="notification-icon ${n.type}">
              ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
            </div>
            <div class="notification-content">
              <p><strong>${n.message}</strong></p>
              <p>${n.detail}</p>
              <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
            </div>
          </div>`
          )
          .join("");
      }
    }

    const notificationBell = document.getElementById("notificationBell");
    const notificationMenu = document.getElementById("notificationMenu");
    const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
    const markAllReadBtn = document.getElementById("markAllReadBtn");

    notificationBell.addEventListener("click", (e) => {
      e.stopPropagation();
      notificationMenu.classList.toggle("show");
      document.getElementById("dropdownMenu").classList.remove("show");
    });

    clearNotificationsBtn.addEventListener("click", () => {
      notificationsList = [];
      seenNotificationIds.clear();
      updateNotificationUI();
    });

    markAllReadBtn.addEventListener("click", () => {
      notificationsList.forEach(n => n.read = true);
      updateNotificationUI();
    });

    document.querySelectorAll(".filter-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
        e.target.classList.add("active");
        currentFilter = e.target.dataset.filter;
        updateNotificationUI();
      });
    });

    async function setupRealtimeNotifications(db) {
      const { collection, getDocs, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
      
      const userSnap = await getDocs(collection(db, "users"));
      userSnap.forEach((docSnap) => {
        const userId = docSnap.id;
        const data = docSnap.data();
        const status = normalizeStatus(data.status);
        trackedUserStatuses[userId] = status;
        if (status === "active") {
          const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
          const position = data.position || "User";
          addNotification("user", `User approved: ${fullName}`, `Position: ${position}`);
        }
      });

      onSnapshot(collection(db, "users"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const userId = change.doc.id;
          const data = change.doc.data();
          const currentStatus = normalizeStatus(data.status);
          const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
          const position = data.position || "User";

          if (change.type === "added") {
            trackedUserStatuses[userId] = currentStatus;
            if (currentStatus === "active") {
              addNotification("user", `New user approved: ${fullName}`, `Position: ${position}`);
            }
          }

          if (change.type === "modified") {
            const oldStatus = trackedUserStatuses[userId];
            if (oldStatus !== "active" && currentStatus === "active") {
              addNotification("user", `New user approved: ${fullName}`, `Position: ${position}`);
            }
            trackedUserStatuses[userId] = currentStatus;
          }
        });
      });

      const reportSnap = await getDocs(collection(db, "reports"));
      reportSnap.forEach((docSnap) => {
        const id = docSnap.id;
        trackedReportIds.add(id);
        const data = docSnap.data();
        const barangay = data.barangay || data.location || "Unknown location";
        const type = data.reportType || data.type || data.projectName || "Report";
        addNotification("report", "Report submitted", `${type} in ${barangay}`);
      });

      onSnapshot(collection(db, "reports"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const id = change.doc.id;
          const data = change.doc.data();
          if (change.type === "added" && !trackedReportIds.has(id)) {
            trackedReportIds.add(id);
            const barangay = data.barangay || data.location || "Unknown location";
            const type = data.reportType || data.type || data.projectName || "Report";
            addNotification("report", "New report submitted", `${type} in ${barangay}`);
          }
        });
      });

      updateNotificationUI();
      console.log("✅ Notifications active — existing + new");
    }

    function previousMonth(){selectedMonth--;if(selectedMonth<0){selectedMonth=11;selectedYear--}renderCalendar()}
    function nextMonth(){selectedMonth++;if(selectedMonth>11){selectedMonth=0;selectedYear++}renderCalendar()}

    function renderCalendar(){const firstDay=new Date(selectedYear,selectedMonth,1);const lastDay=new Date(selectedYear,selectedMonth+1,0);const prevLastDay=new Date(selectedYear,selectedMonth,0);const firstDayIndex=firstDay.getDay();const lastDayIndex=lastDay.getDay();const nextDays=7-lastDayIndex-1;const months=['January','February','March','April','May','June','July','August','September','October','November','December'];document.getElementById('currentMonthYear').textContent=`${months[selectedMonth]} ${selectedYear}`;let days='';for(let x=firstDayIndex;x>0;x--){days+=`<div class="calendar-day other-month"><div class="calendar-day-number">${prevLastDay.getDate()-x+1}</div></div>`}for(let i=1;i<=lastDay.getDate();i++){const isToday=i===currentDate.getDate()&&selectedMonth===currentDate.getMonth()&&selectedYear===currentDate.getFullYear();const currentDateStr=`${selectedYear}-${String(selectedMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;const eventsForDay=ongoingReports.filter(report=>{const start=formatDateForComparison(report.startDate);const end=formatDateForComparison(report.endDate);return currentDateStr>=start&&currentDateStr<=end});let eventHTML='';if(eventsForDay.length>0){eventHTML='<div class="event-indicators">';eventsForDay.forEach(report=>{const start=formatDateForComparison(report.startDate);const end=formatDateForComparison(report.endDate);let dotClass='event-dot';if(currentDateStr===start){dotClass+=' start'}else if(currentDateStr===end){dotClass+=' end'}else{dotClass+=' ongoing'}eventHTML+=`<div class="${dotClass}" onclick="showEventTooltip(event,'${report.id}')" title="${report.projectName}"></div>`});eventHTML+='</div>'}days+=`<div class="calendar-day ${isToday?'today':''}"><div class="calendar-day-number">${i}</div>${eventHTML}</div>`}for(let j=1;j<=nextDays;j++){days+=`<div class="calendar-day other-month"><div class="calendar-day-number">${j}</div></div>`}document.getElementById('calendarDays').innerHTML=days}

    function formatDateForComparison(date){if(!date)return'';const d=date instanceof Date?date:(date.toDate?date.toDate():new Date(date));return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

    async function loadOngoingReports(db){try{const{collection,query,where,onSnapshot}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");const{getStorage,ref,getDownloadURL}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const storage=getStorage();const reportsRef=collection(db,'reports');const q=query(reportsRef,where('status','==','Ongoing'));onSnapshot(q,async(snapshot)=>{ongoingReports=[];let eventCount=0;for(const doc of snapshot.docs){const data=doc.data();if(data.startDate&&data.endDate){const startDate=data.startDate.toDate?data.startDate.toDate():new Date(data.startDate);const endDate=data.endDate.toDate?data.endDate.toDate():new Date(data.endDate);let imageUrl='';if(data.incidentImage||data.imageUrl||data.image){const imagePath=data.incidentImage||data.imageUrl||data.image;if(imagePath.startsWith('http')){imageUrl=imagePath}else{try{imageUrl=await getDownloadURL(ref(storage,imagePath))}catch(err){console.error("Error loading image:",err)}}}ongoingReports.push({id:doc.id,startDate:startDate,endDate:endDate,projectName:data.projectName||'Unnamed Project',barangay:data.barangay||'N/A',contractor:data.contractor||'N/A',supplier:data.supplier||'N/A',allocatedBudget:data.allocatedBudget||'N/A',imageUrl:imageUrl});eventCount++}}renderCalendar();const syncStatus=document.getElementById('syncStatus');syncStatus.innerHTML=`<i class="fa fa-check-circle" style="color:#1cc88a"></i> Auto-synced ${eventCount} ongoing inspection${eventCount!==1?'s':''} - Last updated: ${new Date().toLocaleTimeString()}`})}catch(err){console.error("Error loading ongoing reports:",err);document.getElementById('syncStatus').innerHTML=`<i class="fa fa-exclamation-circle" style="color:#d9534f"></i> Error syncing calendar`}}

    window.showEventTooltip=function(event,reportId){event.stopPropagation();const report=ongoingReports.find(r=>r.id===reportId);if(!report)return;const tooltip=document.getElementById('eventTooltip');document.getElementById('tooltipTitle').textContent=`Inspection Details`;document.getElementById('tooltipProjectName').textContent=report.projectName;document.getElementById('tooltipBarangay').textContent=report.barangay;document.getElementById('tooltipContractorSupplier').textContent=`${report.contractor} & ${report.supplier}`;document.getElementById('tooltipBudget').textContent=report.allocatedBudget;const tooltipImage=document.getElementById('tooltipImage');if(report.imageUrl){tooltipImage.src=report.imageUrl;tooltipImage.style.display='block'}else{tooltipImage.style.display='none'}const x=event.clientX;const y=event.clientY;tooltip.style.left=x+15+'px';tooltip.style.top=y+15+'px';setTimeout(()=>{const rect=tooltip.getBoundingClientRect();if(rect.right>window.innerWidth){tooltip.style.left=(x-rect.width-15)+'px'}if(rect.bottom>window.innerHeight){tooltip.style.top=(y-rect.height-15)+'px'}},0);tooltip.classList.add('show');document.addEventListener('click',hideEventTooltipOnClick)};

    function hideEventTooltipOnClick(e){if(!e.target.closest('.event-dot')&&!e.target.closest('.event-tooltip')){hideEventTooltip();document.removeEventListener('click',hideEventTooltipOnClick)}}

    window.hideEventTooltip=function(){document.getElementById('eventTooltip').classList.remove('show')};

    const dropdownMenu=document.getElementById('dropdownMenu');
    const profileToggle=document.getElementById('profileToggle');
    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle("show");
      notificationMenu.classList.remove("show");
    });

    window.addEventListener('click',(e)=>{if(!e.target.closest('.profile-dropdown')){dropdownMenu.classList.remove("show")}if(!e.target.closest('.notification-menu')&&e.target!==notificationBell){notificationMenu.classList.remove("show")}});

    const editModal=document.getElementById("editModal");
    const editPhoto=document.getElementById("editPhoto");
    const previewImg=document.getElementById("previewImg");

    window.openEditModal=function(){editModal.style.display="flex"};
    window.closeEditModal=function(){editModal.style.display="none"};

    editPhoto.addEventListener("change",e=>{const file=e.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('Please select an image file');editPhoto.value='';return}if(file.size>5*1024*1024){alert('Image size should be less than 5MB');editPhoto.value='';return}const reader=new FileReader();reader.onload=ev=>{previewImg.src=ev.target.result};reader.readAsDataURL(file)});

    function updateAllProfilePhotos(photoURL) {
      const photoElements = ["profilePic", "navAvatar", "previewImg"];
      photoElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.src = photoURL;
          el.onerror = function() {
            this.src = "image.png";
          };
        }
      });
    }

    window.saveEdit=async function(){if(!currentUser){alert("No user logged in");return}const{updateDoc,doc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");const{ref,uploadBytes,getDownloadURL}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const{getStorage}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const uid=currentUser.uid;const userRef=doc(window.db,"users",uid);const saveBtn=document.getElementById("saveBtn");const updated={name:document.getElementById("editName").value.trim(),ID:document.getElementById("editID").value.trim(),email:document.getElementById("editEmail").value.trim(),phone:document.getElementById("editPhone").value.trim(),address:document.getElementById("editAddress").value.trim(),gender:document.getElementById("editGender").value.trim()};if(!updated.name){alert("Name is required");return}const file=editPhoto.files[0];try{saveBtn.disabled=true;saveBtn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Saving...';if(file){const storage=getStorage();const timestamp=Date.now();const fileExt=file.name.split('.').pop();const fileName=`profile_${timestamp}.${fileExt}`;const storageRef=ref(storage,`user_images/${uid}/${fileName}`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);updated.photoURL=url;console.log("Photo uploaded successfully:",url);updateAllProfilePhotos(url)}await updateDoc(userRef,updated);alert("Profile updated successfully!");closeEditModal();editPhoto.value=''}catch(err){console.error("Error details:",err);alert("Error updating profile: "+err.message)}finally{saveBtn.disabled=false;saveBtn.innerHTML='<i class="fa fa-save"></i> Save Changes'}};

    window.addEventListener("click",(e)=>{if(e.target===editModal)closeEditModal()});
  </script>

  <script type="module">
    import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import{getFirestore,doc,onSnapshot,serverTimestamp,updateDoc}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig={apiKey:"AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",authDomain:"tayabastrack-23b95.firebaseapp.com",projectId:"tayabastrack-23b95",storageBucket:"tayabastrack-23b95.appspot.com",messagingSenderId:"674055915366",appId:"1:674055915366:web:aa560336c1f8b504eeaaa7"};

    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    window.db=db;

    async function handleLogout() {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch(err) {
        alert("Error logging out: " + err.message);
      }
    }

    document.getElementById("sidebarLogoutBtn").addEventListener("click", handleLogout);
    const navLogoutBtn = document.getElementById('navLogoutBtn');
    navLogoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      handleLogout();
    });

    onAuthStateChanged(auth, async(user)=>{
      if(!user) {
        console.warn("No user logged in.");
        window.location.href="login.html";
        return;
      }
      
      console.log("User authenticated:",user.uid);
      currentUser=user;
      window.currentUser=user;
      
      try{
        const userRef=doc(db,'users',user.uid);
        await updateDoc(userRef,{lastLogin:serverTimestamp()});
        console.log("Last login updated");
      }catch(err){
        console.error("Error updating last login:",err);
      }
      
      const ref=doc(db,'users',user.uid);
      onSnapshot(ref,docSnap=>{
        if(!docSnap.exists()){
          console.error("User document not found!");
          return;
        }
        
        const data=docSnap.data();
        console.log("User data loaded:",data);
        
        let fullName="User";
        if(data.firstName&&data.lastName){
          fullName=`${data.firstName} ${data.lastName}`;
        }else if(data.name){
          fullName=data.name;
        }else if(data.firstName){
          fullName=data.firstName;
        }
        
        const elements={
          navUsername:fullName,
          displayName:fullName,
          displayRole:data.position||data.role||"Administrator",
          accountType:data.position||data.role||"Administrator"
        };
        
        Object.keys(elements).forEach(id=>{
          const el=document.getElementById(id);
          if(el)el.textContent=elements[id];
        });
        
        const photoURL=data.photoURL||"image.png";
        updateAllProfilePhotos(photoURL);
        
        const fields={
          cardName:fullName,
          cardID:data.ID||data.id||"",
          cardEmail:data.email||user.email,
          cardPhone:data.phone||"",
          cardAddress:data.address||data.barangay||"",
          cardGender:data.gender||"",
          editName:fullName,
          editID:data.ID||data.id||"",
          editEmail:data.email||user.email,
          editPhone:data.phone||"",
          editAddress:data.address||data.barangay||"",
          editGender:data.gender||""
        };
        
        Object.keys(fields).forEach(id=>{
          const el=document.getElementById(id);
          if(el)el.value=fields[id];
        });
        
        if(data.createdAt){
          const date=data.createdAt.toDate?data.createdAt.toDate():new Date(data.createdAt);
          const el=document.getElementById("registeredAt");
          if(el)el.textContent=date.toLocaleDateString();
        }
        
        if(data.lastLogin){
          const date=data.lastLogin.toDate?data.lastLogin.toDate():new Date(data.lastLogin);
          const el=document.getElementById("lastLogin");
          if(el)el.textContent=date.toLocaleString();
        }
        
        console.log("UI updated successfully");
      },error=>{
        console.error("Error in user snapshot:",error);
      });
      
      try{
        await setupRealtimeNotifications(db);
        console.log("Notifications setup complete");
      }catch(err){
        console.error("Error setting up notifications:",err);
      }
      
      try{
        await loadOngoingReports(db);
        console.log("Calendar loaded");
      }catch(err){
        console.error("Error loading calendar:",err);
      }
    });
  </script>
</body>
</html>