<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | TayabaStrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; }

        .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; }
        .sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; }
        .sidebar-header img { width: 40px; }
        .sidebar-header h2 { font-size: 1.2rem; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin: 0.5rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1.5rem; text-decoration: none; color: #fff; transition: background 0.3s; }
        .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }

        .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
        .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; width: 100%; }
        .logout-btn:hover { background-color: #c9302c; }

        .main { flex: 1; display: flex; flex-direction: column; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        .navbar h1 { font-size: 1.4rem; color: #004aad; }
        .profile { display: flex; align-items: center; gap: 1rem; }
        
        /* Notification Bell */
        .notification-bell-wrapper { position: relative; cursor: pointer; }
        .fa-bell { font-size: 1.2rem; position: relative; cursor: pointer; transition: color 0.3s; }
        .fa-bell:hover { color: #004aad; }
        .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 20px; text-align: center; }
        .badge.show { display: flex; align-items: center; justify-content: center; }

        /* Notification Menu */
        .notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,.15); width: 380px; max-height: 500px; overflow: hidden; z-index: 1000; }
        .notification-menu.show { display: flex; flex-direction: column; }
        .notification-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
        .notification-header h3 { font-size: 1rem; color: #333; margin: 0; }
        .notification-actions { display: flex; gap: 8px; }
        .action-btn { background: none; border: none; color: #004aad; cursor: pointer; font-size: 0.85rem; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .action-btn:hover { background: #e3f2fd; }
        
        /* Notification Filters */
        .notification-filters { display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid #eee; background: #fff; }
        .filter-btn { padding: 4px 12px; border: 1px solid #e0e0e0; background: #fff; color: #666; border-radius: 16px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background: #f5f5f5; }
        .filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }
        
        .notification-list { max-height: 360px; overflow-y: auto; }
        .notification-item { padding: 0.9rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; transition: background 0.2s; cursor: pointer; position: relative; }
        .notification-item:hover { background: #f9f9f9; }
        .notification-item.unread { background: #e3f2fd; }
        .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #004aad; }
        .notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-icon.user { background: #e3f2fd; color: #1976d2; }
        .notification-icon.report { background: #fff3e0; color: #f57c00; }
        .notification-content { flex: 1; }
        .notification-content p { margin: 0; font-size: 0.85rem; }
        .notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.3rem; }
        .notification-empty { padding: 3rem; text-align: center; color: #999; }
        .notification-empty i { font-size: 3rem; color: #ddd; margin-bottom: 1rem; }

        .profile-dropdown { position: relative; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .username { font-weight: 500; }
        
        .dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); min-width: 160px; z-index: 1000; }
        .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.85rem; }
        .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem; }
        .card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .card i { font-size: 1.8rem; color: #004aad; }
        .card p { font-size: 0.9rem; color: #666; }
        .card h2 { font-size: 1.5rem; font-weight: bold; }

        .bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        .reports, .map { background: #fff; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .reports h3, .map h3 { margin-bottom: 1rem; color: #004aad; }
        canvas { width: 100% !important; height: 250px !important; }
        #miniMap { height: 250px !important; border-radius: 10px; width: 100%; }

        .images h3 { color: #004aad; margin-bottom: 1rem; }
        .image-gallery { display: flex; gap: 1rem; flex-wrap: wrap; }
        .image-gallery img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Notification History Modal */
        #notificationModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        #notificationModal > div { background: #fff; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-filter-btn { padding: 0.5rem 1rem; border: 1px solid #ddd; background: #fff; color: #333; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .modal-filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }
        .modal-filter-btn:hover { border-color: #004aad; }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logu.png" alt="Logo" class="logo" />
                <h2>TayabaStrack</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="active"><a href="ad_dashboard.html"><i class="fa fa-home"></i> Dashboard</a></li>
                <li><a href="ad_reports.html"><i class="fa fa-tasks"></i> Manage Reports</a></li>
                <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
                <li><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
                <li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <nav class="navbar">
            <h1>Dashboard</h1>
            <div class="profile">
                <div class="notification-bell-wrapper">
                    <i class="fa fa-bell" id="notificationBell"></i>
                    <span class="badge" id="notificationBadge">0</span>
                    
                    <div class="notification-menu" id="notificationMenu">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <button class="action-btn" id="markAllReadBtn" title="Mark all as read">
                                    <i class="fa fa-check-double"></i>
                                </button>
                                <button class="action-btn" id="clearAllBtn" title="Clear all">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <button class="action-btn" id="viewHistoryBtn" title="View history">
                                    <i class="fa fa-history"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="report">Reports</button>
                            <button class="filter-btn" data-filter="user">Users</button>
                            <button class="filter-btn" data-filter="24h">Last 24h</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">
                                <i class="fa fa-bell-slash"></i>
                                <p>No new notifications</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-dropdown" id="profileToggle">
                    <img src="image.png" alt="Profile" class="avatar" id="navAvatar" />
                    <span class="username" id="navUsername">---</span>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
                    </div>
                </div>
            </div>
        </nav>

        <section class="stats">
            <div class="card"><i class="fa fa-chart-bar"></i><div><p>Total Reports</p><h2 id="totalReports">0</h2></div></div>
            <div class="card"><i class="fa fa-clock"></i><div><p>Pending</p><h2 id="pendingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-sync"></i><div><p>Ongoing</p><h2 id="ongoingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-check-circle"></i><div><p>Completed</p><h2 id="completedReports">0</h2></div></div>
        </section>

        <section class="bottom">
            <div class="reports">
                <h3>Total Reports</h3>
                <canvas id="dashboardChart"></canvas>
            </div>

            <div class="map">
                <h3>Map</h3>
                <div id="miniMap"></div>
            </div>
        </section>

        <section class="images" style="padding:1.5rem;">
            <h3>Recent Report Images</h3>
            <div class="image-gallery" id="reportImages"></div>
        </section>
    </main>

    <!-- Notification History Modal -->
    <div id="notificationModal">
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #eee;">
                <h2 style="margin: 0; color: #004aad; font-size: 1.3rem;">Notification History</h2>
                <button onclick="window.closeNotificationModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
            </div>

            <div style="display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 1px solid #eee; flex-wrap: wrap;">
                <button class="modal-filter-btn active" onclick="window.filterModalNotifications('all')">All</button>
                <button class="modal-filter-btn" onclick="window.filterModalNotifications('report')">Reports</button>
                <button class="modal-filter-btn" onclick="window.filterModalNotifications('user')">Users</button>
                <button class="modal-filter-btn" onclick="window.filterModalNotifications('24h')">Last 24h</button>
            </div>

            <div id="notificationModalList" style="flex: 1; overflow-y: auto; padding: 0;"></div>

            <div style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem;">
                <button onclick="window.markAllNotificationsAsRead()" style="flex: 1; padding: 0.7rem; background: #004aad; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Mark all as read</button>
                <button onclick="window.clearAllNotifications()" style="flex: 1; padding: 0.7rem; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Clear all</button>
            </div>
        </div>
    </div>

    <!-- Google Maps -->
   <!-- Notification System -->
<script>
    function initNotificationSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        return function playChime() {
            try {
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.setValueAtTime(1046.50, now);
                osc.frequency.setValueAtTime(783.99, now + 0.1);
                
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                
                osc.start(now);
                osc.stop(now + 0.6);
            } catch (error) {
                console.log("Chime sound error:", error);
            }
        };
    }

    let allNotifications = [];
    let currentFilter = "all";
    let previousUnreadCount = 0;
    const playChime = initNotificationSound();

    // Format time ago
    function getTimeAgo(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return "Just now";
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        return date.toLocaleDateString();
    }

    // Filter notifications
    function filterNotifications(notifications) {
        const now = new Date();
        const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
        
        return notifications.filter(n => {
            if (currentFilter === "all") return true;
            if (currentFilter === "report") return n.type === "report";
            if (currentFilter === "user") return n.type === "user";
            if (currentFilter === "24h") {
                const nDate = n.timestamp && n.timestamp.toDate ? n.timestamp.toDate() : new Date(n.timestamp);
                return nDate >= oneDayAgo;
            }
            return true;
        });
    }

    // Update notification UI
    function updateNotificationUI() {
        const badge = document.getElementById('notificationBadge');
        const list = document.getElementById('notificationList');
        
        const unreadCount = allNotifications.filter(n => !n.read).length;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? "99+" : unreadCount;
            badge.classList.add("show");
            
            // Play sound only if unread count increased AND we're not on initial load
            if (unreadCount > previousUnreadCount && previousUnreadCount > 0) {
                playChime();
            }
        } else {
            badge.classList.remove("show");
        }
        
        previousUnreadCount = unreadCount;

        // Filter notifications
        const filtered = filterNotifications(allNotifications).slice(0, 5);

        if (filtered.length === 0) {
            list.innerHTML = `
                <div class="notification-empty">
                    <i class="fa fa-bell-slash"></i>
                    <p>No notifications</p>
                </div>
            `;
            return;
        }

        list.innerHTML = filtered.map(n => `
            <div class="notification-item ${!n.read ? 'unread' : ''}" data-id="${n.id}" onclick="window.markNotificationAsRead('${n.id}')">
                <div class="notification-icon ${n.type}">
                    ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
                </div>
                <div class="notification-content">
                    <p><strong>${n.message}</strong></p>
                    <p>${n.detail}</p>
                    <span class="time">${getTimeAgo(n.timestamp)}</span>
                </div>
            </div>
        `).join("");

        if (allNotifications.length > 5) {
            list.innerHTML += `
                <div style="padding: 0.8rem 1rem; border-top: 1px solid #eee; text-align: center;">
                    <button onclick="window.openNotificationModal()" style="background: none; border: none; color: #004aad; cursor: pointer; font-weight: 500; font-size: 0.85rem;">
                        View all (${allNotifications.length}) →
                    </button>
                </div>
            `;
        }
    }

    // Open notification modal
    window.openNotificationModal = function() {
        document.getElementById('notificationModal').style.display = 'flex';
        window.filterModalNotifications('all');
    };

    // Close notification modal
    window.closeNotificationModal = function() {
        document.getElementById('notificationModal').style.display = 'none';
    };

    // Filter modal notifications
    window.filterModalNotifications = function(filter) {
        let notifications = [];
        const now = new Date();
        const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
        
        if (filter === 'all') {
            notifications = allNotifications;
        } else if (filter === 'report') {
            notifications = allNotifications.filter(n => n.type === 'report');
        } else if (filter === 'user') {
            notifications = allNotifications.filter(n => n.type === 'user');
        } else if (filter === '24h') {
            notifications = allNotifications.filter(n => {
                const nDate = n.timestamp && n.timestamp.toDate ? n.timestamp.toDate() : new Date(n.timestamp);
                return nDate >= oneDayAgo;
            });
        }

        const list = document.getElementById('notificationModalList');
        if (notifications.length === 0) {
            list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">No notifications</div>';
        } else {
            list.innerHTML = notifications.map(n => `
                <div style="padding: 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; ${n.read ? 'background: #f9f9f9;' : 'background: #f0f6ff;'}">
                    <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; ${n.type === 'user' ? 'background: #e3f2fd; color: #1976d2;' : 'background: #fff3e0; color: #f57c00;'}">
                        ${n.type === "user" ? '<i class="fa fa-user"></i>' : '<i class="fa fa-flag"></i>'}
                    </div>
                    <div style="flex: 1;">
                        <p style="margin: 0 0 0.3rem 0; font-weight: 500; color: #333;"><strong>${n.message}</strong></p>
                        <p style="margin: 0 0 0.3rem 0; font-size: 0.9rem; color: #666;">${n.detail}</p>
                        <span style="font-size: 0.75rem; color: #999;">${n.timestamp && n.timestamp.toDate ? n.timestamp.toDate().toLocaleString() : new Date(n.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 0.75rem; color: #999; padding: 0.2rem 0.5rem; background: #eee; border-radius: 4px;">${n.read ? 'Read' : 'New'}</span>
                    </div>
                </div>
            `).join('');
        }

        document.querySelectorAll('.modal-filter-btn').forEach(btn => {
            const btnText = btn.textContent.toLowerCase();
            btn.classList.toggle('active', btnText.includes(filter.toLowerCase()) || (filter === 'all' && btnText === 'all'));
        });
    };

    // Mark notification as read
    window.markNotificationAsRead = async function(notifId) {
        try {
            const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            await updateDoc(doc(window.db, "admin_notifications", notifId), {
                read: true
            });
        } catch (err) {
            console.error("Error marking notification as read:", err);
        }
    };

    // Mark all as read
    window.markAllNotificationsAsRead = async function() {
        try {
            const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const unread = allNotifications.filter(n => !n.read);
            for (const notif of unread) {
                await updateDoc(doc(window.db, "admin_notifications", notif.id), {
                    read: true
                });
            }
        } catch (err) {
            console.error("Error marking all as read:", err);
        }
    };

    // Clear all notifications
    window.clearAllNotifications = async function() {
        if (confirm('Are you sure you want to clear all notifications?')) {
            try {
                const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                for (const notif of allNotifications) {
                    await deleteDoc(doc(window.db, "admin_notifications", notif.id));
                }
            } catch (err) {
                console.error("Error clearing notifications:", err);
            }
        }
    };

    // Toggle notification menu
    document.getElementById('notificationBell').addEventListener("click", (e) => {
        e.stopPropagation();
        document.getElementById("notificationMenu").classList.toggle("show");
        document.getElementById("dropdownMenu").style.display = "none";
    });

    // Filter buttons in dropdown
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            updateNotificationUI();
        });
    });

    // Action buttons
    document.getElementById('markAllReadBtn').addEventListener("click", (e) => {
        e.stopPropagation();
        window.markAllNotificationsAsRead();
    });

    document.getElementById('clearAllBtn').addEventListener("click", (e) => {
        e.stopPropagation();
        window.clearAllNotifications();
    });

    document.getElementById('viewHistoryBtn').addEventListener("click", (e) => {
        e.stopPropagation();
        window.openNotificationModal();
    });

    // Hide notification menu on outside click
    document.addEventListener("click", (e) => {
        if (!e.target.closest('.notification-bell-wrapper') && !e.target.closest('.notification-menu')) {
            document.getElementById("notificationMenu").classList.remove("show");
        }
    });
</script>

<!-- Firebase + Chart -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, onSnapshot, addDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
        authDomain: "tayabastrack-23b95.firebaseapp.com",
        projectId: "tayabastrack-23b95",
        storageBucket: "tayabastrack-23b95.firebasestorage.app",
        messagingSenderId: "674055915366",
        appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    window.db = db;

    const totalReportsEl = document.getElementById("totalReports");
    const pendingEl = document.getElementById("pendingReports");
    const ongoingEl = document.getElementById("ongoingReports");
    const completedEl = document.getElementById("completedReports");

    async function getImageUrl(imagePath) {
        try {
            if (!imagePath) return null;
            if (imagePath.startsWith('http')) return imagePath;
            
            const url = await getDownloadURL(ref(storage, imagePath));
            return url;
        } catch (error) {
            console.error("Error getting image URL:", error);
            return null;
        }
    }

    function isBarangayPosition(position) {
        if (!position) return false;
        const pos = position.toLowerCase().trim();
        return pos.includes("barangay captain") || pos.includes("brgy captain") || 
               pos.includes("brgy. captain") || pos.includes("barangay official") || 
               pos.includes("brgy official") || pos.includes("brgy. official");
    }

    // Listen to Firestore notifications
    function setupNotificationListener() {
        const q = query(collection(db, "admin_notifications"), orderBy("timestamp", "desc"));
        let isFirstLoad = true;
        
        onSnapshot(q, (snapshot) => {
            allNotifications = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Set initial count without playing sound
            if (isFirstLoad) {
                previousUnreadCount = allNotifications.filter(n => !n.read).length;
                isFirstLoad = false;
            }
            
            updateNotificationUI();
        });
    }

    // Setup realtime tracking for new users and reports
    async function setupRealtimeTracking() {
        let isInitialLoad = true;
        
        // Track new pending users - ONLY notify about NEW additions after initial load
        const qNewUsers = query(collection(db, "users"), where("status", "==", "pending"));
        onSnapshot(qNewUsers, async (snapshot) => {
            // Skip initial load to avoid notifying about existing pending users
            if (isInitialLoad) {
                isInitialLoad = false;
                return;
            }
            
            for (const change of snapshot.docChanges()) {
                // Only process newly added documents
                if (change.type === "added") {
                    const userId = change.doc.id;
                    const u = change.doc.data();
                    
                    // Check if this is a barangay official
                    if (isBarangayPosition(u.position)) {
                        try {
                            await addDoc(collection(db, "admin_notifications"), {
                                type: "user",
                                userId: userId,
                                message: `New registration: ${u.firstName || ""} ${u.surname || ""}`,
                                detail: u.email || "No email provided",
                                timestamp: serverTimestamp(),
                                read: false
                            });
                            console.log("✓ New user notification created");
                        } catch (error) {
                            console.error("Error creating user notification:", error);
                        }
                    }
                }
            }
        });

        // Track new reports - ONLY notify about NEW reports after initial load
        let isReportInitialLoad = true;
        const qReports = query(collection(db, "reports"));
        onSnapshot(qReports, async (snapshot) => {
            // Skip initial load to avoid notifying about existing reports
            if (isReportInitialLoad) {
                isReportInitialLoad = false;
                return;
            }
            
            for (const change of snapshot.docChanges()) {
                // Only process newly added documents
                if (change.type === "added") {
                    const reportId = change.doc.id;
                    const r = change.doc.data();
                    
                    try {
                        await addDoc(collection(db, "admin_notifications"), {
                            type: "report",
                            reportId: reportId,
                            message: `New report in ${r.barangay || "a barangay"}`,
                            detail: r.description || r.type || "No description",
                            timestamp: serverTimestamp(),
                            read: false
                        });
                        console.log("✓ New report notification created");
                    } catch (error) {
                        console.error("Error creating report notification:", error);
                    }
                }
            }
        });
    }

    // Real-time profile picture sync
    onAuthStateChanged(auth, async (user) => {
        if (!user) return (window.location.href = "logout.html");

        // USE onSnapshot FOR REAL-TIME UPDATES!
        const userDocRef = doc(db, "users", user.uid);
        onSnapshot(userDocRef, async (userDoc) => {
            if (!userDoc.exists()) {
                alert("User data not found! Redirecting...");
                return (window.location.href = "logout.html");
            }

            const data = userDoc.data();
            
            if (data.position !== "Admin") {
                alert("Unauthorized access! Redirecting...");
                return (window.location.href = "logout.html");
            }

            // Update username - updates automatically when changed!
            document.getElementById("navUsername").textContent = data.name || data.firstName || "Admin";
            
            // Update profile picture - THIS UPDATES IN REAL-TIME!
            const photoURL = data.photoURL || data.profilePic || "image.png";
            document.getElementById("navAvatar").src = photoURL;
        });

        // Load dashboard data (only once)
        await loadDashboardData();
        setupNotificationListener();
        setupRealtimeTracking();
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
        if (confirm("Are you sure you want to logout?")) {
            await signOut(auth);
            window.location.href = "logout.html";
        }
    });

    async function loadDashboardData() {
        const snapshot = await getDocs(collection(db, "reports"));
        let total = 0, pending = 0, ongoing = 0, completed = 0;
        window.reportLocations = [];

        snapshot.forEach(docSnap => {
            const report = docSnap.data();
            total++;
            const status = report.status?.toLowerCase();
            if (status === "pending") pending++;
            else if (status === "ongoing" || status === "in-progress") ongoing++;
            else if (status === "resolved" || status === "completed" || status === "repaired" || status === "posted") completed++;

            const lat = report.latitude || report.lat || report.location?.latitude;
            const lng = report.longitude || report.lng || report.location?.longitude;

            if (lat && lng) {
                window.reportLocations.push({
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    type: report.reportType || report.type || "Unknown",
                    status: status || "pending"
                });
            }
        });

        totalReportsEl.textContent = total;
        pendingEl.textContent = pending;
        ongoingEl.textContent = ongoing;
        completedEl.textContent = completed;
        updateChart(completed, ongoing, pending);
        if (window.miniMap) addReportMarkers();
        loadReportImages();
    }

    let chart;
    function updateChart(completed, ongoing, pending) {
        const ctx = document.getElementById("dashboardChart").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Completed", "Ongoing", "Pending"],
                datasets: [{
                    label: "Reports",
                    data: [completed, ongoing, pending],
                    backgroundColor: ["#1cc88a", "#36b9cc", "#f6c23e"]
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    async function loadReportImages() {
        const gallery = document.getElementById("reportImages");
        gallery.innerHTML = "";
        const snapshot = await getDocs(collection(db, "reports"));
        let count = 0;
        
        for (const docSnap of snapshot.docs) {
            if (count >= 6) break;
            
            const report = docSnap.data();
            const imagePath = report.incidentImage || report.imageUrl || report.image;
            
            if (imagePath) {
                const imageUrl = await getImageUrl(imagePath);
                if (imageUrl) {
                    const img = document.createElement("img");
                    img.src = imageUrl;
                    img.onerror = function() { this.style.display = "none"; };
                    gallery.appendChild(img);
                    count++;
                }
            }
        }
    }

    // Profile dropdown
    const profileToggle = document.getElementById("profileToggle");
    const dropdownMenu = document.getElementById("dropdownMenu");

    profileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
        document.getElementById("notificationMenu").classList.remove("show");
    });

    window.addEventListener("click", (e) => {
        if (!e.target.closest(".profile-dropdown")) {
            dropdownMenu.style.display = "none";
        }
    });
</script>
</body>
</html>