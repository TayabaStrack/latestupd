<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Report Bulletin | Admin</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  /* Reset & Base */
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333}

  /* Sidebar */
  .sidebar{width:240px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0}
  .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem}
  .sidebar-header img{width:40px}
  .sidebar-header h2{font-size:1.2rem;margin:0}
  .sidebar-menu{list-style:none}
  .sidebar-menu li{margin:0.5rem 0}
  .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;text-decoration:none;color:#fff;transition:background .2s}
  .sidebar-menu li.active a,.sidebar-menu a:hover{background:#0756cc;border-left:4px solid #042f68}
  .sidebar-footer{text-align:center;font-size:.85rem;padding:1rem;border-top:1px solid rgba(255,255,255,.2)}

  /* Main + Navbar */
  .main{flex:1;display:flex;flex-direction:column}
  .navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);position:sticky;top:0;z-index:10}
  .navbar h1{font-size:1.4rem;color:#004aad}
  .profile{display:flex;align-items:center;gap:1rem;cursor:pointer}
  .fa-bell{font-size:1.2rem;position:relative}
  .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px}
  .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem}
  .avatar{width:35px;height:35px;border-radius:50%}
  .username{font-weight:500}
  .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
  .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem}
  .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}

  /* Reports */
  .reports-section{padding:1.5rem}
  .report-box{background:#fff;border-radius:8px;padding:.8rem 1rem;margin-bottom:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08)}
  .report-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}
  .report-actions input{padding:.35rem .6rem;border:1px solid #ccc;border-radius:16px;font-size:.85rem}

  /* Table */
  .table-container{padding:.6rem;border-radius:6px;overflow:auto}
  .table-card{width:100%;overflow:auto;border-radius:6px}
  table{width:100%;border-collapse:collapse;background:#fff}
  thead th{background:#f0f0f0;color:#333;font-weight:600;padding:.5rem .6rem;text-align:left;white-space:nowrap}
  th.col-id{width:90px}
  th.col-small{width:70px;text-align:center}
  th[style*="min-width"]{min-width:300px}
  th,td{padding:.45rem .6rem;font-size:.78rem;vertical-align:top;border-bottom:1px solid #eee}
  tbody tr:nth-child(even){background:#f9f9f9}
  .status{display:inline-block;min-width:80px;text-align:center;padding:.2rem .5rem;border-radius:5px;color:#fff;font-weight:700;font-size:.72rem}
  .pending{background:#222} .ongoing{background:#6c757d} .completed{background:#1cc88a}
  .action a{color:#004aad;text-decoration:none;font-weight:600;cursor:pointer}
  .action a:hover{text-decoration:underline}

  /* Modal */
  .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);justify-content:center;align-items:center;padding:18px}
  .modal-content{background:#fff;width:100%;max-width:980px;border-radius:12px;padding:18px;max-height:92vh;overflow:auto}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .modal-header h2{color:#004aad;font-size:1.1rem;margin:0}
  .close-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#444}
  .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .modal-row{display:flex;flex-direction:column}
  .modal-row label{font-weight:700;font-size:.85rem;margin-bottom:6px;color:#333}
  .modal-row input[type="text"], .modal-row input[type="number"], .modal-row textarea, .modal-row select{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:.9rem}
  .modal-row textarea{min-height:70px;resize:vertical}
  .img-preview{width:100%;max-height:240px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-top:6px}
  .modal-footer{text-align:right;margin-top:12px}
  .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer;margin-left:8px}
  .btn-save{background:#004aad;color:#fff}
  .btn-post{background:#1cc88a;color:#fff}
  .btn-cancel{background:#ccc;color:#222}

  @media (max-width:900px){ .modal-grid{grid-template-columns:1fr} }
</style>
</head>

<body>
<!-- Sidebar -->
<aside class="sidebar">
  <div>
    <div class="sidebar-header">
      <img src="logu.png" alt="Logo">
      <h2>TayabaStrack</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="ad_dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
      <li><a href="ad_reports.html"><i class="fa fa-tasks"></i>&nbsp; Manage Reports</a></li>
      <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i>&nbsp; Map</a></li>
      <li><a href="ad_usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
      <li class="active"><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i>&nbsp; Report Bulletin</a></li>
    </ul>
  </div>
  <div class="sidebar-footer">
    <p>Logged in as:</p>
    <strong id="sidebarName">Loading...</strong><br>
    <span id="sidebarPosition">Loading...</span>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <nav class="navbar">
    <h1>Report Bulletin</h1>
    <div style="display:flex;align-items:center;gap:14px">
      <div style="position:relative">
        <i class="fa fa-bell"></i>
        <span class="badge" id="notifBadge">0</span>
      </div>

      <div class="profile-dropdown" id="profileToggle">
        <img src="admin-profile.jpg" alt="Profile" class="avatar">
        <span class="username" id="navUsername">Loading...</span>

        <div class="dropdown-menu" id="dropdownMenu">
          <a href="ad_profile.html"><i class="fa fa-user"></i>&nbsp; Profile</a>
          <a href="logout.html" id="logoutBtn"><i class="fa fa-sign-out-alt"></i>&nbsp; Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Reports -->
  <section class="reports-section">
    <div class="report-box">
      <div class="report-box-header">
        <h2>Reports</h2>
        <div class="report-actions">
          <input id="searchReports" placeholder="Search reports...">
        </div>
      </div>

      <div class="table-container">
        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th class="col-id">Report ID</th>
                <th>Barangay</th>
                <th style="min-width:300px">Description</th>
                <th>Affected Age Groups</th>
                <th class="col-small">People</th>
                <th class="col-small">Width</th>
                <th class="col-small">Height</th>
                <th>Image</th>
                <th class="col-small">Lat</th>
                <th class="col-small">Lng</th>
                <th class="col-small">Status</th>
                <th class="col-small">Timestamp</th>
                <th class="col-id">Created At</th>
                <th class="col-id">User ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="completedBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Report</h2>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid" id="modalGrid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" id="cancelBtn">Cancel</button>
      <button class="btn btn-save" id="saveChangesBtn">Save Changes</button>
      <button class="btn btn-post" id="postToBulletinBtn">Post to Bulletin</button>
    </div>
  </div>
</div>

<!-- Firebase Script -->
<!-- Firebase Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
  authDomain: "tayabastrack-23b95.firebaseapp.com",
  projectId: "tayabastrack-23b95",
  storageBucket: "tayabastrack-23b95.firebasestorage.app",
  messagingSenderId: "674055915366",
  appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM elements
const reportTable = document.getElementById("completedBody");
const searchReports = document.getElementById("searchReports");
const editModal = document.getElementById("editModal");
const modalGrid = document.getElementById("modalGrid");
const closeModal = document.getElementById("closeModal");
const cancelBtn = document.getElementById("cancelBtn");
const saveChangesBtn = document.getElementById("saveChangesBtn");
const postToBulletinBtn = document.getElementById("postToBulletinBtn");
const dropdownMenu = document.getElementById("dropdownMenu");
const profileToggle = document.getElementById("profileToggle");
const navUsername = document.getElementById("navUsername");
const sidebarName = document.getElementById("sidebarName");
const sidebarPosition = document.getElementById("sidebarPosition");
const logoutBtn = document.getElementById("logoutBtn");
const notifBadge = document.getElementById("notifBadge");

let currentDocId = null;
let currentDocData = null;

// Load reports
async function loadReports() {
  reportTable.innerHTML = "";
  const q = query(collection(db, "reports"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);

  let notifCount = 0;
  snapshot.forEach(snap => {
    const r = snap.data();

    // Only show completed reports
    if (r.status && r.status.toString().trim().toLowerCase() === "completed") {
      const tr = document.createElement("tr");

      const cols = [
        r.reportId || "",
        r.barangay || "",
        r.description || "",
        r.affectedAgeGroups || "",
        r.peopleInvolved || "",
        r.width || "",
        r.height || "",
        r.imageUrl || r.image || "",
        r.latitude || "",
        r.longitude || "",
        r.status || "",
        r.timestamp || "",
        r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "",
        r.userId || ""
      ];

      cols.forEach(c => {
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      });

      const actionTd = document.createElement("td");
      actionTd.className = "action";
      const editLink = document.createElement("a");
      editLink.href = "#";
      editLink.textContent = "Edit";
      editLink.dataset.id = snap.id;
      editLink.className = "edit-link";
      actionTd.appendChild(editLink);
      tr.appendChild(actionTd);

      reportTable.appendChild(tr);
    } else {
      // Count pending reports for notifications
      if (r.status && r.status.toString().trim().toLowerCase() === "pending") {
        notifCount++;
      }
    }
  });

  notifBadge.textContent = notifCount;
}

// Search reports
searchReports.addEventListener("input", e => {
  const search = e.target.value.toLowerCase();
  [...reportTable.rows].forEach(row => {
    row.style.display = [...row.cells].some(cell => cell.textContent.toLowerCase().includes(search)) ? "" : "none";
  });
});

// Modal open
reportTable.addEventListener("click", async e => {
  if (e.target.classList.contains("edit-link")) {
    e.preventDefault();
    currentDocId = e.target.dataset.id;
    const docSnap = await getDoc(doc(db, "reports", currentDocId));
    currentDocData = docSnap.data();
    modalGrid.innerHTML = "";

    Object.keys(currentDocData).forEach(key => {
      const wrapper = document.createElement("div");
      wrapper.className = "modal-row";
      const label = document.createElement("label");
      label.textContent = key;
      wrapper.appendChild(label);
      const input = document.createElement("input");
      input.type = "text";
      input.id = `field-${key}`;
      input.value = currentDocData[key];
      wrapper.appendChild(input);
      modalGrid.appendChild(wrapper);
    });
    editModal.style.display = "flex";
  }
});

// Modal close
function closeModalFunc() { editModal.style.display = "none"; currentDocId = null; currentDocData = null; }
closeModal.addEventListener("click", closeModalFunc);
cancelBtn.addEventListener("click", closeModalFunc);

// Dropdown toggle
profileToggle.addEventListener("click", () => {
  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
});

// Logout
logoutBtn.addEventListener("click", () => signOut(auth).then(() => location.href = "logout.html"));

// Auth & Firestore user name
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists()) return location.href = "login.html";
    const data = userDoc.data();
    navUsername.textContent = data.name || user.email;
    sidebarName.textContent = data.name || user.email;
    sidebarPosition.textContent = data.position || "Admin";
  } catch (err) {
    console.error(err);
    location.href = "login.html";
  }
});

// Save changes button
saveChangesBtn.addEventListener("click", async () => {
  if (!currentDocId) return;
  const updates = {};
  Object.keys(currentDocData).forEach(key => {
    const input = document.getElementById(`field-${key}`);
    if (input) updates[key] = input.value;
  });
  try {
    await updateDoc(doc(db, "reports", currentDocId), updates);
    closeModalFunc();
    loadReports();
    alert("Changes saved successfully!");
  } catch (err) {
    console.error(err);
    alert("Error saving changes.");
  }
});

/// Post to Bulletin button (Fixed)
postToBulletinBtn.addEventListener("click", async () => {
  if (!currentDocId) return;
  try {
    // Convert date to proper Timestamp for Firestore ordering
    let dateValue = new Date();
    
    if (currentDocData.createdAt && currentDocData.createdAt.toDate) {
      dateValue = currentDocData.createdAt.toDate();
    } else if (currentDocData.timestamp) {
      dateValue = new Date(currentDocData.timestamp);
    }

    const bulletinData = {
      barangay: currentDocData.barangay || "",
      issue: currentDocData.description || "",
      date: dateValue, // Save as proper Date object
      imageURL: currentDocData.imageUrl || ""
    };

    await setDoc(doc(db, "ad_bulletin", currentDocId), bulletinData);
    alert("Report posted to bulletin!");
  } catch (err) {
    console.error(err);
    alert("Error posting to bulletin.");
  }
});

// Load reports on page load
loadReports();
</script>


</body>
</html>
