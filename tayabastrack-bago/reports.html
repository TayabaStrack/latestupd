<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Reports | TayabaStrack Super Admin</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* ---------- RESET & BASE ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI', Tahoma, sans-serif;
      display:flex;
      min-height:100vh;
      background:#f5f7fb;
      color:#333;
      overflow:auto;
    }

    /* ---------- SIDEBAR (fixed) ---------- */
    .sidebar{
      width:250px;
      min-width:250px;
      background:#004aad;
      color:#fff;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:1rem 0;
      position:fixed;
      top:0;
      left:0;
      bottom:0;
      z-index:50;
    }
    .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem}
    .sidebar-header img{width:40px}
    .sidebar-header h2{font-size:1.2rem;margin:0}
    .sidebar-menu{list-style:none;padding-left:0}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;color:#fff;text-decoration:none;transition:background .2s}
    .sidebar-menu a:hover,.sidebar-menu li.active a{background:#0756cc;border-left:4px solid #042f68}
    .sidebar-footer{text-align:center;font-size:.85rem;padding:1rem;border-top:1px solid rgba(255,255,255,.2)}

    /* ---------- NAVBAR (fixed) ---------- */
    .navbar{
      position:fixed;
      top:0;
      left:250px;
      right:0;
      height:64px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 24px;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      z-index:40;
    }
    .navbar h1{font-size:1.4rem;color:#004aad}
    .profile{display:flex;align-items:center;gap:1rem}
    .fa-bell{font-size:1.2rem;position:relative}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px}
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer}
    .avatar{width:35px;height:35px;border-radius:50%}
    .username{font-weight:500}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}

    /* ---------- MAIN CONTENT (space for fixed sidebar & navbar) ---------- */
    .main {
      margin-left:250px;
      margin-top:74px;
      flex:1;
      display:block;
      padding:20px 28px;
      height: calc(100vh - 74px);
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* ---------- CONTENT ---------- */
    .reports-section{
      padding-bottom:40px;
      max-width: 100%;
    }
    .report-box{
      background:#fff;
      border-radius:10px;
      padding:16px;
      margin-bottom:1rem;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
      overflow: visible;
    }
    .report-box-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .report-box-header h2{
      color:#004aad;
      font-size:1.05rem;
    }
    .report-actions input{
      padding:.4rem .75rem;
      border:1px solid #e0e0e0;
      border-radius:18px;
      font-size:.9rem;
      width:260px;
    }

    /* ---------- SCROLL HINT ---------- */
    .scroll-hint {
      background: linear-gradient(135deg, #004aad 0%, #0066cc 100%);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      text-align: center;
      margin: 10px 0 12px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0, 74, 173, 0.2);
      flex-shrink: 0;
    }

    .scroll-hint i {
      animation: slideHint 2s ease-in-out infinite;
    }
    @keyframes slideHint {
      0%, 100% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
    }

    /* ---------- TABLE CARD WITH ENHANCED SCROLLING ---------- */
    .table-card {
      overflow-x: auto;
      overflow-y: hidden;
      border-radius: 10px;
      background: #fff;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      scroll-behavior: smooth;
      position: relative;
      margin-bottom: 0;
      width: 100%;
    }

    .table-card::-webkit-scrollbar {
      height: 10px;
    }

    .table-card::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #004aad 0%, #0066cc 100%);
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      min-width: 1800px;
    }

    thead {
      background: #f5f8fb;
      color: #333;
    }

    thead th {
      font-weight: 700;
      padding: 0.7rem 0.75rem;
      text-align: left;
      border-bottom: 2px solid #e0e0e0;
      white-space: nowrap;
    }

    th, td {
      text-align: left;
      padding: 0.6rem 0.8rem;
      font-size: 0.85rem;
      border-bottom: 1px solid #f0f2f5;
      overflow: visible;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #fbfdff;
    }

    tbody tr:hover {
      background: #f1f8ff;
    }

    /* Column width distribution */
    th:nth-child(1), td:nth-child(1) { min-width: 180px; } /* Report ID */
    th:nth-child(2), td:nth-child(2) { min-width: 150px; } /* Barangay */
    th:nth-child(3), td:nth-child(3) { min-width: 320px; } /* Description */
    th:nth-child(4), td:nth-child(4) { min-width: 180px; } /* Age Groups */
    th:nth-child(5), td:nth-child(5) { min-width: 140px; } /* Dimensions */
    th:nth-child(6), td:nth-child(6) { min-width: 100px; } /* Image */
    th:nth-child(7), td:nth-child(7) { min-width: 180px; } /* Coordinates */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Status */
    th:nth-child(9), td:nth-child(9) { min-width: 200px; } /* Timestamp */
    th:nth-child(10), td:nth-child(10) { min-width: 180px; } /* User ID */
    th:nth-child(11), td:nth-child(11) { min-width: 160px; } /* Inspection Date */
    th:nth-child(12), td:nth-child(12) { min-width: 160px; } /* Budget */
    th:nth-child(13), td:nth-child(13) { min-width: 200px; } /* Actions */

    .truncate {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
    }

    .status {
      display: inline-block;
      padding: .25rem .5rem;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      font-size: .75rem;
      min-width: 80px;
      text-align: center;
    }

    .pending { background: #f6c23e; color: #2b2b2b; }
    .ongoing { background: #36b9cc; color: #fff; }
    .completed { background: #1cc88a; color: #fff; }
    .declined { background: #d9534f; color: #fff; }

    .action a {
      color: #004aad;
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      margin-right: 8px;
    }
    .action a.decline { color: #d9534f; }

    td button {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 4px;
    }

    td button.btn-edit {
      background: #004aad;
      color: #fff;
    }

    td button.btn-decline {
      background: #d9534f;
      color: #fff;
    }

    /* ---------- MODAL ---------- */
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);justify-content:center;align-items:center;padding:18px}
    .modal-content{background:#fff;width:100%;max-width:980px;border-radius:12px;padding:18px;max-height:92vh;overflow:auto}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal-header h2{color:#004aad;font-size:1.1rem;margin:0}
    .close-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#444}
    .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .modal-row{display:flex;flex-direction:column}
    .modal-row label{font-weight:700;font-size:.9rem;margin-bottom:6px;color:#333}
    .modal-row input[type="text"],.modal-row input[type="number"],.modal-row textarea,.modal-row select { padding:8px;border:1px solid #e0e0e0;border-radius:8px;font-size:.95rem }
    .modal-row textarea{min-height:80px;resize:vertical}
    .img-preview{width:100%;max-height:280px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-top:6px}
    .modal-footer{text-align:right;margin-top:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer;margin-left:8px}
    .btn-save{background:#004aad;color:#fff}
    .btn-cancel{background:#9e9e9e;color:#fff}
    .btn-delete{background:#d9534f;color:#fff}

    /* Decline Modal */
    .decline-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
      justify-content: center;
      align-items: center;
      padding: 18px;
    }
    .decline-modal-content {
      background: #fff;
      width: 100%;
      max-width: 600px;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
    }
    .decline-modal-header {
      margin-bottom: 20px;
    }
    .decline-modal-header h3 {
      color: #d9534f;
      font-size: 1.3rem;
      margin: 0;
    }
    .decline-form-group {
      margin-bottom: 18px;
    }
    .decline-form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 0.95rem;
    }
    .decline-form-group label .required {
      color: #d9534f;
      margin-left: 3px;
    }
    .decline-form-group textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      resize: vertical;
      font-family: inherit;
    }
    .decline-form-group input[type="date"],
    .decline-form-group input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .decline-form-group input:focus,
    .decline-form-group textarea:focus {
      outline: none;
      border-color: #004aad;
      box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1);
    }
    .budget-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .budget-input-wrapper span {
      font-weight: 600;
      color: #666;
    }
    .budget-input-wrapper input {
      flex: 1;
    }
    .decline-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }

    /* ---------- LOADING ---------- */
    .loading-overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);z-index:3000;display:none}
    .spinner { width:56px;height:56px;border-radius:50%;border:6px solid #e9eef5;border-top-color:#004aad;animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    @media (max-width:900px) {
      .modal-grid{grid-template-columns:1fr}
      .report-actions input{width:100%}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logu.png" alt="Logo">
        <h2>TayabaStrack</h2>
      </div>

      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a></li>
        <li><a href="usermanagement.html"><i class="fa fa-tasks"></i> User Management</a></li>
        <li class="active"><a href="reports.html"><i class="fa fa-map-marker-alt"></i> Manage Reports</a></li>
        <li><a href="bdatemanagement.html"><i class="fa fa-coins"></i> Budget & Date Management</a></li>
      </ul>
    </div>

    <div class="sidebar-footer">
      <p>Logged in as:</p>
      <strong id="sidebarName">Loading...</strong><br>
      <span id="sidebarPosition">Loading...</span>
    </div>
  </aside>

  <!-- Navbar -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <h1>Manage Reports</h1>
    <div style="display:flex;align-items:center;gap:14px">
      <div style="position:relative">
        <i class="fa fa-bell" aria-hidden="true"></i>
        <span class="badge" id="notifBadge">0</span>
      </div>

      <div class="profile-dropdown" id="profileToggle" aria-haspopup="true">
        <img src="mark.jpg" alt="Profile" class="avatar">
        <span class="username" id="navUsername">Loading...</span>

        <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-hidden="true">
          <a href="profile.html"><i class="fa fa-user"></i>&nbsp; Profile</a>
          <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i>&nbsp; Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="main" role="main">
    <!-- Reports section -->
    <section class="reports-section">
      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
        <div class="spinner" role="status" aria-label="Loading"></div>
      </div>

      <div class="report-box">
        <div class="report-box-header">
          <h2>Ongoing Reports</h2>
          <div class="report-actions">
            <input id="searchOngoing" placeholder="Search ongoing..." aria-label="Search ongoing reports">
          </div>
        </div>

        <div class="scroll-hint">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Scroll horizontally to view all columns</span>
        </div>

        <div class="table-card" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Report ID</th>
                <th>Barangay</th>
                <th>Description</th>
                <th>Age Groups / People</th>
                <th>Dimensions (W×H)</th>
                <th>Image</th>
                <th>Coordinates</th>
                <th>Status</th>
                <th>Timestamp</th>
                <th>User ID</th>
                <th>Inspection Date</th>
                <th>Budget Allocation</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="ongoingBody"></tbody>
          </table>
        </div>
      </div>

      <div class="report-box">
        <div class="report-box-header">
          <h2>Completed Reports</h2>
          <div class="report-actions">
            <input id="searchCompleted" placeholder="Search completed..." aria-label="Search completed reports">
          </div>
        </div>

        <div class="scroll-hint">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Scroll horizontally to view all columns</span>
        </div>

        <div class="table-card" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Report ID</th>
                <th>Barangay</th>
                <th>Description</th>
                <th>Age Groups / People</th>
                <th>Dimensions (W×H)</th>
                <th>Image</th>
                <th>Coordinates</th>
                <th>Status</th>
                <th>Timestamp</th>
                <th>User ID</th>
                <th>Inspection Date</th>
                <th>Budget Allocation</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="completedBody"></tbody>
          </table>
        </div>
      </div>

      <div class="report-box">
        <div class="report-box-header">
          <h2>Declined Reports</h2>
          <div class="report-actions">
            <input id="searchDeclined" placeholder="Search declined..." aria-label="Search declined reports">
          </div>
        </div>

        <div class="scroll-hint">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Scroll horizontally to view all columns</span>
        </div>

        <div class="table-card" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Report ID</th>
                <th>Barangay</th>
                <th>Description</th>
                <th>Age Groups / People</th>
                <th>Dimensions (W×H)</th>
                <th>Image</th>
                <th>Coordinates</th>
                <th>Status</th>
                <th>Timestamp</th>
                <th>User ID</th>
                <th>Inspection Date</th>
                <th>Budget Allocation</th>
                <th>Decline Reason</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="declinedBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Edit Report</h2>
        <button class="close-btn" id="closeModal" title="Close">&times;</button>
      </div>

      <div class="modal-body">
        <div class="modal-grid" id="modalGrid"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" id="cancelBtn">Cancel</button>
        <button class="btn btn-save" id="saveChangesBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Decline Modal -->
  <div class="decline-modal" id="declineModal">
    <div class="decline-modal-content">
      <div class="decline-modal-header">
        <h3>Decline Report</h3>
      </div>
      <div class="decline-reason-group">
        <label for="declineReason">Please provide a reason for declining this report:</label>
        <textarea id="declineReason" placeholder="Enter reason for declining..."></textarea>
      </div>
      <div class="decline-modal-footer">
        <button class="btn btn-cancel" id="cancelDeclineBtn">Cancel</button>
        <button class="btn btn-delete" id="confirmDeclineBtn">Confirm Decline</button>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      getDoc,
      doc,
      updateDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
      authDomain: "tayabastrack-23b95.firebaseapp.com",
      projectId: "tayabastrack-23b95",
      storageBucket: "tayabastrack-23b95.firebasestorage.app",
      messagingSenderId: "674055915366",
      appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM references
    const ongoingBody = document.getElementById("ongoingBody");
    const completedBody = document.getElementById("completedBody");
    const declinedBody = document.getElementById("declinedBody");
    const searchOngoing = document.getElementById("searchOngoing");
    const searchCompleted = document.getElementById("searchCompleted");
    const searchDeclined = document.getElementById("searchDeclined");

    const editModal = document.getElementById("editModal");
    const modalGrid = document.getElementById("modalGrid");
    const closeModal = document.getElementById("closeModal");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveChangesBtn = document.getElementById("saveChangesBtn");

    const declineModal = document.getElementById("declineModal");
    const declineReason = document.getElementById("declineReason");
    const cancelDeclineBtn = document.getElementById("cancelDeclineBtn");
    const confirmDeclineBtn = document.getElementById("confirmDeclineBtn");

    const dropdownMenu = document.getElementById("dropdownMenu");
    const profileToggle = document.getElementById("profileToggle");
    const navUsername = document.getElementById("navUsername");
    const sidebarName = document.getElementById("sidebarName");
    const sidebarPosition = document.getElementById("sidebarPosition");
    const logoutBtn = document.getElementById("logoutBtn");
    const notifBadge = document.getElementById("notifBadge");
    const loadingOverlay = document.getElementById("loadingOverlay");

    let currentDocId = null;
    let currentDocData = null;
    let reportsUnsub = null;
    let reportToDecline = null;

    function formatTimestamp(timestamp) {
      if (!timestamp) return "";
      let date;
      if (timestamp.toDate) date = timestamp.toDate();
      else if (typeof timestamp === 'string') date = new Date(timestamp);
      else return timestamp;
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const m = months[date.getMonth()];
      const d = String(date.getDate()).padStart(2,'0');
      const y = date.getFullYear();
      let h = date.getHours();
      const min = String(date.getMinutes()).padStart(2,'0');
      const ampm = h>=12?'PM':'AM';
      h = h%12||12;
      return `${m}/${d}/${y} | ${h}:${min} ${ampm}`;
    }

    function formatDate(timestamp) {
      if (!timestamp) return "Not Set";
      let date;
      if (timestamp.toDate) date = timestamp.toDate();
      else if (typeof timestamp === 'string') date = new Date(timestamp);
      else return "Not Set";
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const m = months[date.getMonth()];
      const d = String(date.getDate()).padStart(2,'0');
      const y = date.getFullYear();
      return `${m} ${d}, ${y}`;
    }

    function showLoading(show = true) {
      loadingOverlay.style.display = show ? "flex" : "none";
    }

    function buildTableRow(docSnap, isDeclined = false) {
      const r = docSnap.data();
      const tr = document.createElement("tr");
      const addCell = (c, cls="")=>{
        const td=document.createElement("td");
        if(cls)td.className=cls;
        if(typeof c==="string")td.textContent=c;else td.appendChild(c);
        tr.appendChild(td);
      };
      
      addCell(r.reportId||"");
      addCell(r.barangay||"");
      const desc=document.createElement("span");
      desc.className="truncate";
      desc.textContent=r.description||"";
      desc.title=r.description||"";
      addCell(desc);
      addCell(`${r.affectedAgeGroups||""}${r.affectedAgeGroups&&r.peopleInvolved?" / ":""}${r.peopleInvolved||""}`);
      const dims=(r.width&&r.height)?`${r.width}×${r.height}`:(r.width||r.height||"");
      addCell(dims);
      
      const imgSpan=document.createElement("span");
      const imgData=r.incidentImage||r.imageUrl||r.image;
      if(imgData){
        const link=document.createElement("a");
        link.href="#";link.textContent="View";
        link.onclick=(e)=>{
          e.preventDefault();
          const overlay=document.createElement("div");
          overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center";
          const img=document.createElement("img");
          img.src=imgData.startsWith("http")?imgData:`data:image/jpeg;base64,${imgData}`;
          img.style.cssText="max-width:90%;max-height:90%;border-radius:8px";
          overlay.appendChild(img);
          overlay.onclick=()=>overlay.remove();
          document.body.appendChild(overlay);
        };
        imgSpan.appendChild(link);
      } else imgSpan.textContent="No";
      addCell(imgSpan);
      
      addCell(`${r.latitude||""}${r.latitude&&r.longitude?", ":""}${r.longitude||""}`);
      
      const status=document.createElement("span");
      const s=(r.status||"Ongoing").toLowerCase();
      status.className=`status ${s}`;
      status.textContent=r.status||"Ongoing";
      addCell(status);
      
      addCell(formatTimestamp(r.timestamp||r.createdAt));
      addCell(r.userId||"");
      addCell(formatDate(r.inspectionDate));
      addCell(r.budgetAllocation ? `₱${parseFloat(r.budgetAllocation).toLocaleString()}` : "Not Set");
      
      // Add decline reason column for declined reports
      if(isDeclined) {
        const reasonSpan = document.createElement("span");
        reasonSpan.className = "truncate";
        reasonSpan.textContent = r.declineReason || "No reason provided";
        reasonSpan.title = r.declineReason || "No reason provided";
        addCell(reasonSpan);
      }
      
      const action=document.createElement("span");
      const eLink=document.createElement("button");
      eLink.className="btn-edit";
      eLink.textContent="Edit";
      eLink.dataset.id=docSnap.id;
      eLink.onclick=openEditFromRow;
      
      action.appendChild(eLink);
      
      // Only show decline button for ongoing and completed reports
      if(!isDeclined) {
        const dLink=document.createElement("button");
        dLink.className="btn-decline";
        dLink.textContent="Decline";
        dLink.dataset.id=docSnap.id;
        dLink.onclick=openDeclineModal;
        action.appendChild(dLink);
      }
      
      addCell(action,"action");
      return tr;
    }

    function attachSearch(inputElem, tableBody) {
      inputElem.addEventListener("keyup", ()=>{
        const val=inputElem.value.toLowerCase();
        [...tableBody.rows].forEach(r=>{
          const text=r.innerText.toLowerCase();
          r.style.display=text.includes(val)?"":"none";
        });
      });
    }
    attachSearch(searchOngoing, ongoingBody);
    attachSearch(searchCompleted, completedBody);
    attachSearch(searchDeclined, declinedBody);

    async function openEditFromRow(e){
      e.preventDefault();
      const id=e.currentTarget.dataset.id;
      const snap=await getDoc(doc(db,"reports",id));
      if(!snap.exists())return alert("Not found");
      currentDocId=id;
      currentDocData=snap.data();
      modalGrid.innerHTML="";
      Object.entries(currentDocData).forEach(([k,v])=>{
        const row=document.createElement("div");
        row.className="modal-row";
        const lab=document.createElement("label");
        lab.textContent=k;
        row.appendChild(lab);
        const inp=document.createElement("textarea");
        inp.value=typeof v==="object"?JSON.stringify(v):v;
        inp.id=`field-${k}`;
        row.appendChild(inp);
        modalGrid.appendChild(row);
      });
      editModal.style.display="flex";
    }

    function openDeclineModal(e){
      e.preventDefault();
      const id=e.currentTarget.dataset.id;
      reportToDecline = id;
      declineReason.value = "";
      declineModal.style.display="flex";
    }

    async function confirmDecline(){
      const reason = declineReason.value.trim();
      if(!reason) {
        alert("Please provide a reason for declining this report.");
        return;
      }
      
      if(!reportToDecline) return;
      
      try {
        await updateDoc(doc(db, "reports", reportToDecline), {
          status: "Declined",
          declineReason: reason,
          declinedAt: serverTimestamp()
        });
        
        declineModal.style.display = "none";
        reportToDecline = null;
        alert("Report has been declined.");
      } catch(err) {
        alert("Error declining report: " + err.message);
      }
    }

    closeModal.onclick=()=>editModal.style.display="none";
    cancelBtn.onclick=()=>editModal.style.display="none";
    cancelDeclineBtn.onclick=()=>{
      declineModal.style.display="none";
      reportToDecline = null;
    };
    confirmDeclineBtn.onclick=confirmDecline;

    // Profile dropdown toggle
    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });

    window.addEventListener("click", () => dropdownMenu.style.display = "none");

    onAuthStateChanged(auth, async(user)=>{
      if(!user)return location.href="login.html";
      const uDoc=await getDoc(doc(db,"users",user.uid));
      if(!uDoc.exists())return location.href="login.html";
      const d=uDoc.data();
      if(d.position!=="Super Admin"){alert("Unauthorized");location.href="login.html";return;}
      navUsername.textContent=d.name||"Super Admin";
      sidebarName.textContent=d.name||"Super Admin";
      sidebarPosition.textContent=d.position||"Super Admin";

      const q=query(collection(db,"reports"),orderBy("createdAt","desc"));
      if(reportsUnsub)reportsUnsub();
      reportsUnsub=onSnapshot(q,(snap)=>{
        ongoingBody.innerHTML="";
        completedBody.innerHTML="";
        declinedBody.innerHTML="";
        snap.forEach(docSnap=>{
          const data=docSnap.data();
          const status=(data.status||"ongoing").toLowerCase();
          if(status==="ongoing") {
            const row=buildTableRow(docSnap, false);
            ongoingBody.appendChild(row);
          }
          else if(status==="completed") {
            const row=buildTableRow(docSnap, false);
            completedBody.appendChild(row);
          }
          else if(status==="declined") {
            const row=buildTableRow(docSnap, true);
            declinedBody.appendChild(row);
          }
        });
      });
    });

    logoutBtn.onclick=async(e)=>{
      e.preventDefault();
      await signOut(auth);
      window.location.href="index.html";
    };
  </script>
</body>
</html>