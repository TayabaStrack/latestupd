<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TayabaStrack | User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; }

    /* Sidebar */
    .sidebar {
      width: 240px; background: #004aad; color: #fff;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 1rem 0;
      position: fixed;
      height: 100vh;
    }
    .sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; }
    .sidebar-header img { width: 40px; }
    .sidebar-header h2 { font-size: 1.2rem; margin: 0; }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin: 0.5rem 0; }
    .sidebar-menu a {
      display: flex; align-items: center; gap: 10px;
      padding: 0.8rem 1.5rem; text-decoration: none; color: #fff;
      transition: background 0.3s;
    }
    .sidebar-menu li.active a, .sidebar-menu a:hover {
      background: #0756cc; border-left: 4px solid #042f68;
    }
    .sidebar-footer {
      text-align: center; font-size: 0.85rem; padding: 1rem;
      border-top: 1px solid rgba(255,255,255,0.2);
    }

    /* Main */
    .main { 
      flex: 1; 
      display: flex; 
      flex-direction: column;
      margin-left: 240px;
      height: 100vh;
      overflow: hidden;
    }

    /* Navbar */
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 10;
    }
    .navbar h1 { font-size: 1.4rem; color: #004aad; }

    .profile { display: flex; align-items: center; gap: 1rem; position: relative; }
    .fa-bell { font-size: 1.2rem; color: #004aad; cursor: pointer; }
    .badge {
      position: absolute; top: -5px; right: 55px;
      background: red; color: #fff; font-size: 0.7rem;
      border-radius: 50%; padding: 2px 6px;
    }

    /* Profile Dropdown */
    .profile-dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .avatar { width: 35px; height: 35px; border-radius: 50%; }
    .username { font-weight: 500; }

    .dropdown-menu {
      display: none; position: absolute; top: 120%; right: 0;
      background: #fff; border: 1px solid #ddd; border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); min-width: 160px; z-index: 1000;
    }
    .dropdown-menu a {
      display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.85rem;
    }
    .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }

    /* Content - Scrollable */
    .content { 
      flex: 1; 
      padding: 1.5rem; 
      overflow-y: auto;
      height: calc(100vh - 80px);
    }

    /* Table Sections */
    .table-section {
      margin-bottom: 2rem;
    }

    .table-section h2 {
      color: #004aad;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-section h2 span {
      font-size: 0.9rem;
      color: #666;
      font-weight: normal;
    }

    /* Search Box */
    .search-box {
      margin-bottom: 1rem;
      position: relative;
      max-width: 400px;
    }

    .search-box input {
      width: 100%;
      padding: 0.6rem 2.5rem 0.6rem 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .search-box i {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }

    /* Table */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: #fff; 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
    }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #004aad; color: #fff; }
    tr:hover { background: #f9f9f9; }
    
    button {
      border: none; 
      padding: 0.4rem 0.8rem; 
      border-radius: 6px; 
      cursor: pointer;
      font-size: 0.8rem; 
      color: #fff;
      margin-right: 0.3rem;
    }
    
    button.approve { background: #28a745; }
    button.decline { background: #dc3545; }
    button.edit { background: #007bff; }
    button.inactive { background: #ffc107; color: #333; }
    button.activate { background: #28a745; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      color: #004aad;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      padding: 0;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    button.save { background: #28a745; }
    button.cancel { background: #6c757d; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logu.png" alt="Logo" class="logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="ad_dashboard.html"><i class="fa fa-home"></i> Dashboard</a></li>
        <li><a href="ad_reports.html"><i class="fa fa-tasks"></i> Manage Reports</a></li>
        <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
        <li class="active"><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
        <li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <p>Logged in as:</p>
      <strong id="sidebarName">Loading...</strong><br>
      <span id="sidebarPosition">---</span>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <nav class="navbar">
      <h1>User Management</h1>
      <div class="profile">
        <i class="fa fa-bell"></i>
        <span class="badge">2</span>
        <div class="profile-dropdown" id="profileToggle">
          <img src="admin-profile.jpg" alt="Profile" class="avatar">
          <span class="username" id="navbarName">---</span>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
            <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="content">
      <!-- Pending Registration Table -->
      <div class="table-section">
        <h2>Pending Registration <span id="pendingCount"></span></h2>
        <div class="search-box">
          <input type="text" id="searchPending" placeholder="Search pending users...">
          <i class="fa fa-search"></i>
        </div>
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Contact</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="pendingTable">
            <tr><td colspan="7" style="text-align:center; color:#777; padding:1rem;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Active Users Table -->
      <div class="table-section">
        <h2>Active Users <span id="activeCount"></span></h2>
        <div class="search-box">
          <input type="text" id="searchActive" placeholder="Search active users...">
          <i class="fa fa-search"></i>
        </div>
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Contact</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="activeTable">
            <tr><td colspan="7" style="text-align:center; color:#777; padding:1rem;">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Inactive Users Table -->
      <div class="table-section">
        <h2>Inactive Users <span id="inactiveCount"></span></h2>
        <div class="search-box">
          <input type="text" id="searchInactive" placeholder="Search inactive users...">
          <i class="fa fa-search"></i>
        </div>
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Contact</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inactiveTable">
            <tr><td colspan="7" style="text-align:center; color:#777; padding:1rem;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit User Information</h3>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="editFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="editLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editEmail" required>
        </div>
        <div class="form-group">
          <label>Barangay</label>
          <input type="text" id="editBarangay" required>
        </div>
        <div class="form-group">
          <label>Position</label>
          <input type="text" id="editPosition" required>
        </div>
        <div class="form-group">
          <label>Contact</label>
          <input type="text" id="editContact" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="cancel" id="cancelEdit">Cancel</button>
          <button type="submit" class="save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.firebasestorage.app",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const sidebarName = document.getElementById("sidebarName");
  const sidebarPosition = document.getElementById("sidebarPosition");
  const navbarName = document.getElementById("navbarName");

  // Tables
  const pendingTable = document.getElementById("pendingTable");
  const activeTable = document.getElementById("activeTable");
  const inactiveTable = document.getElementById("inactiveTable");

  // Search inputs
  const searchPending = document.getElementById("searchPending");
  const searchActive = document.getElementById("searchActive");
  const searchInactive = document.getElementById("searchInactive");

  // Modal
  const editModal = document.getElementById("editModal");
  const closeModal = document.getElementById("closeModal");
  const cancelEdit = document.getElementById("cancelEdit");
  const editForm = document.getElementById("editForm");

  // Store all users
  let allPendingUsers = [];
  let allActiveUsers = [];
  let allInactiveUsers = [];

  // Helper function to check if position is Barangay Captain or Official
  function isBarangayPosition(position) {
    if (!position) return false;
    const pos = position.toLowerCase().trim();
    return pos.includes("barangay captain") || 
           pos.includes("brgy captain") || 
           pos.includes("brgy. captain") ||
           pos.includes("barangay official") || 
           pos.includes("brgy official") || 
           pos.includes("brgy. official");
  }

  // Render table
  function renderTable(tbody, users, actionType) {
    if (users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#777; padding:1rem;">No users found.</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    users.forEach(({ id, data: u }) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.firstName || ""}</td>
        <td>${u.surname || ""}</td>
        <td>${u.email || ""}</td>
        <td>${u.barangay || ""}</td>
        <td>${u.position || ""}</td>
        <td>${u.phoneNumber || u.contact || "—"}</td>
        <td>
          ${actionType === 'pending' ? `
            <button class="approve" onclick="approveUser('${id}')">Approve</button>
            <button class="decline" onclick="declineUser('${id}')">Decline</button>
          ` : actionType === 'active' ? `
            <button class="edit" onclick="openEditModal('${id}')">Edit</button>
            <button class="inactive" onclick="makeInactive('${id}')">Inactive</button>
          ` : `
            <button class="activate" onclick="activateUser('${id}')">Activate</button>
          `}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Search filter
  function filterUsers(searchTerm, allUsers) {
    return allUsers.filter(({ data: u }) => {
      return (u.firstName || "").toLowerCase().includes(searchTerm) ||
             (u.surname || "").toLowerCase().includes(searchTerm) ||
             (u.email || "").toLowerCase().includes(searchTerm) ||
             (u.barangay || "").toLowerCase().includes(searchTerm) ||
             (u.position || "").toLowerCase().includes(searchTerm);
    });
  }

  // Approve user
  window.approveUser = async function(userId) {
    if (!confirm("Approve this user?")) return;
    try {
      await updateDoc(doc(db, "users", userId), { status: "active" });
      alert("User approved successfully!");
    } catch (err) {
      console.error("Error approving user:", err);
      alert("Error approving user.");
    }
  };

  // Decline user (delete)
  window.declineUser = async function(userId) {
    if (!confirm("Delete this user account? This cannot be undone!")) return;
    try {
      await deleteDoc(doc(db, "users", userId));
      alert("User account deleted.");
    } catch (err) {
      console.error("Error deleting user:", err);
      alert("Error deleting user.");
    }
  };

  // Make inactive
  window.makeInactive = async function(userId) {
    if (!confirm("Make this user inactive?")) return;
    try {
      await updateDoc(doc(db, "users", userId), { status: "inactive" });
      alert("User set to inactive.");
    } catch (err) {
      console.error("Error:", err);
      alert("Error setting user inactive.");
    }
  };

  // Activate user
  window.activateUser = async function(userId) {
    if (!confirm("Activate this user?")) return;
    try {
      await updateDoc(doc(db, "users", userId), { status: "active" });
      alert("User activated!");
    } catch (err) {
      console.error("Error:", err);
      alert("Error activating user.");
    }
  };

  // Open edit modal
  window.openEditModal = function(userId) {
    const user = allActiveUsers.find(u => u.id === userId);
    if (!user) return;

    document.getElementById('editUserId').value = userId;
    document.getElementById('editFirstName').value = user.data.firstName || "";
    document.getElementById('editLastName').value = user.data.surname || "";
    document.getElementById('editEmail').value = user.data.email || "";
    document.getElementById('editBarangay').value = user.data.barangay || "";
    document.getElementById('editPosition').value = user.data.position || "";
    document.getElementById('editContact').value = user.data.phoneNumber || user.data.contact || "";

    editModal.classList.add('show');
  };

  // Close modal
  closeModal.addEventListener('click', () => editModal.classList.remove('show'));
  cancelEdit.addEventListener('click', () => editModal.classList.remove('show'));

  // Save edit
  editForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userId = document.getElementById('editUserId').value;

    try {
      await updateDoc(doc(db, "users", userId), {
        firstName: document.getElementById('editFirstName').value,
        surname: document.getElementById('editLastName').value,
        email: document.getElementById('editEmail').value,
        barangay: document.getElementById('editBarangay').value,
        position: document.getElementById('editPosition').value,
        phoneNumber: document.getElementById('editContact').value
      });
      alert("User updated successfully!");
      editModal.classList.remove('show');
    } catch (err) {
      console.error("Error updating user:", err);
      alert("Error updating user.");
    }
  });

  // Auth check
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      console.warn("No user detected. Redirecting to login...");
      window.location.href = "login.html";
      return;
    }

    try {
      const userDocRef = doc(db, "users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (!userDocSnap.exists()) {
        console.error("User document not found.");
        window.location.href = "login.html";
        return;
      }

      const data = userDocSnap.data();
      console.log("Logged in as:", data);

      if (data.position !== "Admin") {
        alert("Unauthorized access!");
        window.location.href = "login.html";
        return;
      }

      sidebarName.textContent = data.name || data.firstName || "Admin";
      sidebarPosition.textContent = data.position || "Admin";
      navbarName.textContent = data.name || data.firstName || "Admin";

      // Load pending users
      console.log("Loading pending users...");
      const qPending = query(collection(db, "users"), where("status", "==", "pending"));
      onSnapshot(qPending, (snapshot) => {
        console.log("Pending snapshot size:", snapshot.size);
        allPendingUsers = [];
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          if (isBarangayPosition(u.position)) {
            allPendingUsers.push({ id: docSnap.id, data: u });
          }
        });
        console.log("Filtered pending:", allPendingUsers.length);
        document.getElementById('pendingCount').textContent = `(${allPendingUsers.length})`;
        renderTable(pendingTable, allPendingUsers, 'pending');
      });

      // Search pending
      searchPending.addEventListener('input', (e) => {
        const filtered = filterUsers(e.target.value.toLowerCase(), allPendingUsers);
        renderTable(pendingTable, filtered, 'pending');
      });

      // Load active users
      console.log("Loading active users...");
      const qActive = query(collection(db, "users"), where("status", "==", "active"));
      onSnapshot(qActive, (snapshot) => {
        console.log("Active snapshot size:", snapshot.size);
        allActiveUsers = [];
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          if (isBarangayPosition(u.position)) {
            allActiveUsers.push({ id: docSnap.id, data: u });
          }
        });
        console.log("Filtered active:", allActiveUsers.length);
        document.getElementById('activeCount').textContent = `(${allActiveUsers.length})`;
        renderTable(activeTable, allActiveUsers, 'active');
      });

      // Search active
      searchActive.addEventListener('input', (e) => {
        const filtered = filterUsers(e.target.value.toLowerCase(), allActiveUsers);
        renderTable(activeTable, filtered, 'active');
      });

      // Load inactive users
      console.log("Loading inactive users...");
      const qInactive = query(collection(db, "users"), where("status", "==", "inactive"));
      onSnapshot(qInactive, (snapshot) => {
        console.log("Inactive snapshot size:", snapshot.size);
        allInactiveUsers = [];
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          if (isBarangayPosition(u.position)) {
            allInactiveUsers.push({ id: docSnap.id, data: u });
          }
        });
        console.log("Filtered inactive:", allInactiveUsers.length);
        document.getElementById('inactiveCount').textContent = `(${allInactiveUsers.length})`;
        renderTable(inactiveTable, allInactiveUsers, 'inactive');
      });

      // Search inactive
      searchInactive.addEventListener('input', (e) => {
        const filtered = filterUsers(e.target.value.toLowerCase(), allInactiveUsers);
        renderTable(inactiveTable, filtered, 'inactive');
      });

    } catch (err) {
      console.error("Error loading admin or users:", err);
      window.location.href = "login.html";
    }
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try {
      await signOut(auth);
      console.log("Admin signed out.");
      window.location.href = "logout.html";
      setTimeout(() => (window.location.href = "login.html"), 1000);
    } catch (err) {
      console.error("Logout error:", err);
    }
  });

  // Dropdown toggle
  const profileToggle = document.getElementById("profileToggle");
  const dropdownMenu = document.getElementById("dropdownMenu");

  profileToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.style.display =
      dropdownMenu.style.display === "block" ? "none" : "block";
  });

  window.addEventListener("click", (e) => {
    if (!profileToggle.contains(e.target)) dropdownMenu.style.display = "none";
  });
</script>


</body>
</html>