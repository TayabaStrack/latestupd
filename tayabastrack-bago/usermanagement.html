<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow: auto; }
    
    .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; flex-shrink: 0; height: 100vh; position: fixed; left: 0; top: 0; }
    .sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; }
    .sidebar-header img { width: 40px; }
    .sidebar-header h2 { font-size: 1.2rem; margin: 0; }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin: 0.5rem 0; }
    .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1.5rem; text-decoration: none; color: #fff; transition: background 0.3s; }
    .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }
    .sidebar-footer { text-align: center; font-size: 0.85rem; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
    
    .dashboard-main { flex: 1; display: flex; flex-direction: column; min-width: 0; margin-left: 240px; height: 100vh; overflow: hidden; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 100; }
    .navbar h1 { font-size: 1.4rem; color: #004aad; white-space: nowrap; }

    .profile { display: flex; align-items: center; gap: 1rem; position: relative; cursor: pointer; flex-shrink: 0; }
    .profile .fa-bell { font-size: 1.2rem; cursor: pointer; position: relative; }
    .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; }
    .avatar { width: 35px; height: 35px; border-radius: 50%; flex-shrink: 0; }
    .username { font-weight: 500; white-space: nowrap; }
    .profile-dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 10000; }
    .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.9rem; }
    .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
    
    .user-section { padding: 1.5rem; flex: 1; overflow-y: auto; overflow-x: hidden; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px; }
    .header h2 { color: #004aad; }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .actions button { background: #004aad; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
    .actions button:hover { background: #005ce6; }
    .actions input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; }

    .scroll-hint { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,74,173,0.2); }
    .scroll-hint i { animation: slideHint 2s ease-in-out infinite; }
    @keyframes slideHint { 0%, 100% { transform: translateX(-4px); } 50% { transform: translateX(4px); } }

      /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; z-index: 5000; padding: 1rem; }
    .modal-content { background: #fff; padding: 1.2rem; border-radius: 12px; border: 3px solid #004aad; width: 380px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
    .modal-content h2 { margin-bottom: 0.8rem; color: #004aad; text-align: center; font-size: 1.2rem; }
    .form-group { display: flex; flex-direction: column; margin-bottom: 0.7rem; }
    .form-group input, .form-group select { padding: 0.5rem; border: none; background: #f1f1f1; border-radius: 6px; font-size: 0.9rem; }
    .password-wrap { position: relative; }
    .password-wrap i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #555; cursor: pointer; font-size: 0.9rem; }
    .modal-actions { margin-top: 0.6rem; display: flex; justify-content: flex-end; gap: 0.5rem; }
    .modal-actions button { border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    .cancel-btn { background: #ccc; color: #333; }
    .save-btn { background: #004aad; color: #fff; }

.table-wrapper { 
  margin-top: 1rem; 
}

.table-card { 
  overflow-x: auto; 
  overflow-y: hidden; 
  border-radius: 10px; 
  background: #fff; 
  padding: 8px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
  scroll-behavior: smooth; 
  position: relative; 
  margin-bottom: 1.5rem; 
}

.table-card::-webkit-scrollbar { 
  height: 10px; 
}

.table-card::-webkit-scrollbar-thumb { 
  background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); 
  border-radius: 5px; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  table-layout: auto; /* ‚úÖ now respects min-width settings */
  min-width: 1200px; /* ‚¨Ü gives more space for long content */
}

thead { 
  background: #f5f8fb; 
  color: #333; 
}

thead th { 
  font-weight: 700; 
  padding: 0.7rem 0.75rem; 
  text-align: left; 
  border-bottom: 2px solid #e0e0e0; 
}

th, td { 
  text-align: left; 
  padding: 0.6rem 0.8rem; 
  font-size: 0.85rem; 
  border-bottom: 1px solid #f0f2f5; 
  overflow: visible; /* ‚úÖ allow full text */
  white-space: nowrap; /* keeps long emails in one line */
}

tbody tr:nth-child(even) { 
  background: #fbfdff; 
}

tbody tr:hover { 
  background: #f1f8ff; 
}

/* üìè Column width distribution */
th:nth-child(1), td:nth-child(1) { 
  min-width: 300px; /* ‚¨Ü Name wider */
}

th:nth-child(2), td:nth-child(2) { 
  min-width: 320px; /* ‚¨Ü Email wider */
}

th:nth-child(3), td:nth-child(3) { 
  min-width: 180px; /* Address */
}

th:nth-child(4), td:nth-child(4) { 
  min-width: 140px; /* Position */
}

th:nth-child(5), td:nth-child(5) { 
  min-width: 100px; /* Status */
}

th:nth-child(6), td:nth-child(6) { 
  min-width: 220px; /* ‚¨Ü Actions wider for buttons */
}

td button { 
  padding: 0.3rem 0.6rem; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 0.8rem; 
  margin-right: 4px; 
}

td button:first-child { 
  background: #004aad; 
  color: #fff; 
}

td button:last-child { 
  background: #d9534f; 
  color: #fff; 
}

/* Header and actions */
.user-section .header, .user-section h3 {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.user-section h3 {
  margin: 1rem 0 0.5rem 0;
}

.actions {
  display: flex;
  gap: 10px;
}

.actions input {
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.actions button {
  background: #004aad;
  color: #fff;
  padding: 6px 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.scroll-hint {
  font-size: 0.85rem;
  color: #666;
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 0.5rem;
}

  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logu.png" alt="Logo" class="logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a></li>
        <li class="active"><a href="usermanagement.html"><i class="fa fa-tasks"></i> User Management</a></li>
        <li><a href="reports.html"><i class="fa fa-map-marker-alt"></i> Manage Reports</a></li>
        <li><a href="bdatemanagement.html"><i class="fa fa-coins"></i> Budget & Date Management</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <p>Logged in as:</p>
      <strong id="footerName">Loading...</strong><br>
      <span id="footerPosition">---</span>
    </div>
  </aside>

  <!-- Main -->
  <div class="dashboard-main">
    <nav class="navbar">
      <h1>User Management</h1>
      <div class="profile" id="profileToggle">
        <div style="position: relative;">
          <i class="fa fa-bell"></i>
          <span class="badge" id="notifBadge">0</span>
        </div>
        <div class="profile-dropdown">
          <img src="mark.jpg" alt="Profile" class="avatar">
          <span class="username" id="navUsername">---</span>
          <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#666;"></i>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
            <a href="#" id="logoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="user-section">
      <div class="header">
        <h2>Admins</h2>
        <div class="actions">
          <button onclick="openAddModal()">Add User</button>
          <input type="text" id="searchInput" placeholder="Search user" oninput="searchUser()"/>
        </div>
      </div>

      <div class="scroll-hint">
        <i class="fas fa-arrows-alt-h"></i>
        <span>Scroll horizontally to view all columns</span>
      </div>

      <!-- PENDING ADMINS -->
      <h3>Pending Admins</h3>
      <div class="table-wrapper">
        <div class="table-card"><table><thead><tr>
          <th>Name</th><th>Email</th><th>Address</th><th>Position</th><th>Status</th><th>Actions</th>
        </tr></thead><tbody id="pendingAdmins"></tbody></table></div>
      </div>

      <!-- ACTIVE ADMINS -->
      <h3>Active Admins</h3>
      <div class="table-wrapper">
        <div class="table-card"><table><thead><tr>
          <th>Name</th><th>Email</th><th>Address</th><th>Position</th><th>Status</th><th>Actions</th>
        </tr></thead><tbody id="activeAdmins"></tbody></table></div>
      </div>

      <!-- INACTIVE ADMINS -->
      <h3>Inactive Admins</h3>
      <div class="table-wrapper">
        <div class="table-card"><table><thead><tr>
          <th>Name</th><th>Email</th><th>Address</th><th>Position</th><th>Status</th><th>Actions</th>
        </tr></thead><tbody id="inactiveAdmins"></tbody></table></div>
      </div>
    </div>
  </div>

   <!-- Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h2>Add User</h2>
      <form id="addUserForm">
        <div class="form-group"><input type="text" id="name" placeholder="Full Name" required></div>
        <div class="form-group"><input type="email" id="email" placeholder="Email" required></div>
      <div class="form-group">
        <select id="address" required>
          <option value="">Select Barangay</option>
          <option value="Alitao">Alitao</option>
          <option value="Alsam Ibaba">Alsam Ibaba</option>
          <option value="Alsam Ilaya">Alsam Ilaya</option>
          <option value="Alupay">Alupay</option>
          <option value="Angeles Zone I (Poblacion)">Angeles Zone I (Poblacion)</option>
          <option value="Angeles Zone II">Angeles Zone II</option>
          <option value="Angeles Zone III">Angeles Zone III</option>
          <option value="Angeles Zone IV">Angeles Zone IV</option>
          <option value="Angustias Zone I (Poblacion)">Angustias Zone I (Poblacion)</option>
          <option value="Angustias Zone II">Angustias Zone II</option>
          <option value="Angustias Zone III">Angustias Zone III</option>
          <option value="Angustias Zone IV">Angustias Zone IV</option>
          <option value="Anos">Anos</option>
          <option value="Ayaas">Ayaas</option>
          <option value="Baguio">Baguio</option>
          <option value="Banilad">Banilad</option>
          <option value="Ibabang Bukal">Ibabang Bukal</option>
          <option value="Ilayang Bukal">Ilayang Bukal</option>
          <option value="Calantas">Calantas</option>
          <option value="Calumpang">Calumpang</option>
          <option value="Camaysa">Camaysa</option>
          <option value="Dapdap">Dapdap</option>
          <option value="Kanlurang Domoit">Kanlurang Domoit</option>
          <option value="Silangang Domoit">Silangang Domoit</option>
          <option value="Gibanga">Gibanga</option>
          <option value="Ibas">Ibas</option>
          <option value="Ilasan Ibaba">Ilasan Ibaba</option>
          <option value="Ilasan Ilaya">Ilasan Ilaya</option>
          <option value="Ipilan">Ipilan</option>
          <option value="Isabang">Isabang</option>
          <option value="Katigan Kanluran">Katigan Kanluran</option>
          <option value="Katigan Silangan">Katigan Silangan</option>
          <option value="Lakawan">Lakawan</option>
          <option value="Lalo">Lalo</option>
          <option value="Lawigue">Lawigue</option>
          <option value="Lita">Lita</option>
          <option value="Malaoa">Malaoa</option>
          <option value="Masin">Masin</option>
          <option value="Mate">Mate</option>
          <option value="Mateuna">Mateuna</option>
          <option value="Mayowe">Mayowe</option>
          <option value="Ibabang Nangka">Ibabang Nangka</option>
          <option value="Ilayang Nangka">Ilayang Nangka</option>
          <option value="Opias">Opias</option>
          <option value="Ibabang Palale">Ibabang Palale</option>
          <option value="Ilayang Palale">Ilayang Palale</option>
          <option value="Kanlurang Palale">Kanlurang Palale</option>
          <option value="Silangang Palale">Silangang Palale</option>
          <option value="Pandakaki">Pandakaki</option>
          <option value="Pook">Pook</option>
          <option value="Potol">Potol</option>
          <option value="San Diego Zone I (Poblacion)">San Diego Zone I (Poblacion)</option>
          <option value="San Diego Zone II (Poblacion)">San Diego Zone II (Poblacion)</option>
          <option value="San Diego Zone III">San Diego Zone III</option>
          <option value="San Diego Zone IV">San Diego Zone IV</option>
          <option value="San Isidro Zone I (Poblacion)">San Isidro Zone I (Poblacion)</option>
          <option value="San Isidro Zone II">San Isidro Zone II</option>
          <option value="San Isidro Zone III">San Isidro Zone III</option>
          <option value="San Isidro Zone IV">San Isidro Zone IV</option>
          <option value="San Roque Zone I (Poblacion)">San Roque Zone I (Poblacion)</option>
          <option value="San Roque Zone II">San Roque Zone II</option>
          <option value="Talolong">Talolong</option>
          <option value="Tamlong">Tamlong</option>
          <option value="Tongko">Tongko</option>
          <option value="Valencia">Valencia</option>
          <option value="Wakas">Wakas</option>
        </select>
      </div>
        <div class="form-group"><select id="position" required><option value="">Select Position</option><option>Super Admin</option><option>Admin</option><option>Barangay Official</option></select></div>
        <div class="form-group password-wrap">
          <input type="password" id="password" placeholder="Password" required>
          <i class="fa fa-eye" onclick="togglePassword()"></i>
        </div>
        <div class="modal-actions">
          <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.appspot.com",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Modal control
  window.openAddModal = () => document.getElementById("userModal").style.display = "flex";
  window.closeModal = () => document.getElementById("userModal").style.display = "none";
  window.togglePassword = () => {
    const p = document.getElementById("password");
    p.type = p.type === "password" ? "text" : "password";
  };

  // Add User
  document.getElementById("addUserForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const address = document.getElementById("address").value.trim();
    const position = document.getElementById("position").value;
    const password = document.getElementById("password").value;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), {
        name, email, address, position,
        status: "Pending",
        role: "Admin",
        createdAt: serverTimestamp()
      });
      closeModal();
      document.getElementById("addUserForm").reset();
    } catch (err) {
      alert("Error: " + err.message);
    }
  });

  const pendingTable = document.getElementById("pendingAdmins");
  const activeTable = document.getElementById("activeAdmins");
  const inactiveTable = document.getElementById("inactiveAdmins");

  const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    pendingTable.innerHTML = "";
    activeTable.innerHTML = "";
    inactiveTable.innerHTML = "";
    snap.forEach(docSnap => {
      const u = docSnap.data();
      if (u.position !== "Admin") return;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.name || ""}</td>
        <td>${u.email || ""}</td>
        <td>${u.address || ""}</td>
        <td>${u.position || ""}</td>
        <td>${u.status || ""}</td>
        <td>
          ${
            u.status === "Pending" ? `<button onclick="approveUser('${docSnap.id}')">Approve</button>` :
            u.status === "Active" ? `<button onclick="deactivateUser('${docSnap.id}')">Deactivate</button>` :
            u.status === "Inactive" ? `<button onclick="activateUser('${docSnap.id}')">Activate</button>` : ''
          }
          <button onclick="deleteUser('${docSnap.id}')">Delete</button>
        </td>
      `;
      if (u.status === "Pending") pendingTable.appendChild(tr);
      else if (u.status === "Active") activeTable.appendChild(tr);
      else if (u.status === "Inactive") inactiveTable.appendChild(tr);
    });
  });

  window.approveUser = async (id) => {
    if (confirm("Approve this admin?")) {
      await updateDoc(doc(db, "users", id), { status: "Active" });
    }
  };
  window.deactivateUser = async (id) => {
    if (confirm("Deactivate this admin?")) {
      await updateDoc(doc(db, "users", id), { status: "Inactive" });
    }
  };

  window.activateUser = async (id) => {
    if (confirm("Activate this admin?")) {
      await updateDoc(doc(db, "users", id), { status: "Active" });
    }
  };

  window.deleteUser = async (id) => {
    if (confirm("Are you sure you want to delete this user?")) {
      await deleteDoc(doc(db, "users", id));
    }
  };

  // üîç Search Function
  window.searchUser = () => {
    const input = document.getElementById("searchInput").value.toLowerCase();
    [pendingTable, activeTable, inactiveTable].forEach(table => {
      [...table.querySelectorAll("tr")].forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const email = row.cells[1].textContent.toLowerCase();
        row.style.display = name.includes(input) || email.includes(input) ? "" : "none";
      });
    });
  };

  // üë§ Profile Dropdown Toggle
  const profileToggle = document.getElementById("profileToggle");
  const dropdownMenu = document.getElementById("dropdownMenu");

  profileToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });

  window.addEventListener("click", () => dropdownMenu.style.display = "none");

  // üö™ Logout
  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    await signOut(auth);
    window.location.href = "index.html";
  });

  // üßë Auth State
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        document.getElementById("navUsername").textContent = data.name || "Unknown";
        document.getElementById("footerName").textContent = data.name || "Unknown";
        document.getElementById("footerPosition").textContent = data.position || "---";

        if (data.position !== "Super Admin") {
          alert("Access denied. Only Super Admins can manage users.");
          window.location.href = "dashboard.html";
        }
      }
    } else {
      window.location.href = "index.html";
    }
  });
</script>
</body>
</html>