<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TayabaStrack - Public Dashboard</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      min-height: 100vh;
    }

    /* Header */
    header {
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 25px;
      box-shadow: 0 2px 8px rgba(0,74,173,0.08);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-container {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .logo-container img {
      width: 150%;
      height: 150%;
      object-fit: cover;
    }

    .logo-placeholder {
      color: white;
      font-weight: bold;
      font-size: 1.3rem;
    }

    header h1 {
      color: #004aad;
      font-size: 1.4rem;
      font-weight: 700;
    }

    .login-btn {
      background: #004aad;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
      font-weight: 600;
    }

    .login-btn:hover {
      background: #003a8c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,74,173,0.3);
    }

    .container {
      margin: 20px auto;
      padding: 20px;
      max-width: 1400px;
    }

    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1a1a1a;
      padding-bottom: 1rem;
      position: relative;
      display: inline-block;
    }

    .page-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, #004aad 0%, #0066ff 100%);
      border-radius: 2px;
    }

    /* Stats Grid - 3 columns now */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #004aad 0%, #0066ff 100%);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,74,173,0.15);
      background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
    }

    .stat-number {
      font-size: 3rem;
      font-weight: 800;
      color: #004aad;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0,74,173,0.1);
    }

    .stat-label {
      font-size: 0.95rem;
      color: #666;
      font-weight: 500;
    }

    /* Main Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    /* Filter Section */
    .filters-section {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-left: 4px solid #004aad;
    }

    .filter-header {
      color: #004aad;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
    }

    .filter-header::before {
      content: 'üîç';
      font-size: 1.2rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 1.25rem;
    }

    .filter-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .filters-section input,
    .filters-section select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s;
      width: 100%;
    }

    .filters-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
    }

    @media (max-width: 992px) {
      .filters-row {
        grid-template-columns: repeat(2, 1fr);
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .filters-row {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .filters-section input:focus,
    .filters-section select:focus {
      outline: none;
      border-color: #004aad;
      box-shadow: 0 0 0 3px rgba(0,74,173,0.1);
    }

    /* Map Section */
    .map-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
      border-left: 4px solid #004aad;
    }

    .map-section-title {
      font-size: 1.1rem;
      color: #004aad;
      font-weight: 700;
      cursor: default;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
      transition: background 0.3s;
      user-select: none;
    }

    .map-section-title::before {
      content: 'üìç';
      font-size: 1.2rem;
      margin-right: 0.5rem;
    }

    .map-container {
      background: #f8f9fa;
      overflow: hidden;
      min-height: 450px;
      position: relative;
      transition: all 0.3s ease;
    }

    .map-wrapper {
      width: 100%;
      height: 100%;
      min-height: 450px;
    }

    #projectMap {
      width: 100%;
      height: 100%;
      min-height: 450px;
    }

    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 15px;
      border-radius: 8px;
      z-index: 400;
      box-shadow: 0 2px 8px rgba(0,74,173,0.2);
      border: 2px solid #004aad;
    }

    .legend-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: #004aad;
      margin-bottom: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 4px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      flex-shrink: 0;
    }

    .legend-marker.completed {
      background: #28a745;
    }

    .legend-marker.ongoing {
      background: #ffc107;
    }

    .legend-marker.reported {
      background: #17a2b8;
    }

    /* Carousel Section */
    .carousel-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .carousel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #f0f0f0;
    }

    .carousel-title {
      font-size: 1.3rem;
      color: #004aad;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .carousel-title::before {
      content: 'üìã';
      font-size: 1.3rem;
    }

    .carousel-title.ongoing::before {
      content: 'üöß';
    }

    .carousel-title.completed::before {
      content: '‚úÖ';
    }

    .carousel-controls {
      display: flex;
      gap: 10px;
    }

    .carousel-btn {
      background: #004aad;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      font-weight: bold;
    }

    .carousel-btn:hover:not(:disabled) {
      background: #003a8c;
      transform: scale(1.1);
    }

    .carousel-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: scale(1);
    }

    .carousel-wrapper {
      position: relative;
      overflow: hidden;
    }

    .carousel-container {
      display: flex;
      gap: 20px;
      transition: transform 0.5s ease;
    }

    /* Older Posts Section */
    .older-posts-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
      padding: 1.5rem;
    }

    .older-posts-title {
      font-size: 1.3rem;
      color: #004aad;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .older-posts-title::before {
      content: 'üìÅ';
      font-size: 1.3rem;
    }

    .posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    /* Project Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      border: 2px solid transparent;
      flex: 0 0 300px;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 24px rgba(0,74,173,0.15);
      border-color: #004aad;
    }

    .card-image-wrapper {
      position: relative;
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: linear-gradient(135deg, #e8f4ff 0%, #d4e9ff 100%);
    }

    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .card:hover img {
      transform: scale(1.1);
    }

    .new-label {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(40,167,69,0.4);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .card-content {
      padding: 1.25rem;
    }

    .card h3 {
      color: #004aad;
      font-size: 1.05rem;
      margin-bottom: 0.75rem;
      word-break: break-word;
      line-height: 1.4;
      font-weight: 700;
    }

    .card-info {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 6px;
    }

    .card-info strong {
      color: #333;
      display: block;
      margin-bottom: 3px;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-ongoing {
      background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
      color: #333;
    }

    .status-resolved {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .status-reported {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }

    .status-completed {
      background: linear-gradient(135deg, #1cc88a 0%, #17a673 100%);
      color: white;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #004aad 0%, #0066ff 100%);
      border-radius: 10px;
      transition: width 0.3s;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.1rem;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 1rem;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #f5c6cb;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 74, 173, 0.15);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 40px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,74,173,0.3);
      animation: slideUp 0.3s;
      margin: 0 auto;
      border-top: 4px solid #004aad;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .close-btn {
      float: right;
      font-size: 28px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      transition: color 0.2s;
      line-height: 1;
    }

    .close-btn:hover {
      color: #004aad;
    }

    .modal-images {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0 30px 0;
      clear: both;
    }

    .modal-image-container {
      position: relative;
    }

    .modal-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      border: 3px solid #e9ecef;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-image:hover {
      transform: scale(1.02);
      border-color: #004aad;
    }

    .image-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 74, 173, 0.9);
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .modal-header-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 2px solid #e9ecef;
    }

    .project-title {
      font-size: 1.5rem;
      color: #004aad;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .project-dates {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .date-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .date-label {
      font-weight: 600;
      color: #666;
      min-width: 120px;
    }

    .date-value {
      color: #333;
    }

    .modal-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid #e9ecef;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .info-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #004aad;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1rem;
      color: #333;
      font-weight: 500;
    }

    .modal-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #004aad;
    }

    .section-content {
      color: #666;
      line-height: 1.7;
      font-size: 0.95rem;
    }

    .progress-section {
      margin-bottom: 25px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-percentage {
      font-size: 1.2rem;
      font-weight: 700;
      color: #004aad;
    }

    .progress-bar-large {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #004aad 0%, #0066ff 100%);
      border-radius: 10px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .coordinates-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #004aad;
    }

    .coordinate-item {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .image-preview-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .image-preview-modal.active {
      display: flex;
    }

    .image-preview-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    }

    .image-preview-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .image-preview-close:hover {
      color: #ccc;
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 968px) {
      .modal-images {
        grid-template-columns: 1fr;
      }

      .modal-header-section {
        grid-template-columns: 1fr;
      }

      .modal-info-grid {
        grid-template-columns: 1fr;
      }

      .coordinates-grid {
        grid-template-columns: 1fr;
      }

      .map-legend {
        bottom: 10px;
        right: 10px;
        padding: 8px 10px;
      }
    }

    @media (max-width: 768px) {
      .modal-content {
        padding: 20px;
        margin: 20px;
      }

      .card {
        flex: 0 0 250px;
      }

      .container {
        padding: 15px;
      }

      .posts-grid {
        grid-template-columns: 1fr;
      }

      .carousel-controls {
        display: none;
      }

      .carousel-container {
        overflow-x: auto;
        scroll-behavior: smooth;
        padding-bottom: 10px;
      }

      .carousel-container::-webkit-scrollbar {
        height: 8px;
      }

      .carousel-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .carousel-container::-webkit-scrollbar-thumb {
        background: #004aad;
        border-radius: 4px;
      }

      .map-container {
        min-height: 250px;
      }

      .map-wrapper {
        min-height: 250px;
      }

      #projectMap {
        min-height: 250px;
      }

      .map-section-title {
        font-size: 1rem;
        padding: 10px;
      }

      .map-section-title::after {
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-left">
      <div class="logo-container">
        <img src="logo.png" alt="Logo" onerror="this.parentElement.innerHTML='<div class=\'logo-placeholder\'>TS</div>'">
      </div>
      <h1>TayabaStrack</h1>
    </div>
    <a href="login.html" class="login-btn">Login</a>
  </header>

  <div class="container">
    <div class="page-header">
      <h2 class="page-title">Mga Imprastraktura ng Tayabas</h2>
    </div>
    
    <!-- Statistics Cards - 3 columns -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="statTotal">0</div>
        <div class="stat-label">Kabuuang Imprastraktura</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statOngoing">0</div>
        <div class="stat-label">Kasalukuyang Ginagawa</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statCompleted">0</div>
        <div class="stat-label">Natapos na</div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      <!-- Left Side: Filters -->
      <div class="filters-section">
        <h3 class="filter-header">Maghanap ng Imprastraktura</h3>
        
        <div class="filters-row">
          <div class="filter-group">
            <label class="filter-label">Salain ayon sa Barangay</label>
            <select id="barangayFilter">
              <option value="">Lahat ng Barangay</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">Salain ayon sa Katayuan</label>
            <select id="statusFilter">
              <option value="">Lahat ng Katayuan</option>
              <option value="ongoing">Kasalukuyang Ginagawa</option>
              <option value="completed">Natapos na</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">Salain ayon sa Taon ng Simula</label>
            <select id="yearFilter">
              <option value="">Lahat ng Taon</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Right Side: Map -->
      <div class="map-section">
        <div class="map-section-title">Mapa ng mga Imprastraktura</div>
<div class="map-container">
<div class="map-wrapper">
<div id="projectMap"></div>
</div>
<div class="map-legend">
<div class="legend-title">Alamat:</div>
<div class="legend-item">
<div class="legend-marker completed"></div>
<span>Natapos na</span>
</div>
<div class="legend-item">
<div class="legend-marker ongoing"></div>
<span>Kasalukuyang Ginagawa</span>
</div>
</div>
</div>
</div>
</div>
<div id="errorMessage" class="error" style="display:none;"></div>

<!-- Ongoing Projects Carousel -->
<div class="carousel-section" id="ongoingSection" style="display:none;">
  <div class="carousel-header">
    <div class="carousel-title ongoing">Mga Kasalukuyang Ginagawa</div>
    <div class="carousel-controls">
      <button class="carousel-btn" id="ongoPrev">‚Äπ</button>
      <button class="carousel-btn" id="ongoNext">‚Ä∫</button>
    </div>
  </div>
  <div id="loadingOngoing" class="loading">Naglo-load ng kasalukuyang proyekto...</div>
  <div id="noOngoing" class="no-data" style="display:none;">Walang kasalukuyang proyekto.</div>
  <div class="carousel-wrapper">
    <div class="carousel-container" id="ongoContainer">
      <!-- Ongoing project cards -->
    </div>
  </div>
</div>

<!-- Completed Projects Carousel -->
<div class="carousel-section" id="completedSection" style="display:none;">
  <div class="carousel-header">
    <div class="carousel-title completed">Mga Natapos na Imprastraktura</div>
    <div class="carousel-controls">
      <button class="carousel-btn" id="completedPrev">‚Äπ</button>
      <button class="carousel-btn" id="completedNext">‚Ä∫</button>
    </div>
  </div>
  <div id="loadingCompleted" class="loading">Naglo-load ng natapos na proyekto...</div>
  <div id="noCompleted" class="no-data" style="display:none;">Walang natapos na proyekto.</div>
  <div class="carousel-wrapper">
    <div class="carousel-container" id="completedContainer">
      <!-- Completed project cards -->
    </div>
  </div>
</div>

<!-- Older Posts Grid -->
<div class="older-posts-section" id="olderPostsSection" style="display:none;">
  <div class="older-posts-title">Mga Nakaraang Proyekto</div>
  <div id="loadingOlder" class="loading">Naglo-load ng nakaraang proyekto...</div>
  <div id="noDataOlder" class="no-data" style="display:none;">Walang makitang nakaraang proyekto.</div>
  <div id="noSearchMessage" class="no-data" style="display:none;">Walang proyektong tumutugma sa inyong paghahanap.</div>
  <div class="posts-grid" id="olderPostsContainer">
    <!-- Older posts appear here -->
  </div>
</div>
  </div>
  <!-- Main Modal -->
  <div id="bulletinModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
  <!-- Before/After Images -->
  <div class="modal-images" id="modalImagesContainer">
    <div class="modal-image-container">
      <img id="modalBeforeImage" class="modal-image" src="" alt="Before" onclick="previewImage(this.src)">
      <div class="image-label">BEFORE</div>
    </div>
    <div class="modal-image-container" id="modalAfterContainer">
      <img id="modalAfterImage" class="modal-image" src="" alt="After" onclick="previewImage(this.src)">
      <div class="image-label">AFTER</div>
    </div>
  </div>

  <!-- Project Name and Dates -->
  <div class="modal-header-section">
    <div>
      <div class="project-title" id="modalProjectName">Pangalan ng Proyekto</div>
      <div class="info-item" style="margin-top: 10px;">
        <span class="info-label">ID ng Proyekto</span>
        <span class="info-value" id="modalProjectId">N/A</span>
      </div>
    </div>
    <div class="project-dates">
      <div class="date-item">
        <span class="date-label">Petsa ng Pag-uulat:</span>
        <span class="date-value" id="modalReportDate">N/A</span>
      </div>
      <div class="date-item">
        <span class="date-label">Petsa ng Simula:</span>
        <span class="date-value" id="modalStartDate">TBD</span>
      </div>
      <div class="date-item">
        <span class="date-label">Petsa ng Pagtatapos:</span>
        <span class="date-value" id="modalEndDate">TBD</span>
      </div>
      <div class="date-item" id="modalCompletionDateContainer">
        <span class="date-label">Petsa ng Pagkakumpleto:</span>
        <span class="date-value" id="modalCompletionDate">N/A</span>
      </div>
      <div class="date-item">
        <span class="date-label">Katayuan:</span>
        <span class="date-value">
          <span class="status-badge" id="modalStatusBadge">N/A</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Barangay, Contractor, Supplier -->
  <div class="modal-info-grid">
    <div class="info-item">
      <span class="info-label">Barangay</span>
      <span class="info-value" id="modalBarangay">N/A</span>
    </div>
    <div class="info-item">
      <span class="info-label">Kontratista</span>
      <span class="info-value" id="modalContractor">N/A</span>
    </div>
    <div class="info-item">
      <span class="info-label">Supplier</span>
      <span class="info-value" id="modalSupplier">N/A</span>
    </div>
    <div class="info-item">
      <span class="info-label">Uri ng Proyekto</span>
      <span class="info-value" id="modalProjectType">N/A</span>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-section">
    <div class="progress-header">
      <div class="section-title">Pag-unlad ng Proyekto</div>
      <div class="progress-percentage" id="modalProgress">0%</div>
    </div>
    <div class="progress-bar-large">
      <div class="progress-fill" id="modalProgressBar" style="width: 0%"></div>
    </div>
  </div>

  <!-- Description -->
  <div class="modal-section">
    <div class="section-title">Paglalarawan ng Proyekto</div>
    <p class="section-content" id="modalDescription">Walang paglalarawan</p>
  </div>

  <!-- Progress Report -->
  <div class="modal-section">
    <div class="section-title">Ulat ng Pag-unlad</div>
    <p class="section-content" id="modalProgressReport">Walang ulat ng pag-unlad</p>
  </div>

  <!-- Coordinates -->
  <div class="modal-section">
    <div class="section-title">Lokasyon (Coordinates)</div>
    <div class="coordinates-grid">
      <div class="coordinate-item">
        <strong>Latitude:</strong> <span id="modalLatitude">N/A</span>
      </div>
      <div class="coordinate-item">
        <strong>Longitude:</strong> <span id="modalLongitude">N/A</span>
      </div>
    </div>
  </div>
</div>
  </div>
  <!-- Image Preview Modal -->
  <div id="imagePreviewModal" class="image-preview-modal">
    <span class="image-preview-close">&times;</span>
    <img id="imagePreviewContent" class="image-preview-content" src="" alt="Preview">
  </div>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
  authDomain: "tayabastrack-23b95.firebaseapp.com",
  projectId: "tayabastrack-23b95",
  storageBucket: "tayabastrack-23b95.appspot.com",
  messagingSenderId: "674055915366",
  appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Global Map Variables
let map = null;
let markers = [];

// Initialize Leaflet Map
function initMap() {
  map = L.map("projectMap").setView([14.0266, 121.5931], 14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors",
    maxZoom: 18
  }).addTo(map);
  setTimeout(() => map.invalidateSize(), 250);
}

// Update Map Markers
function updateMapMarkers(bulletins) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  const withCoords = bulletins.filter(b => b.latitude && b.longitude);

  withCoords.forEach(p => {
    const lat = parseFloat(p.latitude);
    const lng = parseFloat(p.longitude);
    if (isNaN(lat) || isNaN(lng)) return;

    const s = (p.status || "").toLowerCase();
    let color = "#17a2b8";
    if (s.includes("completed") || s.includes("resolved") || s.includes("repaired") || s.includes("natapos")) color = "#28a745";
    else if (s.includes("ongoing") || s.includes("ginagawa") || s.includes("in progress")) color = "#ffc107";

    const marker = L.marker([lat, lng], {
      icon: L.divIcon({
        className: "custom-marker",
        html: `<div style="background:${color};width:26px;height:26px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>`,
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      })
    }).addTo(map);

    marker.bindPopup(`
      <div style="font-family:Arial;min-width:200px">
        <strong style="color:${color}">${p.projectName || p.issue || "Unnamed Project"}</strong><br>
        <small><b>Barangay:</b> ${p.barangay || "N/A"}</small><br>
        <small><b>Status:</b> ${p.status || "N/A"}</small><br>
        <small><b>Progress:</b> ${p.progress || 0}%</small>
        <div style="width:100%;height:8px;background:#e9ecef;border-radius:4px;margin-top:4px;">
          <div style="width:${p.progress || 0}%;height:100%;background:${color};"></div>
        </div>
      </div>
    `);
    marker.on("click", () => openModal(p));
    markers.push(marker);
  });

  if (markers.length) {
    const g = L.featureGroup(markers);
    map.fitBounds(g.getBounds().pad(0.1));
  }
}

// --- UI & DOM References ---
const olderPostsContainer = document.getElementById("olderPostsContainer");
const loadingOlder = document.getElementById("loadingOlder");
const errorMessage = document.getElementById("errorMessage");
const noDataOlder = document.getElementById("noDataOlder");
const noSearchMessage = document.getElementById("noSearchMessage");
const barangayFilter = document.getElementById("barangayFilter");
const statusFilter = document.getElementById("statusFilter");
const yearFilter = document.getElementById("yearFilter");
const modal = document.getElementById("bulletinModal");
const closeBtn = document.querySelector(".close-btn");
const imagePreviewModal = document.getElementById("imagePreviewModal");
const imagePreviewContent = document.getElementById("imagePreviewContent");
const imagePreviewClose = document.querySelector(".image-preview-close");
const olderPostsSection = document.getElementById("olderPostsSection");
const ongoingSection = document.getElementById("ongoingSection");
const loadingOngoing = document.getElementById("loadingOngoing");
const ongoContainer = document.getElementById("ongoContainer");
const ongoPrev = document.getElementById("ongoPrev");
const ongoNext = document.getElementById("ongoNext");
const completedSection = document.getElementById("completedSection");
const loadingCompleted = document.getElementById("loadingCompleted");
const completedContainer = document.getElementById("completedContainer");
const completedPrev = document.getElementById("completedPrev");
const completedNext = document.getElementById("completedNext");

let allBulletins = [];
let ongoingCarouselIndex = 0;
let completedCarouselIndex = 0;
const cardsPerView = 3;

// Barangay list
const barangays = [
  "Alitao","Alsam Ibaba","Alsam Ilaya","Alupay","Angeles Zone I","Angeles Zone II","Angeles Zone III",
  "Angeles Zone IV","Angustias Zone I","Angustias Zone II","Angustias Zone III","Angustias Zone IV",
  "Anos","Ayaas","Baguio","Banilad","Bukal Ibaba","Bukal Ilaya","Callejon","Camaysa","Dapdap",
  "Domoit Kanluran","Domoit Silangan","Gibanga","Guinhalinan","Ibas","Ilasan Ibaba","Ilasan Ilaya",
  "Ipilan","Isabang","Katigan Kanluran","Katigan Silangan","Lakawan","Lita","Mabato","Mabunga",
  "Masikap","Mateuna","Mayowe","Nangka Ibaba","Nangka Ilaya","Opias","Palale Ibaba","Palale Ilaya",
  "Palale Kanluran","Palale Silangan","Pandakaki","Pook","Potrero","San Diego Zone I","San Diego Zone II",
  "San Diego Zone III","San Diego Zone IV","San Isidro Zone I","San Isidro Zone II","San Isidro Zone III",
  "San Isidro Zone IV","San Roque Zone I","San Roque Zone II","Wakas","Laguio","Sabang"
];
barangays.forEach(b => {
  const o = document.createElement("option");
  o.value = b;
  o.textContent = b;
  barangayFilter.appendChild(o);
});

// Populate Year Filter
(() => {
  const y = new Date().getFullYear();
  for (let i = y; i >= 2020; i--) {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = i;
    yearFilter.appendChild(o);
  }
})();

// --- Helper Functions ---
function formatDate(d) {
  try {
    if (!d) return "N/A";
    if (d.toDate) d = d.toDate();
    return new Date(d).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
  } catch { return "N/A"; }
}
function getStatusClass(s) {
  s = (s || "").toLowerCase();
  if (s.includes("ongoing") || s.includes("ginagawa")) return "status-ongoing";
  if (s.includes("resolved") || s.includes("completed") || s.includes("repaired") || s.includes("natapos")) return "status-completed";
  return "status-reported";
}

// Filter out pending and declined statuses
function isValidStatus(status) {
  const s = (status || "").toLowerCase();
  return !s.includes("pending") && !s.includes("declined");
}

function updateStatistics(b) {
  const t = b.length;
  const o = b.filter(x => {
    const s = (x.status || "").toLowerCase();
    return s.includes("ongoing") || s.includes("ginagawa");
  }).length;
  const c = b.filter(x => {
    const s = (x.status || "").toLowerCase();
    return s.match(/completed|resolved|repaired|fixed|natapos/);
  }).length;
  document.getElementById("statTotal").textContent = t;
  document.getElementById("statOngoing").textContent = o;
  document.getElementById("statCompleted").textContent = c;
}

// --- Modal Functions ---
async function openModal(d) {
  document.getElementById("modalProjectName").textContent = d.projectName || d.issue || "Unnamed Project";
  document.getElementById("modalProjectId").textContent = d.projectId || d.id || "N/A";
  document.getElementById("modalReportDate").textContent = formatDate(d.createdAt || d.date);
  document.getElementById("modalStartDate").textContent = formatDate(d.startDate);
  document.getElementById("modalEndDate").textContent = formatDate(d.endDate);
  
  // Check if project is ongoing - hide after image and completion date
  const status = (d.status || "").toLowerCase();
  const isOngoing = status.includes("ongoing") || status.includes("ginagawa");
  
  const afterContainer = document.getElementById("modalAfterContainer");
  const completionDateContainer = document.getElementById("modalCompletionDateContainer");
  
  if (isOngoing) {
    afterContainer.style.display = "none";
    completionDateContainer.style.display = "none";
    // Make images container single column when ongoing
    document.getElementById("modalImagesContainer").style.gridTemplateColumns = "1fr";
  } else {
    afterContainer.style.display = "block";
    completionDateContainer.style.display = "flex";
    document.getElementById("modalImagesContainer").style.gridTemplateColumns = "1fr 1fr";
    const after = d.afterImage || d.completionImage || "https://via.placeholder.com/400x300?text=No+After+Image";
    document.getElementById("modalAfterImage").src = after;
    document.getElementById("modalCompletionDate").textContent = formatDate(d.completionDate);
  }
  
  const badge = document.getElementById("modalStatusBadge");
  badge.textContent = d.status || "Not specified";
  badge.className = "status-badge " + getStatusClass(d.status);
  document.getElementById("modalBarangay").textContent = d.barangay || "N/A";
  document.getElementById("modalContractor").textContent = d.contractor || "N/A";
  document.getElementById("modalSupplier").textContent = d.supplier || "N/A";
  document.getElementById("modalProjectType").textContent = d.projectType || "Infrastructure";
  const p = d.progress || 0;
  document.getElementById("modalProgress").textContent = p + "%";
  document.getElementById("modalProgressBar").style.width = p + "%";
  document.getElementById("modalDescription").textContent = d.description || d.issue || "No description";
  document.getElementById("modalProgressReport").textContent = d.progressReport || "No report";
  document.getElementById("modalLatitude").textContent = d.latitude || "N/A";
  document.getElementById("modalLongitude").textContent = d.longitude || "N/A";
  const before = d.imageURL || d.imageUrl || "https://via.placeholder.com/400x300?text=No+Image";
  document.getElementById("modalBeforeImage").src = before;
  modal.classList.add("active");
  document.body.style.overflow = "hidden";
}
function closeModal() { modal.classList.remove("active"); document.body.style.overflow = "auto"; }
function closeImagePreview() { imagePreviewModal.classList.remove("active"); }

window.previewImage = function(src) {
  imagePreviewContent.src = src;
  imagePreviewModal.classList.add("active");
};

// --- Filtering & Rendering ---
function filterBulletins() {
  const bSel = barangayFilter.value;
  const stSel = statusFilter.value;
  const ySel = yearFilter.value;
  
  const f = allBulletins.filter(d => {
    // Filter out pending and declined
    if (!isValidStatus(d.status)) return false;
    
    const bar = (d.barangay || "").toLowerCase();
    const status = (d.status || "").toLowerCase();
    
    const matchB = !bSel || bar === bSel.toLowerCase();
    const matchT = !stSel || status.includes(stSel);
    let matchY = true;
    const dt = d.createdAt || d.date;
    if (ySel && dt) {
      const yr = dt.toDate ? dt.toDate().getFullYear() : new Date(dt).getFullYear();
      matchY = String(yr) === String(ySel);
    }
    return matchB && matchT && matchY;
  });
  
  updateStatistics(f);
  olderPostsContainer.innerHTML = "";
  noSearchMessage.style.display = "none";
  olderPostsSection.style.display = "none";
  
  if (!f.length) { 
    noSearchMessage.style.display = "block"; 
    return; 
  }
  
  // Filter completed/repaired projects only for "Mga Nakaraang Proyekto"
  const completed = f.filter(d => {
    const s = (d.status || "").toLowerCase();
    return s.match(/completed|resolved|repaired|fixed|natapos/);
  });
  
  // Show older completed projects (skip the first 10 that are in carousel)
  const olderCompleted = completed.slice(10);
  
  if (olderCompleted.length > 0) {
    olderPostsSection.style.display = "block";
    olderCompleted.forEach((d, i) => olderPostsContainer.appendChild(createCard(d, i)));
  }
  
  updateMapMarkers(f);
}

function createCard(d, i, isNew = false) {
  const c = document.createElement("div");
  c.className = "card";
  const img = d.imageURL || d.imageUrl || "https://via.placeholder.com/300x200?text=No+Image";
  c.innerHTML = `
    ${isNew ? "<div class='new-label'>NEW</div>" : ""}
    <div class="card-image-wrapper"><img src="${img}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Available'"></div>
    <div class="card-content">
      <h3>${(d.projectName || d.issue || "Unnamed").substring(0, 50)}</h3>
      <div><b>Barangay:</b> ${d.barangay || "N/A"}</div>
      <div><span class="status-badge ${getStatusClass(d.status)}">${d.status || "Reported"}</span></div>
      <div class="progress-bar-container"><div class="progress-bar" style="width:${d.progress || 0}%"></div></div>
    </div>`;
  c.onclick = () => openModal(d);
  return c;
}

function updateCarouselButtons(totalItems, currentIndex, prevButton, nextButton) {
  prevButton.disabled = currentIndex === 0;
  nextButton.disabled = currentIndex >= Math.max(0, totalItems - cardsPerView);
}

// --- Ongoing Carousel ---
function buildOngoingCarousel(b) {
  const ongoing = b.filter(x => {
    const s = (x.status || "").toLowerCase();
    return (s.includes("ongoing") || s.includes("ginagawa")) && isValidStatus(x.status);
  });
  
  loadingOngoing.style.display = "none";
  
  if (!ongoing.length) { 
    ongoingSection.style.display = "none"; 
    return; 
  }
  
  ongoingSection.style.display = "block";
  ongoContainer.innerHTML = "";
  ongoing.forEach((p, i) => ongoContainer.appendChild(createCard(p, i)));
  
  ongoingCarouselIndex = 0;
  
  function update() {
    ongoContainer.style.transform = `translateX(${-ongoingCarouselIndex * 320}px)`;
    updateCarouselButtons(ongoing.length, ongoingCarouselIndex, ongoPrev, ongoNext);
  }
  
  ongoPrev.onclick = () => { 
    if (ongoingCarouselIndex > 0) {
      ongoingCarouselIndex--;
      update();
    }
  };
  
  ongoNext.onclick = () => { 
    if (ongoingCarouselIndex < ongoing.length - cardsPerView) {
      ongoingCarouselIndex++;
      update();
    }
  };
  
  update();
}

// --- Completed Carousel ---
function buildCompletedCarousel(b) {
  const completed = b.filter(x => {
    const s = (x.status || "").toLowerCase();
    return s.match(/completed|resolved|repaired|fixed|natapos/) && isValidStatus(x.status);
  });
  
  loadingCompleted.style.display = "none";
  
  if (!completed.length) { 
    completedSection.style.display = "none"; 
    return; 
  }
  
  completedSection.style.display = "block";
  completedContainer.innerHTML = "";
  completed.forEach((p, i) => completedContainer.appendChild(createCard(p, i)));
  
  completedCarouselIndex = 0;
  
  function update() {
    completedContainer.style.transform = `translateX(${-completedCarouselIndex * 320}px)`;
    updateCarouselButtons(completed.length, completedCarouselIndex, completedPrev, completedNext);
  }
  
  completedPrev.onclick = () => { 
    if (completedCarouselIndex > 0) {
      completedCarouselIndex--;
      update();
    }
  };
  
  completedNext.onclick = () => { 
    if (completedCarouselIndex < completed.length - cardsPerView) {
      completedCarouselIndex++;
      update();
    }
  };
  
  update();
}

// --- Firestore Listener ---
function renderBulletins(snap) {
  if (snap.empty) { 
    loadingOngoing.style.display = "none";
    loadingCompleted.style.display = "none";
    return; 
  }
  
  // Filter out pending and declined from all bulletins
  allBulletins = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(b => isValidStatus(b.status));
  
  filterBulletins();
  buildOngoingCarousel(allBulletins);
  buildCompletedCarousel(allBulletins);
}

function handleError(e) {
  console.error("Firestore error:", e);
  errorMessage.textContent = "Error loading reports. Please try again later.";
  errorMessage.style.display = "block";
  loadingOngoing.style.display = "none";
  loadingCompleted.style.display = "none";
}

// --- Events ---
closeBtn.onclick = closeModal;
modal.onclick = e => { if (e.target === modal) closeModal(); };
imagePreviewClose.onclick = closeImagePreview;
imagePreviewModal.onclick = e => { if (e.target === imagePreviewModal) closeImagePreview(); };
barangayFilter.onchange = filterBulletins;
statusFilter.onchange = filterBulletins;
yearFilter.onchange = filterBulletins;
window.onload = () => initMap();

// ‚úÖ Updated: use 'reports' collection (public viewable)
try {
  const q = query(collection(db, "reports"), orderBy("createdAt", "desc"));
  onSnapshot(q, renderBulletins, handleError);
} catch (e) {
  handleError(e);
}
</script>
</body>
</html>