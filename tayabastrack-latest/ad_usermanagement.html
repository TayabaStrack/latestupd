<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TayabaStrack | User Management</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow: hidden; }

/* SIDEBAR - DASHBOARD STYLE */
.sidebar {
width: 250px;
min-width: 250px;
background: #004aad;
color: #fff;
display: flex;
flex-direction: column;
justify-content: space-between;
padding: 1rem 0;
position: fixed;
top: 0;
left: 0;
bottom: 0;
z-index: 50;
height: 100vh;
overflow-y: auto;
transition: left 0.3s ease;
}
.sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; padding: 0 1rem; }
.sidebar-header img{width:50px;height:50px;object-fit:contain}
.sidebar-header h2 { font-size: 1.2rem; margin: 0; font-weight: 600; }
.sidebar-menu { list-style: none; padding-left: 0; margin: 0; }
.sidebar-menu li { margin: 0.5rem 0; }
.sidebar-menu a {
display: flex;
align-items: center;
gap: 10px;
padding: 0.8rem 1.5rem;
text-decoration: none;
color: #fff;
transition: background 0.2s;
border-left: 4px solid transparent;
}
.sidebar-menu a:hover,
.sidebar-menu li.active a { background: #0756cc; border-left: 4px solid #042f68; }
.sidebar-menu a i { width: 20px; text-align: center; font-size: 1rem; }
.sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); margin-top: auto; }
.logout-btn {
background-color: #d9534f;
color: #fff;
border: none;
padding: 0.6rem 1.2rem;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
transition: background 0.3s;
width: 100%;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}
.logout-btn:hover { background-color: #c9302c; }

/* Submenu Styling */
.sidebar-submenu {
list-style: none;
padding-left: 0;
margin: 0;
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease;
background: rgba(0, 0, 0, 0.1);
}

.sidebar-submenu.open {
max-height: 500px;
}

.sidebar-submenu li {
margin: 0;
}

.sidebar-submenu a {
padding: 0.6rem 1.5rem 0.6rem 3rem !important;
font-size: 0.9rem;
border-left: 4px solid transparent;
}

.sidebar-submenu li.active a {
background: #042f68;
border-left: 4px solid #fff;
}

.has-submenu > a {
display: flex;
justify-content: space-between;
align-items: center;
}

.has-submenu > a .fa-chevron-down {
transition: transform 0.3s ease;
margin-left: auto;
}

/* NAVBAR - dashboard style */
.navbar {
position: fixed;
top: 0;
left: 250px;
right: 0;
height: 64px;
display: flex;
justify-content: space-between;
align-items: center;
padding: 0 24px;
background: #fff;
box-shadow: 0 2px 6px rgba(0,0,0,.05);
z-index: 40;
transition: left 0.3s ease;
}
.navbar h1 { font-size: 1.4rem; color: #004aad; margin: 0; }
.navbar-left { display: flex; align-items: center; gap: 1rem; }
.mobile-menu-btn {
display: none;
background: none;
border: none;
color: #004aad;
font-size: 1.5rem;
cursor: pointer;
padding: 0.5rem;
}

/* Profile & Notification */
.fa-bell { font-size: 1.2rem; position: relative; cursor: pointer; color: #333; }
.badge { background: red; color: #fff; font-size: .7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 18px; text-align: center; }
.badge.show { display: flex; align-items: center; justify-content: center; }

.notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 340px; max-height: 420px; overflow: hidden; z-index: 1000; font-family: "Segoe UI", Tahoma, sans-serif; animation: fadeIn 0.2s ease-in-out; }
.notification-menu.show { display: block; }
.notification-header { padding: 0.9rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
.notification-header h3 { font-size: 1rem; color: #333; margin: 0; font-weight: 600; }
.notification-actions { display: flex; gap: 0.5rem; align-items: center; }
.action-icon-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.3rem; transition: color 0.2s ease; display: flex; align-items: center; justify-content: center; }
.action-icon-btn:hover { color: #004aad; }
.action-icon-btn i { font-size: 0.95rem; }

.notification-filters { display: flex; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; background: #fafafa; }
.filter-btn { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.8rem; background: #f2f2f2; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.25s ease; color: #333; }
.filter-btn:hover { background: #004aad; color: #fff; }
.filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }

.notification-list { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ccc transparent; }
.notification-list::-webkit-scrollbar { width: 6px; }
.notification-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
.notification-list::-webkit-scrollbar-track { background: transparent; }
.notification-item { padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; align-items: flex-start; transition: background 0.2s; position: relative; }
.notification-item:hover { background: #f5f7ff; }
.notification-item.unread { background: #f0f7ff; }
.notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: #004aad; border-radius: 0 4px 4px 0; }
.notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
.notification-icon.user { background: #e3f2fd; color: #1976d2; }
.notification-icon.report { background: #fff3e0; color: #f57c00; }
.notification-content { flex: 1; }
.notification-content p { margin: 0; font-size: 0.86rem; color: #333; line-height: 1.3; }
.notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.25rem; }
.notification-empty { padding: 2rem; text-align: center; color: #999; font-size: 0.9rem; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

.profile-dropdown { position: relative; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background 0.2s; }
.profile-dropdown:hover { background: #f5f7fb; }
.avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #004aad; }
.username { font-weight: 500; color: #333; }

.dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; }
.dropdown-menu.show { display: block; }
.dropdown-menu a { display: block; padding: .6rem 1rem; text-decoration: none; color: #333; font-size: .9rem; transition: background 0.2s; }
.dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
.dropdown-menu a i { margin-right: 8px; width: 20px; text-align: center; }

/* MAIN CONTENT */
.main { margin-left: 250px; margin-top: 64px; flex: 1; display: block; min-width: 0; height: calc(100vh - 64px); overflow: hidden; transition: margin-left 0.3s ease; }
.content { flex: 1; padding: 1.5rem; overflow-y: auto; height: 100%; }
.table-section { margin-bottom: 2rem; }
.table-section h2 { color: #004aad; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
.table-section h2 span { font-size: 0.9rem; color: #666; font-weight: normal; }

.search-box { margin-bottom: 1rem; position: relative; max-width: 400px; }
.search-box input { width: 100%; padding: 0.6rem 2.5rem 0.6rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
.search-box i { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #999; }

.scroll-hint { background: linear-gradient(135deg,#004aad 0%,#0066cc 100%); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,74,173,0.2); }
.scroll-hint i { animation: slideHint 2s ease-in-out infinite; }
@keyframes slideHint { 0%,100% { transform: translateX(-4px); } 50% { transform: translateX(4px); } }

.table-wrapper { position: relative; }
.table-card { overflow-x: auto; overflow-y: hidden; border-radius: 8px; background: #fff; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); scroll-behavior: smooth; position: relative; }
.table-card::-webkit-scrollbar { height: 10px; }
.table-card::-webkit-scrollbar-track { background: #e9eef5; border-radius: 5px; }
.table-card::-webkit-scrollbar-thumb { background: linear-gradient(135deg,#004aad 0%,#0066cc 100%); border-radius: 5px; border: 2px solid #e9eef5; }
.table-card::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg,#003580 0%,#004aad 100%); }
.table-card { scrollbar-width: thin; scrollbar-color: #004aad #e9eef5; }
.table-card::before, .table-card::after { content: ''; position: absolute; top: 0; bottom: 12px; width: 30px; pointer-events: none; z-index: 2; transition: opacity 0.3s; }
.table-card::before { left: 8px; background: linear-gradient(to right, rgba(255,255,255,0.95), transparent); opacity: 0; }
.table-card::after { right: 8px; background: linear-gradient(to left, rgba(255,255,255,0.95), transparent); }
.table-card.scrolled-left::before { opacity: 1; }
.table-card.scrolled-right::after { opacity: 0; }

table { width: 100%; border-collapse: collapse; background: #fff; min-width: 900px; }
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; white-space: nowrap; }
th { background: #f5f8fb; color: #333; font-weight: 700; border-bottom: 2px solid #e0e0e0; }
tr:hover { background: #f1f8ff; }

button { border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; color: #fff; margin-right: 0.3rem; transition: background 0.2s; font-weight: 600; }
button.approve { background: #28a745; }
button.approve:hover { background: #218838; }
button.decline { background: #dc3545; }
button.decline:hover { background: #c82333; }
button.edit { background: #007bff; }
button.edit:hover { background: #0056b3; }
button.inactive { background: #ffc107; color: #333; }
button.inactive:hover { background: #e0a800; }
button.activate { background: #28a745; }
button.activate:hover { background: #218838; }
button:disabled { background: #ccc; cursor: not-allowed; }

.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
.modal.show { display: flex; }
.modal-content { background: #fff; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.modal-header h3 { color: #004aad; margin: 0; }
.close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; padding: 0; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333; }
.form-group input, .form-group select { width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
.modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; }
button.save { background: #28a745; }
button.save:hover { background: #218838; }
button.cancel { background: #6c757d; }
button.cancel:hover { background: #5a6268; }

/* ==========================================
   PASSWORD SECTION STYLING
   ========================================== */

.password-section {
  background: #f8f9fa;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.password-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.8rem;
}

.password-header label {
  font-weight: 600;
  color: #004aad;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0;
}

.password-input-wrapper {
  position: relative;
  margin-bottom: 0.5rem;
}

.password-input-wrapper input {
  width: 100%;
  padding: 0.65rem 100px 0.65rem 0.65rem;
  font-family: 'Courier New', monospace;
  letter-spacing: 1px;
  font-size: 0.9rem;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 6px;
  transition: all 0.2s;
}

.password-input-wrapper input:focus {
  outline: none;
  border-color: #004aad;
  box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1);
}

.password-actions {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 0.3rem;
  align-items: center;
}

.toggle-password,
.suggest-password {
  color: #666;
  cursor: pointer;
  font-size: 0.9rem;
  transition: color 0.2s;
  background: none;
  border: none;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
}

.toggle-password:hover,
.suggest-password:hover {
  color: #004aad;
}

.suggest-btn {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: #fff;
  border: none;
  padding: 0.5rem 0.9rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 600;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
  width: 100%;
  justify-content: center;
}

.suggest-btn:hover {
  background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(40, 167, 69, 0.5);
}

.suggest-btn i {
  font-size: 0.85rem;
}

.password-hint {
  font-size: 0.75rem;
  color: #666;
  margin-top: 0.3rem;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.password-hint i {
  color: #004aad;
  font-size: 0.8rem;
}

/* ==========================================
   FORM GROUP STYLING
   ========================================== */

.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 1rem;
}

.form-group label {
  font-weight: 600;
  margin-bottom: 0.4rem;
  color: #333;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.form-group label i {
  color: #004aad;
  font-size: 0.9rem;
}

.form-group input,
.form-group select {
  padding: 0.65rem;
  border: 1px solid #ddd;
  background: #f9f9f9;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #004aad;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1);
}

/* ==========================================
   MODAL ACTIONS
   ========================================== */

.modal-actions {
  margin-top: 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.8rem;
  padding-top: 1rem;
  border-top: 2px solid #e0e0e0;
}

.modal-actions button {
  border: none;
  padding: 0.65rem 1.8rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 600;
  transition: all 0.3s;
}

.cancel-btn {
  background: #6c757d;
  color: #fff;
}

.cancel-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
}

.save-btn {
  background: linear-gradient(135deg, #004aad 0%, #0066cc 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3);
}

.save-btn:hover {
  background: linear-gradient(135deg, #003d8f 0%, #0052a3 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 74, 173, 0.5);
}

/* ==========================================
   MODAL STYLING
   ========================================== */

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  align-items: center;
  justify-content: center;
  z-index: 5000;
  padding: 1rem;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: #fff;
  padding: 1.5rem;
  border-radius: 12px;
  border: 3px solid #004aad;
  width: 520px;
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.modal-content h2 {
  margin-bottom: 1.2rem;
  color: #004aad;
  text-align: center;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.modal-content h2 i {
  font-size: 1.3rem;
}

/* ==========================================
   ADD USER BUTTON
   ========================================== */

.add-user-btn {
  background: linear-gradient(135deg, #004aad 0%, #0066cc 100%);
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3);
}

.add-user-btn:hover {
  background: linear-gradient(135deg, #003d8f 0%, #0052a3 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 74, 173, 0.5);
}

.add-user-btn i {
  font-size: 0.95rem;
}

/* ==========================================
   RESPONSIVE DESIGN
   ========================================== */

@media (max-width: 768px) {
  .password-input-wrapper input {
    padding-right: 90px;
    font-size: 0.85rem;
  }

  .suggest-btn {
    font-size: 0.75rem;
    padding: 0.45rem 0.8rem;
  }

  .password-hint {
    font-size: 0.7rem;
  }

  .toggle-password,
  .suggest-password {
    width: 22px;
    height: 22px;
    font-size: 0.85rem;
  }

  .modal-content {
    width: 100%;
    padding: 1rem;
  }

  .modal-content h2 {
    font-size: 1.2rem;
  }

  .modal-actions button {
    padding: 0.6rem 1.2rem;
    font-size: 0.85rem;
  }
}

/* ==========================================
   ANIMATIONS
   ========================================== */

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal.show .modal-content {
  animation: fadeIn 0.3s ease;
}

/* Focus states for accessibility */
.toggle-password:focus,
.suggest-password:focus,
.suggest-btn:focus {
  outline: 2px solid #004aad;
  outline-offset: 2px;
  border-radius: 4px;
}

/* Loading state */
.suggest-btn.loading {
  pointer-events: none;
  opacity: 0.7;
}

.suggest-btn.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* PAGINATION STYLES */
.pagination-wrapper {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 1rem;
padding: 1rem;
background: #f9f9f9;
border-radius: 6px;
gap: 1rem;
flex-wrap: wrap;
}

.pagination-info {
font-size: 0.85rem;
color: #666;
font-weight: 500;
}

.pagination-controls {
display: flex;
gap: 0.5rem;
align-items: center;
flex-wrap: wrap;
}

.pagination-btn {
background: #004aad;
color: #fff;
border: none;
padding: 0.5rem 0.75rem;
border-radius: 4px;
cursor: pointer;
font-size: 0.8rem;
font-weight: 600;
transition: all 0.2s;
min-width: 35px;
text-align: center;
}

.pagination-btn:hover:not(:disabled) {
background: #0756cc;
transform: translateY(-1px);
}

.pagination-btn:disabled {
background: #ccc;
cursor: not-allowed;
opacity: 0.6;
}

.pagination-btn.active {
background: #0756cc;
font-weight: 700;
}

.page-size-select {
padding: 0.5rem;
border: 1px solid #ddd;
border-radius: 4px;
font-size: 0.85rem;
background: #fff;
cursor: pointer;
}

.pagination-ellipsis {
color: #666;
font-weight: bold;
padding: 0.5rem 0.25rem;
}

/* MOBILE */
@media (max-width: 980px) {
.sidebar { left: -250px; }
.sidebar.mobile-open { left: 0; }
.navbar { left: 0; }
.main { margin-left: 0; }
.mobile-menu-btn { display: block !important; }
.username { display: none; }
.checkbox-grid {
grid-template-columns: 1fr;
}
.password-input-group {
flex-direction: column;
}
.add-user-btn {
padding: 0.5rem 0.8rem;
font-size: 0.85rem;
}
.pagination-wrapper {
flex-direction: column;
gap: 0.5rem;
}
.pagination-controls {
width: 100%;
justify-content: center;
}
}
</style>

</head>
<body>

<!-- Sidebar (from dashboard) -->
<aside class="sidebar" id="sidebar">
<div>
<div class="sidebar-header" style="display:flex;align-items:center;gap:12px;">
<div style="width:50px;height:50px;border-radius:50%;background:#fff;display:inline-flex;align-items:center;justify-content:center;overflow:visible;">
<img src="logo.png" alt="Logo" style="width:72px;height:72px;object-fit:contain;display:block;align-items:center;" />
</div>
<h2 style="margin:0;">TayabaStrack</h2>
</div>
<ul class="sidebar-menu">
<li><a href="ad_dash.html"><i class="fa fa-home"></i> Dashboard</a></li>
<li class="has-submenu">
<a href="#" onclick="toggleSubmenu(event)">
<span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
<i class="fa fa-chevron-down"></i>
</a>
<ul class="sidebar-submenu">
<li><a href="ad_repopend.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
<li><a href="ad_repon.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
<li><a href="ad_repcom.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
<li><a href="ad_repdec.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
</ul>
</li>
<li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
<li class="active"><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
<li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
</ul>
</div>
<div class="sidebar-footer">
<button class="logout-btn" id="logoutBtn">
<i class="fa fa-sign-out-alt"></i>
<span>Logout</span>
</button>
</div>
</aside>

<!-- Navbar (kept behavior) -->
<nav class="navbar">
<div class="navbar-left">
<button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa fa-bars"></i></button>
<h1>User Management</h1>
</div>

<div style="display:flex;align-items:center;gap:14px">
<div style="position:relative">
<i class="fa fa-bell" id="notificationBell" aria-hidden="true"></i>
<span class="badge" id="notificationBadge">0</span>

<!-- Notification dropdown -->
<div class="notification-menu" id="notificationMenu">
<div class="notification-header">
<h3>Notifications</h3>
<div class="notification-actions">
<button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read"><i class="fa fa-check-double"></i></button>
<button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all"><i class="fa fa-trash-alt"></i></button>
</div>
</div>

<div class="notification-filters">
<button class="filter-btn active" data-filter="all">All</button>
<button class="filter-btn" data-filter="report">Reports</button>
<button class="filter-btn" data-filter="user">Users</button>
<button class="filter-btn" data-filter="24h">Last 24h</button>
</div>

<div class="notification-list" id="notificationList">
<div class="notification-empty">No new notifications</div>
</div>
</div>
</div>

<!-- Profile -->
<div class="profile-dropdown" id="profileToggle">
<img src="image.png" alt="Profile" class="avatar" id="navAvatar">
<span class="username" id="navUsername">Loading...</span>

<div class="dropdown-menu" id="dropdownMenu">
<a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
</div>
</div>
</div>
</nav>

<!-- Main -->
<main class="main">
  <div class="content">
    <!-- Pending Registration -->
    <div class="table-section">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Pending Registration <span id="pendingCount">(0)</span></h2>
        <button class="add-user-btn" onclick="openAddUserModal()">
          <i class="fa fa-user-plus"></i> Add Official
        </button>
      </div>
      <div class="search-box">
        <input type="text" id="searchPending" placeholder="Search pending users...">
        <i class="fa fa-search"></i>
      </div>
      <div class="table-wrapper">
        <div class="table-card" id="pendingTableCard">
          <table>
            <thead>
              <tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Barangay</th><th>Position</th><th>Contact</th><th>Action</th></tr>
            </thead>
            <tbody id="pendingTable">
              <tr><td colspan="7" style="text-align:center;color:#777;padding:1rem">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-wrapper" id="pendingPagination"></div>
      </div>
    </div>

    <!-- Active Users -->
    <div class="table-section">
      <h2>Active Users <span id="activeCount">(0)</span></h2>
      <div class="search-box">
        <input type="text" id="searchActive" placeholder="Search active users...">
        <i class="fa fa-search"></i>
      </div>
      <div class="table-wrapper">
        <div class="table-card" id="activeTableCard">
          <table>
            <thead>
              <tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Barangay</th><th>Position</th><th>Contact</th><th>Action</th></tr>
            </thead>
            <tbody id="activeTable">
              <tr><td colspan="7" style="text-align:center;color:#777;padding:1rem">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-wrapper" id="activePagination"></div>
      </div>
    </div>

    <!-- Inactive Users -->
    <div class="table-section">
      <h2>Inactive Users <span id="inactiveCount">(0)</span></h2>
      <div class="search-box">
        <input type="text" id="searchInactive" placeholder="Search inactive users...">
        <i class="fa fa-search"></i>
      </div>
      <div class="table-wrapper">
        <div class="table-card" id="inactiveTableCard">
          <table>
            <thead>
              <tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Barangay</th><th>Position</th><th>Contact</th><th>Action</th></tr>
            </thead>
            <tbody id="inactiveTable">
              <tr><td colspan="7" style="text-align:center;color:#777;padding:1rem">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-wrapper" id="inactivePagination"></div>
      </div>
    </div>

    <!-- Declined Registrations -->
    <div class="table-section">
      <h2>Declined Registrations <span id="declinedCount">(0)</span></h2>
      <div class="search-box">
        <input type="text" id="searchDeclined" placeholder="Search declined users...">
        <i class="fa fa-search"></i>
      </div>
      <div class="table-wrapper">
        <div class="table-card" id="declinedTableCard">
          <table>
            <thead>
              <tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Barangay</th><th>Position</th><th>Contact</th><th>Declined Date</th><th>Action</th></tr>
            </thead>
            <tbody id="declinedTable">
              <tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-wrapper" id="declinedPagination"></div>
      </div>
    </div>
  </div>
</main>

<!-- Edit modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit User Information</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    <form id="editForm">
      <input type="hidden" id="editUserId">
      <div class="form-group"><label>First Name</label><input type="text" id="editFirstName" required></div>
      <div class="form-group"><label>Last Name</label><input type="text" id="editLastName" required></div>
      <div class="form-group"><label>Email</label><input type="email" id="editEmail" required></div>
      
      <!-- Changed to dropdown -->
      <div class="form-group">
        <label>Barangay</label>
        <select id="editBarangay" required>
          <option value="">Select Barangay</option>
          <option value="Alitao">Alitao</option>
          <option value="Alsam Ibaba">Alsam Ibaba</option>
          <option value="Alsam Ilaya">Alsam Ilaya</option>
          <option value="Alupay">Alupay</option>
          <option value="Angeles Zone I">Angeles Zone I</option>
          <option value="Angeles Zone II">Angeles Zone II</option>
          <option value="Angeles Zone III">Angeles Zone III</option>
          <option value="Angeles Zone IV">Angeles Zone IV</option>
          <option value="Angustias Zone I">Angustias Zone I</option>
          <option value="Angustias Zone II">Angustias Zone II</option>
          <option value="Angustias Zone III">Angustias Zone III</option>
          <option value="Angustias Zone IV">Angustias Zone IV</option>
          <option value="Anos">Anos</option>
          <option value="Ayaas">Ayaas</option>
          <option value="Baguio">Baguio</option>
          <option value="Banilad">Banilad</option>
          <option value="Ibabang Bukal">Ibabang Bukal</option>
          <option value="Ilayang Bukal">Ilayang Bukal</option>
          <option value="Calantas">Calantas</option>
          <option value="Calumpang">Calumpang</option>
          <option value="Camaysa">Camaysa</option>
          <option value="Dapdap">Dapdap</option>
          <option value="Kanlurang Domoit">Kanlurang Domoit</option>
          <option value="Silangang Domoit">Silangang Domoit</option>
          <option value="Gibanga">Gibanga</option>
          <option value="Ibas">Ibas</option>
          <option value="Ilasan Ibaba">Ilasan Ibaba</option>
          <option value="Ilasan Ilaya">Ilasan Ilaya</option>
          <option value="Ipilan">Ipilan</option>
          <option value="Isabang">Isabang</option>
          <option value="Katigan Kanluran">Katigan Kanluran</option>
          <option value="Katigan Silangan">Katigan Silangan</option>
          <option value="Lakawan">Lakawan</option>
          <option value="Lalo">Lalo</option>
          <option value="Lawigue">Lawigue</option>
          <option value="Lita">Lita</option>
          <option value="Malaoa">Malaoa</option>
          <option value="Masin">Masin</option>
          <option value="Mate">Mate</option>
          <option value="Mateuna">Mateuna</option>
          <option value="Mayowe">Mayowe</option>
          <option value="Ibabang Nangka">Ibabang Nangka</option>
          <option value="Ilayang Nangka">Ilayang Nangka</option>
          <option value="Opias">Opias</option>
          <option value="Ibabang Palale">Ibabang Palale</option>
          <option value="Ilayang Palale">Ilayang Palale</option>
          <option value="Kanlurang Palale">Kanlurang Palale</option>
          <option value="Silangang Palale">Silangang Palale</option>
          <option value="Pandakaki">Pandakaki</option>
          <option value="Pook">Pook</option>
          <option value="Potol">Potol</option>
          <option value="San Diego Zone I">San Diego Zone I</option>
          <option value="San Diego Zone II">San Diego Zone II</option>
          <option value="San Diego Zone III">San Diego Zone III</option>
          <option value="San Diego Zone IV">San Diego Zone IV</option>
          <option value="San Isidro Zone I">San Isidro Zone I</option>
          <option value="San Isidro Zone II">San Isidro Zone II</option>
          <option value="San Isidro Zone III">San Isidro Zone III</option>
          <option value="San Isidro Zone IV">San Isidro Zone IV</option>
          <option value="San Roque Zone I">San Roque Zone I</option>
          <option value="San Roque Zone II">San Roque Zone II</option>
          <option value="Talolong">Talolong</option>
          <option value="Tamlong">Tamlong</option>
          <option value="Tongko">Tongko</option>
          <option value="Valencia">Valencia</option>
          <option value="Wakas">Wakas</option>
        </select>
      </div>
      
      <!-- Changed to dropdown -->
      <div class="form-group">
        <label>Position</label>
        <select id="editPosition" required>
          <option value="">Select Position</option>
          <option value="Barangay Captain">Barangay Captain</option>
          <option value="Barangay Kagawad">Barangay Kagawad</option>
          <option value="Barangay Secretary">Barangay Secretary</option>
          <option value="Barangay Treasurer">Barangay Treasurer</option>
          <option value="SK Chairperson">SK Chairperson</option>
          <option value="SK Kagawad">SK Kagawad</option>
          <option value="Barangay Health Worker">Barangay Health Worker</option>
          <option value="Barangay Tanod">Barangay Tanod</option>
          <option value="Barangay Nutritionist">Barangay Nutritionist</option>
          <option value="Day Care Worker">Day Care Worker</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <div class="form-group"><label>Contact</label><input type="text" id="editContact" required></div>
      <div class="modal-actions">
        <button type="button" class="cancel" id="cancelEdit">Cancel</button>
        <button type="submit" class="save">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="addUserModal">
  <div class="modal-content" style="max-width: 520px;">
    <div class="modal-header">
      <h3><i class="fa fa-user-plus"></i> Add Barangay Official</h3>
      <button class="close-modal" id="closeAddModal">&times;</button>
    </div>
    <form id="addUserForm">
      <div class="form-group">
        <label><i class="fa fa-user"></i> First Name</label>
        <input type="text" id="addFirstName" placeholder="Enter first name" required>
      </div>
      <div class="form-group">
        <label><i class="fa fa-user"></i> Last Name</label>
        <input type="text" id="addLastName" placeholder="Enter last name" required>
      </div>
      <div class="form-group">
        <label><i class="fa fa-envelope"></i> Email</label>
        <input type="email" id="addEmail" placeholder="Enter email address" required>
      </div>
      <div class="form-group">
        <label><i class="fa fa-map-marker-alt"></i> Barangay</label>
        <select id="addBarangay" required>
          <option value="">Select Barangay</option>
          <option value="Alitao">Alitao</option>
          <option value="Alsam Ibaba">Alsam Ibaba</option>
          <option value="Alsam Ilaya">Alsam Ilaya</option>
          <option value="Alupay">Alupay</option>
          <option value="Angeles Zone I">Angeles Zone I</option>
          <option value="Angeles Zone II">Angeles Zone II</option>
          <option value="Angeles Zone III">Angeles Zone III</option>
          <option value="Angeles Zone IV">Angeles Zone IV</option>
          <option value="Angustias Zone I">Angustias Zone I</option>
          <option value="Angustias Zone II">Angustias Zone II</option>
          <option value="Angustias Zone III">Angustias Zone III</option>
          <option value="Angustias Zone IV">Angustias Zone IV</option>
          <option value="Anos">Anos</option>
          <option value="Ayaas">Ayaas</option>
          <option value="Baguio">Baguio</option>
          <option value="Banilad">Banilad</option>
          <option value="Ibabang Bukal">Ibabang Bukal</option>
          <option value="Ilayang Bukal">Ilayang Bukal</option>
          <option value="Calantas">Calantas</option>
          <option value="Calumpang">Calumpang</option>
          <option value="Camaysa">Camaysa</option>
          <option value="Dapdap">Dapdap</option>
          <option value="Kanlurang Domoit">Kanlurang Domoit</option>
          <option value="Silangang Domoit">Silangang Domoit</option>
          <option value="Gibanga">Gibanga</option>
          <option value="Ibas">Ibas</option>
          <option value="Ilasan Ibaba">Ilasan Ibaba</option>
          <option value="Ilasan Ilaya">Ilasan Ilaya</option>
          <option value="Ipilan">Ipilan</option>
          <option value="Isabang">Isabang</option>
          <option value="Katigan Kanluran">Katigan Kanluran</option>
          <option value="Katigan Silangan">Katigan Silangan</option>
          <option value="Lakawan">Lakawan</option>
          <option value="Lalo">Lalo</option>
          <option value="Lawigue">Lawigue</option>
          <option value="Lita">Lita</option>
          <option value="Malaoa">Malaoa</option>
          <option value="Masin">Masin</option>
          <option value="Mate">Mate</option>
          <option value="Mateuna">Mateuna</option>
          <option value="Mayowe">Mayowe</option>
          <option value="Ibabang Nangka">Ibabang Nangka</option>
          <option value="Ilayang Nangka">Ilayang Nangka</option>
          <option value="Opias">Opias</option>
          <option value="Ibabang Palale">Ibabang Palale</option>
          <option value="Ilayang Palale">Ilayang Palale</option>
          <option value="Kanlurang Palale">Kanlurang Palale</option>
          <option value="Silangang Palale">Silangang Palale</option>
          <option value="Pandakaki">Pandakaki</option>
          <option value="Pook">Pook</option>
          <option value="Potol">Potol</option>
          <option value="San Diego Zone I">San Diego Zone I</option>
          <option value="San Diego Zone II">San Diego Zone II</option>
          <option value="San Diego Zone III">San Diego Zone III</option>
          <option value="San Diego Zone IV">San Diego Zone IV</option>
          <option value="San Isidro Zone I">San Isidro Zone I</option>
          <option value="San Isidro Zone II">San Isidro Zone II</option>
          <option value="San Isidro Zone III">San Isidro Zone III</option>
          <option value="San Isidro Zone IV">San Isidro Zone IV</option>
          <option value="San Roque Zone I">San Roque Zone I</option>
          <option value="San Roque Zone II">San Roque Zone II</option>
          <option value="Talolong">Talolong</option>
          <option value="Tamlong">Tamlong</option>
          <option value="Tongko">Tongko</option>
          <option value="Valencia">Valencia</option>
          <option value="Wakas">Wakas</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fa fa-briefcase"></i> Position</label>
        <select id="addPosition" required>
          <option value="">Select Position</option>
          <option value="Barangay Captain">Barangay Captain</option>
          <option value="Barangay Kagawad">Barangay Kagawad</option>
          <option value="Barangay Secretary">Barangay Secretary</option>
          <option value="Barangay Treasurer">Barangay Treasurer</option>
          <option value="SK Chairperson">SK Chairperson</option>
          <option value="SK Kagawad">SK Kagawad</option>
          <option value="Barangay Health Worker">Barangay Health Worker</option>
          <option value="Barangay Tanod">Barangay Tanod</option>
          <option value="Barangay Nutritionist">Barangay Nutritionist</option>
          <option value="Day Care Worker">Day Care Worker</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fa fa-phone"></i> Contact Number</label>
        <input type="text" id="addContact" placeholder="Enter contact number" required>
      </div>

      <!-- Password Input Section - MANUAL ENTRY -->
<div class="form-group password-input-group">
  <label><i class="fa fa-lock"></i> Password *</label>
  <div class="password-input-wrapper">
    <input type="password" id="addPassword" placeholder="Enter password" required>
    <div class="password-actions">
      <button type="button" class="toggle-password" id="toggleAddPassword" onclick="toggleAddPasswordVisibility()" title="Show/Hide password">
        <i class="fa fa-eye"></i>
      </button>
    </div>
  </div>
  <button type="button" class="suggest-btn" onclick="generateStrongPassword()">
    <i class="fa fa-magic"></i> Generate Strong Password
  </button>
  <div class="password-hint">
    <i class="fa fa-info-circle"></i> Password must be at least 8 characters
  </div>
</div>

      <div class="modal-actions">
        <button type="button" class="cancel" id="cancelAddUser">Cancel</button>
        <button type="submit" class="save">Save User</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
// ==========================================
// FIREBASE INITIALIZATION
// ==========================================
import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, getDocs, doc, updateDoc, deleteDoc, getDoc, addDoc, serverTimestamp, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
  authDomain: "tayabastrack-23b95.firebaseapp.com",
  projectId: "tayabastrack-23b95",
  storageBucket: "tayabastrack-23b95.firebasestorage.app",
  messagingSenderId: "674055915366",
  appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let isInternalNavigation = false;
let isLoggingOut = false;
let autoLogoutInitialized = false;

function setupAutoLogout(auth) {
  if (autoLogoutInitialized) {
    console.log("‚ö†Ô∏è Auto-logout already initialized");
    return;
  }
  autoLogoutInitialized = true;

  // ‚úÖ Track ALL link clicks (including profile links)
  document.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && link.href) {
      try {
        const linkUrl = new URL(link.href, window.location.href);
        const currentOrigin = window.location.origin;
        
        // Check if it's an internal link
        if (linkUrl.origin === currentOrigin) {
          isInternalNavigation = true;
          console.log("üîó Internal navigation detected:", link.href);
          
          // ‚úÖ LONGER timeout - 3 seconds to ensure navigation completes
          setTimeout(() => {
            isInternalNavigation = false;
          }, 3000);
        }
      } catch (err) {
        // If URL parsing fails, treat as internal navigation to be safe
        isInternalNavigation = true;
        setTimeout(() => {
          isInternalNavigation = false;
        }, 3000);
      }
    }
  }, true); // ‚úÖ Use capture phase to catch all clicks

  // ‚úÖ IMPROVED: Only logout on actual page close, not navigation
  window.addEventListener('beforeunload', (e) => {
    // Don't logout if it's internal navigation
    if (isInternalNavigation) {
      console.log("‚úÖ Internal navigation - NOT logging out");
      return;
    }
    
    // Only logout on actual tab/browser close
    if (!isLoggingOut) {
      console.log("üö™ Tab/browser closing - logging out");
      isLoggingOut = true;
      
      // Use synchronous approach for reliable logout on page close
      try {
        signOut(auth);
        sessionStorage.clear();
      } catch (error) {
        console.error("‚ùå Error during auto logout:", error);
      }
    }
  });

  // ‚úÖ Handle browser back/forward button
  window.addEventListener('popstate', async (e) => {
    if (!isInternalNavigation && !isLoggingOut) {
      console.log("‚¨ÖÔ∏è Browser back button detected - logging out");
      isLoggingOut = true;
      try {
        await signOut(auth);
        sessionStorage.clear();
        window.location.replace("login.html");
      } catch (error) {
        console.error("‚ùå Error during back navigation logout:", error);
      }
    }
  });

  console.log("‚úÖ Auto-logout functionality initialized");
}


window.db = db;

// ==========================================
// UI HELPER FUNCTIONS
// ==========================================
function toggleSubmenu(event) {
  event.preventDefault();
  const submenu = event.currentTarget.nextElementSibling;
  const chevron = event.currentTarget.querySelector('.fa-chevron-down');

  if (submenu) {
    submenu.classList.toggle('open');
  }
  if (chevron) {
    chevron.style.transform = submenu.classList.contains('open') 
      ? 'rotate(180deg)' 
      : 'rotate(0deg)';
  }
}
window.toggleSubmenu = toggleSubmenu;

function toggleMobileMenu() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
}
window.toggleMobileMenu = toggleMobileMenu;

// Close mobile menu when clicking outside
document.addEventListener('click', function(e) {
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.querySelector('.mobile-menu-btn');
  
  if (window.innerWidth <= 980 && 
      !sidebar.contains(e.target) && 
      !menuBtn.contains(e.target)) {
    sidebar.classList.remove('mobile-open');
  }
});

// ==========================================
// AUDIT LOGGING SYSTEM
// ==========================================
async function logAuditEvent(action, actionType, module, description, additionalData = {}) {
  try {
    const user = auth.currentUser;
    if (!user) {
      console.warn("No authenticated user for audit log");
      return;
    }

    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists()) {
      console.warn("User document not found for audit log");
      return;
    }
    
    const userData = userDoc.data();

    const logData = {
      timestamp: serverTimestamp(),
      userId: user.uid,
      userName: userData.name || `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || "Unknown User",
      userRole: userData.position || userData.role || "User",
      action: action,
      actionType: (actionType || 'edit').toLowerCase(),
      module: module || 'System',
      description: description || 'No description provided',
      beforeValue: additionalData.beforeValue || null,
      afterValue: additionalData.afterValue || null,
      ...additionalData
    };

    await addDoc(collection(db, "auditLogs"), logData);
    console.log("‚úÖ Audit log created:", logData);

  } catch (error) {
    console.error("‚ùå Error logging audit event:", error);
  }
}

// ==========================================
// DOM REFERENCES
// ==========================================
const pendingTable = document.getElementById("pendingTable");
const activeTable = document.getElementById("activeTable");
const inactiveTable = document.getElementById("inactiveTable");
const declinedTable = document.getElementById("declinedTable");

const pendingTableCard = document.getElementById("pendingTableCard");
const activeTableCard = document.getElementById("activeTableCard");
const inactiveTableCard = document.getElementById("inactiveTableCard");
const declinedTableCard = document.getElementById("declinedTableCard");

const searchPending = document.getElementById("searchPending");
const searchActive = document.getElementById("searchActive");
const searchInactive = document.getElementById("searchInactive");
const searchDeclined = document.getElementById("searchDeclined");

const pendingCountEl = document.getElementById("pendingCount");
const activeCountEl = document.getElementById("activeCount");
const inactiveCountEl = document.getElementById("inactiveCount");
const declinedCountEl = document.getElementById("declinedCount");

const editModal = document.getElementById("editModal");
const closeModal = document.getElementById("closeModal");
const cancelEdit = document.getElementById("cancelEdit");
const editForm = document.getElementById("editForm");

const navUsername = document.getElementById("navUsername");
const navAvatar = document.getElementById("navAvatar");

// ==========================================
// STATE MANAGEMENT
// ==========================================
let allPendingUsers = [];
let allActiveUsers = [];
let allInactiveUsers = [];
let allDeclinedUsers = [];

// Pagination state for all tables
const paginationState = {
  pending: { currentPage: 1, pageSize: 10, filteredData: [], totalItems: 0 },
  active: { currentPage: 1, pageSize: 10, filteredData: [], totalItems: 0 },
  inactive: { currentPage: 1, pageSize: 10, filteredData: [], totalItems: 0 },
  declined: { currentPage: 1, pageSize: 10, filteredData: [], totalItems: 0 }
};

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function normalizeStatus(status) { 
  return (status || "").toLowerCase().trim(); 
}

function normalizePosition(position) {
  if (!position) return "";
  return position.toString().toLowerCase().trim();
}

// ‚úÖ FIXED: Improved position checking with better logging
function isBarangayPosition(position) {
  const barangayPositions = [
    'barangay captain', 
    'barangay kagawad', 
    'barangay secretary', 
    'barangay treasurer', 
    'sk chairperson', 
    'sk kagawad', 
    'barangay health worker', 
    'barangay tanod', 
    'barangay nutritionist', 
    'day care worker'
  ];
  
  if (!position) {
    console.warn("‚ö†Ô∏è Position is null or undefined");
    return false;
  }
  
  const normalizedPosition = position.toString().toLowerCase().trim();
  const isMatch = barangayPositions.some(pos => normalizedPosition.includes(pos));
  
  if (!isMatch) {
    console.warn(`‚ö†Ô∏è Position "${position}" does not match barangay positions`);
  }
  
  return isMatch;
}

function sortByBarangay(users) {
  return users.sort((a, b) => {
    const A = (a.data.barangay || "").toLowerCase();
    const B = (b.data.barangay || "").toLowerCase();
    return A.localeCompare(B);
  });
}

function filterUsers(searchTerm, users) {
  return users.filter(user => {
    const data = user.data;
    return (
      (data.firstName || "").toLowerCase().includes(searchTerm) ||
      (data.surname || "").toLowerCase().includes(searchTerm) ||
      (data.email || "").toLowerCase().includes(searchTerm) ||
      (data.barangay || "").toLowerCase().includes(searchTerm) ||
      (data.position || "").toLowerCase().includes(searchTerm)
    );
  });
}

function handleScrollShadows(el) {
  const isScrolledLeft = el.scrollLeft > 10;
  const isScrolledRight = el.scrollLeft < (el.scrollWidth - el.clientWidth - 10);
  el.classList.toggle('scrolled-left', isScrolledLeft);
  el.classList.toggle('scrolled-right', isScrolledRight);
}

[pendingTableCard, activeTableCard, inactiveTableCard, declinedTableCard].forEach(card => {
  if (card) card.addEventListener('scroll', () => handleScrollShadows(card));
});

// ==========================================
// PAGINATION SYSTEM
// ==========================================
function calculatePagination(tableType) {
  const state = paginationState[tableType];
  const totalPages = Math.ceil(state.totalItems / state.pageSize);
  const startIdx = (state.currentPage - 1) * state.pageSize;
  const endIdx = startIdx + state.pageSize;
  return {
    totalPages,
    startIdx,
    endIdx,
    paginatedData: state.filteredData.slice(startIdx, endIdx)
  };
}

function renderPaginationControls(tableType) {
  const state = paginationState[tableType];
  const { totalPages } = calculatePagination(tableType);
  const paginationEl = document.getElementById(`${tableType}Pagination`);

  if (!paginationEl) return;

  if (state.totalItems === 0 || totalPages <= 1) {
    paginationEl.innerHTML = '';
    return;
  }

  let html = `
    <div class="pagination-info">
      Page ${state.currentPage} of ${totalPages} | 
      Total: ${state.totalItems} items
    </div>
    <div class="pagination-controls">
      <button class="pagination-btn" onclick="window.changePage('${tableType}', ${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>
        <i class="fa fa-chevron-left"></i> Prev
      </button>
  `;

  const maxButtons = 5;
  let startPage = Math.max(1, state.currentPage - 2);
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  
  if (endPage - startPage + 1 < maxButtons) {
    startPage = Math.max(1, endPage - maxButtons + 1);
  }

  if (startPage > 1) {
    html += `<button class="pagination-btn" onclick="window.changePage('${tableType}', 1)">1</button>`;
    if (startPage > 2) html += `<span class="pagination-ellipsis">...</span>`;
  }

  for (let i = startPage; i <= endPage; i++) {
    html += `
      <button class="pagination-btn ${i === state.currentPage ? 'active' : ''}" onclick="window.changePage('${tableType}', ${i})">
        ${i}
      </button>
    `;
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += `<span class="pagination-ellipsis">...</span>`;
    html += `<button class="pagination-btn" onclick="window.changePage('${tableType}', ${totalPages})">${totalPages}</button>`;
  }

  html += `
      <button class="pagination-btn" onclick="window.changePage('${tableType}', ${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''}>
        Next <i class="fa fa-chevron-right"></i>
      </button>
      <select class="page-size-select" onchange="window.changePageSize('${tableType}', this.value)">
        <option value="5" ${state.pageSize === 5 ? 'selected' : ''}>5 per page</option>
        <option value="10" ${state.pageSize === 10 ? 'selected' : ''}>10 per page</option>
        <option value="25" ${state.pageSize === 25 ? 'selected' : ''}>25 per page</option>
        <option value="50" ${state.pageSize === 50 ? 'selected' : ''}>50 per page</option>
      </select>
    </div>
  `;
  paginationEl.innerHTML = html;
}

window.changePage = function(tableType, pageNum) {
  const state = paginationState[tableType];
  const { totalPages } = calculatePagination(tableType);
  if (pageNum < 1 || pageNum > totalPages) return;
  state.currentPage = pageNum;
  updateTableDisplay(tableType);
};

window.changePageSize = function(tableType, newSize) {
  const state = paginationState[tableType];
  state.pageSize = parseInt(newSize);
  state.currentPage = 1;
  updateTableDisplay(tableType);
};

function updateTableDisplay(tableType) {
    const { paginatedData } = calculatePagination(tableType);
    const tableBodyId = `${tableType}Table`;
    const tableBody = document.getElementById(tableBodyId);

    if (!tableBody) return;

    if (paginatedData.length === 0) {
        tableBody.innerHTML =
            '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No items to display</td></tr>';
    } else {
        renderTableRows(tableType, paginatedData, tableBody);
    }

    renderPaginationControls(tableType);
}

function renderTableRows(tableType, data, tableBody) {
  tableBody.innerHTML = data.map(user => {
    const firstName = user.data.firstName || '';
    const lastName = user.data.surname || '';
    const email = user.data.email || '';
    const barangay = user.data.barangay || '';
    const position = user.data.position || '';
    const contact = user.data.phoneNumber || user.data.contact || '';
    const declinedDate = user.data.declinedAt
      ? new Date(user.data.declinedAt.toDate?.() || user.data.declinedAt).toLocaleDateString()
      : '';
    
    let actions = '';
    if (tableType === 'pending') {
      actions = `
        <button class="approve" onclick="window.approveUser('${user.id}')">Approve</button>
        <button class="decline" onclick="window.declineUser('${user.id}')">Decline</button>
      `;
    } else if (tableType === 'active') {
      actions = `
        <button class="edit" onclick="window.openEditModal('${user.id}')">Edit</button>
        <button class="inactive" onclick="window.inactivateUser('${user.id}')">Deactivate</button>
      `;
    } else if (tableType === 'inactive') {
      actions = `
        <button class="activate" onclick="window.activateUser('${user.id}')">Activate</button>
        <button class="decline" onclick="window.deleteUser('${user.id}')">Delete</button>
      `;
    } else if (tableType === 'declined') {
      actions = `
        <button class="approve" onclick="window.reapproveUser('${user.id}')">Reapprove</button>
        <button class="decline" onclick="window.permanentlyDeleteUser('${user.id}')">Delete</button>
      `;
    }

    const cols = tableType === 'declined' 
      ? `<td>${firstName}</td><td>${lastName}</td><td>${email}</td><td>${barangay}</td><td>${position}</td><td>${contact}</td><td>${declinedDate}</td><td>${actions}</td>`
      : `<td>${firstName}</td><td>${lastName}</td><td>${email}</td><td>${barangay}</td><td>${position}</td><td>${contact}</td><td>${actions}</td>`;

    return `<tr>${cols}</tr>`;
  }).join('');
}

function renderTable(tableBody, data, tableType) {
  const state = paginationState[tableType];
  state.filteredData = data;
  state.totalItems = data.length;
  state.currentPage = 1;
  updateTableDisplay(tableType);
}

// ==========================================
// USER MANAGEMENT FUNCTIONS
// ==========================================

// Helper
function getUserFullName(userData) {
    return `${userData.firstName || ""} ${userData.surname || ""}`.trim();
}

window.approveUser = async function (userId) {
    if (!confirm("Approve this user?")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), { status: "active" });

        await logAuditEvent(
            "User Approved",
            "status",
            "Users",
            `Approved user: ${userName}`,
            {
                beforeValue: "Pending",
                afterValue: "Active",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User approved!");
    } catch (err) {
        console.error("Error approving user:", err);
        alert("Error approving user.");
    }
};

window.declineUser = async function (userId) {
    if (!confirm("Decline this user?")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), {
            status: "declined",
            declinedAt: serverTimestamp()
        });

        await logAuditEvent(
            "User Declined",
            "status",
            "Users",
            `Declined user: ${userName}`,
            {
                beforeValue: "Pending",
                afterValue: "Declined",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User declined!");
    } catch (err) {
        console.error("Error declining user:", err);
        alert("Error declining user.");
    }
};

window.inactivateUser = async function (userId) {
    if (!confirm("Deactivate this user? They will not be able to login until reactivated.")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), { status: "inactive" });

        await logAuditEvent(
            "User Deactivated",
            "status",
            "Users",
            `Deactivated user: ${userName}`,
            {
                beforeValue: "Active",
                afterValue: "Inactive",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User deactivated! They will be automatically logged out and cannot login until reactivated.");
    } catch (err) {
        console.error("Error deactivating user:", err);
        alert("Error deactivating user.");
    }
};

window.deleteUser = async function (userId) {
    if (!confirm("Delete this user? They will be automatically logged out and cannot login again.")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), {
            status: "deleted",
            deletedAt: serverTimestamp()
        });

        await logAuditEvent(
            "User Deleted",
            "delete",
            "Users",
            `Deleted user: ${userName}`,
            {
                beforeValue: "Inactive",
                afterValue: "Deleted",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User deleted! They have been automatically logged out.");
    } catch (err) {
        console.error("Error deleting user:", err);
        alert("Error deleting user.");
    }
};

window.activateUser = async function (userId) {
    if (!confirm("Activate this user?")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), { status: "active" });

        await logAuditEvent(
            "User Activated",
            "status",
            "Users",
            `Activated user: ${userName}`,
            {
                beforeValue: "Inactive",
                afterValue: "Active",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User activated!");
    } catch (err) {
        console.error("Error activating user:", err);
        alert("Error activating user.");
    }
};

window.reapproveUser = async function (userId) {
    if (!confirm("Move this user back to pending for review?")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await updateDoc(doc(db, "users", userId), {
            status: "pending",
            declinedAt: null
        });

        await logAuditEvent(
            "User Moved to Pending",
            "status",
            "Users",
            `Moved declined user back to pending: ${userName}`,
            {
                beforeValue: "Declined",
                afterValue: "Pending",
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay
            }
        );

        alert("User moved to pending registrations.");
    } catch (err) {
        console.error("Error re-approving user:", err);
        alert("Error re-approving user.");
    }
};

window.permanentlyDeleteUser = async function (userId) {
    if (!confirm("PERMANENTLY DELETE this user? This action cannot be undone!")) return;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const userData = userDoc.data();
        const userName = getUserFullName(userData);

        await deleteDoc(doc(db, "users", userId));

        await logAuditEvent(
            "User Permanently Deleted",
            "delete",
            "Users",
            `Permanently deleted user: ${userName}`,
            {
                targetUserId: userId,
                targetUserEmail: userData.email,
                targetUserPosition: userData.position,
                barangay: userData.barangay,
                deletedUserData: JSON.stringify(userData)
            }
        );

        alert("User permanently deleted.");
    } catch (err) {
        console.error("Error deleting user:", err);
        alert("Error deleting user.");
    }
};

// ==========================================
// EDIT USER MODAL
// ==========================================

window.openEditModal = function (userId) {
    const user = allActiveUsers.find(u => u.id === userId);
    if (!user) return;

    document.getElementById('editUserId').value = userId;
    document.getElementById('editFirstName').value = user.data.firstName || "";
    document.getElementById('editLastName').value = user.data.surname || "";
    document.getElementById('editEmail').value = user.data.email || "";
    document.getElementById('editBarangay').value = user.data.barangay || "";
    document.getElementById('editPosition').value = user.data.position || "";
    document.getElementById('editContact').value = user.data.phoneNumber || user.data.contact || "";

    editModal.classList.add('show');
};

if (closeModal) closeModal.addEventListener('click', () => editModal.classList.remove('show'));
if (cancelEdit) cancelEdit.addEventListener('click', () => editModal.classList.remove('show'));

editForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const userId = document.getElementById('editUserId').value;

    try {
        const userDoc = await getDoc(doc(db, "users", userId));
        const oldData = userDoc.data();

        const newData = {
            firstName: document.getElementById('editFirstName').value,
            surname: document.getElementById('editLastName').value,
            email: document.getElementById('editEmail').value,
            barangay: document.getElementById('editBarangay').value,
            position: document.getElementById('editPosition').value,
            phoneNumber: document.getElementById('editContact').value
        };

        await updateDoc(doc(db, "users", userId), newData);

        const changes = [];
        if (oldData.firstName !== newData.firstName) changes.push(`First Name: "${oldData.firstName}" ‚Üí "${newData.firstName}"`);
        if (oldData.surname !== newData.surname) changes.push(`Last Name: "${oldData.surname}" ‚Üí "${newData.surname}"`);
        if (oldData.email !== newData.email) changes.push(`Email: "${oldData.email}" ‚Üí "${newData.email}"`);
        if (oldData.barangay !== newData.barangay) changes.push(`Barangay: "${oldData.barangay}" ‚Üí "${newData.barangay}"`);
        if (oldData.position !== newData.position) changes.push(`Position: "${oldData.position}" ‚Üí "${newData.position}"`);
        if ((oldData.phoneNumber || oldData.contact) !== newData.phoneNumber)
            changes.push(`Contact: "${oldData.phoneNumber || oldData.contact}" ‚Üí "${newData.phoneNumber}"`);

        await logAuditEvent(
            "User Updated",
            "edit",
            "Users",
            `Updated user: ${newData.firstName} ${newData.surname} - ${changes.join(", ")}`,
            {
                targetUserId: userId,
                targetUserEmail: newData.email,
                changes: changes.join(", "),
                beforeValue: JSON.stringify(oldData),
                afterValue: JSON.stringify(newData)
            }
        );

        alert("User updated successfully!");
        editModal.classList.remove('show');
    } catch (err) {
        console.error("Error updating user:", err);
        alert("Error updating user.");
    }
});

// ==========================================
// ADD USER MODAL - WITH FIREBASE AUTH
// ==========================================
const addUserModal = document.getElementById("addUserModal");
const closeAddModal = document.getElementById("closeAddModal");
const cancelAddUser = document.getElementById("cancelAddUser");
const addUserForm = document.getElementById("addUserForm");

window.openAddUserModal = function() {
  addUserModal.classList.add('show');
};

if (closeAddModal) closeAddModal.addEventListener('click', () => {
  addUserModal.classList.remove('show');
  addUserForm.reset();
});

if (cancelAddUser) cancelAddUser.addEventListener('click', () => {
  addUserModal.classList.remove('show');
  addUserForm.reset();
});

window.toggleAddPasswordVisibility = function() {
  const passwordInput = document.getElementById('addPassword');
  const icon = document.getElementById('toggleAddPassword').querySelector('i');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
};

window.generateStrongPassword = function() {
  const length = 16;
  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=';
  
  let password = '';
  const randomValues = new Uint32Array(length);
  window.crypto.getRandomValues(randomValues);
  
  // Ensure at least one of each required character type
  password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[randomValues[0] % 26];
  password += 'abcdefghijklmnopqrstuvwxyz'[randomValues[1] % 26];
  password += '0123456789'[randomValues[2] % 10];
  password += '!@#$%^&*()_+-='[randomValues[3] % 14];
  // Fill the rest randomly
for (let i = 4; i < length; i++) {
password += charset[randomValues[i] % charset.length];
}
// Shuffle the password
password = password.split('').sort(() => 0.5 - Math.random()).join('');
document.getElementById('addPassword').value = password;
document.getElementById('addPassword').type = 'text';
document.getElementById('toggleAddPassword').querySelector('i').classList.remove('fa-eye');
document.getElementById('toggleAddPassword').querySelector('i').classList.add('fa-eye-slash');
};
// ‚úÖ FIXED: Improved add user function with better error handling
addUserForm.addEventListener('submit', async (e) => {
e.preventDefault();
const firstName = document.getElementById('addFirstName').value.trim();
const lastName = document.getElementById('addLastName').value.trim();
const email = document.getElementById('addEmail').value.trim();
const barangay = document.getElementById('addBarangay').value.trim();
const position = document.getElementById('addPosition').value;
const contact = document.getElementById('addContact').value.trim();
const password = document.getElementById('addPassword').value;
console.log("üìù Adding new user with data:", {
firstName, lastName, email, barangay, position, contact
});
if (!password) {
alert('Please enter a password!');
return;
}
if (password.length < 8) {
alert('Password must be at least 8 characters long!');
return;
}
const currentUser = auth.currentUser;
if (!currentUser) {
alert("You must be logged in to add users");
return;
}
try {
// Hash the password (if you're using CryptoJS)
const hashedPassword = typeof CryptoJS !== 'undefined'
? CryptoJS.SHA256(password).toString()
: password;
// Create Firebase Auth account using secondary app
console.log("üîß Creating secondary Firebase app...");
const secondaryApp = initializeApp(firebaseConfig, "Secondary-" + Date.now());
const secondaryAuth = getAuth(secondaryApp);

console.log("üë§ Creating Firebase Auth account...");
const userCredential = await createUserWithEmailAndPassword(
  secondaryAuth, 
  email, 
  password
);

const newUid = userCredential.user.uid;
console.log("‚úÖ Auth account created with UID:", newUid);

// Sign out from secondary app and clean up
await signOut(secondaryAuth);
await deleteApp(secondaryApp);
console.log("üßπ Secondary app cleaned up");

// Create user document in Firestore with the Auth UID
const userRef = doc(db, "users", newUid);

const userData = {
  firstName,
  surname: lastName,
  email,
  barangay,
  position,
  phoneNumber: contact,
  password: password,
  hashedPassword: hashedPassword,
  status: "active",
  role: "Official",
  createdAt: serverTimestamp()
};

console.log("üíæ Creating Firestore document with data:", userData);
await setDoc(userRef, userData);
console.log("‚úÖ Firestore document created successfully");

await logAuditEvent(
  "Barangay Official Added",
  "add",
  "Users",
  `Added new barangay official: ${firstName} ${lastName}`,
  {
    targetUserEmail: email,
    targetUserPosition: position,
    targetUserId: newUid,
    barangay: barangay
  }
);

addUserModal.classList.remove('show');
addUserForm.reset();

alert(`‚úÖ Barangay Official added successfully!\n\nFirebase Auth account created.\nUID: ${newUid}\n\nLogin Credentials:\nEmail: ${email}\nPassword: ${password}\n\nPlease save these credentials securely and share them with the official.`);
} catch (err) {
console.error("‚ùå Error adding user:", err);
if (err.code === 'auth/email-already-in-use') {
  alert("Error: This email is already registered. Please use a different email address.");
} else if (err.code === 'auth/weak-password') {
  alert("Error: The password is too weak. Please use a stronger password (at least 6 characters).");
} else if (err.code === 'auth/invalid-email') {
  alert("Error: Invalid email format.");
} else {
  alert("Error adding user: " + err.message);
}
}
});
// ==========================================
// NOTIFICATION SYSTEM
// ==========================================
async function setupRealtimeNotifications() {
if (!localStorage.getItem('notifications')) {
localStorage.setItem('notifications', '[]');
}
let allNotifications = [];
// LISTEN TO REPORTS
const reportsRef = collection(db, "reports");
const reportsQuery = query(reportsRef, orderBy("createdAt", "desc"), limit(50));
onSnapshot(reportsQuery, (snapshot) => {
const reportNotifications = [];
snapshot.forEach((docSnap) => {
  const data = docSnap.data();
  
  let timestamp;
  if (data.createdAt && typeof data.createdAt.toDate === 'function') {
    timestamp = data.createdAt.toDate();
  } else if (data.timestamp && typeof data.timestamp === 'string') {
    timestamp = new Date(data.timestamp.replace(' ', 'T'));
  } else if (data.createdAt) {
    timestamp = new Date(data.createdAt);
  } else {
    timestamp = new Date();
  }
  
  const category = data.category || 'Report';
  const issue = data.issue || '';
  const barangay = data.barangay || data.userBarangay || 'Unknown Location';
  const status = data.status || 'Pending';
  const firstName = data.firstName || 'User';
  
  let title = `New ${category} Report`;
  let message = `${firstName} reported ${issue} in Brgy. ${barangay}`;
  
  if (status.toLowerCase() === 'repaired' || status.toLowerCase() === 'completed') {
    title = `‚úì ${category} Completed`;
    message = `${issue} in Brgy. ${barangay} has been ${status.toLowerCase()}`;
  } else if (status.toLowerCase() === 'ongoing') {
    title = `‚öô ${category} In Progress`;
    message = `${issue} in Brgy. ${barangay} is now ${status.toLowerCase()}`;
  }
  
  reportNotifications.push({
    id: 'report_' + docSnap.id,
    type: 'report',
    title: title,
    message: message,
    timestamp: timestamp.toISOString(),
    read: false,
    status: status,
    category: category,
    barangay: barangay,
    data: data
  });
});

allNotifications = [...reportNotifications, ...allNotifications.filter(n => n.type === 'user')];
allNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

const existingNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
allNotifications = allNotifications.map(notification => {
  const existing = existingNotifications.find(n => n.id === notification.id);
  if (existing) {
    notification.read = existing.read;
  }
  return notification;
});

localStorage.setItem('notifications', JSON.stringify(allNotifications));
updateNotificationUI();
});
// LISTEN TO USERS
const usersRef = collection(db, "users");
const usersQuery = query(usersRef, orderBy("createdAt", "desc"), limit(50));
onSnapshot(usersQuery, (snapshot) => {
const userNotifications = [];
snapshot.forEach((docSnap) => {
  const data = docSnap.data();
  
  let timestamp;
  if (data.createdAt && typeof data.createdAt === 'number') {
    timestamp = new Date(data.createdAt);
  } else if (data.createdAt && typeof data.createdAt.toDate === 'function') {
    timestamp = data.createdAt.toDate();
  } else {
    timestamp = new Date();
  }
  
  const fullName = data.fullName || `${data.firstName || ''} ${data.surname || ''}`.trim() || 'New User';
  const position = data.position || 'User';
  const barangay = data.barangay || 'Unknown Barangay';
  const status = data.status || 'active';
  
  let title = `‚úì New User Active`;
  let message = `${fullName} (${position}) from Brgy. ${barangay}`;
  
  if (status === 'inactive') {
    title = `User Deactivated`;
    message = `${fullName} account is now inactive`;
  }
  
  userNotifications.push({
    id: 'user_' + docSnap.id,
    type: 'user',
    title: title,
    message: message,
    timestamp: timestamp.toISOString(),
    read: false,
    status: status,
    position: position,
    barangay: barangay,
    data: data
  });
});

allNotifications = [...allNotifications.filter(n => n.type === 'report'), ...userNotifications];
allNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

const existingNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
allNotifications = allNotifications.map(notification => {
  const existing = existingNotifications.find(n => n.id === notification.id);
  if (existing) {
    notification.read = existing.read;
  }
  return notification;
});

localStorage.setItem('notifications', JSON.stringify(allNotifications));
updateNotificationUI();
});
console.log("‚úÖ Notifications active");
}
function updateNotificationUI() {
const notificationsStr = localStorage.getItem('notifications') || '[]';
let notifications = [];
try {
notifications = JSON.parse(notificationsStr);
} catch (e) {
console.error('Error parsing notifications:', e);
notifications = [];
}
const activeFilterBtn = document.querySelector('.filter-btn.active');
const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
let filteredNotifications = filterNotifications(notifications, activeFilter);
const unreadCount = notifications.filter(n => n && n.read === false).length;
const badge = document.getElementById('notificationBadge');
if (badge) {
badge.textContent = unreadCount;
if (unreadCount > 0) {
badge.classList.add('show');
} else {
badge.classList.remove('show');
}
}
const notificationList = document.getElementById('notificationList');
if (!notificationList) return;
if (filteredNotifications.length === 0) {
notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
return;
}
notificationList.innerHTML = filteredNotifications.map(notification => {
if (!notification) return '';
const timeAgo = getTimeAgo(notification.timestamp);
const unreadClass = notification.read ? '' : 'unread';
const title = notification.title || 'Notification';
const message = notification.message || 'No details';
const id = notification.id || '';

let iconClass = 'report';
let iconName = 'fa-exclamation-triangle';

if (notification.type === 'user') {
  iconClass = 'user';
  iconName = notification.status === 'inactive' ? 'fa-user-slash' : 'fa-user-plus';
} else if (notification.type === 'report') {
  const status = (notification.status || '').toLowerCase();
  if (status === 'repaired' || status === 'completed') {
    iconName = 'fa-check-circle';
  } else if (status === 'ongoing') {
    iconName = 'fa-tools';
  }
}

return `
  <div class="notification-item ${unreadClass}" data-id="${id}">
    <div class="notification-icon ${iconClass}">
      <i class="fa ${iconName}"></i>
    </div>
    <div class="notification-content">
      <p><strong>${title}</strong></p>
      <p>${message}</p>
      <div class="time">${timeAgo}</div>
    </div>
  </div>
`;
}).filter(html => html !== '').join('');
document.querySelectorAll('.notification-item').forEach(item => {
item.addEventListener('click', () => {
const id = item.dataset.id;
if (id) markAsRead(id);
});
});
}
function filterNotifications(notifications, filter) {
const now = new Date();
const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
switch(filter) {
case 'report':
return notifications.filter(n => n.type === 'report');
case 'user':
return notifications.filter(n => n.type === 'user');
case '24h':
return notifications.filter(n => new Date(n.timestamp) > oneDayAgo);
default:
return notifications;
}
}
function markAsRead(notificationId) {
const notificationsStr = localStorage.getItem('notifications') || '[]';
let notifications = JSON.parse(notificationsStr);
const notification = notifications.find(n => n.id === notificationId);
if (notification) {
notification.read = true;
localStorage.setItem('notifications', JSON.stringify(notifications));
updateNotificationUI();
}
}
function markAllAsRead() {
const notificationsStr = localStorage.getItem('notifications') || '[]';
let notifications = JSON.parse(notificationsStr);
notifications.forEach(n => n.read = true);
localStorage.setItem('notifications', JSON.stringify(notifications));
updateNotificationUI();
}
function clearAllNotifications() {
if (confirm('Are you sure you want to clear all notifications?')) {
localStorage.setItem('notifications', '[]');
updateNotificationUI();
}
}
function getTimeAgo(date) {
  if (!date) return 'Recently';
  
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  if (isNaN(dateObj.getTime())) return 'Recently';
  
  const seconds = Math.floor((new Date() - dateObj) / 1000);
  if (seconds < 0) return 'Just now';

  const intervals = {
    year: 31536000,
    month: 2592000,
    week: 604800,
    day: 86400,
    hour: 3600,
    minute: 60
  };

  for (const [unit, secondsInUnit] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / secondsInUnit);
    if (interval >= 1) {
      // ‚úÖ FIX: Properly close the return statement with backticks
      return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
    }
  }

  return 'Just now';
}
function initNotificationListeners() {
const notificationBell = document.getElementById('notificationBell');
const notificationMenu = document.getElementById('notificationMenu');
const profileToggle = document.getElementById('profileToggle');
const dropdownMenu = document.getElementById('dropdownMenu');
if (notificationBell && notificationMenu) {
notificationBell.addEventListener('click', (e) => {
e.stopPropagation();
notificationMenu.classList.toggle('show');
if (dropdownMenu) dropdownMenu.classList.remove('show');
});
}
document.querySelectorAll('.filter-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
updateNotificationUI();
});
});
const markAllBtn = document.getElementById('markAllReadBtn');
if (markAllBtn) {
markAllBtn.addEventListener('click', (e) => {
e.stopPropagation();
markAllAsRead();
});
}
const clearBtn = document.getElementById('clearNotificationsBtn');
if (clearBtn) {
clearBtn.addEventListener('click', (e) => {
e.stopPropagation();
clearAllNotifications();
});
}
if (profileToggle && dropdownMenu) {
profileToggle.addEventListener('click', (e) => {
e.stopPropagation();
dropdownMenu.classList.toggle('show');
if (notificationMenu) notificationMenu.classList.remove('show');
});
}
window.addEventListener('click', (e) => {
if (dropdownMenu && !e.target.closest('.profile-dropdown')) {
dropdownMenu.classList.remove('show');
}
if (notificationMenu && !e.target.closest('.notification-menu') && e.target !== notificationBell) {
notificationMenu.classList.remove('show');
}
});
}
// ==========================================
// REALTIME DATA LISTENERS - WITH DEBUG LOGGING
// ==========================================
try {
console.log("üîÑ Setting up real-time listeners...");
// Pending users
const qPending = query(
    collection(db, "users"),
    where("status", "==", "pending")
);

onSnapshot(qPending, (snapshot) => {
    console.log("üìä Pending users snapshot - Total docs:", snapshot.size);
    allPendingUsers = [];

    snapshot.forEach((docSnap) => {
        const u = docSnap.data();
        console.log("  üë§ Pending user:", u.firstName, u.surname, "Position:", u.position);
        
        if (isBarangayPosition(u.position)) {
            allPendingUsers.push({ id: docSnap.id, data: u });
        }
    });

    console.log("‚úÖ Total pending barangay users:", allPendingUsers.length);

    if (pendingCountEl) {
        pendingCountEl.textContent = allPendingUsers.length;
    }

    renderTable(
        pendingTable,
        sortByBarangay(allPendingUsers),
        "pending"
    );
});

// Active users
const qActive = query(
    collection(db, "users"),
    where("status", "==", "active")
);

onSnapshot(qActive, (snapshot) => {
    console.log("üìä Active users snapshot - Total docs:", snapshot.size);
    allActiveUsers = [];

    snapshot.forEach((docSnap) => {
        const u = docSnap.data();
        console.log("  üë§ Active user:", u.firstName, u.surname, "Position:", u.position);
        
        if (isBarangayPosition(u.position)) {
            allActiveUsers.push({ id: docSnap.id, data: u });
            console.log("    ‚úÖ Added to active list");
        } else {
            console.log("    ‚ö†Ô∏è Filtered out - not a barangay position");
        }
    });

    console.log("‚úÖ Total active barangay users:", allActiveUsers.length);

    if (activeCountEl) {
        activeCountEl.textContent = allActiveUsers.length;
    }

    renderTable(activeTable, sortByBarangay(allActiveUsers), "active");
});

// Inactive users
const qInactive = query(
    collection(db, "users"),
    where("status", "==", "inactive")
);

onSnapshot(qInactive, (snapshot) => {
    console.log("üìä Inactive users snapshot - Total docs:", snapshot.size);
    allInactiveUsers = [];

    snapshot.forEach((docSnap) => {
        const u = docSnap.data();
        console.log("  üë§ Inactive user:", u.firstName, u.surname, "Position:", u.position);
        
        if (isBarangayPosition(u.position)) {
            allInactiveUsers.push({ id: docSnap.id, data: u });
        }
    });

    console.log("‚úÖ Total inactive barangay users:", allInactiveUsers.length);

    if (inactiveCountEl) {
        inactiveCountEl.textContent = allInactiveUsers.length;
    }

    renderTable(inactiveTable, sortByBarangay(allInactiveUsers), "inactive");
});

// Declined users
const qDeclined = query(
    collection(db, "users"),
    where("status", "==", "declined")
);

onSnapshot(qDeclined, (snapshot) => {
    console.log("üìä Declined users snapshot - Total docs:", snapshot.size);
    allDeclinedUsers = [];

    snapshot.forEach((docSnap) => {
        const u = docSnap.data();
        console.log("  üë§ Declined user:", u.firstName, u.surname, "Position:", u.position);
        
        if (isBarangayPosition(u.position)) {
            allDeclinedUsers.push({ id: docSnap.id, data: u });
        }
    });

    console.log("‚úÖ Total declined barangay users:", allDeclinedUsers.length);

    if (declinedCountEl) {
        declinedCountEl.textContent = allDeclinedUsers.length;
    }

    renderTable(declinedTable, sortByBarangay(allDeclinedUsers), "declined");
});

console.log("‚úÖ All real-time listeners set up successfully");
} catch (err) {
console.error("‚ùå Error setting up collections:", err);
}
// ==========================================
// SEARCH FUNCTIONALITY
// ==========================================
if (searchPending) {
searchPending.addEventListener('input', (e) => {
const filtered = filterUsers(e.target.value.toLowerCase(), allPendingUsers);
renderTable(pendingTable, sortByBarangay(filtered), 'pending');
});
}
if (searchActive) {
searchActive.addEventListener('input', (e) => {
const filtered = filterUsers(e.target.value.toLowerCase(), allActiveUsers);
renderTable(activeTable, sortByBarangay(filtered), 'active');
});
}
if (searchInactive) {
searchInactive.addEventListener('input', (e) => {
const filtered = filterUsers(e.target.value.toLowerCase(), allInactiveUsers);
renderTable(inactiveTable, sortByBarangay(filtered), 'inactive');
});
}
if (searchDeclined) {
searchDeclined.addEventListener('input', (e) => {
const filtered = filterUsers(e.target.value.toLowerCase(), allDeclinedUsers);
renderTable(declinedTable, sortByBarangay(filtered), 'declined');
});
}
// ==========================================
// AUTHENTICATION
// ==========================================
onAuthStateChanged(auth, async (user) => {
if (!user) {
window.location.href = "index.html";
return;
}
try {
const userDocRef = doc(db, "users", user.uid);
onSnapshot(userDocRef, async (userDocSnap) => {
  if (!userDocSnap.exists()) {
    window.location.href = "index.html";
    return;
  }

  const data = userDocSnap.data();
  const normalizedPosition = normalizePosition(data.position);
  
  // ‚úÖ Allow both Admin and Super Admin
  if (normalizedPosition !== "admin" && normalizedPosition !== "super admin") {
    alert("Unauthorized access!");
    await signOut(auth);
    window.location.href = "index.html";
    return;
  }
  
  const displayName = data.name || data.firstName || "Admin";
  const photoURL = data.profilePic || data.photoURL || "image.png";
  
  if (navUsername) navUsername.textContent = displayName;
  if (navAvatar) navAvatar.src = photoURL;
});

initNotificationListeners();
await setupRealtimeNotifications();

console.log("‚úÖ Authentication and initialization complete");
} catch (err) {
console.error("‚ùå Auth error:", err);
window.location.href = "index.html";
}
});
// ==========================================
// LOGOUT WITH AUDIT LOGGING
// ==========================================
const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
logoutBtn.addEventListener("click", async () => {
if (!confirm("Are you sure you want to logout?")) return;
try {
  await logAuditEvent(
    "Logged Out",
    "logout",
    "Authentication",
    "Admin logged out from the system"
  );
  
  await signOut(auth);
  window.location.href = "index.html";
} catch (err) {
  console.error("‚ùå Logout error:", err);
}
});
}
console.log("‚úÖ Script loaded successfully");
</script>
</body>
</html>
