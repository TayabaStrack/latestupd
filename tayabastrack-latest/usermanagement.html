<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0"/>
  <title>Super Admin User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow: auto; zoom: 1.0;  }
    
    .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; flex-shrink: 0; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: left 0.3s; overflow-y: auto; }
    .sidebar-header { display: flex; align-items: center; justify-content: flex-start; gap: 12px; margin-bottom: 2rem; padding: 0 1rem; }
    .sidebar-header img { width: 50px; height: 50px; object-fit: contain; }
    .sidebar-header h2 { font-size: 1.3rem; font-weight: 600; margin: 0; }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin: 0.5rem 0; }
    .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1.5rem; text-decoration: none; color: #fff; transition: background 0.3s; border-left: 4px solid transparent; }
    .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }
    
    .sidebar-submenu {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.1);
    }
    .sidebar-submenu.open {
      max-height: 500px;
    }
    .sidebar-submenu li {
      margin: 0;
    }
    .sidebar-submenu a {
      padding: 0.6rem 1.5rem 0.6rem 3rem !important;
      font-size: 0.9rem;
      border-left: 4px solid transparent;
    }
    .sidebar-submenu li.active a {
      background: #042f68;
      border-left: 4px solid #fff;
    }
    .has-submenu > a {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .has-submenu > a .fa-chevron-down {
      transition: transform 0.3s ease;
      margin-left: auto;
    }
    
    .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
    .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .logout-btn:hover { background-color: #c9302c; }
    
    .dashboard-main { flex: 1; display: flex; flex-direction: column; min-width: 0; margin-left: 240px; height: 100vh; overflow: hidden; transition: margin-left 0.3s; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 100; }
    .navbar-left { display: flex; align-items: center; gap: 1rem; }
    .navbar h1 { font-size: 1.4rem; color: #004aad; white-space: nowrap; }
    .mobile-menu-btn { display: none; background: none; border: none; color: #004aad; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }

    .profile { display: flex; align-items: center; gap: 1rem; position: relative; flex-shrink: 0; }
    .profile .fa-bell { font-size: 1.2rem; cursor: pointer; position: relative; color: #333; }
    .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 18px; text-align: center; }
    .badge.show { display: flex; align-items: center; justify-content: center; }
    .avatar { width: 35px; height: 35px; border-radius: 50%; flex-shrink: 0; object-fit: cover; border: 2px solid #004aad; }
    .username { font-weight: 500; white-space: nowrap; color: #333; }
    .profile-dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 8px; transition: background 0.2s; }
    .profile-dropdown:hover { background: #f5f7fb; }
    
    .notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); width: 340px; max-height: 420px; overflow: hidden; z-index: 1000; font-family: "Segoe UI", Tahoma, sans-serif; animation: fadeIn 0.2s ease-in-out; }
    .notification-menu.show { display: block; }

    .notification-header { padding: 0.9rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
    .notification-header h3 { font-size: 1rem; color: #333; margin: 0; font-weight: 600; }
    .notification-actions { display: flex; gap: 0.5rem; align-items: center; }
    .action-icon-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.3rem; transition: color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .action-icon-btn:hover { color: #004aad; }
    .action-icon-btn i { font-size: 0.95rem; }

    .notification-filters { display: flex; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; background: #fafafa; }
    .filter-btn { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.8rem; background: #f2f2f2; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.25s ease; color: #333; }
    .filter-btn:hover { background: #004aad; color: #fff; }
    .filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }

    .notification-list { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ccc transparent; }
    .notification-list::-webkit-scrollbar { width: 6px; }
    .notification-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .notification-list::-webkit-scrollbar-track { background: transparent; }

    .notification-item { padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; align-items: flex-start; transition: background 0.2s; position: relative; }
    .notification-item:hover { background: #f5f7ff; }
    .notification-item.unread { background: #f0f7ff; }
    .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: #004aad; border-radius: 0 4px 4px 0; }
    .notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
    .notification-icon.user { background: #e3f2fd; color: #1976d2; }
    .notification-icon.report { background: #fff3e0; color: #f57c00; }
    .notification-content { flex: 1; }
    .notification-content p { margin: 0; font-size: 0.86rem; color: #333; line-height: 1.3; }
    .notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.25rem; }
    .notification-empty { padding: 2rem; text-align: center; color: #999; font-size: 0.9rem; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    .dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 10000; }
    .dropdown-menu.show { display: block; }
    .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.9rem; transition: background 0.2s; }
    .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
    .dropdown-menu a i { margin-right: 8px; width: 20px; text-align: center; }
    
    .user-section { padding: 1.5rem; flex: 1; overflow-y: auto; overflow-x: hidden; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px; }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-left: auto; }
    .actions button { background: #004aad; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .actions button:hover { background: #005ce6; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3); }
    .actions input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; }

    .view-toggle-container { display: flex; justify-content: center; margin-bottom: 1.5rem; }
    .view-toggle { position: relative; display: inline-flex; background: #e8eef5; border-radius: 50px; padding: 4px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.1); }
    .view-toggle-btn { position: relative; z-index: 2; padding: 0.7rem 2rem; border: none; background: transparent; color: #666; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: color 0.3s ease; border-radius: 50px; display: flex; align-items: center; gap: 0.5rem; }
    .view-toggle-btn.active { color: #fff; }
    .view-toggle-btn i { font-size: 1rem; }
    .slider-bg { position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); border-radius: 50px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 10px rgba(0, 74, 173, 0.4); z-index: 1; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 5000; padding: 1rem; }
    .modal-content { background: #fff; padding: 1.5rem; border-radius: 12px; border: 3px solid #004aad; width: 520px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .modal-content h2 { margin-bottom: 1.2rem; color: #004aad; text-align: center; font-size: 1.4rem; }
    .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
    .form-group label { font-weight: 600; margin-bottom: 0.4rem; color: #333; font-size: 0.9rem; }
    .form-group input, .form-group select { padding: 0.65rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #004aad; background: #fff; box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1); }
    
    .password-section { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .password-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.8rem; }
    .password-header label { font-weight: 600; color: #004aad; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .password-input-wrapper { position: relative; margin-bottom: 0.5rem; }
    .password-input-wrapper input { width: 100%; padding: 0.65rem 100px 0.65rem 0.65rem; font-family: 'Courier New', monospace; letter-spacing: 1px; font-size: 0.9rem; border: 1px solid #ddd; background: #fff; border-radius: 6px; }
    .password-input-wrapper input:focus { outline: none; border-color: #004aad; box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1); }
    .password-actions { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 0.3rem; align-items: center; }
    .toggle-password, .suggest-password { color: #666; cursor: pointer; font-size: 0.9rem; transition: color 0.2s; background: none; border: none; padding: 0; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
    .toggle-password:hover, .suggest-password:hover { color: #004aad; }
    .suggest-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; border: none; padding: 0.5rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 0.4rem; white-space: nowrap; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3); }
    .suggest-btn:hover { background: linear-gradient(135deg, #218838 0%, #1aa179 100%); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(40, 167, 69, 0.5); }
    .password-hint { font-size: 0.75rem; color: #666; margin-top: 0.3rem; font-style: italic; }
    
    .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.8rem; padding-top: 1rem; border-top: 2px solid #e0e0e0; }
    .modal-actions button { border: none; padding: 0.65rem 1.8rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s; }
    .cancel-btn { background: #6c757d; color: #fff; }
    .cancel-btn:hover { background: #5a6268; transform: translateY(-1px); box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3); }
    .save-btn { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); color: #fff; box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3); }
    .save-btn:hover { background: linear-gradient(135deg, #003d8f 0%, #0052a3 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 74, 173, 0.5); }

    .table-wrapper { margin-top: 1rem; }
    .table-card { overflow-x: auto; overflow-y: hidden; border-radius: 10px; background: #fff; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); scroll-behavior: smooth; position: relative; }
    .table-card::-webkit-scrollbar { height: 10px; }
    .table-card::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); border-radius: 5px; }

    table { width: 100%; border-collapse: collapse; table-layout: auto; min-width: 1200px; }
    thead { background: #f5f8fb; color: #333; }
    thead th { font-weight: 700; padding: 0.8rem 0.75rem; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 0.9rem; }
    th, td { text-align: left; padding: 0.7rem 0.8rem; font-size: 0.85rem; border-bottom: 1px solid #f0f2f5; overflow: visible; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #fbfdff; }
    tbody tr:hover { background: #f1f8ff; }

    th:nth-child(1), td:nth-child(1) { min-width: 150px; }
    th:nth-child(2), td:nth-child(2) { min-width: 150px; }
    th:nth-child(3), td:nth-child(3) { min-width: 250px; }
    th:nth-child(4), td:nth-child(4) { min-width: 200px; }
    th:nth-child(5), td:nth-child(5) { min-width: 160px; }
    th:nth-child(6), td:nth-child(6) { min-width: 120px; }
    th:nth-child(7), td:nth-child(7) { min-width: 200px; }

    td button { padding: 0.4rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 4px; transition: all 0.2s; font-weight: 500; }
    td button:first-child { background: #004aad; color: #fff; }
    td button:first-child:hover { background: #003d8f; transform: translateY(-1px); }
    td button:nth-child(2) { background: #17a2b8; color: #fff; }
    td button:nth-child(2):hover { background: #138496; transform: translateY(-1px); }
    td button:last-child { background: #d9534f; color: #fff; }
    td button:last-child:hover { background: #c9302c; transform: translateY(-1px); }

    .status-badge { display: inline-block; padding: 5px 14px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-align: center; }
    .status-pending { background: #ffc107; color: #fff; }
    .status-active { background: #007bff; color: #fff; }
    .status-inactive { background: #dc3545; color: #fff; }

    .user-section h3 { margin: 1.5rem 0 0.8rem 0; color: #004aad; font-size: 1.15rem; display: flex; align-items: center; gap: 0.5rem; }
    .user-section h3 i { font-size: 1.1rem; }

    .view-section { display: none; }
    .view-section.active { display: block; }

    .view-only-cell { color: #17a2b8; font-weight: 600; font-size: 0.85rem; }

    /* Pagination styles */
    .pagination-wrapper { margin-top: 1rem; }
    .pagination-container { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f9f9f9; border-radius: 8px; flex-wrap: wrap; gap: 1rem; }
    .pagination-controls { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .pagination-btn { padding: 0.5rem 0.8rem; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; font-weight: 500; }
    .pagination-btn:hover:not(:disabled) { background: #004aad; color: #fff; border-color: #004aad; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination-btn.active { background: #004aad; color: #fff; border-color: #004aad; }
    .pagination-info { font-size: 0.85rem; color: #666; white-space: nowrap; }
    .page-size-select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.85rem; }

    @media (max-width: 980px) {
      .sidebar { left: -240px; }
      .sidebar.mobile-open { left: 0; }
      .dashboard-main { margin-left: 0; }
      .mobile-menu-btn { display: block !important; }
      .navbar h1 { font-size: 1.1rem; }
      .actions { width: 100%; }
      .actions input { flex: 1; }
      .view-toggle-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logo.png" alt="Logo" class="logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
        <li class="active"><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
        <li class="has-submenu">
          <a href="#" onclick="toggleSubmenu(event)">
            <span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
            <i class="fa fa-chevron-down"></i>
          </a>
          <ul class="sidebar-submenu">
            <li><a href="reports-pending.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
            <li><a href="reports-ongoing.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
            <li><a href="reports-completed.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
            <li><a href="reports-declined.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
          </ul>
        </li>
        <li><a href="auditlogs.html"><i class="fa fa-clipboard-list"></i>&nbsp; Audit Logs</a></li>
      </ul>
    </div>  
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <div class="dashboard-main">
    <nav class="navbar">
      <div class="navbar-left">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
          <i class="fa fa-bars"></i>
        </button>
        <h1>Super Admin - User Management</h1>
      </div>
      <div class="profile">
        <div style="position: relative;">
          <i class="fa fa-bell" id="notificationBell"></i>
          <span class="badge" id="notificationBadge">0</span>
          <div class="notification-menu" id="notificationMenu">
            <div class="notification-header">
              <h3>Notifications</h3>
              <div class="notification-actions">
                <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read">
                  <i class="fa fa-check-double"></i>
                </button>
                <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all">
                  <i class="fa fa-trash-alt"></i>
                </button>
              </div>
            </div>
            <div class="notification-filters">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="report">Reports</button>
              <button class="filter-btn" data-filter="user">Users</button>
              <button class="filter-btn" data-filter="24h">Last 24h</button>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="notification-empty">No new notifications</div>
            </div>
          </div>
        </div>
        <div class="profile-dropdown" id="profileToggle">
          <img src="image.png" alt="Profile" class="avatar" id="navbarAvatar" />
          <span class="username" id="navUsername">---</span>
          <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#666;"></i>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
            <a href="#" id="dropdownLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="user-section">
      <div class="header">
        <div class="view-toggle-container" style="margin: 0;">
          <div class="view-toggle">
            <div class="slider-bg" id="sliderBg"></div>
            <button class="view-toggle-btn active" id="adminBtn" onclick="switchView('admin')">
              <i class="fa fa-user-shield"></i> ADMINS
            </button>
            <button class="view-toggle-btn" id="officialBtn" onclick="switchView('official')">
              <i class="fa fa-users"></i> BARANGAY OFFICIALS
            </button>
          </div>
        </div>
        <div class="actions">
          <button onclick="openAddModal()">
            <i class="fa fa-user-plus"></i> Add User
          </button>
          <input type="text" id="searchInput" placeholder="Search user" oninput="searchUser()"/>
        </div>
      </div>

      <div id="adminsView" class="view-section active">
        <h3><i class="fa fa-clock"></i> Pending Admins</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingAdmins"></tbody>
            </table>
          </div>
          <div class="pagination-wrapper">
            <div class="pagination-container" id="paginationPending">
              <div class="pagination-info" id="infoPending"></div>
              <div class="pagination-controls" id="controlsPending"></div>
              <select class="page-size-select" onchange="setPageSize('pending', this.value)">
                <option value="5">5 per page</option>
                <option value="10" selected>10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
              </select>
            </div>
          </div>
        </div>
        <h3><i class="fa fa-check-circle"></i> Active Admins</h3>
    <div class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="activeAdmins"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div class="pagination-container" id="paginationActive">
          <div class="pagination-info" id="infoActive"></div>
          <div class="pagination-controls" id="controlsActive"></div>
          <select class="page-size-select" onchange="setPageSize('active', this.value)">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>

    <h3><i class="fa fa-times-circle"></i> Inactive Admins</h3>
    <div class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="inactiveAdmins"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div class="pagination-container" id="paginationInactive">
          <div class="pagination-info" id="infoInactive"></div>
          <div class="pagination-controls" id="controlsInactive"></div>
          <select class="page-size-select" onchange="setPageSize('inactive', this.value)">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="officialsView" class="view-section">
    <h3><i class="fa fa-check-circle"></i> Active Barangay Officials</h3>
    <div class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Access</th>
            </tr>
          </thead>
          <tbody id="activeOfficials"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div class="pagination-container" id="paginationActiveOfficials">
          <div class="pagination-info" id="infoActiveOfficials"></div>
          <div class="pagination-controls" id="controlsActiveOfficials"></div>
          <select class="page-size-select" onchange="setPageSize('activeOfficials', this.value)">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>

    <h3><i class="fa fa-times-circle"></i> Inactive Barangay Officials</h3>
    <div class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Barangay</th>
              <th>Position</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Access</th>
            </tr>
          </thead>
          <tbody id="inactiveOfficials"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div class="pagination-container" id="paginationInactiveOfficials">
          <div class="pagination-info" id="infoInactiveOfficials"></div>
          <div class="pagination-controls" id="controlsInactiveOfficials"></div>
          <select class="page-size-select" onchange="setPageSize('inactiveOfficials', this.value)">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h2 id="modalTitle"><i class="fa fa-user-plus"></i> Add User</h2>
      <form id="addUserForm">
        <div class="form-group">
          <label><i class="fa fa-user"></i> First Name</label>
          <input type="text" id="firstName" placeholder="Enter first name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-user"></i> Last Name</label>
          <input type="text" id="lastName" placeholder="Enter last name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-id-card"></i> Full Name</label>
          <input type="text" id="name" placeholder="Enter full name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-envelope"></i> Email</label>
          <input type="email" id="email" placeholder="Enter email address" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-map-marker-alt"></i> Barangay</label>
          <select id="barangay" required>
            <option value="">Select Barangay</option>
            <option value="Alitao">Alitao</option>
            <option value="Alsam Ibaba">Alsam Ibaba</option>
            <option value="Alsam Ilaya">Alsam Ilaya</option>
            <option value="Alupay">Alupay</option>
            <option value="Angeles Zone I (Poblacion)">Angeles Zone I (Poblacion)</option>
            <option value="Angeles Zone II">Angeles Zone II</option>
            <option value="Angeles Zone III">Angeles Zone III</option>
            <option value="Angeles Zone IV">Angeles Zone IV</option>
            <option value="Angustias Zone I (Poblacion)">Angustias Zone I (Poblacion)</option>
            <option value="Angustias Zone II">Angustias Zone II</option>
            <option value="Angustias Zone III">Angustias Zone III</option>
            <option value="Angustias Zone IV">Angustias Zone IV</option>
            <option value="Anos">Anos</option>
            <option value="Ayaas">Ayaas</option>
            <option value="Baguio">Baguio</option>
            <option value="Banilad">Banilad</option>
            <option value="Ibabang Bukal">Ibabang Bukal</option>
            <option value="Ilayang Bukal">Ilayang Bukal</option>
            <option value="Calantas">Calantas</option>
            <option value="Calumpang">Calumpang</option>
            <option value="Camaysa">Camaysa</option>
            <option value="Dapdap">Dapdap</option>
            <option value="Kanlurang Domoit">Kanlurang Domoit</option>
            <option value="Silangang Domoit">Silangang Domoit</option>
            <option value="Gibanga">Gibanga</option>
            <option value="Ibas">Ibas</option>
            <option value="Ilasan Ibaba">Ilasan Ibaba</option>
            <option value="Ilasan Ilaya">Ilasan Ilaya</option>
            <option value="Ipilan">Ipilan</option>
            <option value="Isabang">Isabang</option>
            <option value="Katigan Kanluran">Katigan Kanluran</option>
            <option value="Katigan Silangan">Katigan Silangan</option>
            <option value="Lakawan">Lakawan</option>
            <option value="Lalo">Lalo</option>
            <option value="Lawigue">Lawigue</option>
            <option value="Lita">Lita</option>
            <option value="Malaoa">Malaoa</option>
            <option value="Masin">Masin</option>
            <option value="Mate">Mate</option>
            <option value="Mateuna">Mateuna</option>
            <option value="Mayowe">Mayowe</option>
            <option value="Ibabang Nangka">Ibabang Nangka</option>
            <option value="Ilayang Nangka">Ilayang Nangka</option>
            <option value="Opias">Opias</option>
            <option value="Ibabang Palale">Ibabang Palale</option>
            <option value="Ilayang Palale">Ilayang Palale</option>
            <option value="Kanlurang Palale">Kanlurang Palale</option>
            <option value="Silangang Palale">Silangang Palale</option>
            <option value="Pandakaki">Pandakaki</option>
            <option value="Pook">Pook</option>
            <option value="Potol">Potol</option>
            <option value="San Diego Zone I (Poblacion)">San Diego Zone I (Poblacion)</option>
            <option value="San Diego Zone II (Poblacion)">San Diego Zone II (Poblacion)</option>
            <option value="San Diego Zone III">San Diego Zone III</option>
            <option value="San Diego Zone IV">San Diego Zone IV</option>
            <option value="San Isidro Zone I (Poblacion)">San Isidro Zone I (Poblacion)</option>
            <option value="San Isidro Zone II">San Isidro Zone II</option>
            <option value="San Isidro Zone III">San Isidro Zone III</option>
            <option value="San Isidro Zone IV">San Isidro Zone IV</option>
            <option value="San Roque Zone I (Poblacion)">San Roque Zone I (Poblacion)</option>
            <option value="San Roque Zone II">San Roque Zone II</option>
            <option value="Talolong">Talolong</option>
            <option value="Tamlong">Tamlong</option>
            <option value="Tongko">Tongko</option>
            <option value="Valencia">Valencia</option>
            <option value="Wakas">Wakas</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fa fa-briefcase"></i> Position</label>
          <select id="position" onchange="updatePositionOptions()" required>
            <option value="">Select Position</option>
            <option>Super Admin</option>
            <option>Admin</option>
            <option>Barangay Captain</option>
            <option>Barangay Kagawad</option>
            <option>Barangay Secretary</option>
            <option>Barangay Treasurer</option>
            <option>SK Chairperson</option>
            <option>SK Kagawad</option>
            <option>Barangay Health Worker</option>
            <option>Barangay Tanod</option>
            <option>Barangay Nutritionist</option>
            <option>Day Care Worker</option>
            <option>Other</option>
          </select>
        </div>
        <div class="password-section" id="passwordSection" style="display: none;">
          <div class="password-header">
            <label><i class="fa fa-lock"></i> Password</label>
          </div>
          <div class="password-input-wrapper">
            <input type="password" id="password" placeholder="Enter password" required>
            <div class="password-actions">
              <button type="button" class="toggle-password" id="togglePasswordIcon" onclick="togglePasswordVisibility()" title="Show/Hide password">
                <i class="fa fa-eye"></i>
              </button>
              <button type="button" class="suggest-password" onclick="showSuggestPassword()" title="Suggest strong password">
                <i class="fa fa-key"></i>
              </button>
            </div>
          </div>
          <button type="button" class="suggest-btn" onclick="generateSuggestedPassword()">
            <i class="fa fa-magic"></i> Suggest Strong Password
          </button>
          <div class="password-hint">
            <i class="fa fa-info-circle"></i> Password should be at least 8 characters with uppercase, lowercase, numbers, and symbols.
          </div>
        </div>
        <div class="modal-actions">
      <button type="button" class="cancel-btn" onclick="closeModal()">
        <i class="fa fa-times"></i> Cancel
      </button>
      <button type="submit" class="save-btn" id="submitBtn">
        <i class="fa fa-save"></i> Save User
      </button>
    </div>
  </form>
</div>
</div>
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2><i class="fa fa-user-edit"></i> Edit User</h2>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label><i class="fa fa-user"></i> First Name</label>
          <input type="text" id="editFirstName" placeholder="Enter first name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-user"></i> Last Name</label>
          <input type="text" id="editLastName" placeholder="Enter last name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-id-card"></i> Full Name</label>
          <input type="text" id="editName" placeholder="Enter full name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-envelope"></i> Email</label>
          <input type="email" id="editEmail" placeholder="Enter email address" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-map-marker-alt"></i> Barangay</label>
          <select id="editBarangay" required>
            <option value="">Select Barangay</option>
            <option value="Alitao">Alitao</option>
            <option value="Alsam Ibaba">Alsam Ibaba</option>
            <option value="Alsam Ilaya">Alsam Ilaya</option>
            <option value="Alupay">Alupay</option>
            <option value="Angeles Zone I (Poblacion)">Angeles Zone I (Poblacion)</option>
            <option value="Angeles Zone II">Angeles Zone II</option>
            <option value="Angeles Zone III">Angeles Zone III</option>
            <option value="Angeles Zone IV">Angeles Zone IV</option>
            <option value="Angustias Zone I (Poblacion)">Angustias Zone I (Poblacion)</option>
            <option value="Angustias Zone II">Angustias Zone II</option>
            <option value="Angustias Zone III">Angustias Zone III</option>
            <option value="Angustias Zone IV">Angustias Zone IV</option>
            <option value="Anos">Anos</option>
            <option value="Ayaas">Ayaas</option>
            <option value="Baguio">Baguio</option>
            <option value="Banilad">Banilad</option>
            <option value="Ibabang Bukal">Ibabang Bukal</option>
            <option value="Ilayang Bukal">Ilayang Bukal</option>
            <option value="Calantas">Calantas</option>
            <option value="Calumpang">Calumpang</option>
            <option value="Camaysa">Camaysa</option>
            <option value="Dapdap">Dapdap</option>
            <option value="Kanlurang Domoit">Kanlurang Domoit</option>
            <option value="Silangang Domoit">Silangang Domoit</option>
            <option value="Gibanga">Gibanga</option>
            <option value="Ibas">Ibas</option>
            <option value="Ilasan Ibaba">Ilasan Ibaba</option>
            <option value="Ilasan Ilaya">Ilasan Ilaya</option>
            <option value="Ipilan">Ipilan</option>
            <option value="Isabang">Isabang</option>
            <option value="Katigan Kanluran">Katigan Kanluran</option>
            <option value="Katigan Silangan">Katigan Silangan</option>
            <option value="Lakawan">Lakawan</option>
            <option value="Lalo">Lalo</option>
            <option value="Lawigue">Lawigue</option>
            <option value="Lita">Lita</option>
            <option value="Malaoa">Malaoa</option>
            <option value="Masin">Masin</option>
            <option value="Mate">Mate</option>
            <option value="Mateuna">Mateuna</option>
            <option value="Mayowe">Mayowe</option>
            <option value="Ibabang Nangka">Ibabang Nangka</option>
            <option value="Ilayang Nangka">Ilayang Nangka</option>
            <option value="Opias">Opias</option>
            <option value="Ibabang Palale">Ibabang Palale</option>
            <option value="Ilayang Palale">Ilayang Palale</option>
            <option value="Kanlurang Palale">Kanlurang Palale</option>
            <option value="Silangang Palale">Silangang Palale</option>
            <option value="Pandakaki">Pandakaki</option>
            <option value="Pook">Pook</option>
            <option value="Potol">Potol</option>
            <option value="San Diego Zone I (Poblacion)">San Diego Zone I (Poblacion)</option>
            <option value="San Diego Zone II (Poblacion)">San Diego Zone II (Poblacion)</option>
            <option value="San Diego Zone III">San Diego Zone III</option>
            <option value="San Diego Zone IV">San Diego Zone IV</option>
            <option value="San Isidro Zone I (Poblacion)">San Isidro Zone I (Poblacion)</option>
            <option value="San Isidro Zone II">San Isidro Zone II</option>
            <option value="San Isidro Zone III">San Isidro Zone III</option>
            <option value="San Isidro Zone IV">San Isidro Zone IV</option>
            <option value="San Roque Zone I (Poblacion)">San Roque Zone I (Poblacion)</option>
            <option value="San Roque Zone II">San Roque Zone II</option>
            <option value="Talolong">Talolong</option>
            <option value="Tamlong">Tamlong</option>
            <option value="Tongko">Tongko</option>
            <option value="Valencia">Valencia</option>
            <option value="Wakas">Wakas</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fa fa-briefcase"></i> Position</label>
          <select id="editPosition" required>
            <option value="">Select Position</option>
            <option>Super Admin</option>
            <option>Admin</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="cancel-btn" onclick="closeEditModal()">
            <i class="fa fa-times"></i> Cancel
          </button>
          <button type="submit" class="save-btn">
            <i class="fa fa-save"></i> Update User
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function toggleSubmenu(event) {
      event.preventDefault();
      const submenu = event.currentTarget.nextElementSibling;
      const chevron = event.currentTarget.querySelector('.fa-chevron-down');
      if (submenu) {
        submenu.classList.toggle('open');
      }
      if (chevron) {
        chevron.style.transform = submenu.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
      }
    }

    function toggleMobileMenu() {
      document.querySelector('.sidebar').classList.toggle('mobile-open');
    }

    document.addEventListener('click', function(e) {
      const sidebar = document.querySelector('.sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      if (window.innerWidth <= 980 && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
        sidebar.classList.remove('mobile-open');
      }
    });

    function updateAllProfilePhotos(photoURL) {
      const photoElements = ["navbarAvatar"];
      photoElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.src = photoURL;
          el.onerror = function() {
            this.src = "image.png";
          };
        }
      });
    }

    let currentView = 'admin';

    function switchView(view) {
      currentView = view;
      const adminBtn = document.getElementById('adminBtn');
      const officialBtn = document.getElementById('officialBtn');
      const sliderBg = document.getElementById('sliderBg');
      const adminsView = document.getElementById('adminsView');
      const officialsView = document.getElementById('officialsView');

      if (view === 'admin') {
        adminBtn.classList.add('active');
        officialBtn.classList.remove('active');
        adminsView.classList.add('active');
        officialsView.classList.remove('active');
        
        const btnWidth = adminBtn.offsetWidth;
        sliderBg.style.width = btnWidth + 'px';
        sliderBg.style.transform = 'translateX(0)';
      } else {
        officialBtn.classList.add('active');
        adminBtn.classList.remove('active');
        officialsView.classList.add('active');
        adminsView.classList.remove('active');
        
        const btnWidth = officialBtn.offsetWidth;
        const adminWidth = adminBtn.offsetWidth;
        sliderBg.style.width = btnWidth + 'px';
        sliderBg.style.transform = `translateX(${adminWidth}px)`;
      }
    }

    window.addEventListener('load', function() {
      const adminBtn = document.getElementById('adminBtn');
      const sliderBg = document.getElementById('sliderBg');
      sliderBg.style.width = adminBtn.offsetWidth + 'px';
    });

    window.addEventListener('resize', function() {
      if (currentView === 'admin') {
        const adminBtn = document.getElementById('adminBtn');
        document.getElementById('sliderBg').style.width = adminBtn.offsetWidth + 'px';
      } else {
        const officialBtn = document.getElementById('officialBtn');
        const adminBtn = document.getElementById('adminBtn');
        const sliderBg = document.getElementById('sliderBg');
        sliderBg.style.width = officialBtn.offsetWidth + 'px';
        sliderBg.style.transform = `translateX(${adminBtn.offsetWidth}px)`;
      }
    });

    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const icon = document.getElementById('togglePasswordIcon').querySelector('i');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function generateSuggestedPassword() {
      const length = 16;
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=';
      
      let password = '';
      const randomValues = new Uint32Array(length);
      window.crypto.getRandomValues(randomValues);
      
      password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[randomValues[0] % 26];
      password += 'abcdefghijklmnopqrstuvwxyz'[randomValues[1] % 26];
      password += '0123456789'[randomValues[2] % 10];
      password += '!@#$%^&*()_+-='[randomValues[3] % 14];
      
      for (let i = 4; i < length; i++) {
        password += charset[randomValues[i] % charset.length];
      }
      
      password = password.split('').sort(() => 0.5 - Math.random()).join('');
      
      document.getElementById('password').value = password;
      document.getElementById('password').type = 'text';
      document.getElementById('togglePasswordIcon').querySelector('i').classList.remove('fa-eye');
      document.getElementById('togglePasswordIcon').querySelector('i').classList.add('fa-eye-slash');
    }

    function showSuggestPassword() {
      generateSuggestedPassword();
    }

    function updatePositionOptions() {
      const position = document.getElementById('position').value;
      const passwordSection = document.getElementById('passwordSection');
      if (position) {
        passwordSection.style.display = 'block';
      } else {
        passwordSection.style.display = 'none';
      }
    }

    window.openAddModal = () => {
      document.getElementById("modalTitle").innerHTML = '<i class="fa fa-user-plus"></i> Add User';
      document.getElementById("submitBtn").innerHTML = '<i class="fa fa-save"></i> Save User';
      document.getElementById("userModal").style.display = "flex";
      document.getElementById("position").value = "";
      document.getElementById("password").value = "";
      updatePositionOptions();
    };
    
    window.closeModal = () => {
      document.getElementById("userModal").style.display = "none";
      document.getElementById("addUserForm").reset();
      document.getElementById('passwordSection').style.display = 'none';
      document.getElementById('password').type = 'password';
      document.getElementById('togglePasswordIcon').querySelector('i').classList.remove('fa-eye-slash');
      document.getElementById('togglePasswordIcon').querySelector('i').classList.add('fa-eye');
    };
    
    window.openEditModal = (userId, userData) => {
      document.getElementById("editModal").style.display = "flex";
      document.getElementById("editUserId").value = userId;
      document.getElementById("editFirstName").value = userData.firstName || "";
      document.getElementById("editLastName").value = userData.lastName || "";
      document.getElementById("editName").value = userData.name || "";
      document.getElementById("editEmail").value = userData.email || "";
      document.getElementById("editBarangay").value = userData.barangay || "";
      document.getElementById("editPosition").value = userData.position || "";
    };
    
    window.closeEditModal = () => {
      document.getElementById("editModal").style.display = "none";
      document.getElementById("editUserForm").reset();
    };

  </script>
  <script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { 
      getFirestore, collection, doc, setDoc, updateDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, getDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
      authDomain: "tayabastrack-23b95.firebaseapp.com",
      projectId: "tayabastrack-23b95",
      storageBucket: "tayabastrack-23b95.appspot.com",
      messagingSenderId: "674055915366",
      appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    setPersistence(auth, browserSessionPersistence)
      .then(() => {
        console.log("Auth persistence set to SESSION");
      })
      .catch((error) => {
        console.error("Error setting persistence:", error);
      });

let isInternalNavigation = false;
let isLoggingOut = false;
let autoLogoutInitialized = false;

function setupAutoLogout(auth) {
  if (autoLogoutInitialized) {
    console.log(" Auto-logout already initialized");
    return;
  }
  autoLogoutInitialized = true;

  //  Track ALL link clicks (including profile links)
  document.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && link.href) {
      try {
        const linkUrl = new URL(link.href, window.location.href);
        const currentOrigin = window.location.origin;
        
        // Check if it's an internal link
        if (linkUrl.origin === currentOrigin) {
          isInternalNavigation = true;
          console.log(" Internal navigation detected:", link.href);
          
          //  LONGER timeout - 3 seconds to ensure navigation completes
          setTimeout(() => {
            isInternalNavigation = false;
          }, 3000);
        }
      } catch (err) {
        // If URL parsing fails, treat as internal navigation to be safe
        isInternalNavigation = true;
        setTimeout(() => {
          isInternalNavigation = false;
        }, 3000);
      }
    }
  }, true); //  Use capture phase to catch all clicks

  //  IMPROVED: Only logout on actual page close, not navigation
  window.addEventListener('beforeunload', (e) => {
    // Don't logout if it's internal navigation
    if (isInternalNavigation) {
      console.log(" Internal navigation - NOT logging out");
      return;
    }
    
    // Only logout on actual tab/browser close
    if (!isLoggingOut) {
      console.log(" Tab/browser closing - logging out");
      isLoggingOut = true;
      
      // Use synchronous approach for reliable logout on page close
      try {
        signOut(auth);
        sessionStorage.clear();
      } catch (error) {
        console.error(" Error during auto logout:", error);
      }
    }
  });

  //  Handle browser back/forward button
  window.addEventListener('popstate', async (e) => {
    if (!isInternalNavigation && !isLoggingOut) {
      console.log(" Browser back button detected - logging out");
      isLoggingOut = true;
      try {
        await signOut(auth);
        sessionStorage.clear();
        window.location.replace("login.html");
      } catch (error) {
        console.error(" Error during back navigation logout:", error);
      }
    }
  });

  console.log(" Auto-logout functionality initialized");
}
    let superAdminData = null;

    const paginationState = {
      pending: { currentPage: 1, pageSize: 10, data: [] },
      active: { currentPage: 1, pageSize: 10, data: [] },
      inactive: { currentPage: 1, pageSize: 10, data: [] },
      activeOfficials: { currentPage: 1, pageSize: 10, data: [] },
      inactiveOfficials: { currentPage: 1, pageSize: 10, data: [] }
    };

    function updatePagination(tableType) {
      const state = paginationState[tableType];
      const totalPages = Math.ceil(state.data.length / state.pageSize);
      const start = (state.currentPage - 1) * state.pageSize;
      const end = start + state.pageSize;
      const paginatedData = state.data.slice(start, end);
      
      const tbody = document.getElementById({
        pending: 'pendingAdmins', active: 'activeAdmins', inactive: 'inactiveAdmins',
        activeOfficials: 'activeOfficials', inactiveOfficials: 'inactiveOfficials'
      }[tableType]);

      tbody.innerHTML = '';
      paginatedData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = row.html;
        tbody.appendChild(tr);
      });

      const infoEl = document.getElementById({
        pending: 'infoPending', active: 'infoActive', inactive: 'infoInactive',
        activeOfficials: 'infoActiveOfficials', inactiveOfficials: 'infoInactiveOfficials'
      }[tableType]);

      if (state.data.length === 0) {
        infoEl.textContent = 'No records found';
        document.getElementById({
          pending: 'controlsPending', active: 'controlsActive', inactive: 'controlsInactive',
          activeOfficials: 'controlsActiveOfficials', inactiveOfficials: 'controlsInactiveOfficials'
        }[tableType]).innerHTML = '';
      } else {
        const displayStart = state.data.length === 0 ? 0 : start + 1;
        const displayEnd = Math.min(end, state.data.length);
        infoEl.textContent = `Showing ${displayStart} to ${displayEnd} of ${state.data.length}`;
        renderPaginationButtons(tableType, totalPages);
      }
    }

    function renderPaginationButtons(tableType, totalPages) {
      const state = paginationState[tableType];
      const controlsId = {
        pending: 'controlsPending', active: 'controlsActive', inactive: 'controlsInactive',
        activeOfficials: 'controlsActiveOfficials', inactiveOfficials: 'controlsInactiveOfficials'
      }[tableType];

      const controlsEl = document.getElementById(controlsId);
      controlsEl.innerHTML = '';

      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.textContent = 'Previous';
      prevBtn.disabled = state.currentPage === 1;
      prevBtn.onclick = () => {
        state.currentPage--;
        updatePagination(tableType);
      };
      controlsEl.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= state.currentPage - 1 && i <= state.currentPage + 1)) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination-btn ${i === state.currentPage ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => {
            state.currentPage = i;
            updatePagination(tableType);
          };
          controlsEl.appendChild(pageBtn);
        } else if (i === 2 && state.currentPage > 3) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0.5rem 0.3rem';
          controlsEl.appendChild(ellipsis);
        } else if (i === totalPages - 1 && state.currentPage < totalPages - 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0.5rem 0.3rem';
          controlsEl.appendChild(ellipsis);
        }
      }

      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.textContent = 'Next';
      nextBtn.disabled = state.currentPage === totalPages;
      nextBtn.onclick = () => {
        state.currentPage++;
        updatePagination(tableType);
      };
      controlsEl.appendChild(nextBtn);
    }

    window.setPageSize = (tableType, size) => {
      paginationState[tableType].pageSize = parseInt(size);
      paginationState[tableType].currentPage = 1;
      updatePagination(tableType);
    };

    async function logAuditEvent(action, actionType, module, description, additionalData = {}) {
      try {
        const user = auth.currentUser;
        if (!user) {
          console.warn("No authenticated user for audit log");
          return;
        }

        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists()) {
          console.warn("User document not found for audit log");
          return;
        }
        
        const userData = userDoc.data();

        const logData = {
          timestamp: serverTimestamp(),
          userId: user.uid,
          userName: userData.name || `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || "Unknown User",
          userRole: userData.position || userData.role || "User",
          action: action,
          actionType: (actionType || 'edit').toLowerCase(),
          module: module || 'System',
          description: description || 'No description provided',
          beforeValue: additionalData.beforeValue || null,
          afterValue: additionalData.afterValue || null,
          ...additionalData
        };

        await addDoc(collection(db, "auditLogs"), logData);
        console.log(" Audit log created:", logData);

      } catch (error) {
        console.error(" Error logging audit event:", error);
      }
    }

    const notificationBell = document.getElementById("notificationBell");
    const notificationBadge = document.getElementById("notificationBadge");
    const notificationMenu = document.getElementById("notificationMenu");
    const notificationList = document.getElementById("notificationList");
    const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
    const markAllReadBtn = document.getElementById("markAllReadBtn");

    let notificationsList = [];
    let trackedIds = new Set();
    let currentFilter = "all";

    function normalizeStatus(status) {
      return (status || "").toLowerCase().trim();
    }

    function isBarangayPosition(position) {
      if (!position) return false;
      const pos = position.toLowerCase().trim();
      const barangayPositions = [
        'barangay captain',
        'barangay kagawad', 
        'barangay secretary',
        'barangay treasurer',
        'sk chairperson',
        'sk kagawad',
        'barangay health worker',
        'barangay tanod',
        'barangay nutritionist',
        'day care worker',
        'other'
      ];
      
      return barangayPositions.some(p => pos.includes(p)) || 
             pos.includes("barangay") || 
             pos.includes("brgy") || 
             pos.includes("brgy.") || 
             pos.includes("kagawad") ||
             pos.includes("captain") ||
             pos.includes("secretary") ||
             pos.includes("treasurer");
    }

    function saveNotificationsToLocalStorage() {
      try {
        localStorage.setItem('notifications', JSON.stringify(notificationsList));
        localStorage.setItem('trackedIds', JSON.stringify([...trackedIds]));
      } catch (error) {
        console.error("Error saving notifications:", error);
      }
    }

    function loadNotificationsFromLocalStorage() {
      try {
        const savedNotifications = localStorage.getItem('notifications');
        const savedTrackedIds = localStorage.getItem('trackedIds');
        
        if (savedNotifications) {
          notificationsList = JSON.parse(savedNotifications).map(n => ({
            ...n,
            timestamp: new Date(n.timestamp)
          }));
        }
        
        if (savedTrackedIds) {
          trackedIds = new Set(JSON.parse(savedTrackedIds));
        }
      } catch (error) {
        console.error("Error loading notifications:", error);
      }
    }

    notificationBell.addEventListener("click", (e) => {
      e.stopPropagation();
      notificationMenu.classList.toggle("show");
      const dropdown = document.getElementById("dropdownMenu");
      if (dropdown) dropdown.classList.remove("show");
    });

    clearNotificationsBtn.addEventListener("click", () => {
      notificationsList = [];
      trackedIds.clear();
      saveNotificationsToLocalStorage();
      updateNotificationUI();
    });

    markAllReadBtn.addEventListener("click", () => {
      notificationsList.forEach(n => n.read = true);
      saveNotificationsToLocalStorage();
      updateNotificationUI();
    });

    const profileToggle = document.getElementById("profileToggle");
    const dropdownMenu = document.getElementById("dropdownMenu");

    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle("show");
      notificationMenu.classList.remove("show");
    });

    window.addEventListener("click", (e) => {
      if (!e.target.closest(".profile-dropdown")) {
        dropdownMenu.classList.remove("show");
      }
      if (!e.target.closest(".notification-menu") && e.target !== notificationBell) {
        notificationMenu.classList.remove("show");
      }
    });

    document.querySelectorAll(".filter-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
        e.target.classList.add("active");
        currentFilter = e.target.dataset.filter;
        updateNotificationUI();
      });
    });

    function addNotification(type, message, detail, uniqueId) {
      if (trackedIds.has(uniqueId)) return;
      
      trackedIds.add(uniqueId);
      
      const timestamp = new Date();
      const id = `${type}-${uniqueId}-${timestamp.getTime()}`;
      
      notificationsList.unshift({
        id,
        type,
        message: message.trim(),
        detail: detail.trim(),
        timestamp: timestamp,
        read: false
      });
      
      saveNotificationsToLocalStorage();
      updateNotificationUI();
    }

    function updateNotificationUI() {
      let filtered = [...notificationsList];
      
      if (currentFilter === "report") {
        filtered = filtered.filter((n) => n.type === "report");
      } else if (currentFilter === "user") {
        filtered = filtered.filter((n) => n.type === "user");
      } else if (currentFilter === "24h") {
        const ago = Date.now() - 24 * 60 * 60 * 1000;
        filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
      }

      filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

      const unreadCount = notificationsList.filter(n => !n.read).length;
      if (unreadCount > 0) {
        notificationBadge.textContent = unreadCount;
        notificationBadge.classList.add("show");
      } else {
        notificationBadge.textContent = "";
        notificationBadge.classList.remove("show");
      }

      if (filtered.length === 0) {
        notificationList.innerHTML = `<div class="notification-empty">No notifications</div>`;
      } else {
        notificationList.innerHTML = filtered
          .map(
            (n) => `
          <div class="notification-item ${n.read ? '' : 'unread'}">
            <div class="notification-icon ${n.type}">
              ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
            </div>
            <div class="notification-content">
              <p><strong>${n.message}</strong></p>
              <p>${n.detail}</p>
              <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
            </div>
          </div>`
          )
          .join("");
      }
    }

    async function setupRealtimeNotifications() {
      loadNotificationsFromLocalStorage();

      onSnapshot(collection(db, "users"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const userId = change.doc.id;
          const data = change.doc.data();
          const currentStatus = normalizeStatus(data.status);
          const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
          const position = data.position || "User";

          if (change.type === "modified") {
            if (currentStatus === "active") {
              const uniqueId = `user-${userId}-active`;
              if (!trackedIds.has(uniqueId)) {
                addNotification("user", `User approved: ${fullName}`, `Position: ${position}`, uniqueId);
              }
            }
          }
        });
      });

      onSnapshot(collection(db, "reports"), (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const reportId = change.doc.id;
          const data = change.doc.data();
          
          if (change.type === "added") {
            const barangay = data.barangay || data.location || "Unknown location";
            const type = data.reportType || data.type || data.projectName || "Report";
            const uniqueId = `report-${reportId}`;
            addNotification("report", "New report submitted", `${type} in ${barangay}`, uniqueId);
          }
        });
      });

      updateNotificationUI();
      console.log("Notifications system active");
    }

document.getElementById("addUserForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const position = document.getElementById("position").value;
  const password = document.getElementById("password").value;

  const isAdminPosition = position === "Super Admin" || position === "Admin";

  if (!password) {
    alert("Password is required for all users");
    return;
  }

  const hashedPassword = CryptoJS.SHA256(password).toString();

  const currentUser = auth.currentUser;
  if (!currentUser) {
    alert("You must be logged in to add users");
    return;
  }

  try {
    let newUid;
    let userRef;

    // Only create Firebase Auth account for Barangay Officials
    if (!isAdminPosition) {
      const secondaryApp = initializeApp(firebaseConfig, "Secondary-" + Date.now());
      const secondaryAuth = getAuth(secondaryApp);

      console.log("Creating Firebase Auth account for Official...");
      const userCredential = await createUserWithEmailAndPassword(
        secondaryAuth, 
        email, 
        password
      );

      newUid = userCredential.user.uid;
      console.log("Auth account created with UID:", newUid);

      await signOut(secondaryAuth);
      await deleteApp(secondaryApp);
      console.log("Secondary app cleaned up");
    } else {
      newUid = doc(collection(db, "users")).id;
      console.log("Admin pending approval, temporary ID:", newUid);
    }

    userRef = doc(db, "users", newUid);

    //  FIXED: Use "surname" and lowercase "active"/"pending"
    const userData = {
      firstName,
      surname: lastName,        //  Changed from "lastName" to "surname"
      name,
      email,
      barangay,
      position,
      password,
      hashedPassword,
      createdAt: serverTimestamp()
    };

    if (isAdminPosition) {
      userData.status = "pending";      //  Changed from "Pending" to "pending"
      userData.role = "Admin";
    } else {
      userData.status = "active";       //  Changed from "Active" to "active"
      userData.role = "Official";
      userData.phoneNumber = "";        //  Add phoneNumber field
    }

    await setDoc(userRef, userData);

    await logAuditEvent(
      "User Added",
      "add",
      "Users",
      `Added new user: ${name}`,
      {
        targetUserEmail: email,
        targetUserPosition: position,
        targetUserId: newUid,
        barangay: barangay
      }
    );

    closeModal();
    document.getElementById("addUserForm").reset();

    if (isAdminPosition) {
      alert(`Admin user added successfully (Pending approval)!\n\nUID: ${newUid}\n\nFirebase Auth account will be created upon approval.\nEmail: ${email}\nPassword: ${password}`);
    } else {
      alert(`Barangay Official added successfully!\n\nFirebase Auth account created.\nUID: ${newUid}\n\nThey can login with:\nEmail: ${email}\nPassword: ${password}`);
    }
  } catch (err) {
    console.error("Error adding user:", err);
    
    if (err.code === 'auth/email-already-in-use') {
      alert("Error: This email is already registered. Please use a different email address.");
    } else if (err.code === 'auth/weak-password') {
      alert("Error: The password is too weak. Please use a stronger password (at least 6 characters).");
    } else if (err.code === 'auth/invalid-email') {
      alert("Error: Invalid email format.");
    } else {
      alert("Error: " + err.message);
    }
  }
});

 document.getElementById("editUserForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const userId = document.getElementById("editUserId").value;
  const firstName = document.getElementById("editFirstName").value.trim();
  const lastName = document.getElementById("editLastName").value.trim();
  const name = document.getElementById("editName").value.trim();
  const email = document.getElementById("editEmail").value.trim();
  const barangay = document.getElementById("editBarangay").value.trim();
  const position = document.getElementById("editPosition").value;

  try {
    const userRef = doc(db, "users", userId);
    const oldDoc = await getDoc(userRef);
    const oldData = oldDoc.data();

    //  FIXED: Use "surname" instead of "lastName"
    await updateDoc(userRef, {
      firstName,
      surname: lastName,  //  Changed from "lastName" to "surname"
      name,
      email,
      barangay,
      position,
      updatedAt: serverTimestamp()
    });

    const changes = [];
    if (oldData.firstName !== firstName) changes.push(`First Name: "${oldData.firstName}"  "${firstName}"`);
    if (oldData.surname !== lastName) changes.push(`Last Name: "${oldData.surname}"  "${lastName}"`);  //  Changed
    if (oldData.name !== name) changes.push(`Name: "${oldData.name}"  "${name}"`);
    if (oldData.email !== email) changes.push(`Email: "${oldData.email}"  "${email}"`);
    if (oldData.barangay !== barangay) changes.push(`Barangay: "${oldData.barangay}"  "${barangay}"`);
    if (oldData.position !== position) changes.push(`Position: "${oldData.position}"  "${position}"`);

    await logAuditEvent(
      "User Updated",
      "edit",
      "Users",
      `Updated user: ${name}`,
      {
        targetUserId: userId,
        targetUserEmail: email,
        changes: changes.join(", "),
        beforeValue: JSON.stringify(oldData),
        afterValue: JSON.stringify({ firstName, surname: lastName, name, email, barangay, position })
      }
    );

    closeEditModal();
    alert("User updated successfully!");
  } catch (err) {
    console.error("Error updating user:", err);
    alert("Error: " + err.message);
  }
});
    const q = query(collection(db, "users"));
    onSnapshot(q, (snap) => {
      paginationState.pending.data = [];
      paginationState.active.data = [];
      paginationState.inactive.data = [];
      paginationState.activeOfficials.data = [];
      paginationState.inactiveOfficials.data = [];

      const activeOfficialsData = [];
      const inactiveOfficialsData = [];

      snap.forEach(docSnap => {
        const u = docSnap.data();
        const rawStatus = u.status || "";
        const status = normalizeStatus(rawStatus);
        
        let statusBadge = '';
        if (status === "pending") statusBadge = '<span class="status-badge status-pending">Pending</span>';
        else if (status === "active") statusBadge = '<span class="status-badge status-active">Active</span>';
        else if (status === "inactive") statusBadge = '<span class="status-badge status-inactive">Inactive</span>';
        else statusBadge = '<span class="status-badge" style="background:#999;color:#fff;">Unknown</span>';

        const isAdmin = u.position === "Admin" || u.position === "Super Admin";
        const isBrgyOfficial = isBarangayPosition(u.position);

        if (isAdmin) {
          const userDataStr = JSON.stringify(u).replace(/"/g, '&quot;');
          const rowHtml = `
            <td>${u.firstName || ""}</td>
            <td>${u.lastName || ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.barangay || ""}</td>
            <td>${u.position || ""}</td>
            <td>${statusBadge}</td>
            <td>
              ${status === "pending" ? `<button onclick="approveUser('${docSnap.id}')">Approve</button>` : ''}
              ${status === "active" || status === "inactive" ? `<button onclick="openEditModal('${docSnap.id}', ${userDataStr})">Edit</button>` : ''}
              ${status === "active" ? `<button onclick="deactivateUser('${docSnap.id}')">Deactivate</button>` : ''}
              ${status === "inactive" ? `<button onclick="activateUser('${docSnap.id}')">Activate</button>` : ''}
              <button onclick="deleteUser('${docSnap.id}')">Delete</button>
            </td>
          `;

          if (status === "pending") {
            paginationState.pending.data.push({ html: rowHtml });
          } else if (status === "active") {
            paginationState.active.data.push({ html: rowHtml });
          } else if (status === "inactive") {
            paginationState.inactive.data.push({ html: rowHtml });
          }
        }

if (isBrgyOfficial) {
  const contactDisplay = u.phoneNumber || u.contact || "";
  const rowHtml = `
    <td>${u.firstName || ""}</td>
    <td>${u.surname || u.lastName || ""}</td>  
    <td>${u.email || ""}</td>
    <td>${u.barangay || ""}</td>
    <td>${u.position || ""}</td>
    <td>${contactDisplay}</td>
    <td>${statusBadge}</td>
    <td><span class="view-only-cell"><i class="fa fa-eye"></i> View Only</span></td>
  `;

          if (status === "active") {
            activeOfficialsData.push({ html: rowHtml, barangay: u.barangay || "" });
          } else if (status === "inactive") {
            inactiveOfficialsData.push({ html: rowHtml, barangay: u.barangay || "" });
          }
        }
      });

      activeOfficialsData.sort((a, b) => a.barangay.localeCompare(b.barangay));
      inactiveOfficialsData.sort((a, b) => a.barangay.localeCompare(b.barangay));

      paginationState.activeOfficials.data = activeOfficialsData.map(o => ({ html: o.html }));
      paginationState.inactiveOfficials.data = inactiveOfficialsData.map(o => ({ html: o.html }));

      ['pending', 'active', 'inactive', 'activeOfficials', 'inactiveOfficials'].forEach(tableType => {
        paginationState[tableType].currentPage = 1;
        updatePagination(tableType);
      });
    });

window.approveUser = async (pendingDocId) => {
  if (!confirm("Approve this user? Their Firebase Auth account will be created and status will be changed to Active.")) return;
  
  try {
    console.log(" Approving user with document ID:", pendingDocId);
    
    const userRef = doc(db, "users", pendingDocId);
    const userDoc = await getDoc(userRef);
    
    if (!userDoc.exists()) {
      alert("User not found.");
      return;
    }
    
    const userData = userDoc.data();
    console.log("User data retrieved:", userData);

    const secondaryApp = initializeApp(firebaseConfig, "Secondary-" + Date.now());
    const secondaryAuth = getAuth(secondaryApp);

    console.log("Creating Firebase Auth account for approved admin...");
    const userCredential = await createUserWithEmailAndPassword(
      secondaryAuth, 
      userData.email, 
      userData.password
    );

    const authUid = userCredential.user.uid;
    console.log("Auth account created with UID:", authUid);

    await signOut(secondaryAuth);
    await deleteApp(secondaryApp);

    if (authUid !== pendingDocId) {
      console.log("Migrating user document from temp ID to Auth UID...");
      const newUserRef = doc(db, "users", authUid);
      await setDoc(newUserRef, {
        ...userData,
        status: "active",              //  Changed from "Active" to "active"
        approvedAt: serverTimestamp()
      });
      await deleteDoc(userRef);
      console.log("User document migrated successfully");
    } else {
      await updateDoc(userRef, {
        status: "active",              //  Changed from "Active" to "active"
        approvedAt: serverTimestamp()
      });
    }
    
    console.log("User approved successfully");

    await logAuditEvent(
      "User Approved",
      "approve",
      "Users",
      `Approved user: ${userData.name}`,
      {
        beforeValue: "pending",        //  Changed from "Pending" to "pending"
        afterValue: "active",          //  Changed from "Active" to "active"
        targetUserId: authUid,
        targetUserEmail: userData.email,
        targetUserPosition: userData.position
      }
    );

    alert(` ${userData.name} has been approved successfully!\n\nFirebase Auth account created.\nThey can now login with:\nEmail: ${userData.email}\nPassword: (the password you set)`);
    
  } catch (err) {
    console.error("Error approving user:", err);
    if (err.code === 'auth/email-already-in-use') {
      alert("Error: This email already has a Firebase Auth account. Updating status only...");
      try {
        await updateDoc(userRef, {
          status: "active",            //  Changed from "Active" to "active"
          approvedAt: serverTimestamp()
        });
        alert("Status updated to Active!");
      } catch (updateErr) {
        console.error("Error updating status:", updateErr);
      }
    } else {
      alert("Error approving user: " + err.message);
    }
  }
};
window.deactivateUser = async (id) => {
  if (confirm("Deactivate this user? They will not be able to login.")) {
    try {
      const userRef = doc(db, "users", id);
      const userDoc = await getDoc(userRef);
      const userData = userDoc.data();
      const userName = userData.name || `${userData.firstName} ${userData.surname || userData.lastName}`;

      await updateDoc(userRef, { status: "inactive" });  //  Changed from "Inactive" to "inactive"

      await logAuditEvent(
        "User Deactivated",
        "status",
        "Users",
        `Deactivated user: ${userName}`,
        {
          beforeValue: "active",      //  lowercase
          afterValue: "inactive",     //  lowercase
          targetUserId: id,
          targetUserEmail: userData.email
        }
      );

      alert("User deactivated successfully!");
    } catch (err) {
      console.error("Error deactivating user:", err);
      alert("Error: " + err.message);
    }
  }
};

window.activateUser = async (id) => {
  if (confirm("Activate this user? They will be able to login again.")) {
    try {
      const userRef = doc(db, "users", id);
      const userDoc = await getDoc(userRef);
      const userData = userDoc.data();
      const userName = userData.name || `${userData.firstName} ${userData.surname || userData.lastName}`;

      await updateDoc(userRef, { status: "active" });  //  Changed from "Active" to "active"

      await logAuditEvent(
        "User Activated",
        "status",
        "Users",
        `Activated user: ${userName}`,
        {
          beforeValue: "inactive",    //  lowercase
          afterValue: "active",       //  lowercase
          targetUserId: id,
          targetUserEmail: userData.email
        }
      );

      alert("User activated successfully!");
    } catch (err) {
      console.error("Error activating user:", err);
      alert("Error: " + err.message);
    }
  }
};

    window.activateUser = async (id) => {
      if (confirm("Activate this user? They will be able to login again.")) {
        try {
          const userRef = doc(db, "users", id);
          const userDoc = await getDoc(userRef);
          const userData = userDoc.data();
          const userName = userData.name || `${userData.firstName} ${userData.lastName}`;

          await updateDoc(userRef, { status: "Active" });

          await logAuditEvent(
            "User Activated",
            "status",
            "Users",
            `Activated user: ${userName}`,
            {
              beforeValue: "Inactive",
              afterValue: "Active",
              targetUserId: id,
              targetUserEmail: userData.email
            }
          );

          alert("User activated successfully!");
        } catch (err) {
          console.error("Error activating user:", err);
          alert("Error: " + err.message);
        }
      }
    };

    window.deleteUser = async (id) => {
      if (confirm("Are you sure you want to permanently delete this user?\n\nThis action cannot be undone!")) {
        try {
          const userRef = doc(db, "users", id);
          const userDoc = await getDoc(userRef);
          const userData = userDoc.data();
          const userName = userData.name || `${userData.firstName} ${userData.lastName}`;

          await deleteDoc(userRef);

          await logAuditEvent(
            "User Deleted",
            "delete",
            "Users",
            `Deleted user: ${userName}`,
            {
              targetUserId: id,
              targetUserEmail: userData.email,
              targetUserPosition: userData.position,
              deletedUserData: JSON.stringify(userData)
            }
          );

          alert("User deleted successfully!");
        } catch (err) {
          console.error("Error deleting user:", err);
          alert("Error: " + err.message);
        }
      }
    };

    window.searchUser = () => {
      const input = document.getElementById("searchInput").value.toLowerCase();
      ['pending', 'active', 'inactive', 'activeOfficials', 'inactiveOfficials'].forEach(tableType => {
        const state = paginationState[tableType];
        const filtered = state.data.filter(row => {
          const html = row.html.toLowerCase();
          return html.includes(input);
        });
        state.data = filtered;
        state.currentPage = 1;
        updatePagination(tableType);
      });
    };

//  SHARED LOGOUT FUNCTION
    async function performLogout(isManualLogout = true) {
      try {
        if (isManualLogout) {
          await logAuditEvent(
            "Logged Out",
            "logout",
            "Authentication",
            "User logged out from the system"
          );
        }
        
        await signOut(auth);
        sessionStorage.clear();
        console.log(" User logged out successfully");
        window.location.href = "login.html";
      } catch (error) {
        console.error(" Error during logout:", error);
        if (isManualLogout) {
          alert("Error logging out. Please try again.");
        }
      }
    }

    //  MANUAL LOGOUT HANDLERS
    const handleLogout = async (e) => {
    e.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
      await performLogout(true);
    }
  };

  document.getElementById("sidebarLogoutBtn").addEventListener("click", handleLogout);
  document.getElementById("dropdownLogoutBtn").addEventListener("click", handleLogout);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        setupAutoLogout(auth);
        const userDocRef = doc(db, "users", user.uid);
        onSnapshot(userDocRef, (docSnap) => {
          if (!docSnap.exists()) {
            console.error("User document not found!");
            return;
          }    
          const data = docSnap.data();    
          let fullName = "Unknown";
          if (data.firstName && data.lastName) {
            fullName = `${data.firstName} ${data.lastName}`;
          } else if (data.name) {
          fullName = data.name;
          } else if (data.firstName) {
          fullName = data.firstName;
          }
          document.getElementById("navUsername").textContent = fullName;
          const photoURL = data.photoURL || data.profilePic || "image.png";
          updateAllProfilePhotos(photoURL);
          superAdminData = {
          uid: user.uid,
          email: user.email,
          position: data.position
          };
            if (data.position !== "Super Admin") {
            alert("Access denied. Only Super Admins can manage users.");
            window.location.href = "dashboard.html";
            return;
          }
          console.log("Super Admin authenticated and authorized");
          }, (error) => {
          console.error("Error in user snapshot:", error);
          });
          await setupRealtimeNotifications();
          } else {
          window.location.href = "login.html";
          }
          });
  </script>
</body>
</html>
