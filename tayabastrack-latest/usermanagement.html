<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0"/>
  <title>User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow: auto; zoom: 1.0;  }
    
    .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; flex-shrink: 0; height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: left 0.3s; overflow-y: auto; }
    .sidebar-header { display: flex; align-items: center; justify-content: flex-start; gap: 12px; margin-bottom: 2rem; padding: 0 1rem; }
    .sidebar-header img { width: 50px; height: 50px; object-fit: contain; }
    .sidebar-header h2 { font-size: 1.3rem; font-weight: 600; margin: 0; }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin: 0.5rem 0; }
    .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1rem; text-decoration: none; color: #fff; transition: background 0.3s; border-left: 4px solid transparent; }
    .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }
    .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
    .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .logout-btn:hover { background-color: #c9302c; }
    
    .dashboard-main { flex: 1; display: flex; flex-direction: column; min-width: 0; margin-left: 240px; height: 100vh; overflow: hidden; transition: margin-left 0.3s; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 100; }
    .navbar-left { display: flex; align-items: center; gap: 1rem; }
    .navbar h1 { font-size: 1.4rem; color: #004aad; white-space: nowrap; }
    .mobile-menu-btn { display: none; background: none; border: none; color: #004aad; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }

    .profile { display: flex; align-items: center; gap: 1rem; position: relative; flex-shrink: 0; }
    .profile .fa-bell { font-size: 1.2rem; cursor: pointer; position: relative; color: #333; }
    .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 18px; text-align: center; }
    .badge.show { display: flex; align-items: center; justify-content: center; }
    .avatar { width: 35px; height: 35px; border-radius: 50%; flex-shrink: 0; object-fit: cover; border: 2px solid #004aad; }
    .username { font-weight: 500; white-space: nowrap; color: #333; }
    .profile-dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 8px; transition: background 0.2s; }
    .profile-dropdown:hover { background: #f5f7fb; }
    
    .notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); width: 340px; max-height: 420px; overflow: hidden; z-index: 1000; font-family: "Segoe UI", Tahoma, sans-serif; animation: fadeIn 0.2s ease-in-out; }
    .notification-menu.show { display: block; }

    .notification-header { padding: 0.9rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
    .notification-header h3 { font-size: 1rem; color: #333; margin: 0; font-weight: 600; }
    .notification-actions { display: flex; gap: 0.5rem; align-items: center; }
    .action-icon-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.3rem; transition: color 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .action-icon-btn:hover { color: #004aad; }
    .action-icon-btn i { font-size: 0.95rem; }

    .notification-filters { display: flex; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; background: #fafafa; }
    .filter-btn { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.8rem; background: #f2f2f2; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.25s ease; color: #333; }
    .filter-btn:hover { background: #004aad; color: #fff; }
    .filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }

    .notification-list { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ccc transparent; }
    .notification-list::-webkit-scrollbar { width: 6px; }
    .notification-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .notification-list::-webkit-scrollbar-track { background: transparent; }

    .notification-item { padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; align-items: flex-start; transition: background 0.2s; position: relative; }
    .notification-item:hover { background: #f5f7ff; }
    .notification-item.unread { background: #f0f7ff; }
    .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: #004aad; border-radius: 0 4px 4px 0; }
    .notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
    .notification-icon.user { background: #e3f2fd; color: #1976d2; }
    .notification-icon.report { background: #fff3e0; color: #f57c00; }
    .notification-content { flex: 1; }
    .notification-content p { margin: 0; font-size: 0.86rem; color: #333; line-height: 1.3; }
    .notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.25rem; }
    .notification-empty { padding: 2rem; text-align: center; color: #999; font-size: 0.9rem; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    .dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 10000; }
    .dropdown-menu.show { display: block; }
    .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.9rem; transition: background 0.2s; }
    .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
    .dropdown-menu a i { margin-right: 8px; width: 20px; text-align: center; }
    
    .user-section { padding: 1.5rem; flex: 1; overflow-y: auto; overflow-x: hidden; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px; }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-left: auto; }
    .actions button { background: #004aad; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .actions button:hover { background: #005ce6; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3); }
    .actions input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; }

    .view-toggle-container { display: flex; justify-content: center; margin-bottom: 1.5rem; }
    .view-toggle { position: relative; display: inline-flex; background: #e8eef5; border-radius: 50px; padding: 4px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.1); }
    .view-toggle-btn { position: relative; z-index: 2; padding: 0.7rem 2rem; border: none; background: transparent; color: #666; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: color 0.3s ease; border-radius: 50px; display: flex; align-items: center; gap: 0.5rem; }
    .view-toggle-btn.active { color: #fff; }
    .view-toggle-btn i { font-size: 1rem; }
    .slider-bg { position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); border-radius: 50px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 10px rgba(0, 74, 173, 0.4); z-index: 1; }

    .scroll-hint { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; text-align: center; margin: 10px 0 12px 0; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0, 74, 173, 0.2); flex-shrink: 0; }
    .scroll-hint i { animation: slideHint 2s ease-in-out infinite; }
    @keyframes slideHint { 0%, 100% { transform: translateX(-4px); } 50% { transform: translateX(4px); } }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 5000; padding: 1rem; }
    .modal-content { background: #fff; padding: 1.5rem; border-radius: 12px; border: 3px solid #004aad; width: 520px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .modal-content h2 { margin-bottom: 1.2rem; color: #004aad; text-align: center; font-size: 1.4rem; }
    .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
    .form-group label { font-weight: 600; margin-bottom: 0.4rem; color: #333; font-size: 0.9rem; }
    .form-group input, .form-group select { padding: 0.65rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #004aad; background: #fff; box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1); }
    
    .password-section { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .password-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.8rem; }
    .password-header label { font-weight: 600; color: #004aad; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .password-input-group { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; }
    .password-input-wrapper { flex: 1; position: relative; }
    .password-input-wrapper input { width: 100%; padding: 0.65rem 40px 0.65rem 0.65rem; font-family: 'Courier New', monospace; letter-spacing: 1px; font-size: 0.9rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 6px; }
    .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; font-size: 1rem; transition: color 0.2s; background: none; border: none; padding: 0; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
    .toggle-password:hover { color: #004aad; }
    .generate-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; border: none; padding: 0.65rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); }
    .generate-btn:hover { background: linear-gradient(135deg, #218838 0%, #1aa179 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.5); }
    
    .password-options { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 0.8rem; }
    .options-title { font-size: 0.85rem; font-weight: 600; color: #555; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem; }
    .length-control { margin-bottom: 0.8rem; }
    .length-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
    .length-header span:first-child { font-size: 0.85rem; color: #555; }
    .length-value { font-weight: 700; color: #004aad; font-size: 0.95rem; background: #e3f2fd; padding: 2px 8px; border-radius: 4px; }
    .length-slider { width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #004aad 0%, #0066cc 100%); outline: none; -webkit-appearance: none; opacity: 0.7; transition: opacity 0.2s; }
    .length-slider:hover { opacity: 1; }
    .length-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #004aad; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s; }
    .length-slider::-webkit-slider-thumb:hover { background: #003d8f; transform: scale(1.15); }
    .length-slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #004aad; cursor: pointer; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s; }
    .length-slider::-moz-range-thumb:hover { background: #003d8f; transform: scale(1.15); }
    
    .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.6rem; }
    .checkbox-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #f9f9f9; border-radius: 4px; transition: background 0.2s; }
    .checkbox-item:hover { background: #e8f4fd; }
    .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #004aad; }
    .checkbox-item label { font-size: 0.85rem; color: #555; cursor: pointer; user-select: none; }
    
    .strength-indicator { margin-top: 0.8rem; }
    .strength-label { font-size: 0.85rem; color: #555; margin-bottom: 0.4rem; font-weight: 500; }
    .strength-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; position: relative; }
    .strength-fill { height: 100%; transition: width 0.3s ease, background 0.3s ease; border-radius: 4px; }
    .strength-text { font-size: 0.85rem; margin-top: 0.4rem; font-weight: 600; text-align: center; }
    
    .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.8rem; padding-top: 1rem; border-top: 2px solid #e0e0e0; }
    .modal-actions button { border: none; padding: 0.65rem 1.8rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s; }
    .cancel-btn { background: #6c757d; color: #fff; }
    .cancel-btn:hover { background: #5a6268; transform: translateY(-1px); box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3); }
    .save-btn { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); color: #fff; box-shadow: 0 2px 8px rgba(0, 74, 173, 0.3); }
    .save-btn:hover { background: linear-gradient(135deg, #003d8f 0%, #0052a3 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 74, 173, 0.5); }

    .table-wrapper { margin-top: 1rem; }
    .table-card { overflow-x: auto; overflow-y: hidden; border-radius: 10px; background: #fff; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); scroll-behavior: smooth; position: relative; margin-bottom: 1.5rem; }
    .table-card::-webkit-scrollbar { height: 10px; }
    .table-card::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #004aad 0%, #0066cc 100%); border-radius: 5px; }

    table { width: 100%; border-collapse: collapse; table-layout: auto; min-width: 1500px; }
    thead { background: #f5f8fb; color: #333; }
    thead th { font-weight: 700; padding: 0.8rem 0.75rem; text-align: left; border-bottom: 2px solid #e0e0e0; font-size: 0.9rem; }
    th, td { text-align: left; padding: 0.7rem 0.8rem; font-size: 0.85rem; border-bottom: 1px solid #f0f2f5; overflow: visible; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #fbfdff; }
    tbody tr:hover { background: #f1f8ff; }

    th:nth-child(1), td:nth-child(1) { min-width: 150px; }
    th:nth-child(2), td:nth-child(2) { min-width: 150px; }
    th:nth-child(3), td:nth-child(3) { min-width: 250px; }
    th:nth-child(4), td:nth-child(4) { min-width: 200px; }
    th:nth-child(5), td:nth-child(5) { min-width: 160px; }
    th:nth-child(6), td:nth-child(6) { min-width: 180px; }
    th:nth-child(7), td:nth-child(7) { min-width: 120px; }
    th:nth-child(8), td:nth-child(8) { min-width: 200px; }

    .password-cell { display: flex; align-items: center; gap: 8px; }
    .password-hidden { font-family: 'Courier New', monospace; background: #f0f0f0; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; letter-spacing: 2px; color: #666; user-select: none; }
    .show-password-btn { background: #17a2b8 !important; color: #fff; border: none; padding: 5px 10px !important; border-radius: 4px; cursor: pointer; font-size: 0.75rem; transition: 0.3s; margin: 0 !important; display: flex; align-items: center; gap: 4px; }
    .show-password-btn:hover { background: #138496 !important; transform: scale(1.05); }
    .copy-btn { background: #28a745 !important; color: #fff; border: none; padding: 5px 10px !important; border-radius: 4px; cursor: pointer; font-size: 0.75rem; transition: 0.3s; margin: 0 !important; }
    .copy-btn:hover { background: #218838 !important; transform: scale(1.05); }

    td button { padding: 0.4rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 4px; transition: all 0.2s; font-weight: 500; }
    td button:first-child { background: #004aad; color: #fff; }
    td button:first-child:hover { background: #003d8f; transform: translateY(-1px); }
    td button:last-child { background: #d9534f; color: #fff; }
    td button:last-child:hover { background: #c9302c; transform: translateY(-1px); }

    .status-badge { display: inline-block; padding: 5px 14px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-align: center; }
    .status-pending { background: #ffc107; color: #fff; }
    .status-active { background: #007bff; color: #fff; }
    .status-inactive { background: #dc3545; color: #fff; }

    .user-section h3 { margin: 1.5rem 0 0.8rem 0; color: #004aad; font-size: 1.15rem; display: flex; align-items: center; gap: 0.5rem; }
    .user-section h3 i { font-size: 1.1rem; }

    .view-section { display: none; }
    .view-section.active { display: block; }

    .view-only-cell { color: #17a2b8; font-weight: 600; font-size: 0.85rem; }

    @media (max-width: 980px) {
      .sidebar { left: -240px; }
      .sidebar.mobile-open { left: 0; }
      .dashboard-main { margin-left: 0; }
      .mobile-menu-btn { display: block !important; }
      .navbar h1 { font-size: 1.1rem; }
      .actions { width: 100%; }
      .actions input { flex: 1; }
      .view-toggle-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
      .checkbox-grid { grid-template-columns: 1fr; }
      .password-input-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logo.png" alt="Logo" class="logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
        <li class="active"><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
        <li><a href="reports.html"><i class="fa fa-tasks"></i>&nbsp; Manage Reports</a></li>
      </ul>
    </div>  
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <div class="dashboard-main">
    <nav class="navbar">
      <div class="navbar-left">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
          <i class="fa fa-bars"></i>
        </button>
        <h1>User Management</h1>
      </div>
      <div class="profile">
        <div style="position: relative;">
          <i class="fa fa-bell" id="notificationBell"></i>
          <span class="badge" id="notificationBadge">0</span>

          <div class="notification-menu" id="notificationMenu">
            <div class="notification-header">
              <h3>Notifications</h3>
              <div class="notification-actions">
                <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read">
                  <i class="fa fa-check-double"></i>
                </button>
                <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all">
                  <i class="fa fa-trash-alt"></i>
                </button>
              </div>
            </div>

            <div class="notification-filters">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="report">Reports</button>
              <button class="filter-btn" data-filter="user">Users</button>
              <button class="filter-btn" data-filter="24h">Last 24h</button>
            </div>

            <div class="notification-list" id="notificationList">
              <div class="notification-empty">No new notifications</div>
            </div>
          </div>
        </div>

        <div class="profile-dropdown" id="profileToggle">
          <img src="image.png" alt="Profile" class="avatar" id="navbarAvatar" />
          <span class="username" id="navUsername">---</span>
          <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#666;"></i>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
            <a href="#" id="dropdownLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="user-section">
      <div class="header">
        <div class="view-toggle-container" style="margin: 0;">
          <div class="view-toggle">
            <div class="slider-bg" id="sliderBg"></div>
            <button class="view-toggle-btn active" id="adminBtn" onclick="switchView('admin')">
              <i class="fa fa-user-shield"></i> ADMINS
            </button>
            <button class="view-toggle-btn" id="officialBtn" onclick="switchView('official')">
              <i class="fa fa-users"></i> BARANGAY OFFICIALS
            </button>
          </div>
        </div>
        <div class="actions">
          <button onclick="openAddModal()">
            <i class="fa fa-user-plus"></i> Add User
          </button>
          <input type="text" id="searchInput" placeholder="Search user" oninput="searchUser()"/>
        </div>
      </div>

      <div class="scroll-hint">
        <i class="fas fa-arrows-alt-h"></i>
        <span>Scroll horizontally to view all columns</span>
      </div>

      <div id="adminsView" class="view-section active">
        <h3><i class="fa fa-clock"></i> Pending Admins</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Password</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingAdmins"></tbody>
            </table>
          </div>
        </div>

        <h3><i class="fa fa-check-circle"></i> Active Admins</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Password</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="activeAdmins"></tbody>
            </table>
          </div>
        </div>

        <h3><i class="fa fa-times-circle"></i> Inactive Admins</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Password</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inactiveAdmins"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="officialsView" class="view-section">
        <h3><i class="fa fa-check-circle"></i> Active Barangay Officials</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Access</th>
                </tr>
              </thead>
              <tbody id="activeOfficials"></tbody>
            </table>
          </div>
        </div>

        <h3><i class="fa fa-times-circle"></i> Inactive Barangay Officials</h3>
        <div class="table-wrapper">
          <div class="table-card">
            <table>
              <thead>
                <tr>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Barangay</th>
                  <th>Position</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Access</th>
                </tr>
              </thead>
              <tbody id="inactiveOfficials"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="userModal">
    <div class="modal-content">
      <h2><i class="fa fa-user-plus"></i> Add User</h2>
      <form id="addUserForm">
        <div class="form-group">
          <label><i class="fa fa-user"></i> First Name</label>
          <input type="text" id="firstName" placeholder="Enter first name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-user"></i> Last Name</label>
          <input type="text" id="lastName" placeholder="Enter last name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-id-card"></i> Full Name</label>
          <input type="text" id="name" placeholder="Enter full name" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-envelope"></i> Email</label>
          <input type="email" id="email" placeholder="Enter email address" required>
        </div>
        <div class="form-group">
          <label><i class="fa fa-map-marker-alt"></i> Barangay</label>
          <select id="barangay" required>
            <option value="">Select Barangay</option>
            <option value="Alitao">Alitao</option>
            <option value="Alsam Ibaba">Alsam Ibaba</option>
            <option value="Alsam Ilaya">Alsam Ilaya</option>
            <option value="Alupay">Alupay</option>
            <option value="Angeles Zone I (Poblacion)">Angeles Zone I (Poblacion)</option>
            <option value="Angeles Zone II">Angeles Zone II</option>
            <option value="Angeles Zone III">Angeles Zone III</option>
            <option value="Angeles Zone IV">Angeles Zone IV</option>
            <option value="Angustias Zone I (Poblacion)">Angustias Zone I (Poblacion)</option>
            <option value="Angustias Zone II">Angustias Zone II</option>
            <option value="Angustias Zone III">Angustias Zone III</option>
            <option value="Angustias Zone IV">Angustias Zone IV</option>
            <option value="Anos">Anos</option>
            <option value="Ayaas">Ayaas</option>
            <option value="Baguio">Baguio</option>
            <option value="Banilad">Banilad</option>
            <option value="Ibabang Bukal">Ibabang Bukal</option>
            <option value="Ilayang Bukal">Ilayang Bukal</option>
            <option value="Calantas">Calantas</option>
            <option value="Calumpang">Calumpang</option>
            <option value="Camaysa">Camaysa</option>
            <option value="Dapdap">Dapdap</option>
            <option value="Kanlurang Domoit">Kanlurang Domoit</option>
            <option value="Silangang Domoit">Silangang Domoit</option>
            <option value="Gibanga">Gibanga</option>
            <option value="Ibas">Ibas</option>
            <option value="Ilasan Ibaba">Ilasan Ibaba</option>
            <option value="Ilasan Ilaya">Ilasan Ilaya</option>
            <option value="Ipilan">Ipilan</option>
            <option value="Isabang">Isabang</option>
            <option value="Katigan Kanluran">Katigan Kanluran</option>
            <option value="Katigan Silangan">Katigan Silangan</option>
            <option value="Lakawan">Lakawan</option>
            <option value="Lalo">Lalo</option>
            <option value="Lawigue">Lawigue</option>
            <option value="Lita">Lita</option>
            <option value="Malaoa">Malaoa</option>
            <option value="Masin">Masin</option>
            <option value="Mate">Mate</option>
            <option value="Mateuna">Mateuna</option>
            <option value="Mayowe">Mayowe</option>
            <option value="Ibabang Nangka">Ibabang Nangka</option>
            <option value="Ilayang Nangka">Ilayang Nangka</option>
            <option value="Opias">Opias</option>
            <option value="Ibabang Palale">Ibabang Palale</option>
            <option value="Ilayang Palale">Ilayang Palale</option>
            <option value="Kanlurang Palale">Kanlurang Palale</option>
            <option value="Silangang Palale">Silangang Palale</option>
            <option value="Pandakaki">Pandakaki</option>
            <option value="Pook">Pook</option>
            <option value="Potol">Potol</option>
            <option value="San Diego Zone I (Poblacion)">San Diego Zone I (Poblacion)</option>
            <option value="San Diego Zone II (Poblacion)">San Diego Zone II (Poblacion)</option>
            <option value="San Diego Zone III">San Diego Zone III</option>
            <option value="San Diego Zone IV">San Diego Zone IV</option>
            <option value="San Isidro Zone I (Poblacion)">San Isidro Zone I (Poblacion)</option>
            <option value="San Isidro Zone II">San Isidro Zone II</option>
            <option value="San Isidro Zone III">San Isidro Zone III</option>
            <option value="San Isidro Zone IV">San Isidro Zone IV</option>
            <option value="San Roque Zone I (Poblacion)">San Roque Zone I (Poblacion)</option>
            <option value="San Roque Zone II">San Roque Zone II</option>
            <option value="Talolong">Talolong</option>
            <option value="Tamlong">Tamlong</option>
            <option value="Tongko">Tongko</option>
            <option value="Valencia">Valencia</option>
            <option value="Wakas">Wakas</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fa fa-briefcase"></i> Position</label>
          <select id="position" required>
            <option value="">Select Position</option>
            <option>Super Admin</option>
            <option>Admin</option>
            <option>Barangay Official</option>
          </select>
        </div>
        
        <div class="password-section">
          <div class="password-header">
            <label><i class="fa fa-lock"></i> Password Generator</label>
          </div>
          <div class="password-input-group">
            <div class="password-input-wrapper">
              <input type="password" id="password" placeholder="Generated password" required readonly>
              <button type="button" class="toggle-password" id="togglePasswordIcon" onclick="togglePasswordVisibility()">
                <i class="fa fa-eye"></i>
              </button>
            </div>
            <button type="button" class="generate-btn" onclick="generatePassword()">
              <i class="fa fa-sync-alt"></i> Generate
            </button>
          </div>
          
          <div class="password-options">
            <div class="options-title">
              <i class="fa fa-cog"></i> Password Options
            </div>
            <div class="length-control">
              <div class="length-header">
                <span>Length:</span>
                <span class="length-value" id="lengthValue">16</span>
              </div>
              <input type="range" class="length-slider" id="passwordLength" min="8" max="32" value="16" oninput="updateLengthValue()">
            </div>
            <div class="checkbox-grid">
              <div class="checkbox-item">
                <input type="checkbox" id="includeUppercase" checked>
                <label for="includeUppercase">Uppercase (A-Z)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="includeLowercase" checked>
                <label for="includeLowercase">Lowercase (a-z)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="includeNumbers" checked>
                <label for="includeNumbers">Numbers (0-9)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="includeSymbols" checked>
                <label for="includeSymbols">Symbols (!@#$%)</label>
              </div>
            </div>
          </div>
          
          <div class="strength-indicator">
            <div class="strength-label">Password Strength:</div>
            <div class="strength-bar">
              <div class="strength-fill" id="strengthFill"></div>
            </div>
            <div class="strength-text" id="strengthText">Not Generated</div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="cancel-btn" onclick="closeModal()">
            <i class="fa fa-times"></i> Cancel
          </button>
          <button type="submit" class="save-btn">
            <i class="fa fa-save"></i> Save User
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
  function toggleMobileMenu() {
    document.querySelector('.sidebar').classList.toggle('mobile-open');
  }

  document.addEventListener('click', function(e) {
    const sidebar = document.querySelector('.sidebar');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    if (window.innerWidth <= 980 && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
      sidebar.classList.remove('mobile-open');
    }
  });

  function updateAllProfilePhotos(photoURL) {
    const photoElements = ["navbarAvatar"];
    photoElements.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.src = photoURL;
        el.onerror = function() {
          this.src = "image.png";
        };
      }
    });
  }

  let currentView = 'admin';

  function switchView(view) {
    currentView = view;
    const adminBtn = document.getElementById('adminBtn');
    const officialBtn = document.getElementById('officialBtn');
    const sliderBg = document.getElementById('sliderBg');
    const adminsView = document.getElementById('adminsView');
    const officialsView = document.getElementById('officialsView');

    if (view === 'admin') {
      adminBtn.classList.add('active');
      officialBtn.classList.remove('active');
      adminsView.classList.add('active');
      officialsView.classList.remove('active');
      
      const btnWidth = adminBtn.offsetWidth;
      sliderBg.style.width = btnWidth + 'px';
      sliderBg.style.transform = 'translateX(0)';
    } else {
      officialBtn.classList.add('active');
      adminBtn.classList.remove('active');
      officialsView.classList.add('active');
      adminsView.classList.remove('active');
      
      const btnWidth = officialBtn.offsetWidth;
      const adminWidth = adminBtn.offsetWidth;
      sliderBg.style.width = btnWidth + 'px';
      sliderBg.style.transform = `translateX(${adminWidth}px)`;
    }
  }

  window.addEventListener('load', function() {
    const adminBtn = document.getElementById('adminBtn');
    const sliderBg = document.getElementById('sliderBg');
    sliderBg.style.width = adminBtn.offsetWidth + 'px';
  });

  window.addEventListener('resize', function() {
    if (currentView === 'admin') {
      const adminBtn = document.getElementById('adminBtn');
      document.getElementById('sliderBg').style.width = adminBtn.offsetWidth + 'px';
    } else {
      const officialBtn = document.getElementById('officialBtn');
      const adminBtn = document.getElementById('adminBtn');
      const sliderBg = document.getElementById('sliderBg');
      sliderBg.style.width = officialBtn.offsetWidth + 'px';
      sliderBg.style.transform = `translateX(${adminBtn.offsetWidth}px)`;
    }
  });

  function updateLengthValue() {
    const length = document.getElementById('passwordLength').value;
    document.getElementById('lengthValue').textContent = length;
  }

  function togglePasswordVisibility() {
    const passwordInput = document.getElementById('password');
    const icon = document.getElementById('togglePasswordIcon').querySelector('i');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  function generatePassword() {
    const length = parseInt(document.getElementById('passwordLength').value);
    const includeUppercase = document.getElementById('includeUppercase').checked;
    const includeLowercase = document.getElementById('includeLowercase').checked;
    const includeNumbers = document.getElementById('includeNumbers').checked;
    const includeSymbols = document.getElementById('includeSymbols').checked;

    if (!includeUppercase && !includeLowercase && !includeNumbers && !includeSymbols) {
      alert('Please select at least one character type!');
      return;
    }

    let charset = '';
    if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
    if (includeNumbers) charset += '0123456789';
    if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';

    let password = '';
    const randomValues = new Uint32Array(length);
    window.crypto.getRandomValues(randomValues);
    
    for (let i = 0; i < length; i++) {
      password += charset[randomValues[i] % charset.length];
    }

    document.getElementById('password').value = password;
    calculatePasswordStrength(password);
  }

  function calculatePasswordStrength(password) {
    let strength = 0;
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');

    if (password.length >= 8) strength += 20;
    if (password.length >= 12) strength += 20;
    if (password.length >= 16) strength += 10;
    if (/[a-z]/.test(password)) strength += 10;
    if (/[A-Z]/.test(password)) strength += 10;
    if (/[0-9]/.test(password)) strength += 15;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

    strengthFill.style.width = strength + '%';

    if (strength < 40) {
      strengthFill.style.background = '#dc3545';
      strengthText.textContent = 'Weak';
      strengthText.style.color = '#dc3545';
    } else if (strength < 70) {
      strengthFill.style.background = '#ffc107';
      strengthText.textContent = 'Medium';
      strengthText.style.color = '#ffc107';
    } else {
      strengthFill.style.background = '#28a745';
      strengthText.textContent = 'Strong';
      strengthText.style.color = '#28a745';
    }
  }

  window.openAddModal = () => {
    document.getElementById("userModal").style.display = "flex";
    generatePassword();
  };
  
  window.closeModal = () => {
    document.getElementById("userModal").style.display = "none";
    document.getElementById("addUserForm").reset();
    document.getElementById('strengthFill').style.width = '0%';
    document.getElementById('strengthText').textContent = 'Not Generated';
    document.getElementById('strengthText').style.color = '#666';
  };

  window.copyPassword = (password) => {
    navigator.clipboard.writeText(password).then(() => {
      alert("Password copied to clipboard!");
    }).catch(() => {
      alert("Failed to copy password");
    });
  };

  window.toggleTablePassword = (btnElement, password) => {
    const cell = btnElement.parentElement;
    const hiddenSpan = cell.querySelector('.password-hidden');
    const icon = btnElement.querySelector('i');
    
    if (hiddenSpan.textContent === '••••••••') {
      hiddenSpan.textContent = password;
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
      btnElement.title = 'Hide';
    } else {
      hiddenSpan.textContent = '••••••••';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
      btnElement.title = 'Show';
    }
  };
</script>

<script type="module">
  import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { 
    getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { 
    getFirestore, collection, doc, setDoc, updateDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.appspot.com",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let superAdminData = null;

  const notificationBell = document.getElementById("notificationBell");
  const notificationBadge = document.getElementById("notificationBadge");
  const notificationMenu = document.getElementById("notificationMenu");
  const notificationList = document.getElementById("notificationList");
  const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
  const markAllReadBtn = document.getElementById("markAllReadBtn");

  let notificationsList = [];
  let trackedIds = new Set();
  let currentFilter = "all";

  function normalizeStatus(status) {
    return (status || "").toLowerCase().trim();
  }

  function isBarangayPosition(position) {
    if (!position) return false;
    const pos = position.toLowerCase().trim();
    return pos.includes("barangay") || 
           pos.includes("brgy") || 
           pos.includes("brgy.") || 
           pos.includes("kagawad") ||
           pos.includes("sk kagawad") ||
           pos.includes("captain") ||
           pos.includes("secretary") ||
           pos.includes("treasurer");
  }

  function saveNotificationsToLocalStorage() {
    try {
      localStorage.setItem('notifications', JSON.stringify(notificationsList));
      localStorage.setItem('trackedIds', JSON.stringify([...trackedIds]));
    } catch (error) {
      console.error("Error saving notifications:", error);
    }
  }

  function loadNotificationsFromLocalStorage() {
    try {
      const savedNotifications = localStorage.getItem('notifications');
      const savedTrackedIds = localStorage.getItem('trackedIds');
      
      if (savedNotifications) {
        notificationsList = JSON.parse(savedNotifications).map(n => ({
          ...n,
          timestamp: new Date(n.timestamp)
        }));
      }
      
      if (savedTrackedIds) {
        trackedIds = new Set(JSON.parse(savedTrackedIds));
      }
    } catch (error) {
      console.error("Error loading notifications:", error);
    }
  }

  notificationBell.addEventListener("click", (e) => {
    e.stopPropagation();
    notificationMenu.classList.toggle("show");
    const dropdown = document.getElementById("dropdownMenu");
    if (dropdown) dropdown.classList.remove("show");
  });

  clearNotificationsBtn.addEventListener("click", () => {
    notificationsList = [];
    trackedIds.clear();
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  });

  markAllReadBtn.addEventListener("click", () => {
    notificationsList.forEach(n => n.read = true);
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  });

  const profileToggle = document.getElementById("profileToggle");
  const dropdownMenu = document.getElementById("dropdownMenu");

  profileToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("show");
    notificationMenu.classList.remove("show");
  });

  window.addEventListener("click", (e) => {
    if (!e.target.closest(".profile-dropdown")) {
      dropdownMenu.classList.remove("show");
    }
    if (!e.target.closest(".notification-menu") && e.target !== notificationBell) {
      notificationMenu.classList.remove("show");
    }
  });

  document.querySelectorAll(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      e.target.classList.add("active");
      currentFilter = e.target.dataset.filter;
      updateNotificationUI();
    });
  });

  function addNotification(type, message, detail, uniqueId) {
    if (trackedIds.has(uniqueId)) return;
    
    trackedIds.add(uniqueId);
    
    const timestamp = new Date();
    const id = `${type}-${uniqueId}-${timestamp.getTime()}`;
    
    notificationsList.unshift({
      id,
      type,
      message: message.trim(),
      detail: detail.trim(),
      timestamp: timestamp,
      read: false
    });
    
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  }

  function updateNotificationUI() {
    let filtered = [...notificationsList];
    
    if (currentFilter === "report") {
      filtered = filtered.filter((n) => n.type === "report");
    } else if (currentFilter === "user") {
      filtered = filtered.filter((n) => n.type === "user");
    } else if (currentFilter === "24h") {
      const ago = Date.now() - 24 * 60 * 60 * 1000;
      filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
    }

    filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

    const unreadCount = notificationsList.filter(n => !n.read).length;
    if (unreadCount > 0) {
      notificationBadge.textContent = unreadCount;
      notificationBadge.classList.add("show");
    } else {
      notificationBadge.textContent = "";
      notificationBadge.classList.remove("show");
    }

    if (filtered.length === 0) {
      notificationList.innerHTML = `<div class="notification-empty">No notifications</div>`;
    } else {
      notificationList.innerHTML = filtered
        .map(
          (n) => `
        <div class="notification-item ${n.read ? '' : 'unread'}">
          <div class="notification-icon ${n.type}">
            ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
          </div>
          <div class="notification-content">
            <p><strong>${n.message}</strong></p>
            <p>${n.detail}</p>
            <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
          </div>
        </div>`
        )
        .join("");
    }
  }

  async function setupRealtimeNotifications() {
    loadNotificationsFromLocalStorage();

    onSnapshot(collection(db, "users"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const userId = change.doc.id;
        const data = change.doc.data();
        const currentStatus = normalizeStatus(data.status);
        const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
        const position = data.position || "User";

        if (change.type === "modified") {
          if (currentStatus === "active") {
            const uniqueId = `user-${userId}-active`;
            if (!trackedIds.has(uniqueId)) {
              addNotification("user", `User approved: ${fullName}`, `Position: ${position}`, uniqueId);
            }
          }
        }
      });
    });

    onSnapshot(collection(db, "reports"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const reportId = change.doc.id;
        const data = change.doc.data();
        
        if (change.type === "added") {
          const barangay = data.barangay || data.location || "Unknown location";
          const type = data.reportType || data.type || data.projectName || "Report";
          const uniqueId = `report-${reportId}`;
          addNotification("report", "New report submitted", `${type} in ${barangay}`, uniqueId);
        }
      });
    });

    updateNotificationUI();
    console.log("Notifications system active");
  }

  document.getElementById("addUserForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const firstName = document.getElementById("firstName").value.trim();
    const lastName = document.getElementById("lastName").value.trim();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const barangay = document.getElementById("barangay").value.trim();
    const position = document.getElementById("position").value;
    const password = document.getElementById("password").value;

    const hashedPassword = CryptoJS.SHA256(password).toString();

    const currentUser = auth.currentUser;
    if (!currentUser) {
      alert("You must be logged in to add users");
      return;
    }

    try {
      const userRef = doc(collection(db, "users"));
      await setDoc(userRef, {
        firstName,
        lastName,
        name,
        email,
        barangay,
        position,
        password: password,
        hashedPassword: hashedPassword,
        status: "Pending",
        role: position === "Barangay Official" ? "Official" : "Admin",
        createdAt: serverTimestamp()
      });

      closeModal();
      document.getElementById("addUserForm").reset();
      alert("User added successfully (Pending approval)!");
    } catch (err) {
      console.error("Error adding user:", err);
      alert("Error: " + err.message);
    }
  });

  const pendingTable = document.getElementById("pendingAdmins");
  const activeTable = document.getElementById("activeAdmins");
  const inactiveTable = document.getElementById("inactiveAdmins");
  const activeOfficialsTable = document.getElementById("activeOfficials");
  const inactiveOfficialsTable = document.getElementById("inactiveOfficials");

  const q = query(collection(db, "users"));
  onSnapshot(q, (snap) => {
    pendingTable.innerHTML = "";
    activeTable.innerHTML = "";
    inactiveTable.innerHTML = "";
    activeOfficialsTable.innerHTML = "";
    inactiveOfficialsTable.innerHTML = "";

    snap.forEach(docSnap => {
      const u = docSnap.data();
      const rawStatus = u.status || "";
      const status = normalizeStatus(rawStatus);
      
      const passwordDisplay = u.password 
        ? `<div class="password-cell">
             <span class="password-hidden">••••••••</span>
             <button class="show-password-btn" onclick="toggleTablePassword(this, '${u.password}')" title="Show">
               <i class="fa fa-eye"></i>
             </button>
             <button class="copy-btn" onclick="copyPassword('${u.password}')">
               <i class="fa fa-copy"></i>
             </button>
           </div>`
        : '<span style="color: #999;">N/A</span>';

      let statusBadge = '';
      if (status === "pending") statusBadge = '<span class="status-badge status-pending">Pending</span>';
      else if (status === "active") statusBadge = '<span class="status-badge status-active">Active</span>';
      else if (status === "inactive") statusBadge = '<span class="status-badge status-inactive">Inactive</span>';
      else statusBadge = '<span class="status-badge" style="background:#999;color:#fff;">Unknown</span>';

      const isAdmin = u.position === "Admin" || u.position === "Super Admin";
      const isBrgyOfficial = isBarangayPosition(u.position);

      if (isAdmin) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.firstName || ""}</td>
          <td>${u.lastName || ""}</td>
          <td>${u.email || ""}</td>
          <td>${u.barangay || ""}</td>
          <td>${u.position || ""}</td>
          <td>${passwordDisplay}</td>
          <td>${statusBadge}</td>
          <td>
            ${
              status === "pending" ? `<button onclick="approveUser('${docSnap.id}')">Approve</button>` :
              status === "active" ? `<button onclick="deactivateUser('${docSnap.id}')">Deactivate</button>` :
              status === "inactive" ? `<button onclick="activateUser('${docSnap.id}')">Activate</button>` : ''
            }
            <button onclick="deleteUser('${docSnap.id}')">Delete</button>
          </td>
        `;

        if (status === "pending") pendingTable.appendChild(tr);
        else if (status === "active") activeTable.appendChild(tr);
        else if (status === "inactive") inactiveTable.appendChild(tr);
      }

      if (isBrgyOfficial) {
        const contactDisplay = u.phoneNumber || u.contact || "—";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.firstName || ""}</td>
          <td>${u.lastName || u.surname || ""}</td>
          <td>${u.email || ""}</td>
          <td>${u.barangay || ""}</td>
          <td>${u.position || ""}</td>
          <td>${contactDisplay}</td>
          <td>${statusBadge}</td>
          <td><span class="view-only-cell"><i class="fa fa-eye"></i> View Only</span></td>
        `;

        if (status === "active") activeOfficialsTable.appendChild(tr);
        else if (status === "inactive") inactiveOfficialsTable.appendChild(tr);
      }
    });

    if (pendingTable.innerHTML === "") {
      pendingTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No pending admins found.</td></tr>';
    }
    if (activeTable.innerHTML === "") {
      activeTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No active admins found.</td></tr>';
    }
    if (inactiveTable.innerHTML === "") {
      inactiveTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No inactive admins found.</td></tr>';
    }
    if (activeOfficialsTable.innerHTML === "") {
      activeOfficialsTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No active barangay officials found.</td></tr>';
    }
    if (inactiveOfficialsTable.innerHTML === "") {
      inactiveOfficialsTable.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777;padding:1rem">No inactive barangay officials found.</td></tr>';
    }
  });

  window.approveUser = async (oldDocId) => {
    if (!confirm("Approve this user and create their login credentials?")) return;
    
    try {
      console.log("🔄 Starting approval process for document ID:", oldDocId);
      
      const oldDocRef = doc(db, "users", oldDocId);
      const oldDocSnap = await getDoc(oldDocRef);
      
      if (!oldDocSnap.exists()) {
        alert("User not found.");
        return;
      }
      
      const userData = oldDocSnap.data();
      console.log("User data retrieved:", userData);

      const secondaryApp = initializeApp(firebaseConfig, "Secondary-" + Date.now());
      const secondaryAuth = getAuth(secondaryApp);

      console.log("Creating Firebase Auth account...");
      const userCredential = await createUserWithEmailAndPassword(
        secondaryAuth, 
        userData.email, 
        userData.password
      );
      
      const newUid = userCredential.user.uid;
      console.log("Auth account created with UID:", newUid);

      const newDocRef = doc(db, "users", newUid);
      console.log("Creating new Firestore document with ID:", newUid);
      
      await setDoc(newDocRef, {
        firstName: userData.firstName,
        lastName: userData.lastName,
        name: userData.name,
        email: userData.email,
        barangay: userData.barangay,
        position: userData.position,
        password: userData.password,
        hashedPassword: userData.hashedPassword,
        status: "Active",
        role: userData.role || (userData.position === "Barangay Official" ? "Official" : "Admin"),
        createdAt: userData.createdAt || serverTimestamp(),
        approvedAt: serverTimestamp()
      });
      
      console.log("New document created successfully");

      console.log("Deleting old pending document:", oldDocId);
      await deleteDoc(oldDocRef);
      console.log("Old document deleted");

      await signOut(secondaryAuth);
      await deleteApp(secondaryApp);
      console.log("Secondary app cleaned up");

      alert(`✅ ${userData.name} has been approved successfully!\n\nThey can now login with:\nEmail: ${userData.email}\nPassword: (the one you set)`);
      
    } catch (err) {
      console.error("Error approving user:", err);
      console.error("Error code:", err.code);
      console.error("Error message:", err.message);
      
      if (err.code === 'auth/email-already-in-use') {
        alert("Error: This email is already registered in Firebase Authentication. The user may have already been approved or registered separately.");
      } else if (err.code === 'auth/weak-password') {
        alert("Error: The password is too weak. Please use a stronger password.");
      } else if (err.code === 'auth/invalid-email') {
        alert("Error: Invalid email format.");
      } else {
        alert("Error approving user: " + err.message);
      }
    }
  };

  window.deactivateUser = async (id) => {
    if (confirm("Deactivate this user? They will not be able to login.")) {
      try {
        await updateDoc(doc(db, "users", id), { status: "Inactive" });
        alert("User deactivated successfully!");
      } catch (err) {
        console.error("Error deactivating user:", err);
        alert("Error: " + err.message);
      }
    }
  };

  window.activateUser = async (id) => {
    if (confirm("Activate this user? They will be able to login again.")) {
      try {
        await updateDoc(doc(db, "users", id), { status: "Active" });
        alert("User activated successfully!");
      } catch (err) {
        console.error("Error activating user:", err);
        alert("Error: " + err.message);
      }
    }
  };

  window.deleteUser = async (id) => {
    if (confirm("Are you sure you want to permanently delete this user?\n\nThis action cannot be undone!")) {
      try {
        await deleteDoc(doc(db, "users", id));
        alert("User deleted successfully!");
      } catch (err) {
        console.error("Error deleting user:", err);
        alert("Error: " + err.message);
      }
    }
  };

  window.searchUser = () => {
    const input = document.getElementById("searchInput").value.toLowerCase();
    [pendingTable, activeTable, inactiveTable, activeOfficialsTable, inactiveOfficialsTable].forEach(table => {
      [...table.querySelectorAll("tr")].forEach(row => {
        if (row.cells.length > 0) {
          const firstName = row.cells[0].textContent.toLowerCase();
          const lastName = row.cells[1].textContent.toLowerCase();
          const email = row.cells[2].textContent.toLowerCase();
          const barangay = row.cells[3].textContent.toLowerCase();
          row.style.display = firstName.includes(input) || lastName.includes(input) || email.includes(input) || barangay.includes(input) ? "" : "none";
        }
      });
    });
  };

  const handleLogout = async (e) => {
    e.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
      await signOut(auth);
      window.location.href = "logout.html";
    }
  };

  document.getElementById("sidebarLogoutBtn").addEventListener("click", handleLogout);
  document.getElementById("dropdownLogoutBtn").addEventListener("click", handleLogout);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDocRef = doc(db, "users", user.uid);
      
      onSnapshot(userDocRef, (docSnap) => {
        if (!docSnap.exists()) {
          console.error("User document not found!");
          return;
        }

        const data = docSnap.data();

        let fullName = "Unknown";
        if (data.firstName && data.lastName) {
          fullName = `${data.firstName} ${data.lastName}`;
        } else if (data.name) {
          fullName = data.name;
        } else if (data.firstName) {
          fullName = data.firstName;
        }

        document.getElementById("navUsername").textContent = fullName;

        const photoURL = data.photoURL || data.profilePic || "image.png";
        updateAllProfilePhotos(photoURL);

        superAdminData = {
          uid: user.uid,
          email: user.email,
          position: data.position
        };

        if (data.position !== "Super Admin") {
          alert("Access denied. Only Super Admins can manage users.");
          window.location.href = "dashboard.html";
          return;
        }

        console.log("Super Admin authenticated and authorized");
      }, (error) => {
        console.error("Error in user snapshot:", error);
      });

      await setupRealtimeNotifications();
    } else {
      window.location.href = "logout.html";
    }
  });
</script>
</body>
</html>