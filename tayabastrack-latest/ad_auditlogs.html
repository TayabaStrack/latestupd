<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audit Logs | TayabaStrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; }

        .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; position: fixed; top: 0; left: 0; bottom: 0; z-index: 50; height: 100vh; overflow-y: auto; transition: left 0.3s; }
        .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 2rem; padding: 0 1rem; }
        .sidebar-header img { width: 50px; height: 50px; object-fit: contain; }
        .sidebar-header h2 { font-size: 1.3rem; font-weight: 600; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1rem; text-decoration: none; color: #fff; transition: background 0.3s; border-left: 4px solid transparent; }
        .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }

        .main { flex: 1; margin-left: 240px; display: flex; flex-direction: column; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .navbar h1 { font-size: 1.4rem; color: #004aad; }
        
        .content { flex: 1; padding: 2rem; background: #f5f7fb; }
        
        .filter-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; background: #fff; padding: 1.5rem; border-radius: 12px; }
        .filter-label { font-size: 0.9rem; font-weight: 600; color: #666; }
        .dropdown-filter select { padding: 0.6rem 2.5rem 0.6rem 1rem; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; background: #fff; cursor: pointer; }
        .action-btn { padding: 0.6rem 1.2rem; background: #4a90e2; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-left: auto; }
        .action-btn:hover { background: #357abd; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-label { color: #666; font-size: 0.9rem; }

        .logs-section { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        
        .search-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e0e0e0; }
        .search-input-wrapper { flex: 1; position: relative; }
        .search-input-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #999; }
        .search-input-wrapper input { width: 100%; padding: 0.7rem 1rem 0.7rem 2.5rem; border: 1px solid #e0e0e0; border-radius: 8px; }
        
        .logs-table { width: 100%; border-collapse: collapse; }
        .logs-table thead th { background: #f8f9fb; padding: 1rem; text-align: left; font-weight: 600; color: #666; border-bottom: 2px solid #e0e0e0; }
        .logs-table tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .logs-table tbody tr:hover { background: #f8f9fb; }
        .logs-table tbody td { padding: 1rem; }
        
        .user-cell { display: flex; align-items: center; gap: 0.75rem; }
        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.85rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; }
        
        .empty-state { text-align: center; padding: 3rem; color: #999; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; }

        @media (max-width: 980px) {
            .sidebar { left: -240px; }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" />
                <h2>TayabaStrack</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a></li>
                <li><a href="usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
                <li><a href="reports-pending.html"><i class="fa fa-tasks"></i> Manage Reports</a></li>
                <li class="active"><a href="auditlogs.html"><i class="fa fa-clipboard-list"></i> Audit Logs</a></li>
            </ul>
        </div>
        <div style="padding: 1rem;">
            <button class="action-btn" id="logoutBtn" style="width: 100%; background: #d9534f;">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main">
        <nav class="navbar">
            <h1>Audit Logs</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="navbarName">Loading...</span>
                <img src="image.png" alt="Profile" id="navbarAvatar" style="width: 35px; height: 35px; border-radius: 50%;" />
            </div>
        </nav>

        <div class="content">
            <div class="filter-bar">
                <span class="filter-label">Filters:</span>
                <div class="dropdown-filter">
                    <select id="actionFilter">
                        <option value="">All Actions</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                        <option value="add">Add/Create</option>
                        <option value="edit">Edit</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="status">Status Change</option>
                        <option value="approve">Approve</option>
                        <option value="decline">Decline</option>
                    </select>
                </div>
                <div class="dropdown-filter">
                    <select id="moduleFilter">
                        <option value="">All Modules</option>
                        <option value="Authentication">Authentication</option>
                        <option value="Reports">Reports</option>
                        <option value="Users">Users</option>
                        <option value="System">System</option>
                    </select>
                </div>
                <div class="dropdown-filter">
                    <select id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="Super Admin">Super Admin</option>
                        <option value="Admin">Admin</option>
                        <option value="Engineer">Engineer</option>
                    </select>
                </div>
                <button class="action-btn" onclick="exportToCSV()">
                    <i class="fa fa-download"></i> Export CSV
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-left: 4px solid #4a90e2;">
                    <div class="stat-number" id="totalLogs" style="color: #4a90e2;">0</div>
                    <div class="stat-label">Total Logs</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #5cb85c;">
                    <div class="stat-number" id="totalAdded" style="color: #5cb85c;">0</div>
                    <div class="stat-label">Added/Created</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f0ad4e;">
                    <div class="stat-number" id="totalEdited" style="color: #f0ad4e;">0</div>
                    <div class="stat-label">Edited/Updated</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #d9534f;">
                    <div class="stat-number" id="totalDeleted" style="color: #d9534f;">0</div>
                    <div class="stat-label">Deleted/Declined</div>
                </div>
            </div>

            <div class="logs-section">
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <i class="fa fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search logs..." />
                    </div>
                    <button class="action-btn" onclick="loadAuditLogs()" style="padding: 0.6rem 1rem;">
                        <i class="fa fa-sync-alt"></i>
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Module</th>
                                <th>Description</th>
                                <th>Changes</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <i class="fa fa-spinner fa-spin"></i>
                                    <p>Loading audit logs...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, collection, addDoc, onSnapshot, 
            query, orderBy, serverTimestamp, limit, where
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
            authDomain: "tayabastrack-23b95.firebaseapp.com",
            projectId: "tayabastrack-23b95",
            storageBucket: "tayabastrack-23b95.firebasestorage.app",
            messagingSenderId: "674055915366",
            appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allLogs = [];
        let filteredLogs = [];

        // Global audit logging function
        window.logAuditEvent = async function(action, actionType, module, description, additionalData = {}) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const logData = {
                    timestamp: serverTimestamp(),
                    userId: user.uid,
                    userName: userData.name || `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || "Unknown",
                    userRole: userData.position || "User",
                    action: action,
                    actionType: (actionType || 'edit').toLowerCase(),
                    module: module || 'System',
                    description: description,
                    beforeValue: additionalData.beforeValue || null,
                    afterValue: additionalData.afterValue || null,
                    barangay: additionalData.barangay || null,
                    ...additionalData
                };

                await addDoc(collection(db, "auditLogs"), logData);
                console.log("✅ Audit logged:", action);
            } catch (error) {
                console.error("❌ Audit log error:", error);
            }
        };

        function getAvatarColor(name) {
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            return colors[name.charCodeAt(0) % colors.length];
        }

        function getInitials(name) {
            const parts = name.split(' ');
            return parts.length >= 2 
                ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() 
                : name.substring(0, 2).toUpperCase();
        }

        function getActionColor(actionType) {
            const colors = {
                'add': '#5cb85c', 'approve': '#5cb85c',
                'edit': '#f0ad4e', 'update': '#f0ad4e', 'status': '#f0ad4e',
                'delete': '#d9534f', 'decline': '#d9534f',
                'login': '#5bc0de', 'logout': '#999'
            };
            return colors[actionType?.toLowerCase()] || '#999';
        }

        function updateStats() {
            const adds = allLogs.filter(log => ['add', 'approve'].includes(log.actionType?.toLowerCase())).length;
            const edits = allLogs.filter(log => ['edit', 'update', 'status'].includes(log.actionType?.toLowerCase())).length;
            const deletes = allLogs.filter(log => ['delete', 'decline'].includes(log.actionType?.toLowerCase())).length;

            document.getElementById('totalLogs').textContent = allLogs.length;
            document.getElementById('totalAdded').textContent = adds;
            document.getElementById('totalEdited').textContent = edits;
            document.getElementById('totalDeleted').textContent = deletes;
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const actionFilter = document.getElementById('actionFilter').value.toLowerCase();
            const moduleFilter = document.getElementById('moduleFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;

            filteredLogs = allLogs.filter(log => {
                const matchSearch = !search || 
                    log.userName.toLowerCase().includes(search) ||
                    log.description.toLowerCase().includes(search) ||
                    log.action.toLowerCase().includes(search);
                
                const matchAction = !actionFilter || log.actionType?.toLowerCase() === actionFilter;
                const matchModule = !moduleFilter || log.module === moduleFilter;
                const matchRole = !roleFilter || log.userRole === roleFilter;

                return matchSearch && matchAction && matchModule && matchRole;
            });

            renderLogs();
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('actionFilter').addEventListener('change', applyFilters);
        document.getElementById('moduleFilter').addEventListener('change', applyFilters);
        document.getElementById('roleFilter').addEventListener('change', applyFilters);

        function renderLogs() {
            const tbody = document.getElementById('logsTableBody');

            if (filteredLogs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fa fa-inbox"></i>
                            <p>No audit logs found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredLogs.slice(0, 100).map(log => {
                const date = new Date(log.timestamp);
                const dateStr = date.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const initials = getInitials(log.userName);
                const avatarColor = getAvatarColor(log.userName);
                const actionColor = getActionColor(log.actionType);
                
                return `
                    <tr>
                        <td style="white-space: nowrap; color: #666; font-size: 0.9rem;">${dateStr}</td>
                        <td>
                            <div class="user-cell">
                                <div class="avatar-circle" style="background: ${avatarColor}">${initials}</div>
                                <div>
                                    <div style="font-weight: 600;">${log.userName}</div>
                                    <div style="color: #999; font-size: 0.85rem;">${log.userRole}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-dot" style="background: ${actionColor}"></span>
                            <span style="font-weight: 500;">${log.action}</span>
                        </td>
                        <td><span style="color: #666;">${log.module}</span></td>
                        <td>${log.description}</td>
                        <td>
                            ${log.beforeValue && log.afterValue ? 
                                `<div style="font-size: 0.85rem; color: #666;">
                                    <div><strong>From:</strong> ${log.beforeValue}</div>
                                    <div><strong>To:</strong> ${log.afterValue}</div>
                                </div>` : 
                                '<span style="color: #999;">—</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.loadAuditLogs = function() {
            const logsQuery = query(
                collection(db, "auditLogs"),
                orderBy("timestamp", "desc"),
                limit(500)
            );

            onSnapshot(logsQuery, (snapshot) => {
                allLogs = [];
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const timestamp = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
                    
                    allLogs.push({
                        id: docSnap.id,
                        timestamp: timestamp,
                        userId: data.userId || "",
                        userName: data.userName || "Unknown",
                        userRole: data.userRole || "User",
                        action: data.action || "Unknown Action",
                        actionType: data.actionType?.toLowerCase() || "edit",
                        module: data.module || "System",
                        description: data.description || "",
                        beforeValue: data.beforeValue || "",
                        afterValue: data.afterValue || "",
                        barangay: data.barangay || ""
                    });
                });

                filteredLogs = [...allLogs];
                renderLogs();
                updateStats();
                console.log(`✅ Loaded ${allLogs.length} audit logs`);
            }, (error) => {
                console.error("❌ Error loading logs:", error);
                document.getElementById('logsTableBody').innerHTML = `
                    <tr><td colspan="6" class="empty-state">
                        <i class="fa fa-exclamation-triangle"></i>
                        <p>Error: ${error.message}</p>
                    </td></tr>
                `;
            });
        };

        window.exportToCSV = function() {
            const headers = ['Timestamp', 'User', 'Role', 'Action', 'Module', 'Description', 'Before', 'After'];
            const rows = filteredLogs.map(log => [
                new Date(log.timestamp).toLocaleString(),
                log.userName, log.userRole, log.action, log.module,
                log.description, log.beforeValue || '', log.afterValue || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.download = `audit-logs-${Date.now()}.csv`;
            link.href = URL.createObjectURL(blob);
            link.click();
        };

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await window.logAuditEvent("Logged Out", "logout", "Authentication", "User logged out");
            await signOut(auth);
            window.location.href = "login.html";
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists()) return;

            const userData = userDoc.data();
            const position = userData.position;

            // ✅ ALLOW BOTH SUPER ADMIN AND ADMIN
            if (position !== "Super Admin" && position !== "Admin") {
                alert("Access denied! Only admins can view audit logs.");
                window.location.href = "dashboard.html";
                return;
            }

            const fullName = userData.name || 
                `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || 
                "User";
            
            document.getElementById('navbarName').textContent = fullName;
            document.getElementById('navbarAvatar').src = userData.photoURL || "image.png";

            loadAuditLogs();
        });
    </script>
</body>
</html>