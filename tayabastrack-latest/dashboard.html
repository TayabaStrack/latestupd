<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Super Admin Dashboard | TayabaStrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow-x: hidden; }

        .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; position: fixed; top: 0; left: 0; bottom: 0; z-index: 50; height: 100vh; overflow-y: auto; transition: left 0.3s; }
        .sidebar-header { display: flex; align-items: center; justify-content: flex-start; gap: 12px; margin-bottom: 2rem; padding: 0 1rem; }
        .sidebar-header img { width: 50px; height: 50px; object-fit: contain; }
        .sidebar-header h2 { font-size: 1.3rem; font-weight: 600; }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu li { margin: 0.5rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1.5rem; text-decoration: none; color: #fff; transition: background 0.3s; border-left: 4px solid transparent; }
        .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }
        
        /* ✅ IMPROVED SUBMENU STYLING */
        .sidebar-submenu {
          list-style: none;
          padding-left: 0;
          margin: 0;
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease;
          background: rgba(0, 0, 0, 0.1);
        }
        .sidebar-submenu.open {
          max-height: 500px;
        }
        .sidebar-submenu li {
          margin: 0;
        }
        .sidebar-submenu a {
          padding: 0.6rem 1.5rem 0.6rem 3rem !important;
          font-size: 0.9rem;
          border-left: 4px solid transparent;
        }
        .sidebar-submenu li.active a {
          background: #042f68;
          border-left: 4px solid #fff;
        }
        .has-submenu > a {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .has-submenu > a .fa-chevron-down {
          transition: transform 0.3s ease;
          margin-left: auto;
        }

        .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
        .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .logout-btn:hover { background-color: #c9302c; }

        .main { flex: 1; display: flex; flex-direction: column; margin-left: 240px; transition: margin-left 0.3s; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        .navbar h1 { font-size: 1.4rem; color: #004aad; }
        .navbar-left { display: flex; align-items: center; gap: 1rem; }
        .mobile-menu-btn { display: none; background: none; border: none; color: #004aad; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
        .profile { display: flex; align-items: center; gap: 1rem; }
        .fa-bell { font-size: 1.2rem; position: relative; cursor: pointer; color: #333; }
        .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 18px; text-align: center; }
        .badge.show { display: flex; align-items: center; justify-content: center; }

        .profile-dropdown { position: relative; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background 0.2s; }
        .profile-dropdown:hover { background: #f5f7fb; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #004aad; }
        .username { font-weight: 500; color: #333; }
        
        .notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); width: 340px; max-height: 420px; overflow: hidden; z-index: 1000; font-family: "Segoe UI", Tahoma, sans-serif; animation: fadeIn 0.2s ease-in-out; }
        .notification-menu.show { display: block; }

        .notification-header { padding: 0.9rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
        .notification-header h3 { font-size: 1rem; color: #333; margin: 0; font-weight: 600; }
        .notification-actions { display: flex; gap: 0.5rem; align-items: center; }
        .action-icon-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.3rem; transition: color 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .action-icon-btn:hover { color: #004aad; }
        .action-icon-btn i { font-size: 0.95rem; }

        .notification-filters { display: flex; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; background: #fafafa; }
        .filter-btn { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.8rem; background: #f2f2f2; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.25s ease; color: #333; }
        .filter-btn:hover { background: #004aad; color: #fff; }
        .filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }

        .notification-list { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ccc transparent; }
        .notification-list::-webkit-scrollbar { width: 6px; }
        .notification-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .notification-list::-webkit-scrollbar-track { background: transparent; }

        .notification-item { padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; align-items: flex-start; transition: background 0.2s; position: relative; }
        .notification-item:hover { background: #f5f7ff; }
        .notification-item.unread { background: #f0f7ff; }
        .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: #004aad; border-radius: 0 4px 4px 0; }
        .notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
        .notification-icon.user { background: #e3f2fd; color: #1976d2; }
        .notification-icon.report { background: #fff3e0; color: #f57c00; }
        .notification-content { flex: 1; }
        .notification-content p { margin: 0; font-size: 0.86rem; color: #333; line-height: 1.3; }
        .notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.25rem; }
        .notification-empty { padding: 2rem; text-align: center; color: #999; font-size: 0.9rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); min-width: 160px; z-index: 1000; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.85rem; transition: background 0.2s; }
        .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
        .dropdown-menu a i { margin-right: 8px; width: 20px; text-align: center; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem; }
        .card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .card i { font-size: 1.8rem; color: #004aad; }
        .card p { font-size: 0.9rem; color: #666; }
        .card h2 { font-size: 1.5rem; font-weight: bold; }

        .bottom { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        .reports, .map, .barangay-chart { background: #fff; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .reports h3, .map h3, .barangay-chart h3 { margin-bottom: 1rem; color: #004aad; }
        canvas { width: 100% !important; height: 250px !important; }
        #miniMap { height: 250px !important; border-radius: 10px; width: 100%; }

        .images { padding: 1.5rem; }
        .images h3 { color: #004aad; margin-bottom: 1rem; }
        .image-gallery { display: flex; gap: 1rem; flex-wrap: wrap; }
        .image-gallery img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        @media (max-width: 980px) {
            .sidebar { left: -240px; }
            .sidebar.mobile-open { left: 0; }
            .main { margin-left: 0; }
            .mobile-menu-btn { display: block !important; }
            .bottom { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="logo" />
                <h2>TayabaStrack</h2>
            </div>
            <!-- ✅ UPDATED SIDEBAR MENU WITH IMPROVED SUBMENU -->
            <ul class="sidebar-menu">
                <li class="active"><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
                <li><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
                <li class="has-submenu">
                  <a href="#" onclick="toggleSubmenu(event)">
                    <span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
                    <i class="fa fa-chevron-down"></i>
                  </a>
                  <ul class="sidebar-submenu">
                    <li><a href="reports-pending.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
                    <li><a href="reports-ongoing.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
                    <li><a href="reports-completed.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
                    <li><a href="reports-declined.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
                  </ul>
                </li>
                <li><a href="auditlogs.html"><i class="fa fa-clipboard-list"></i>&nbsp; Audit Logs</a></li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main">
        <nav class="navbar">
            <div class="navbar-left">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fa fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
            </div>
            <div class="profile">
                <div style="position: relative;">
                    <i class="fa fa-bell" id="notificationBell"></i>
                    <span class="badge" id="notificationBadge">0</span>

                    <div class="notification-menu" id="notificationMenu">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read">
                                    <i class="fa fa-check-double"></i>
                                </button>
                                <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all">
                                    <i class="fa fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>

                        <div class="notification-filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="report">Reports</button>
                            <button class="filter-btn" data-filter="user">Users</button>
                            <button class="filter-btn" data-filter="24h">Last 24h</button>
                        </div>

                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No new notifications</div>
                        </div>
                    </div>
                </div>

                <div class="profile-dropdown" id="profileToggle">
                    <img src="image.png" alt="Profile" class="avatar" id="navbarAvatar" />
                    <span class="username" id="navbarName">---</span>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
                    </div>
                </div>
            </div>
        </nav>

        <section class="stats">
            <div class="card"><i class="fa fa-chart-bar"></i><div><p>Total Reports</p><h2 id="totalReports">0</h2></div></div>
            <div class="card"><i class="fa fa-clock"></i><div><p>Pending</p><h2 id="pendingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-sync"></i><div><p>Ongoing</p><h2 id="ongoingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-check-circle"></i><div><p>Completed</p><h2 id="completedReports">0</h2></div></div>
        </section>

        <section class="bottom">
            <div class="reports">
                <h3>Total Reports</h3>
                <canvas id="dashboardChart"></canvas>
            </div>

            <div class="barangay-chart">
                <h3>Barangay Reports</h3>
                <canvas id="barangayChart"></canvas>
            </div>

            <div class="map">
                <h3>Map</h3>
                <div id="miniMap"></div>
            </div>
        </section>

        <section class="images">
            <h3>Recent Report Images</h3>
            <div class="image-gallery" id="reportImages"></div>
        </section>
    </main>

    <script>
        // ✅ IMPROVED SUBMENU TOGGLE FUNCTION
        function toggleSubmenu(event) {
            event.preventDefault();
            const submenu = event.currentTarget.nextElementSibling;
            const chevron = event.currentTarget.querySelector('.fa-chevron-down');

            if (submenu) {
                submenu.classList.toggle('open');
            }
            if (chevron) {
                chevron.style.transform = submenu.classList.contains('open') 
                    ? 'rotate(180deg)' 
                    : 'rotate(0deg)';
            }
        }

        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
        }

        document.addEventListener('click', function(e) {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (window.innerWidth <= 980 && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        let miniMap;
        window.reportLocations = [];

        function initMiniMap() {
            const tayabasRizalPark = { lat: 14.0167747, lng: 121.5857253 };
            miniMap = new google.maps.Map(document.getElementById("miniMap"), {
                zoom: 13,
                center: tayabasRizalPark,
                mapTypeId: 'roadmap'
            });

            new google.maps.Marker({
                position: tayabasRizalPark,
                map: miniMap,
                title: "Tayabas City - Rizal Park",
                icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
            });

            addReportMarkers();
        }

        function addReportMarkers() {
            if (!miniMap || !window.reportLocations) return;
            window.reportLocations.forEach((report) => {
                let markerColor = "red";
                if (report.status === "resolved" || report.status === "completed") markerColor = "green";
                else if (report.status === "ongoing" || report.status === "in-progress") markerColor = "yellow";

                new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: miniMap,
                    title: report.type,
                    icon: { url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png` }
                });
            });
        }

        function updateAllProfilePhotos(photoURL) {
            const photoElements = ["navbarAvatar"];
            photoElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.src = photoURL;
                    el.onerror = function() {
                        this.src = "image.png";
                    };
                }
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJkfi59FibsnD-dxAdyYUohj36N_bOtfE&callback=initMiniMap"></script>

   <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, collection, getDocs, onSnapshot 
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.firebasestorage.app",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const navbarName = document.getElementById("navbarName");
  const navbarAvatar = document.getElementById("navbarAvatar");
  const logoutBtn = document.getElementById("logoutBtn");

  const totalReportsEl = document.getElementById("totalReports");
  const pendingEl = document.getElementById("pendingReports");
  const ongoingEl = document.getElementById("ongoingReports");
  const completedEl = document.getElementById("completedReports");

  const notificationBell = document.getElementById("notificationBell");
  const notificationBadge = document.getElementById("notificationBadge");
  const notificationMenu = document.getElementById("notificationMenu");
  const notificationList = document.getElementById("notificationList");
  const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
  const markAllReadBtn = document.getElementById("markAllReadBtn");
  const profileToggle = document.getElementById("profileToggle");
  const dropdownMenu = document.getElementById("dropdownMenu");

  let notificationsList = [];
  let trackedIds = new Set();
  let currentFilter = "all";

  function normalizeStatus(status) {
    return (status || "").toLowerCase().trim();
  }

  function saveNotificationsToLocalStorage() {
    try {
      localStorage.setItem('notifications', JSON.stringify(notificationsList));
      localStorage.setItem('trackedIds', JSON.stringify([...trackedIds]));
    } catch (error) {
      console.error("Error saving notifications:", error);
    }
  }

  function loadNotificationsFromLocalStorage() {
    try {
      const savedNotifications = localStorage.getItem('notifications');
      const savedTrackedIds = localStorage.getItem('trackedIds');
      
      if (savedNotifications) {
        notificationsList = JSON.parse(savedNotifications).map(n => ({
          ...n,
          timestamp: new Date(n.timestamp)
        }));
      }
      
      if (savedTrackedIds) {
        trackedIds = new Set(JSON.parse(savedTrackedIds));
      }
    } catch (error) {
      console.error("Error loading notifications:", error);
    }
  }

  notificationBell.addEventListener("click", (e) => {
    e.stopPropagation();
    notificationMenu.classList.toggle("show");
    dropdownMenu.classList.remove("show");
  });

  clearNotificationsBtn.addEventListener("click", () => {
    notificationsList = [];
    trackedIds.clear();
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  });

  markAllReadBtn.addEventListener("click", () => {
    notificationsList.forEach(n => n.read = true);
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  });

  profileToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("show");
    notificationMenu.classList.remove("show");
  });

  window.addEventListener("click", (e) => {
    if (!e.target.closest(".profile-dropdown")) {
      dropdownMenu.classList.remove("show");
    }
    if (!e.target.closest(".notification-menu") && e.target !== notificationBell) {
      notificationMenu.classList.remove("show");
    }
  });

  document.querySelectorAll(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      e.target.classList.add("active");
      currentFilter = e.target.dataset.filter;
      updateNotificationUI();
    });
  });

  function addNotification(type, message, detail, uniqueId) {
    if (trackedIds.has(uniqueId)) return;
    
    trackedIds.add(uniqueId);
    
    const timestamp = new Date();
    const id = `${type}-${uniqueId}-${timestamp.getTime()}`;
    
    notificationsList.unshift({
      id,
      type,
      message: message.trim(),
      detail: detail.trim(),
      timestamp: timestamp,
      read: false
    });
    
    saveNotificationsToLocalStorage();
    updateNotificationUI();
  }

  function updateNotificationUI() {
    let filtered = [...notificationsList];
    
    if (currentFilter === "report") {
      filtered = filtered.filter((n) => n.type === "report");
    } else if (currentFilter === "user") {
      filtered = filtered.filter((n) => n.type === "user");
    } else if (currentFilter === "24h") {
      const ago = Date.now() - 24 * 60 * 60 * 1000;
      filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
    }

    filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

    const unreadCount = notificationsList.filter(n => !n.read).length;
    if (unreadCount > 0) {
      notificationBadge.textContent = unreadCount;
      notificationBadge.classList.add("show");
    } else {
      notificationBadge.textContent = "";
      notificationBadge.classList.remove("show");
    }

    if (filtered.length === 0) {
      notificationList.innerHTML = `<div class="notification-empty">No notifications</div>`;
    } else {
      notificationList.innerHTML = filtered
        .map(
          (n) => `
        <div class="notification-item ${n.read ? '' : 'unread'}">
          <div class="notification-icon ${n.type}">
            ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
          </div>
          <div class="notification-content">
            <p><strong>${n.message}</strong></p>
            <p>${n.detail}</p>
            <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
          </div>
        </div>`
        )
        .join("");
    }
  }

  async function setupRealtimeNotifications() {
    loadNotificationsFromLocalStorage();

    onSnapshot(collection(db, "users"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const userId = change.doc.id;
        const data = change.doc.data();
        const currentStatus = normalizeStatus(data.status);
        const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
        const position = data.position || "User";

        if (change.type === "added" || change.type === "modified") {
          if (currentStatus === "active") {
            const uniqueId = `user-${userId}-active`;
            addNotification("user", `User approved: ${fullName}`, `Position: ${position}`, uniqueId);
          }
        }
      });
    });

    onSnapshot(collection(db, "reports"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const reportId = change.doc.id;
        const data = change.doc.data();
        
        if (change.type === "added") {
          const barangay = data.barangay || data.location || "Unknown location";
          const type = data.reportType || data.type || data.projectName || "Report";
          const uniqueId = `report-${reportId}`;
          addNotification("report", "New report submitted", `${type} in ${barangay}`, uniqueId);
        }});
});
updateNotificationUI();
console.log("Notifications system active");
}
async function getImageUrl(imagePath) {
try {
if (!imagePath) return null;
if (imagePath.startsWith("http")) return imagePath;
return await getDownloadURL(ref(storage, imagePath));
} catch (error) {
console.error("Error getting image URL:", error);
return null;
}
}
onAuthStateChanged(auth, async (user) => {
if (!user) return (window.location.href = "login.html");
const userDocRef = doc(db, "users", user.uid);

onSnapshot(userDocRef, (docSnap) => {
  if (!docSnap.exists()) {
    console.error("User document not found!");
    return;
  }

  const data = docSnap.data();
  
  if (data.position !== "Super Admin") {
    alert("Unauthorized access! Redirecting...");
    window.location.href = "login.html";
    return;
  }
  
  let fullName = "Super Admin";
  if (data.firstName && data.lastName) {
    fullName = `${data.firstName} ${data.lastName}`;
  } else if (data.name) {
    fullName = data.name;
  } else if (data.firstName) {
    fullName = data.firstName;
  }

  navbarName.textContent = fullName;

  const photoURL = data.photoURL || data.profilePic || "image.png";
  updateAllProfilePhotos(photoURL);

  console.log("User profile updated in real-time");
}, (error) => {
  console.error("Error in user snapshot:", error);
});

await loadDashboardData();
await setupRealtimeNotifications();
});
logoutBtn.addEventListener("click", async () => {
await signOut(auth);
window.location.href = "login.html";
});
async function loadDashboardData() {
const snapshot = await getDocs(collection(db, "reports"));
let total = 0, pending = 0, ongoing = 0, completed = 0;
window.reportLocations = [];
const barangayData = {};
snapshot.forEach((docSnap) => {
  const report = docSnap.data();
  total++;
  const status = normalizeStatus(report.status);
  if (status === "pending") pending++;
  else if (status === "ongoing" || status === "in-progress") ongoing++;
  else if (["resolved", "completed", "repaired", "posted"].includes(status)) completed++;

  const barangay = report.barangay || report.location || "Unknown";
  barangayData[barangay] = (barangayData[barangay] || 0) + 1;

  const lat = report.latitude || report.lat || report.location?.latitude;
  const lng = report.longitude || report.lng || report.location?.longitude;
  if (lat && lng) {
    window.reportLocations.push({
      lat: parseFloat(lat),
      lng: parseFloat(lng),
      type: report.reportType || report.type || "Unknown",
      status: status || "pending"
    });
  }
});

totalReportsEl.textContent = total;
pendingEl.textContent = pending;
ongoingEl.textContent = ongoing;
completedEl.textContent = completed;

updateChart(completed, ongoing, pending);
updateBarangayChart(barangayData);

if (window.miniMap) {
  addReportMarkers();
}

loadReportImages();
}
let chart;
function updateChart(completed, ongoing, pending) {
const ctx = document.getElementById("dashboardChart").getContext("2d");
if (chart) chart.destroy();
chart = new Chart(ctx, {
type: "bar",
data: {
labels: ["Completed", "Ongoing", "Pending"],
datasets: [{
label: "Reports",
data: [completed, ongoing, pending],
backgroundColor: ["#1cc88a", "#36b9cc", "#f6c23e"]
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { display: false } }
}
});
}
let barangayChart;
function updateBarangayChart(barangayData) {
const ctx = document.getElementById("barangayChart").getContext("2d");
if (barangayChart) barangayChart.destroy();
const sortedBarangays = Object.entries(barangayData)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

const labels = sortedBarangays.map(item => item[0]);
const data = sortedBarangays.map(item => item[1]);

barangayChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: labels,
    datasets: [{
      label: "Number of Reports",
      data: data,
      borderColor: "#004aad",
      backgroundColor: "rgba(0, 74, 173, 0.1)",
      borderWidth: 2,
      fill: true,
      tension: 0.4,
      pointBackgroundColor: "#004aad",
      pointBorderColor: "#fff",
      pointBorderWidth: 2,
      pointRadius: 4,
      pointHoverRadius: 6
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: true,
        position: 'top'
      },
      tooltip: {
        enabled: true,
        backgroundColor: 'rgba(0, 74, 173, 0.8)',
        titleColor: '#fff',
        bodyColor: '#fff',
        borderColor: '#004aad',
        borderWidth: 1
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        grid: {
          color: 'rgba(0, 0, 0, 0.05)'
        }
      },
      x: {
        grid: {
          display: false
        },
        ticks: {
          maxRotation: 45,
          minRotation: 45
        }
      }
    }
  }
});
}
async function loadReportImages() {
const gallery = document.getElementById("reportImages");
gallery.innerHTML = "";
const snapshot = await getDocs(collection(db, "reports"));
let count = 0;
for (const docSnap of snapshot.docs) {
  if (count >= 6) break;
  const report = docSnap.data();
  const imagePath = report.incidentImage || report.imageUrl || report.image;
  if (imagePath) {
    const url = await getImageUrl(imagePath);
    if (url) {
      const img = document.createElement("img");
      img.src = url;
      img.onerror = () => (img.style.display = "none");
      gallery.appendChild(img);
      count++;
    }
  }
}
}
</script>
</body>
</html>