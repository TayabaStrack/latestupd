<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | TayabaStrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; }

        .sidebar { width: 240px; background: #004aad; color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0; }
        .sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; }
        .sidebar-header img { width: 40px; }
        .sidebar-header h2 { font-size: 1.2rem; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin: 0.5rem 0; }
        .sidebar-menu a { display: flex; align-items: center; gap: 10px; padding: 0.8rem 1.5rem; text-decoration: none; color: #fff; transition: background 0.3s; }
        .sidebar-menu li.active a, .sidebar-menu a:hover { background: #0756cc; border-left: 4px solid #042f68; }

        .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); }
        .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s; width: 100%; }
        .logout-btn:hover { background-color: #c9302c; }

        .main { flex: 1; display: flex; flex-direction: column; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        .navbar h1 { font-size: 1.4rem; color: #004aad; }
        .profile { display: flex; align-items: center; gap: 1rem; }
        .fa-bell { font-size: 1.2rem; position: relative; cursor: pointer; }
        .badge { background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; }
        .badge.show { display: flex; align-items: center; justify-content: center; }

        .profile-dropdown { position: relative; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .username { font-weight: 500; }
        
      /* ✅ Notification Dropdown Container */
.notification-menu {
  display: none;
  position: absolute;
  top: 120%;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  width: 340px;
  max-height: 420px;
  overflow: hidden;
  z-index: 1000;
  font-family: "Segoe UI", Tahoma, sans-serif;
  animation: fadeIn 0.2s ease-in-out;
}

.notification-menu.show {
  display: block;
}

/* ✅ Header Section */
.notification-header {
  padding: 0.9rem 1rem;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9f9f9;
}

.notification-header h3 {
  font-size: 1rem;
  color: #333;
  margin: 0;
  font-weight: 600;
}

.clear-btn {
  background: none;
  border: none;
  color: #004aad;
  cursor: pointer;
  font-size: 0.85rem;
  transition: color 0.2s ease;
}

.clear-btn:hover {
  color: #003380;
  text-decoration: underline;
}

/* ✅ Filter Buttons Section */
.notification-filters {
  display: flex;
  justify-content: space-between;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-bottom: 1px solid #eee;
  background: #fafafa;
}

.filter-btn {
  flex: 1;
  padding: 0.4rem 0.6rem;
  font-size: 0.8rem;
  background: #f2f2f2;
  border: 1px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.25s ease;
  color: #333;
}

.filter-btn:hover {
  background: #004aad;
  color: #fff;
}

.filter-btn.active {
  background: #004aad;
  color: #fff;
  border-color: #004aad;
}

/* ✅ Notification List */
.notification-list {
  max-height: 300px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #ccc transparent;
}

.notification-list::-webkit-scrollbar {
  width: 6px;
}

.notification-list::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 10px;
}

.notification-list::-webkit-scrollbar-track {
  background: transparent;
}

/* ✅ Notification Item */
.notification-item {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  gap: 0.8rem;
  align-items: flex-start;
  transition: background 0.2s;
}

.notification-item:hover {
  background: #f5f7ff;
}

.notification-icon {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 1rem;
}

.notification-icon.user {
  background: #e3f2fd;
  color: #1976d2;
}

.notification-icon.report {
  background: #fff3e0;
  color: #f57c00;
}

.notification-content {
  flex: 1;
}

.notification-content p {
  margin: 0;
  font-size: 0.86rem;
  color: #333;
  line-height: 1.3;
}

.notification-content .time {
  color: #999;
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* ✅ Empty State */
.notification-empty {
  padding: 2rem;
  text-align: center;
  color: #999;
  font-size: 0.9rem;
}

/* ✨ Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}


        .dropdown-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); min-width: 160px; z-index: 1000; }
        .dropdown-menu a { display: block; padding: 0.6rem 1rem; text-decoration: none; color: #333; font-size: 0.85rem; }
        .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem; }
        .card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .card i { font-size: 1.8rem; color: #004aad; }
        .card p { font-size: 0.9rem; color: #666; }
        .card h2 { font-size: 1.5rem; font-weight: bold; }

        .bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        .reports, .map { background: #fff; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .reports h3, .map h3 { margin-bottom: 1rem; color: #004aad; }
        canvas { width: 100% !important; height: 250px !important; }
        #miniMap { height: 250px !important; border-radius: 10px; width: 100%; }

        .images h3 { color: #004aad; margin-bottom: 1rem; }
        .image-gallery { display: flex; gap: 1rem; flex-wrap: wrap; }
        .image-gallery img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logu.png" alt="Logo" class="logo" />
                <h2>TayabaStrack</h2>
            </div>
           <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
                <li><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
                <li class="active"><a href="reports.html"><i class="fa fa-tasks"></i>&nbsp; Manage Reports</a></li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main -->
<main class="main">
  <nav class="navbar">
    <h1>Dashboard</h1>
    <div class="profile">
      <div style="position: relative;">
        <i class="fa fa-bell" id="notificationBell"></i>
        <span class="badge" id="notificationBadge">0</span>

        <!-- Notification Menu -->
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <button class="clear-btn" id="clearNotificationsBtn">Clear all</button>
          </div>

          <!-- ✅ Filter buttons -->
          <div class="notification-filters">
            <button class="filter-btn" data-filter="all">All</button>
            <button class="filter-btn" data-filter="report">Reports</button>
            <button class="filter-btn" data-filter="user">Users</button>
            <button class="filter-btn" data-filter="24h">Last 24h</button>
          </div>

          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>

      <div class="profile-dropdown" id="profileToggle">
        <img src="image.png" alt="Profile" class="avatar" id="navbarAvatar" />
        <span class="username" id="navbarName">---</span>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
        </div>
      </div>
    </div>
  </nav>


        <!-- Stats Cards -->
        <section class="stats">
            <div class="card"><i class="fa fa-chart-bar"></i><div><p>Total Reports</p><h2 id="totalReports">0</h2></div></div>
            <div class="card"><i class="fa fa-clock"></i><div><p>Pending</p><h2 id="pendingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-sync"></i><div><p>Ongoing</p><h2 id="ongoingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-check-circle"></i><div><p>Completed</p><h2 id="completedReports">0</h2></div></div>
        </section>

        <!-- Reports & Map -->
        <section class="bottom">
            <div class="reports">
                <h3>Total Reports</h3>
                <canvas id="dashboardChart"></canvas>
            </div>

            <div class="map">
                <h3>Map</h3>
                <div id="miniMap"></div>
            </div>
        </section>

        <section class="images" style="padding:1.5rem;">
            <h3>Recent Report Images</h3>
            <div class="image-gallery" id="reportImages"></div>
        </section>
    </main>

    <!-- Google Maps -->
    <script>
        let miniMap;
        window.reportLocations = [];

        function initMiniMap() {
            const tayabasRizalPark = { lat: 14.0167747, lng: 121.5857253 };
            miniMap = new google.maps.Map(document.getElementById("miniMap"), {
                zoom: 13,
                center: tayabasRizalPark,
                mapTypeId: 'roadmap'
            });

            new google.maps.Marker({
                position: tayabasRizalPark,
                map: miniMap,
                title: "Tayabas City - Rizal Park",
                icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
            });

            addReportMarkers();
        }

        function addReportMarkers() {
            if (!miniMap || !window.reportLocations) return;
            window.reportLocations.forEach((report) => {
                let markerColor = "red";
                if (report.status === "resolved" || report.status === "completed") markerColor = "green";
                else if (report.status === "ongoing" || report.status === "in-progress") markerColor = "yellow";

                new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: miniMap,
                    title: report.type,
                    icon: { url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png` }
                });
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJkfi59FibsnD-dxAdyYUohj36N_bOtfE&callback=initMiniMap"></script>

    <!-- Firebase + Chart -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
            authDomain: "tayabastrack-23b95.firebaseapp.com",
            projectId: "tayabastrack-23b95",
            storageBucket: "tayabastrack-23b95.firebasestorage.app",
            messagingSenderId: "674055915366",
            appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const navbarName = document.getElementById("navbarName");
        const navbarAvatar = document.getElementById("navbarAvatar");
        const logoutBtn = document.getElementById("logoutBtn");

        const totalReportsEl = document.getElementById("totalReports");
        const pendingEl = document.getElementById("pendingReports");
        const ongoingEl = document.getElementById("ongoingReports");
        const completedEl = document.getElementById("completedReports");

        let notificationsList = [];
        let trackedUsers = new Set();
        let trackedReports = new Set();

        const notificationBell = document.getElementById("notificationBell");
        const notificationBadge = document.getElementById("notificationBadge");
        const notificationMenu = document.getElementById("notificationMenu");
        const notificationList = document.getElementById("notificationList");
        const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
        const profileToggle = document.getElementById("profileToggle");
        const dropdownMenu = document.getElementById("dropdownMenu");

        function isBarangayPosition(position) {
            if (!position) return false;
            const pos = position.toLowerCase().trim();
            return pos.includes("barangay captain") || pos.includes("brgy captain") || pos.includes("brgy. captain") || pos.includes("barangay official") || pos.includes("brgy official") || pos.includes("brgy. official");
        }

        notificationBell.addEventListener("click", (e) => {
            e.stopPropagation();
            notificationMenu.classList.toggle("show");
            dropdownMenu.style.display = "none";
        });

        clearNotificationsBtn.addEventListener("click", () => {
            notificationsList = [];
            updateNotificationUI();
        });

        profileToggle.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
            notificationMenu.classList.remove("show");
        });

        window.addEventListener("click", (e) => {
            if (!e.target.closest(".profile")) {
                notificationMenu.classList.remove("show");
                dropdownMenu.style.display = "none";
            }
        });

        function addNotification(type, message, detail) {
            const notification = {
                id: Date.now(),
                type,
                message,
                detail,
                timestamp: new Date()
            };
            notificationsList.unshift(notification);
            updateNotificationUI();
        }

        function updateNotificationUI() {
            const count = notificationsList.length;
            if (count > 0) {
                notificationBadge.textContent = count;
                notificationBadge.classList.add("show");
            } else {
                notificationBadge.textContent = "";
                notificationBadge.classList.remove("show");
            }

            if (notificationsList.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty">No new notifications</div>';
            } else {
                notificationList.innerHTML = notificationsList.map(n => `
                    <div class="notification-item">
                        <div class="notification-icon ${n.type}">
                            ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
                        </div>
                        <div class="notification-content">
                            <p><strong>${n.message}</strong></p>
                            <p>${n.detail}</p>
                            <span class="time">${n.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function setupRealtimeNotifications() {
            const qNewUsers = query(collection(db, "users"), where("status", "==", "pending"));
            onSnapshot(qNewUsers, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && !trackedUsers.has(change.doc.id)) {
                        trackedUsers.add(change.doc.id);
                        const u = change.doc.data();
                        if (isBarangayPosition(u.position)) {
                            addNotification("user", `New registration: ${u.firstName || ""} ${u.surname || ""}`, u.email || "");
                        }
                    }
                });
            });

            const qReports = query(collection(db, "reports"));
            onSnapshot(qReports, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && !trackedReports.has(change.doc.id)) {
                        trackedReports.add(change.doc.id);
                        const r = change.doc.data();
                        addNotification("report", `New report submitted in ${r.barangay || "a barangay"}`, r.reportType || r.type || "");
                    }
                });
            });
        }

        async function getImageUrl(imagePath) {
            try {
                if (!imagePath) return null;
                if (imagePath.startsWith('http')) return imagePath;
                
                const url = await getDownloadURL(ref(storage, imagePath));
                return url;
            } catch (error) {
                console.error("Error getting image URL:", error);
                return null;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) return (window.location.href = "logout.html");

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().position !== "Super Admin") {
                alert("Unauthorized access! Redirecting...");
                return (window.location.href = "logout.html");
            }

            const data = userDoc.data();
            navbarName.textContent = data.name || data.firstName || "Super Admin";
            
            if (data.photoURL || data.profilePic) {
                navbarAvatar.src = data.photoURL || data.profilePic;
            }
            
            await loadDashboardData();
            setupRealtimeNotifications();
        });

        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "logout.html";
        });

        async function loadDashboardData() {
            const snapshot = await getDocs(collection(db, "reports"));
            let total = 0, pending = 0, ongoing = 0, completed = 0;
            window.reportLocations = [];

            snapshot.forEach(docSnap => {
                const report = docSnap.data();
                total++;
                const status = report.status?.toLowerCase();
                if (status === "pending") pending++;
                else if (status === "ongoing" || status === "in-progress") ongoing++;
                else if (status === "resolved" || status === "completed" || status === "repaired" || status === "posted") completed++;

                const lat = report.latitude || report.lat || report.location?.latitude;
                const lng = report.longitude || report.lng || report.location?.longitude;

                if (lat && lng) {
                    window.reportLocations.push({
                        lat: parseFloat(lat),
                        lng: parseFloat(lng),
                        type: report.reportType || report.type || "Unknown",
                        status: status || "pending"
                    });
                }
            });

            totalReportsEl.textContent = total;
            pendingEl.textContent = pending;
            ongoingEl.textContent = ongoing;
            completedEl.textContent = completed;
            updateChart(completed, ongoing, pending);
            if (window.miniMap) addReportMarkers();
            loadReportImages();
        }

        let chart;
        function updateChart(completed, ongoing, pending) {
            const ctx = document.getElementById("dashboardChart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Completed", "Ongoing", "Pending"],
                    datasets: [{
                        label: "Reports",
                        data: [completed, ongoing, pending],
                        backgroundColor: ["#1cc88a", "#36b9cc", "#f6c23e"]
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        async function loadReportImages() {
            const gallery = document.getElementById("reportImages");
            gallery.innerHTML = "";
            const snapshot = await getDocs(collection(db, "reports"));
            let count = 0;
            
            for (const docSnap of snapshot.docs) {
                if (count >= 6) break;
                
                const report = docSnap.data();
                const imagePath = report.incidentImage || report.imageUrl || report.image;
                
                if (imagePath) {
                    const imageUrl = await getImageUrl(imagePath);
                    if (imageUrl) {
                        const img = document.createElement("img");
                        img.src = imageUrl;
                        img.onerror = function() { this.style.display = "none"; };
                        gallery.appendChild(img);
                        count++;
                    }
                }
            }
        }
    </script>
</body>
</html>