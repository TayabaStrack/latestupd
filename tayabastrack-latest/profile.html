<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Profile | TayabaStrack</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333;overflow:hidden}
    .sidebar{width:250px;min-width:250px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;height:100vh;overflow-y:auto}
    .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem}
    .sidebar-header img{width:40px}
    .sidebar-header h2{font-size:1.2rem;margin:0}
    .sidebar-menu{list-style:none;padding-left:0}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;color:#fff;text-decoration:none;transition:background .2s}
    .sidebar-menu a:hover,.sidebar-menu li.active a{background:#0756cc;border-left:4px solid #042f68}
    .sidebar-footer{text-align:center;padding:1rem;border-top:1px solid rgba(255,255,255,0.2)}
    .logout-btn{background-color:#d9534f;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s;width:100%}
    .logout-btn:hover{background-color:#c9302c}
    .navbar{position:fixed;top:0;left:250px;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);z-index:40}
    .navbar h1{font-size:1.4rem;color:#004aad}
    .profile{display:flex;align-items:center;gap:1rem}
    .fa-bell{font-size:1.2rem;position:relative;cursor:pointer}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px;display:none}
    .badge.show{display:flex;align-items:center;justify-content:center}
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer}
    .avatar{width:35px;height:35px;border-radius:50%}
    .username{font-weight:500}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}
    .notification-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);width:320px;max-height:400px;overflow-y:auto;z-index:1000}
    .notification-menu.show{display:block}
    .notification-header{padding:1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .notification-header h3{font-size:1rem;color:#333;margin:0}
    .clear-btn{background:none;border:none;color:#004aad;cursor:pointer;font-size:0.85rem;font-weight:500}
    .notification-list{max-height:300px;overflow-y:auto}
    .notification-item{padding:0.8rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;transition:background 0.2s;cursor:pointer}
    .notification-item:hover{background:#f9f9f9}
    .notification-item.read{background:#f9f9f9;opacity:0.7}
    .notification-icon{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .notification-icon.user{background:#e3f2fd;color:#1976d2}
    .notification-icon.report{background:#fff3e0;color:#f57c00}
    .notification-content{flex:1}
    .notification-content p{margin:0;font-size:0.85rem}
    .notification-content .time{color:#999;font-size:0.75rem;margin-top:0.2rem}
    .notification-empty{padding:2rem;text-align:center;color:#999}
    .unread-indicator{width:8px;height:8px;background:#004aad;border-radius:50%}
    .main{margin-left:250px;margin-top:74px;flex:1;display:block;min-width:0;height:calc(100vh - 74px);overflow-y:auto;overflow-x:hidden}
    .content{flex:1;padding:1.5rem;overflow-y:auto;height:100%}
    .page{padding:28px;display:flex;justify-content:center;width:100%}
    .profile-section{max-width:1100px;width:100%;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
    .card{background:white;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(13,34,85,0.06)}
    .profile-card .top{display:flex;gap:18px;align-items:center}
    .profile-card img.profile-main{width:120px;height:120px;border-radius:50%;object-fit:cover}
    .profile-info{margin-top:12px}
    .profile-info label{display:block;font-weight:700;font-size:13px;margin-top:10px}
    .profile-info input{width:100%;padding:8px;border-radius:8px;border:1px solid #d7dce6;margin-top:6px;font-size:14px;background:#fbfdff}
    .btn{background:#004aad;color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;margin-top:12px}
    .btn:hover{opacity:0.95}
    .account-card h2{color:#0b3e89;margin-bottom:8px}
    .account-meta p{margin:6px 0;font-size:14px}
    .calendar-container{margin-top:20px;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);background:#fff;position:relative;max-width:100%}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .calendar-header h3{color:#0b3e89;font-size:1.1rem;margin:0}
    .sync-status{font-size:0.75rem;color:#666;margin-top:8px;text-align:center;padding:8px;background:#f0f8ff;border-radius:6px}
    .calendar-view{background:#fff;border-radius:8px;overflow:hidden;width:100%}
    .calendar-nav{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#004aad;color:#fff}
    .calendar-nav button{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:13px}
    .calendar-nav button:hover{background:rgba(255,255,255,0.3)}
    .calendar-nav h3{margin:0;font-size:1rem}
    .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#f5f7fb;border-bottom:2px solid #e0e0e0}
    .calendar-weekdays div{padding:6px;text-align:center;font-weight:600;font-size:11px;color:#666}
    .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e0e0e0}
    .calendar-day{background:#fff;min-height:55px;padding:4px;position:relative;cursor:pointer;transition:background 0.2s;display:flex;flex-direction:column}
    .calendar-day:hover{background:#f9f9f9}
    .calendar-day.other-month{background:#fafafa;color:#999}
    .calendar-day.today{background:#e3f2fd;font-weight:700}
    .calendar-day-number{font-size:11px;font-weight:600;color:#333;margin-bottom:2px}
    .calendar-day.other-month .calendar-day-number{color:#999}
    .event-indicators{display:flex;gap:2px;flex-wrap:wrap;margin-top:auto;padding-top:2px}
    .event-dot{width:7px;height:7px;border-radius:50%;cursor:pointer;transition:transform 0.2s}
    .event-dot:hover{transform:scale(1.4)}
    .event-dot.start{background:#1cc88a}
    .event-dot.end{background:#f6c23e}
    .event-dot.ongoing{background:#004aad}
    .event-tooltip{position:fixed;background:white;border:2px solid #004aad;border-radius:8px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:10000;min-width:320px;max-width:400px;font-size:13px;display:none;pointer-events:none}
    .event-tooltip.show{display:block}
    .event-tooltip-title{font-weight:700;color:#004aad;margin-bottom:12px;font-size:16px;border-bottom:2px solid #004aad;padding-bottom:8px}
    .event-tooltip-section{margin:10px 0;line-height:1.6}
    .event-tooltip-label{font-weight:600;color:#666;display:block;margin-bottom:4px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
    .event-tooltip-value{color:#222;font-size:14px;display:block}
    .event-tooltip-image{width:100%;max-height:180px;object-fit:cover;border-radius:6px;margin-top:12px;border:2px solid #e0e0e0}
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:50}
    .modal .content{background:white;padding:20px;border-radius:10px;width:420px;max-width:95%;box-shadow:0 14px 40px rgba(2,6,23,0.15);max-height:90vh;overflow-y:auto}
    .modal .content h2{color:#004aad;margin-bottom:16px;text-align:center}
    .modal input[type="text"],.modal input[type="email"],.modal input[type="tel"],.modal textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #d7dce6;font-size:14px}
    .modal label{display:block;font-weight:600;margin-top:12px;font-size:13px;color:#333}
    .photo-upload-section{text-align:center;margin-bottom:16px;padding:16px;background:#f9fafb;border-radius:8px}
    .photo-upload-section .preview{display:block;margin:12px auto;border-radius:50%;width:120px;height:120px;object-fit:cover;border:3px solid #004aad}
    .upload-btn-wrapper{position:relative;display:inline-block;margin-top:10px}
    .upload-btn-wrapper input[type=file]{display:none}
    .upload-btn{background:#004aad;color:white;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;display:inline-block}
    .upload-btn:hover{opacity:0.9}
    .btn-group{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .btn-cancel{background:#6c757d}
    .btn-cancel:hover{background:#5a6268}
    #notificationModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center}
    #notificationModal>div{background:#fff;border-radius:12px;width:90%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
    .modal-filter-btn{padding:0.5rem 1rem;border:1px solid #ddd;background:#fff;color:#333;border-radius:20px;cursor:pointer;font-size:0.85rem;transition:all 0.2s}
    .modal-filter-btn.active{background:#004aad;color:#fff;border-color:#004aad}
    @media (max-width:980px){
      .profile-section{grid-template-columns:1fr;padding-bottom:40px}
      .sidebar{left:-250px;transition:left 0.3s}
      .sidebar.mobile-open{left:0}
      .navbar{left:0}
      .main{margin-left:0}
      .mobile-menu-btn{display:block !important}
      .calendar-day{min-height:45px}
      .event-dot{width:6px;height:6px}
    }
    .mobile-menu-btn{display:none;background:none;border:none;color:#004aad;font-size:1.5rem;cursor:pointer;padding:0.5rem}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logu.png" alt="Logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
        <li><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
        <li class="active"><a href="reports.html"><i class="fa fa-tasks"></i>&nbsp; Manage Reports</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:1rem;">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa fa-bars"></i></button>
      <h1>User Profile</h1>
    </div>
    <div class="profile">
      <div style="position:relative">
        <i class="fa fa-bell" id="notificationBell"></i>
        <span class="badge" id="notificationBadge">0</span>
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <button class="clear-btn" id="clearNotificationsBtn">Mark all as read</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>
      <img src="image.png" alt="avatar" class="avatar" id="navAvatar" onclick="toggleDropdown()">
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="profile.html"><i class="fa fa-user"></i> Profile</a>
      </div>
      <div id="navUsername" style="font-weight:600"></div>
    </div>
  </nav>

  <main class="main">
    <div class="page">
      <div class="profile-section">
        <section class="card profile-card">
          <div class="top">
            <img src="image.png" id="profilePic" alt="profile" class="profile-main">
            <div>
              <div style="font-size:18px;font-weight:700;color:#0b3e89" id="displayName">Loading...</div>
              <div style="margin-top:6px;color:#6b7380" id="displayRole">Administrator</div>
            </div>
          </div>
          <div class="profile-info">
            <label>Full Name</label>
            <input id="cardName" readonly>
            <label>ID</label>
            <input id="cardID" readonly>
            <label>Email</label>
            <input id="cardEmail" readonly>
            <label>Phone</label>
            <input id="cardPhone" readonly>
            <label>Address</label>
            <input id="cardAddress" readonly>
            <label>Gender</label>
            <input id="cardGender" readonly>
          </div>
          <button class="btn" onclick="openEditModal()">Edit Profile</button>
        </section>

        <aside class="card account-card">
          <h2>Account Info</h2>
          <div class="account-meta">
            <p><strong>Type:</strong> <span id="accountType">Loading...</span></p>
            <p><strong>Registered:</strong> <span id="registeredAt">—</span></p>
            <p><strong>Last Login:</strong> <span id="lastLogin">—</span></p>
          </div>

          <div style="margin-top:24px;">
            <div class="calendar-header">
              <h3><i class="fa fa-calendar"></i> Inspection Calendar</h3>
            </div>
            <div class="calendar-container">
              <div class="calendar-view">
                <div class="calendar-nav">
                  <button onclick="previousMonth()"><i class="fa fa-chevron-left"></i></button>
                  <h3 id="currentMonthYear"></h3>
                  <button onclick="nextMonth()"><i class="fa fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
              </div>
            </div>
            <div class="sync-status" id="syncStatus">
              <i class="fa fa-check-circle" style="color:#1cc88a"></i> Auto-syncing ongoing reports...
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <div class="event-tooltip" id="eventTooltip">
    <div class="event-tooltip-title" id="tooltipTitle"></div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Project Name</span>
      <span class="event-tooltip-value" id="tooltipProjectName"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Barangay</span>
      <span class="event-tooltip-value" id="tooltipBarangay"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Contractor & Supplier</span>
      <span class="event-tooltip-value" id="tooltipContractorSupplier"></span>
    </div>
    <div class="event-tooltip-section">
      <span class="event-tooltip-label">Allocated Budget</span>
      <span class="event-tooltip-value" id="tooltipBudget"></span>
    </div>
    <img id="tooltipImage" class="event-tooltip-image" style="display:none;" alt="Project">
  </div>

  <div class="modal" id="editModal">
    <div class="content">
      <h2>Edit Profile</h2>
      <div class="photo-upload-section">
        <img id="previewImg" class="preview" src="image.png" alt="Profile Preview">
        <div class="upload-btn-wrapper">
          <label class="upload-btn">
            <i class="fa fa-camera"></i> Choose Photo
            <input type="file" id="editPhoto" accept="image/*">
          </label>
        </div>
        <div style="font-size:12px;color:#666;margin-top:8px">Upload a profile picture (JPG, PNG)</div>
      </div>
      <label>Full Name</label>
      <input type="text" id="editName" placeholder="Full name">
      <label>ID</label>
      <input type="text" id="editID" placeholder="ID">
      <label>Email</label>
      <input type="email" id="editEmail" placeholder="Email">
      <label>Phone</label>
      <input type="tel" id="editPhone" placeholder="Phone">
      <label>Address</label>
      <input type="text" id="editAddress" placeholder="Address">
      <label>Gender</label>
      <input type="text" id="editGender" placeholder="Gender">
      <div class="btn-group">
        <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button class="btn" onclick="saveEdit()" id="saveBtn"><i class="fa fa-save"></i> Save Changes</button>
      </div>
    </div>
  </div>

  <div id="notificationModal">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #eee;">
        <h2 style="margin:0;color:#004aad;font-size:1.3rem;">Notification History</h2>
        <button onclick="window.closeNotificationModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">×</button>
      </div>
      <div style="display:flex;gap:0.5rem;padding:1rem;border-bottom:1px solid #eee;flex-wrap:wrap;">
        <button class="modal-filter-btn active" onclick="window.filterNotifications('all')">All</button>
        <button class="modal-filter-btn" onclick="window.filterNotifications('report')">Reports</button>
        <button class="modal-filter-btn" onclick="window.filterNotifications('user')">Users</button>
        <button class="modal-filter-btn" onclick="window.filterNotifications('24h')">Last 24h</button>
      </div>
      <div id="notificationModalList" style="flex:1;overflow-y:auto;padding:0;"></div>
      <div style="padding:1rem;border-top:1px solid #eee;display:flex;gap:0.5rem;">
        <button onclick="window.markAllNotificationsAsRead()" style="flex:1;padding:0.7rem;background:#004aad;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;">Mark all as read</button>
        <button onclick="window.clearAllNotifications()" style="flex:1;padding:0.7rem;background:#f0f0f0;color:#333;border:none;border-radius:6px;cursor:pointer;font-weight:500;">Clear all</button>
      </div>
    </div>
  </div>

  <script>
    function toggleMobileMenu(){document.querySelector('.sidebar').classList.toggle('mobile-open')}
    document.addEventListener('click',function(e){const sidebar=document.querySelector('.sidebar');const menuBtn=document.querySelector('.mobile-menu-btn');if(window.innerWidth<=980&&!sidebar.contains(e.target)&&!menuBtn.contains(e.target)){sidebar.classList.remove('mobile-open')}});

    function initNotificationSound(){const audioContext=new(window.AudioContext||window.webkitAudioContext)();return function playChime(){try{const now=audioContext.currentTime;const osc=audioContext.createOscillator();const gain=audioContext.createGain();osc.connect(gain);gain.connect(audioContext.destination);osc.frequency.setValueAtTime(1046.50,now);osc.frequency.setValueAtTime(783.99,now+0.1);gain.gain.setValueAtTime(0.3,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.6);osc.start(now);osc.stop(now+0.6)}catch(error){console.log("Chime sound error:",error)}}}

    let allNotifications=[];
    const playChime=initNotificationSound();

    function updateNotificationUI(){const badge=document.getElementById('notificationBadge');const list=document.getElementById('notificationList');const unreadCount=allNotifications.filter(n=>!n.read).length;if(unreadCount>0){badge.textContent=unreadCount;badge.classList.add("show")}else{badge.textContent="";badge.classList.remove("show")}const recentNotifications=allNotifications.slice(0,5);if(allNotifications.length===0){list.innerHTML=`<div class="notification-empty">No notifications</div>`}else{list.innerHTML=recentNotifications.map(n=>`<div class="notification-item ${n.read?'read':'unread'}" onclick="window.markNotificationAsRead('${n.id}')"><div class="notification-icon ${n.type}">${n.type==="user"?'<i class="fa fa-user"></i>':'<i class="fa fa-flag"></i>'}</div><div class="notification-content"><p><strong>${n.message}</strong></p><p>${n.detail}</p><span class="time">${new Date(n.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>${!n.read?'<div class="unread-indicator"></div>':''}</div>`).join('');if(allNotifications.length>5){list.innerHTML+=`<div style="padding:0.8rem 1rem;border-top:1px solid #eee;text-align:center;"><button onclick="window.openNotificationModal()" style="background:none;border:none;color:#004aad;cursor:pointer;font-weight:500;font-size:0.85rem;">View all (${allNotifications.length}) →</button></div>`}}}

    window.openNotificationModal=function(){document.getElementById('notificationModal').style.display='flex';window.filterNotifications('all')};
    window.closeNotificationModal=function(){document.getElementById('notificationModal').style.display='none'};

    window.filterNotifications=function(filter){let notifications=[];if(filter==='all'){notifications=allNotifications}else if(filter==='report'){notifications=allNotifications.filter(n=>n.type==='report')}else if(filter==='user'){notifications=allNotifications.filter(n=>n.type==='user')}else if(filter==='24h'){const twentyFourHoursAgo=Date.now()-24*60*60*1000;notifications=allNotifications.filter(n=>n.timestamp>twentyFourHoursAgo)}const list=document.getElementById('notificationModalList');if(notifications.length===0){list.innerHTML='<div style="padding:2rem;text-align:center;color:#999;">No notifications</div>'}else{list.innerHTML=notifications.map(n=>`<div style="padding:1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;${n.read?'background:#f9f9f9;':'background:#f0f6ff;'}"><div style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;${n.type==='user'?'background:#e3f2fd;color:#1976d2;':'background:#fff3e0;color:#f57c00;'}">${n.type==="user"?'<i class="fa fa-user"></i>':'<i class="fa fa-flag"></i>'}</div><div style="flex:1;"><p style="margin:0 0 0.3rem 0;font-weight:500;color:#333;"><strong>${n.message}</strong></p><p style="margin:0 0 0.3rem 0;font-size:0.9rem;color:#666;">${n.detail}</p><span style="font-size:0.75rem;color:#999;">${new Date(n.timestamp).toLocaleString()}</span></div><div style="display:flex;align-items:center;"><span style="font-size:0.75rem;color:#999;padding:0.2rem 0.5rem;background:#eee;border-radius:4px;">${n.read?'Read':'New'}</span></div></div>`).join('')}document.querySelectorAll('.modal-filter-btn').forEach(btn=>{btn.classList.toggle('active',btn.textContent.toLowerCase().includes(filter.toLowerCase()))})};

    window.markNotificationAsRead=async function(notifId){try{const{updateDoc,doc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");await updateDoc(doc(window.db,"admin_notifications",notifId),{read:true})}catch(err){console.error("Error marking notification as read:",err)}};

    window.markAllNotificationsAsRead=async function(){try{const{updateDoc,doc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");const unread=allNotifications.filter(n=>!n.read);for(const notif of unread){await updateDoc(doc(window.db,"admin_notifications",notif.id),{read:true})}}catch(err){console.error("Error marking all as read:",err)}};

    window.clearAllNotifications=async function(){if(confirm('Are you sure you want to clear all notifications?')){try{const{deleteDoc,doc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");for(const notif of allNotifications){await deleteDoc(doc(window.db,"admin_notifications",notif.id))}}catch(err){console.error("Error clearing notifications:",err)}}};

    let currentUser=null;
    let ongoingReports=[];
    let currentDate=new Date();
    let selectedMonth=currentDate.getMonth();
    let selectedYear=currentDate.getFullYear();

    function previousMonth(){selectedMonth--;if(selectedMonth<0){selectedMonth=11;selectedYear--}renderCalendar()}
    function nextMonth(){selectedMonth++;if(selectedMonth>11){selectedMonth=0;selectedYear++}renderCalendar()}

    function renderCalendar(){const firstDay=new Date(selectedYear,selectedMonth,1);const lastDay=new Date(selectedYear,selectedMonth+1,0);const prevLastDay=new Date(selectedYear,selectedMonth,0);const firstDayIndex=firstDay.getDay();const lastDayIndex=lastDay.getDay();const nextDays=7-lastDayIndex-1;const months=['January','February','March','April','May','June','July','August','September','October','November','December'];document.getElementById('currentMonthYear').textContent=`${months[selectedMonth]} ${selectedYear}`;let days='';for(let x=firstDayIndex;x>0;x--){days+=`<div class="calendar-day other-month"><div class="calendar-day-number">${prevLastDay.getDate()-x+1}</div></div>`}for(let i=1;i<=lastDay.getDate();i++){const isToday=i===currentDate.getDate()&&selectedMonth===currentDate.getMonth()&&selectedYear===currentDate.getFullYear();const currentDateStr=`${selectedYear}-${String(selectedMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;const eventsForDay=ongoingReports.filter(report=>{const start=formatDateForComparison(report.startDate);const end=formatDateForComparison(report.endDate);return currentDateStr>=start&&currentDateStr<=end});let eventHTML='';if(eventsForDay.length>0){eventHTML='<div class="event-indicators">';eventsForDay.forEach(report=>{const start=formatDateForComparison(report.startDate);const end=formatDateForComparison(report.endDate);let dotClass='event-dot';if(currentDateStr===start){dotClass+=' start'}else if(currentDateStr===end){dotClass+=' end'}else{dotClass+=' ongoing'}eventHTML+=`<div class="${dotClass}" onclick="showEventTooltip(event,'${report.id}')" title="${report.projectName}"></div>`});eventHTML+='</div>'}days+=`<div class="calendar-day ${isToday?'today':''}"><div class="calendar-day-number">${i}</div>${eventHTML}</div>`}for(let j=1;j<=nextDays;j++){days+=`<div class="calendar-day other-month"><div class="calendar-day-number">${j}</div></div>`}document.getElementById('calendarDays').innerHTML=days}

    function formatDateForComparison(date){if(!date)return'';const d=date instanceof Date?date:(date.toDate?date.toDate():new Date(date));return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

    async function loadOngoingReports(){try{const{collection,query,where,onSnapshot}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");const{getStorage,ref,getDownloadURL}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const storage=getStorage();const reportsRef=collection(window.db,'reports');const q=query(reportsRef,where('status','==','Ongoing'));onSnapshot(q,async(snapshot)=>{ongoingReports=[];let eventCount=0;for(const doc of snapshot.docs){const data=doc.data();if(data.startDate&&data.endDate){const startDate=data.startDate.toDate?data.startDate.toDate():new Date(data.startDate);const endDate=data.endDate.toDate?data.endDate.toDate():new Date(data.endDate);let imageUrl='';if(data.incidentImage||data.imageUrl||data.image){const imagePath=data.incidentImage||data.imageUrl||data.image;if(imagePath.startsWith('http')){imageUrl=imagePath}else{try{imageUrl=await getDownloadURL(ref(storage,imagePath))}catch(err){console.error("Error loading image:",err)}}}ongoingReports.push({id:doc.id,startDate:startDate,endDate:endDate,projectName:data.projectName||'Unnamed Project',barangay:data.barangay||'N/A',contractor:data.contractor||'N/A',supplier:data.supplier||'N/A',allocatedBudget:data.allocatedBudget||'N/A',imageUrl:imageUrl});eventCount++}}renderCalendar();const syncStatus=document.getElementById('syncStatus');syncStatus.innerHTML=`<i class="fa fa-check-circle" style="color:#1cc88a"></i> Auto-synced ${eventCount} ongoing inspection${eventCount!==1?'s':''} - Last updated: ${new Date().toLocaleTimeString()}`})}catch(err){console.error("Error loading ongoing reports:",err);document.getElementById('syncStatus').innerHTML=`<i class="fa fa-exclamation-circle" style="color:#d9534f"></i> Error syncing calendar`}}

    window.showEventTooltip=function(event,reportId){event.stopPropagation();const report=ongoingReports.find(r=>r.id===reportId);if(!report)return;const tooltip=document.getElementById('eventTooltip');document.getElementById('tooltipTitle').textContent=`Inspection Details`;document.getElementById('tooltipProjectName').textContent=report.projectName;document.getElementById('tooltipBarangay').textContent=report.barangay;document.getElementById('tooltipContractorSupplier').textContent=`${report.contractor} & ${report.supplier}`;document.getElementById('tooltipBudget').textContent=report.allocatedBudget;const tooltipImage=document.getElementById('tooltipImage');if(report.imageUrl){tooltipImage.src=report.imageUrl;tooltipImage.style.display='block'}else{tooltipImage.style.display='none'}const x=event.clientX;const y=event.clientY;tooltip.style.left=x+15+'px';tooltip.style.top=y+15+'px';setTimeout(()=>{const rect=tooltip.getBoundingClientRect();if(rect.right>window.innerWidth){tooltip.style.left=(x-rect.width-15)+'px'}if(rect.bottom>window.innerHeight){tooltip.style.top=(y-rect.height-15)+'px'}},0);tooltip.classList.add('show');document.addEventListener('click',hideEventTooltipOnClick)};

    function hideEventTooltipOnClick(e){if(!e.target.closest('.event-dot')&&!e.target.closest('.event-tooltip')){hideEventTooltip();document.removeEventListener('click',hideEventTooltipOnClick)}}

    window.hideEventTooltip=function(){document.getElementById('eventTooltip').classList.remove('show')};

    const dropdownMenu=document.getElementById('dropdownMenu');
    window.toggleDropdown=function(){dropdownMenu.style.display=dropdownMenu.style.display==='block'?'none':'block'};

    window.addEventListener('click',(e)=>{if(!e.target.closest('.avatar')&&!e.target.closest('#dropdownMenu')&&!e.target.closest('.notification-menu')){dropdownMenu.style.display='none';document.getElementById("notificationMenu").classList.remove("show")}});

    const editModal=document.getElementById("editModal");
    const editPhoto=document.getElementById("editPhoto");
    const previewImg=document.getElementById("previewImg");

    window.openEditModal=function(){editModal.style.display="flex"};
    window.closeEditModal=function(){editModal.style.display="none"};

    editPhoto.addEventListener("change",e=>{const file=e.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('Please select an image file');editPhoto.value='';return}if(file.size>5*1024*1024){alert('Image size should be less than 5MB');editPhoto.value='';return}const reader=new FileReader();reader.onload=ev=>{previewImg.src=ev.target.result};reader.readAsDataURL(file)});

    window.saveEdit=async function(){if(!currentUser){alert("No user logged in");return}const{updateDoc,doc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");const{ref,uploadBytes,getDownloadURL}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const{getStorage}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js");const uid=currentUser.uid;const userRef=doc(window.db,"users",uid);const saveBtn=document.getElementById("saveBtn");const updated={name:document.getElementById("editName").value.trim(),id:document.getElementById("editID").value.trim(),email:document.getElementById("editEmail").value.trim(),phone:document.getElementById("editPhone").value.trim(),address:document.getElementById("editAddress").value.trim(),gender:document.getElementById("editGender").value.trim()};if(!updated.name){alert("Name is required");return}const file=editPhoto.files[0];try{saveBtn.disabled=true;saveBtn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Saving...';if(file){const storage=getStorage();const storageRef=ref(storage,`profilePics/${uid}/avatar.jpg`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);updated.photoURL=url}await updateDoc(userRef,updated);alert("Profile updated successfully!");closeEditModal();editPhoto.value=''}catch(err){console.error(err);alert("Error updating profile: "+err.message)}finally{saveBtn.disabled=false;saveBtn.innerHTML='<i class="fa fa-save"></i> Save Changes'}};

    window.addEventListener("click",(e)=>{if(e.target===editModal)closeEditModal()});
  </script>

  <script type="module">
    import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import{getFirestore,doc,getDoc,collection,onSnapshot,query,where,addDoc,orderBy,serverTimestamp,getDocs,updateDoc}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig={apiKey:"AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",authDomain:"tayabastrack-23b95.firebaseapp.com",projectId:"tayabastrack-23b95",storageBucket:"tayabastrack-23b95.appspot.com",messagingSenderId:"674055915366",appId:"1:674055915366:web:aa560336c1f8b504eeaaa7"};

    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    window.db=db;

    const trackedUsers=new Set();
    const trackedReports=new Set();

    function isBarangayPosition(position){if(!position)return false;const pos=position.toLowerCase().trim();return pos.includes("barangay captain")||pos.includes("brgy captain")||pos.includes("brgy. captain")||pos.includes("barangay official")||pos.includes("brgy official")||pos.includes("brgy. official")}

    function setupNotificationListener(){const q=query(collection(db,"admin_notifications"),orderBy("timestamp","desc"));onSnapshot(q,(snapshot)=>{const previousUnreadCount=allNotifications.filter(n=>!n.read).length;allNotifications=snapshot.docs.map(doc=>({id:doc.id,...doc.data(),timestamp:doc.data().timestamp?.toMillis()||Date.now()}));const newUnreadCount=allNotifications.filter(n=>!n.read).length;if(newUnreadCount>previousUnreadCount){playChime()}updateNotificationUI()})}

    function setupRealtimeTracking(){const qNewUsers=query(collection(db,"users"),where("status","==","pending"));onSnapshot(qNewUsers,async(snapshot)=>{for(const change of snapshot.docChanges()){if(change.type==="added"&&!trackedUsers.has(change.doc.id)){trackedUsers.add(change.doc.id);const u=change.doc.data();if(isBarangayPosition(u.position)){await addDoc(collection(db,"admin_notifications"),{type:"user",message:`New User: ${u.firstName||""} ${u.surname||""}`,detail:u.email||"",timestamp:serverTimestamp(),read:false})}}}});const qReports=query(collection(db,"reports"));onSnapshot(qReports,async(snapshot)=>{for(const change of snapshot.docChanges()){if(change.type==="added"&&!trackedReports.has(change.doc.id)){trackedReports.add(change.doc.id);const r=change.doc.data();await addDoc(collection(db,"admin_notifications"),{type:"report",message:`New Report in ${r.barangay||"a barangay"}`,detail:r.reportType||r.type||"Unknown type",timestamp:serverTimestamp(),read:false})}}})}

    const notificationBell=document.getElementById("notificationBell");
    const clearNotificationsBtn=document.getElementById("clearNotificationsBtn");

    notificationBell.addEventListener("click",(e)=>{e.stopPropagation();document.getElementById("notificationMenu").classList.toggle("show")});

    clearNotificationsBtn.addEventListener("click",()=>{window.markAllNotificationsAsRead()});

    onAuthStateChanged(auth,async(user)=>{if(!user){console.warn("No user logged in.");window.location.href="login.html";return}currentUser=user;window.currentUser=user;try{const userRef=doc(db,'users',user.uid);await updateDoc(userRef,{lastLogin:serverTimestamp()})}catch(err){console.error("Error updating last login:",err)}const ref=doc(db,'users',user.uid);onSnapshot(ref,docSnap=>{if(!docSnap.exists())return;const data=docSnap.data();document.getElementById("navUsername").textContent=data.name||"User";const photoURL=data.photoURL||"image.png";document.getElementById("profilePic").src=photoURL;document.getElementById("navAvatar").src=photoURL;document.getElementById("previewImg").src=photoURL;document.getElementById("displayName").textContent=data.name||"—";document.getElementById("displayRole").textContent=data.position||data.role||"Administrator";document.getElementById("cardName").value=data.name||"";document.getElementById("cardID").value=data.id||"";document.getElementById("cardEmail").value=data.email||user.email;document.getElementById("cardPhone").value=data.phone||"";document.getElementById("cardAddress").value=data.address||"";document.getElementById("cardGender").value=data.gender||"";document.getElementById("editName").value=data.name||"";document.getElementById("editID").value=data.id||"";document.getElementById("editEmail").value=data.email||user.email;document.getElementById("editPhone").value=data.phone||"";document.getElementById("editAddress").value=data.address||"";document.getElementById("editGender").value=data.gender||"";document.getElementById("accountType").textContent=data.position||data.role||"Administrator";if(data.createdAt){const date=data.createdAt.toDate?data.createdAt.toDate():new Date(data.createdAt);document.getElementById("registeredAt").textContent=date.toLocaleDateString()}if(data.lastLogin){const date=data.lastLogin.toDate?data.lastLogin.toDate():new Date(data.lastLogin);document.getElementById("lastLogin").textContent=date.toLocaleString()}});setupNotificationListener();setupRealtimeTracking();loadOngoingReports()});

    document.getElementById("sidebarLogoutBtn").addEventListener("click",async()=>{try{await signOut(auth);console.log("User signed out.");window.location.href="login.html"}catch(err){console.error("Logout error:",err)}});
  </script>
</body>
</html>