<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Declined Reports | TayabaStrack Super Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333;overflow:auto}
    .sidebar{width:240px;min-width:240px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:left 0.3s;overflow-y:auto}
    .sidebar-header{display:flex;align-items:center;justify-content:flex-start;gap:12px;margin-bottom:2rem;padding:0 1rem}
    .sidebar-header img{width:50px;height:50px;object-fit:contain}
    .sidebar-header h2{font-size:1.3rem;font-weight:600}
    .sidebar-menu{list-style:none}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;text-decoration:none;color:#fff;transition:background 0.3s;border-left:4px solid transparent}
    .sidebar-menu li.active a,.sidebar-menu a:hover{background:#0756cc;border-left:4px solid #042f68}
    
    /* Submenu Styling */
    .sidebar-submenu {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.1);
    }
    .sidebar-submenu.open {
      max-height: 500px;
    }
    .sidebar-submenu li {
      margin: 0;
    }
    .sidebar-submenu a {
      padding: 0.6rem 1.5rem 0.6rem 3rem !important;
      font-size: 0.9rem;
      border-left: 4px solid transparent;
    }
    .sidebar-submenu li.active a {
      background: #042f68;
      border-left: 4px solid #fff;
    }
    .has-submenu > a {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .has-submenu > a .fa-chevron-down {
      transition: transform 0.3s ease;
      margin-left: auto;
    }
    
    .sidebar-footer{text-align:center;padding:1rem;border-top:1px solid rgba(255,255,255,0.2)}
    .logout-btn{background-color:#d9534f;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
    .logout-btn:hover{background-color:#c9302c}
    .navbar{position:fixed;top:0;left:240px;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);z-index:40;transition:left 0.3s}
    .navbar-left{display:flex;align-items:center;gap:1rem}
    .navbar h1{font-size:1.4rem;color:#004aad;white-space:nowrap}
    .mobile-menu-btn{display:none;background:none;border:none;color:#004aad;font-size:1.5rem;cursor:pointer;padding:0.5rem}
    .fa-bell{font-size:1.2rem;position:relative;cursor:pointer;color:#333}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px;display:none;min-width:18px;text-align:center}
    .badge.show{display:flex;align-items:center;justify-content:center}
    .notification-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.15);width:340px;max-height:420px;overflow:hidden;z-index:1000;font-family:"Segoe UI",Tahoma,sans-serif;animation:fadeIn 0.2s ease-in-out}
    .notification-menu.show{display:block}
    .notification-header{padding:0.9rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9}
    .notification-header h3{font-size:1rem;color:#333;margin:0;font-weight:600}
    .notification-actions{display:flex;gap:0.5rem;align-items:center}
    .action-icon-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1rem;padding:0.3rem;transition:color 0.2s ease;display:flex;align-items:center;justify-content:center}
    .action-icon-btn:hover{color:#004aad}
    .action-icon-btn i{font-size:0.95rem}
    .notification-filters{display:flex;justify-content:space-between;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid #eee;background:#fafafa}
    .filter-btn{flex:1;padding:0.4rem 0.6rem;font-size:0.8rem;background:#f2f2f2;border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all 0.25s ease;color:#333}
    .filter-btn:hover{background:#004aad;color:#fff}
    .filter-btn.active{background:#004aad;color:#fff;border-color:#004aad}
    .notification-list{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#ccc transparent}
    .notification-list::-webkit-scrollbar{width:6px}
    .notification-list::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
    .notification-list::-webkit-scrollbar-track{background:transparent}
    .notification-item{padding:0.8rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;align-items:flex-start;transition:background 0.2s;position:relative}
    .notification-item:hover{background:#f5f7ff}
    .notification-item.unread{background:#f0f7ff}
    .notification-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:#004aad;border-radius:0 4px 4px 0}
    .notification-icon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem}
    .notification-icon.user{background:#e3f2fd;color:#1976d2}
    .notification-icon.report{background:#fff3e0;color:#f57c00}
    .notification-content{flex:1}
    .notification-content p{margin:0;font-size:0.86rem;color:#333;line-height:1.3}
    .notification-content .time{color:#999;font-size:0.75rem;margin-top:0.25rem}
    .notification-empty{padding:2rem;text-align:center;color:#999;font-size:0.9rem}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:0.5rem;border-radius:8px;transition:background 0.2s;flex-shrink:0}
    .profile-dropdown:hover{background:#f5f7fb}
    .avatar{width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #004aad;flex-shrink:0}
    .username{font-weight:500;white-space:nowrap;color:#333}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:200px;z-index:10000}
    .dropdown-menu.show{display:block}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem;transition:background 0.2s}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}
    .dropdown-menu a i{margin-right:8px;width:20px;text-align:center}
    .main{margin-left:240px;margin-top:74px;flex:1;display:block;padding:20px 28px;height:calc(100vh - 74px);overflow-y:auto;overflow-x:hidden;transition:margin-left 0.3s}
    .reports-section{padding-bottom:40px;max-width:100%}
    .report-box{background:#fff;border-radius:10px;padding:16px;margin-bottom:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.04);overflow:visible}
    .report-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:10px}
    .report-box-header h2{color:#004aad;font-size:1.05rem}
    
    /* FILTER CONTROLS */
    .filter-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:8px}
    .filter-group{display:flex;align-items:center;gap:8px}
    .filter-group label{font-weight:600;color:#333;font-size:0.9rem;white-space:nowrap}
    .filter-select{padding:0.5rem 0.8rem;border:1px solid #e0e0e0;border-radius:6px;font-size:0.9rem;background:#fff;cursor:pointer;min-width:160px}
    .filter-select:focus{outline:none;border-color:#004aad}
    .clear-filters-btn{padding:0.5rem 1rem;background:#d9534f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:background 0.3s}
    .clear-filters-btn:hover{background:#c9302c}
    .active-filters{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .filter-tag{background:#004aad;color:#fff;padding:4px 10px;border-radius:16px;font-size:0.8rem;display:inline-flex;align-items:center;gap:6px}
    .filter-tag i{cursor:pointer;font-size:0.7rem}
    
    .report-actions input{padding:.4rem .75rem;border:1px solid #e0e0e0;border-radius:18px;font-size:.9rem;width:260px}
    .scroll-hint{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85rem;text-align:center;margin:10px 0 12px 0;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(0,74,173,0.2);flex-shrink:0}
    .scroll-hint i{animation:slideHint 2s ease-in-out infinite}
    @keyframes slideHint{0%,100%{transform:translateX(-4px)}50%{transform:translateX(4px)}}
    .table-card{overflow-x:auto;overflow-y:hidden;border-radius:10px;background:#fff;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);scroll-behavior:smooth;position:relative;margin-bottom:0;width:100%}
    .table-card::-webkit-scrollbar{height:10px}
    .table-card::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);border-radius:5px}
    table{width:100%;border-collapse:collapse;table-layout:auto;min-width:2000px}
    thead{background:#f5f8fb;color:#333}
    thead th{font-weight:700;padding:0.7rem 0.75rem;text-align:left;border-bottom:2px solid #e0e0e0;white-space:nowrap}
    th,td{text-align:left;padding:0.6rem 0.8rem;font-size:0.85rem;border-bottom:1px solid #f0f2f5;overflow:visible;white-space:nowrap}
    tbody tr:nth-child(even){background:#fbfdff}
    tbody tr:hover{background:#f1f8ff}
    .truncate{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle}
    .status{display:inline-block;padding:.25rem .5rem;border-radius:6px;color:#fff;font-weight:700;font-size:.75rem;min-width:80px;text-align:center}
    .pending{background:#f6c23e;color:#2b2b2b}
    .ongoing{background:#36b9cc;color:#fff}
    .repaired{background:#1cc88a;color:#fff}
    .completed{background:#1cc88a;color:#fff}
    .declined{background:#d9534f;color:#fff}
    
    /* CATEGORY & ISSUE BADGES */
    .category-badge, .issue-badge{display:inline-block;padding:0.3rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;white-space:nowrap}
    .category-badge{background:#e3f2fd;color:#1565c0;border:1px solid #90caf9}
    .issue-badge{background:#fff3e0;color:#e65100;border:1px solid #ffb74d}
    
    .action a{color:#004aad;text-decoration:none;font-weight:700;cursor:pointer;margin-right:8px}
    .action a.decline{color:#d9534f}
    td button{padding:0.3rem 0.6rem;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:4px}
    td button.btn-view{background:#858796;color:#fff}
    td button.btn-delete{background:#e74a3b;color:#fff}
    td button:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
    .coords-vertical{display:flex;flex-direction:column;gap:2px;font-size:0.8rem}
    .coords-vertical span{white-space:nowrap}
    .pagination{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;padding:12px}
    .pagination button{padding:0.5rem 0.8rem;border:1px solid #ddd;background:#fff;color:#004aad;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:500;transition:all 0.2s}
    .pagination button:hover:not(:disabled){background:#004aad;color:#fff}
    .pagination button:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
    .pagination button.active{background:#004aad;color:#fff;border-color:#004aad}
    .pagination-info{color:#666;font-size:0.85rem;margin:0 8px}
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);justify-content:center;align-items:center;padding:18px}
    .modal-content{background:#fff;width:100%;max-width:980px;border-radius:12px;padding:18px;max-height:92vh;overflow:auto}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal-header h2{color:#004aad;font-size:1.1rem;margin:0}
    .close-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#444}
    .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .modal-row{display:flex;flex-direction:column}
    .modal-row label{font-weight:700;font-size:.9rem;margin-bottom:6px;color:#333}
    .modal-row input[type="text"],.modal-row input[type="number"],.modal-row input[type="date"],.modal-row textarea,.modal-row select{padding:8px;border:1px solid #e0e0e0;border-radius:8px;font-size:.95rem;background:#f5f5f5;cursor:not-allowed}
    .modal-row textarea{min-height:80px;resize:vertical}
    .modal-row.full-width{grid-column:1 / -1}
    .img-preview{width:100%;max-height:280px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-top:6px}
    .modal-footer{text-align:right;margin-top:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer;margin-left:8px}
    .btn-cancel{background:#9e9e9e;color:#fff}
    .loading-overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);z-index:3000;display:none}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid #e9eef5;border-top-color:#004aad;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:900px){.modal-grid{grid-template-columns:1fr}.report-actions input{width:100%}.filter-controls{flex-direction:column;align-items:stretch}.filter-group{flex-direction:column;align-items:stretch}.filter-select{width:100%}}
    @media (max-width:980px){.sidebar{left:-240px}.sidebar.mobile-open{left:0}.main{margin-left:0}.navbar{left:0}.mobile-menu-btn{display:block !important}.navbar h1{font-size:1.1rem}.report-actions{width:100%}.report-actions input{flex:1}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="logo.png" alt="Logo">
        <h2>TayabaStrack</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fa fa-home"></i>&nbsp; Dashboard</a></li>
        <li><a href="usermanagement.html"><i class="fa fa-users"></i>&nbsp; User Management</a></li>
        <li class="has-submenu">
          <a href="#" onclick="toggleSubmenu(event)">
            <span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
            <i class="fa fa-chevron-down"></i>
          </a>
          <ul class="sidebar-submenu open">
            <li><a href="reports-pending.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
            <li><a href="reports-ongoing.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
            <li><a href="reports-completed.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
            <li class="active"><a href="reports-declined.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
          </ul>
        </li>
        <li><a href="auditlogs.html"><i class="fa fa-clipboard-list"></i>&nbsp; Audit Logs</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn"><i class="fa fa-sign-out-alt"></i> Logout</button>
    </div>
  </aside>

  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="navbar-left">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fa fa-bars"></i>
      </button>
      <h1>Declined Reports</h1>
    </div>
    <div style="display:flex;align-items:center;gap:14px">
      <div style="position:relative">
        <i class="fa fa-bell" id="notificationBell" aria-hidden="true"></i>
        <span class="badge" id="notificationBadge">0</span>
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <div class="notification-actions">
              <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read">
                <i class="fa fa-check-double"></i>
              </button>
              <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all">
                <i class="fa fa-trash-alt"></i>
              </button>
            </div>
          </div>
          <div class="notification-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="report">Reports</button>
            <button class="filter-btn" data-filter="user">Users</button>
            <button class="filter-btn" data-filter="24h">Last 24h</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>
      <div class="profile-dropdown" id="profileToggle" aria-haspopup="true">
        <img src="image.png" alt="Profile" class="avatar" id="navbarAvatar">
        <span class="username" id="navUsername">Loading...</span>
        <i class="fas fa-chevron-down" style="font-size:0.7rem;color:#666;"></i>
        <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-hidden="true">
          <a href="profile.html"><i class="fa fa-user"></i>&nbsp; Profile</a>
          <a href="#" id="navLogoutBtn"><i class="fa fa-sign-out-alt"></i>&nbsp; Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="main" role="main">
    <section class="reports-section">
      <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
        <div class="spinner" role="status" aria-label="Loading"></div>
      </div>

      <div class="report-box">
        <div class="report-box-header">
          <h2>Declined Reports (View Only)</h2>
          <div class="report-actions">
            <input id="searchDeclined" placeholder="Search declined..." aria-label="Search declined reports">
          </div>
        </div>
        
        <!-- FILTER CONTROLS -->
        <div class="filter-controls">
          <div class="filter-group">
            <label><i class="fa fa-filter"></i> Category:</label>
            <select id="categoryFilter" class="filter-select">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label><i class="fa fa-exclamation-triangle"></i> Issue:</label>
            <select id="issueFilter" class="filter-select">
              <option value="">All Issues</option>
            </select>
          </div>
          <button id="clearFiltersBtn" class="clear-filters-btn" style="display:none">
            <i class="fa fa-times"></i> Clear Filters
          </button>
          <div class="active-filters" id="activeFilters"></div>
        </div>
        
        <div class="table-card" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th>Project Name</th><th>Category</th><th>Issue</th><th>Barangay</th><th>Description</th><th>Dimensions (W×H)</th><th>Image</th><th>Coordinates</th><th>Timestamp</th><th>Proposed Budget</th><th>Reporter Position</th><th>Decline Reason</th><th>Status</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="declinedBody"></tbody>
          </table>
        </div>
        <div class="pagination" id="declinedPagination"></div>
      </div>
    </section>
  </main>

  <div class="modal" id="viewModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
      <div class="modal-header">
        <h2 id="viewModalTitle">View Report (Read Only)</h2>
        <button class="close-btn" id="closeViewModal" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid" id="viewModalGrid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" id="closeViewBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Submenu toggle function
    function toggleSubmenu(event) {
      event.preventDefault();
      const submenu = event.currentTarget.nextElementSibling;
      const chevron = event.currentTarget.querySelector('.fa-chevron-down');
      if (submenu) {
        submenu.classList.toggle('open');
      }
      if (chevron) {
        chevron.style.transform = submenu.classList.contains('open') 
          ? 'rotate(180deg)' 
          : 'rotate(0deg)';
      }
    }

    function toggleMobileMenu() {
      document.querySelector('.sidebar').classList.toggle('mobile-open');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(e) {
      const sidebar = document.querySelector('.sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      if (window.innerWidth <= 980 && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
        sidebar.classList.remove('mobile-open');
      }
    });

    function updateAllProfilePhotos(photoURL) {
      const photoElements = ["navbarAvatar"];
      photoElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.src = photoURL;
          el.onerror = function() {
            this.src = "image.png";
          };
        }
      });
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
      authDomain: "tayabastrack-23b95.firebaseapp.com",
      projectId: "tayabastrack-23b95",
      storageBucket: "tayabastrack-23b95.firebasestorage.app",
      messagingSenderId: "674055915366",
      appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

const declinedBody = document.getElementById("declinedBody");
const searchDeclined = document.getElementById("searchDeclined");
const categoryFilter = document.getElementById("categoryFilter");
const issueFilter = document.getElementById("issueFilter");
const clearFiltersBtn = document.getElementById("clearFiltersBtn");
const activeFilters = document.getElementById("activeFilters");
const declinedPagination = document.getElementById("declinedPagination");
const viewModal = document.getElementById("viewModal");
const viewModalGrid = document.getElementById("viewModalGrid");
const closeViewModal = document.getElementById("closeViewModal");
const closeViewBtn = document.getElementById("closeViewBtn");
const dropdownMenu = document.getElementById("dropdownMenu");
const profileToggle = document.getElementById("profileToggle");
const navUsername = document.getElementById("navUsername");
const navbarAvatar = document.getElementById("navbarAvatar");
const sidebarLogoutBtn = document.getElementById("sidebarLogoutBtn");
const navLogoutBtn = document.getElementById("navLogoutBtn");
const notificationBell = document.getElementById("notificationBell");
const notificationBadge = document.getElementById("notificationBadge");
const notificationMenu = document.getElementById("notificationMenu");
const notificationList = document.getElementById("notificationList");
const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
const markAllReadBtn = document.getElementById("markAllReadBtn");
let reportsUnsub = null;
let notificationsList = [];
let trackedIds = new Set();
let currentFilter = "all";
let allDeclinedReports = [];
let filteredDeclinedReports = [];
let currentDeclinedPage = 1;
const itemsPerPage = 10;

// ===== PREDEFINED CATEGORIES AND ISSUES =====
const CATEGORIES = [
  "Daan (Road)",
  "Tulay (Bridge)",
  "Ilaw (Street Light)",
  "Kanal (Drainage)",
  "Basketbol Court (Basketball Court)",
  "Covered Court",
  "Barangay Hall",
  "Health Center",
  "Day Care Center",
  "Multi-Purpose Hall",
  "Waiting Shed",
  "Public Toilet",
  "Water System",
  "Others"
];

const ISSUES = [
  "Sira (Broken)",
  "Butas (Has Holes)",
  "Gumuho (Collapsed)",
  "Hindi Gumagana (Not Working)",
  "Kailangan ng Pagkukumpuni (Needs Repair)",
  "Kailangan ng Pagpapalitan (Needs Replacement)",
  "Kailangan Ayusin (Needs Fixing)",
  "Walang (None/Missing)",
  "Others"
];

function normalizeStatus(status) {
  return (status || "").toLowerCase().trim();
}

function saveNotificationsToLocalStorage() {
  try {
    localStorage.setItem('notifications', JSON.stringify(notificationsList));
    localStorage.setItem('trackedIds', JSON.stringify([...trackedIds]));
  } catch (error) {
    console.error("Error saving notifications:", error);
  }
}

function loadNotificationsFromLocalStorage() {
  try {
    const savedNotifications = localStorage.getItem('notifications');
    const savedTrackedIds = localStorage.getItem('trackedIds');
    if (savedNotifications) {
      notificationsList = JSON.parse(savedNotifications).map(n => ({
        ...n,
        timestamp: new Date(n.timestamp)
      }));
    }
    if (savedTrackedIds) {
      trackedIds = new Set(JSON.parse(savedTrackedIds));
    }
  } catch (error) {
    console.error("Error loading notifications:", error);
  }
}

notificationBell.addEventListener("click", (e) => {
  e.stopPropagation();
  notificationMenu.classList.toggle("show");
  dropdownMenu.classList.remove("show");
});

clearNotificationsBtn.addEventListener("click", () => {
  notificationsList = [];
  trackedIds.clear();
  saveNotificationsToLocalStorage();
  updateNotificationUI();
});

markAllReadBtn.addEventListener("click", () => {
  notificationsList.forEach(n => n.read = true);
  saveNotificationsToLocalStorage();
  updateNotificationUI();
});

document.querySelectorAll(".filter-btn").forEach((btn) => {
  btn.addEventListener("click", (e) => {
    document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
    e.target.classList.add("active");
    currentFilter = e.target.dataset.filter;
    updateNotificationUI();
  });
});

function addNotification(type, message, detail, uniqueId) {
  // Prevent duplicates
  if (trackedIds.has(uniqueId)) return;

  trackedIds.add(uniqueId);

  const timestamp = new Date();
  const id = `${type}-${uniqueId}-${timestamp.getTime()}`;

  notificationsList.unshift({
    id: id,
    type: type,
    message: message.trim(),
    detail: detail.trim(),
    timestamp: timestamp,
    read: false
  });

  saveNotificationsToLocalStorage();
  updateNotificationUI();
}

function updateNotificationUI() {
  let filtered = [...notificationsList];
  if (currentFilter === "report") {
    filtered = filtered.filter((n) => n.type === "report");
  } else if (currentFilter === "user") {
    filtered = filtered.filter((n) => n.type === "user");
  } else if (currentFilter === "24h") {
    const ago = Date.now() - 24 * 60 * 60 * 1000;
    filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
  }
  filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
  const unreadCount = notificationsList.filter(n => !n.read).length;
  if (unreadCount > 0) {
    notificationBadge.textContent = unreadCount;
    notificationBadge.classList.add("show");
  } else {
    notificationBadge.textContent = "";
    notificationBadge.classList.remove("show");
  }
  if (filtered.length === 0) {
    notificationList.innerHTML = `<div class="notification-empty">No notifications</div>`;
  } else {
    notificationList.innerHTML = filtered.map((n) => `
      <div class="notification-item ${n.read ? '' : 'unread'}">
        <div class="notification-icon ${n.type}">
          ${n.type === "user" ? `<i class="fa fa-user"></i>` : `<i class="fa fa-flag"></i>`}
        </div>
        <div class="notification-content">
          <p><strong>${n.message}</strong></p>
          <p>${n.detail}</p>
          <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
        </div>
      </div>`).join("");
  }
}

async function setupRealtimeNotifications() {
  loadNotificationsFromLocalStorage();
  onSnapshot(collection(db, "users"), (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      const userId = change.doc.id;
      const data = change.doc.data();
      const currentStatus = normalizeStatus(data.status);
      const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
      const position = data.position || "User";
      if (change.type === "added" || change.type === "modified") {
        if (currentStatus === "active") {
          const uniqueId = `user-${userId}-active`;
          addNotification("user", `User approved: ${fullName}`, `Position: ${position}`, uniqueId);
        }
      }
    });
  });
  onSnapshot(collection(db, "reports"), (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      const reportId = change.doc.id;
      const data = change.doc.data();
      if (change.type === "added") {
        const barangay = data.barangay || data.location || "Unknown location";
        const type = data.reportType || data.type || data.projectName || "Report";
        const uniqueId = `report-${reportId}`;
        addNotification("report", "New report submitted", `${type} in ${barangay}`, uniqueId);
      }
    });
  });
  updateNotificationUI();
}

function formatTimestamp(timestamp) {
  if (!timestamp) return "";
  let date;
  if (timestamp.toDate) date = timestamp.toDate();
  else if (typeof timestamp === 'string') date = new Date(timestamp);
  else return timestamp;
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const m = months[date.getMonth()];
  const d = String(date.getDate()).padStart(2,'0');
  const y = date.getFullYear();
  let h = date.getHours();
  const min = String(date.getMinutes()).padStart(2,'0');
  const ampm = h>=12?'PM':'AM';
  h = h%12||12;
  return `${m}/${d}/${y} | ${h}:${min} ${ampm}`;
}

function formatDate(timestamp) {
  if (!timestamp) return "Not Set";
  let date;
  if (timestamp.toDate) date = timestamp.toDate();
  else if (typeof timestamp === 'string') date = new Date(timestamp);
  else return "Not Set";
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const m = months[date.getMonth()];
  const d = String(date.getDate()).padStart(2,'0');
  const y = date.getFullYear();
  return `${m} ${d}, ${y}`;
}

async function getImageUrl(imagePath) {
  if (!imagePath) return null;
  if (imagePath.startsWith('http')) return imagePath;
  try {
    const url = await getDownloadURL(ref(storage, imagePath));
    return url;
  } catch (err) {
    console.error("Error getting image URL:", err);
    return null;
  }
}

async function getReporterPosition(userId) {
  if (!userId) return "Unknown";
  try {
    const userDoc = await getDoc(doc(db, "users", userId));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      return userData.position || "User";
    }
  } catch (err) {
    console.error("Error getting user position:", err);
  }
  return "Unknown";
}

// ===== FILTER FUNCTIONS =====
function populateFilterDropdowns() {
  categoryFilter.innerHTML = '<option value="">All Categories</option>';
  CATEGORIES.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    categoryFilter.appendChild(option);
  });
  
  issueFilter.innerHTML = '<option value="">All Issues</option>';
  ISSUES.forEach(iss => {
    const option = document.createElement('option');
    option.value = iss;
    option.textContent = iss;
    issueFilter.appendChild(option);
  });
}

function applyFilters() {
  const searchTerm = searchDeclined.value.toLowerCase();
  const selectedCategory = categoryFilter.value;
  const selectedIssue = issueFilter.value;
  
  let hasActiveFilters = selectedCategory || selectedIssue;
  clearFiltersBtn.style.display = hasActiveFilters ? 'block' : 'none';
  
  activeFilters.innerHTML = '';
  if (selectedCategory) {
    const tag = document.createElement('span');
    tag.className = 'filter-tag';
    tag.innerHTML = `Category: ${selectedCategory} <i class="fa fa-times"></i>`;
    tag.querySelector('i').addEventListener('click', () => {
      categoryFilter.value = '';
      applyFilters();
    });
    activeFilters.appendChild(tag);
  }
  if (selectedIssue) {
    const tag = document.createElement('span');
    tag.className = 'filter-tag';
    tag.innerHTML = `Issue: ${selectedIssue} <i class="fa fa-times"></i>`;
    tag.querySelector('i').addEventListener('click', () => {
      issueFilter.value = '';
      applyFilters();
    });
    activeFilters.appendChild(tag);
  }
  
  // Filter the reports
  filteredDeclinedReports = allDeclinedReports.filter(item => {
    const data = item.data;
    const searchText = `${data.projectName || ''} ${data.barangay || ''} ${data.description || ''}`.toLowerCase();
    
    const matchesSearch = !searchTerm || searchText.includes(searchTerm);
    const matchesCategory = !selectedCategory || data.category === selectedCategory;
    const matchesIssue = !selectedIssue || data.issue === selectedIssue;
    
    return matchesSearch && matchesCategory && matchesIssue;
  });
  
  currentDeclinedPage = 1;
  renderDeclinedTable();
}

searchDeclined.addEventListener("keyup", applyFilters);
categoryFilter.addEventListener("change", applyFilters);
issueFilter.addEventListener("change", applyFilters);
clearFiltersBtn.addEventListener("click", () => {
  categoryFilter.value = '';
  issueFilter.value = '';
  searchDeclined.value = '';
  applyFilters();
});

function renderPagination(paginationContainer, currentPage, totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }
  let html = '';
  html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="window.changePage(${currentPage - 1})">
    <i class="fa fa-chevron-left"></i> Previous
  </button>`;
  const startItem = (currentPage - 1) * itemsPerPage + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalItems);
  html += `<span class="pagination-info">Showing ${startItem}-${endItem} of ${totalItems}</span>`;
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  if (endPage - startPage < maxVisiblePages - 1) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  if (startPage > 1) {
    html += `<button onclick="window.changePage(1)">1</button>`;
    if (startPage > 2) {
      html += `<span class="pagination-info">...</span>`;
    }
  }
  for (let i = startPage; i <= endPage; i++) {
    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="window.changePage(${i})">${i}</button>`;
  }
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<span class="pagination-info">...</span>`;
    }
    html += `<button onclick="window.changePage(${totalPages})">${totalPages}</button>`;
  }
  html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="window.changePage(${currentPage + 1})">
    Next <i class="fa fa-chevron-right"></i>
  </button>`;
  paginationContainer.innerHTML = html;
}

window.changePage = function(newPage) {
  currentDeclinedPage = newPage;
  renderDeclinedTable();
};

async function renderDeclinedTable() {
  declinedBody.innerHTML = "";
  const startIndex = (currentDeclinedPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageItems = filteredDeclinedReports.slice(startIndex, endIndex);
  
  if (pageItems.length === 0 && filteredDeclinedReports.length === 0) {
    const emptyRow = document.createElement("tr");
    const emptyCell = document.createElement("td");
    emptyCell.colSpan = 14;
    emptyCell.style.textAlign = "center";
    emptyCell.style.padding = "2rem";
    emptyCell.style.color = "#999";
    emptyCell.textContent = "No declined reports found";
    emptyRow.appendChild(emptyCell);
    declinedBody.appendChild(emptyRow);
    declinedPagination.innerHTML = '';
    return;
  }
  
  for (const item of pageItems) {
    const row = await buildTableRow(item.docSnap);
    declinedBody.appendChild(row);
  }
  renderPagination(declinedPagination, currentDeclinedPage, filteredDeclinedReports.length);
}

async function openViewModal(e){
  e.preventDefault();
  const id=e.currentTarget.dataset.id;
  try {
    const snap = await getDoc(doc(db,"reports",id));
    if(!snap.exists()) {
      alert("Report not found");
      return;
    }
    const data = snap.data();
    const position = await getReporterPosition(data.userId);
    viewModalGrid.innerHTML = "";
    const fields = [
      {label: 'Project Name', value: data.projectName || data.reportId || ""},
      {label: 'Category', value: data.category || "N/A"},
      {label: 'Issue', value: data.issue || "N/A"},
      {label: 'Timestamp', value: formatTimestamp(data.timestamp || data.createdAt)},
      {label: 'Reporter Position', value: position},
      {label: 'Barangay', value: data.barangay || ""},
      {label: 'Description', value: data.description || "", fullWidth: true, textarea: true},
      {label: 'Width (m)', value: data.width || ""},
      {label: 'Height (m)', value: data.height || ""},
      {label: 'Latitude', value: data.latitude || ""},
      {label: 'Longitude', value: data.longitude || ""},
      {label: 'Proposed Budget', value: data.proposedBudget || "Not Set"},
      {label: 'Decline Reason', value: data.declineReason || data.reason || "No reason provided", fullWidth: true, textarea: true},
      {label: 'Declined At', value: formatTimestamp(data.declinedAt || data.updatedAt)}
    ];
    fields.forEach(field => {
      const row = document.createElement("div");
      row.className = field.fullWidth ? "modal-row full-width" : "modal-row";
      const lab = document.createElement("label");
      lab.textContent = field.label;
      row.appendChild(lab);
      if(field.textarea) {
        const textarea = document.createElement("textarea");
        textarea.value = field.value;
        textarea.disabled = true;
        row.appendChild(textarea);
      } else {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = field.value;
        inp.disabled = true;
        row.appendChild(inp);
      }
      viewModalGrid.appendChild(row);
    });
    const imagePath = data.incidentImage || data.imageUrl || data.image;
    if(imagePath) {
      const imgRow = document.createElement("div");
      imgRow.className = "modal-row full-width";
      const imgLab = document.createElement("label");
      imgLab.textContent = "Image";
      imgRow.appendChild(imgLab);
      const imgPreview = document.createElement("img");
      imgPreview.className = "img-preview";
      imgPreview.alt = "Report image";
      const imgUrl = await getImageUrl(imagePath);
      if(imgUrl) {
        imgPreview.src = imgUrl;
        imgRow.appendChild(imgPreview);
        viewModalGrid.appendChild(imgRow);
      }
    }
    viewModal.style.display="flex";
  } catch(err) {
    alert("Error opening report: " + err.message);
  }
}

async function buildTableRow(docSnap) {
  const r = docSnap.data();
  const tr = document.createElement("tr");
  
  tr.dataset.category = r.category || '';
  tr.dataset.issue = r.issue || '';
  
  const addCell = (c, cls="")=>{
    const td=document.createElement("td");
    if(cls)td.className=cls;
    if(typeof c==="string")td.textContent=c;else td.appendChild(c);
    tr.appendChild(td);
  };
  
  addCell(r.projectName || r.reportId || "Unnamed Project");
  
  const categoryBadge = document.createElement("span");
  categoryBadge.className = "category-badge";
  categoryBadge.textContent = r.category || "N/A";
  addCell(categoryBadge);
  
  const issueBadge = document.createElement("span");
  issueBadge.className = "issue-badge";
  issueBadge.textContent = r.issue || "N/A";
  addCell(issueBadge);
  
  addCell(r.barangay||"");
  
  const desc=document.createElement("span");
  desc.className="truncate";
  desc.textContent=r.description||"";
  desc.title=r.description||"";
  addCell(desc);
  
  const dims=(r.width&&r.height)?`${r.width}×${r.height}`:(r.width||r.height||"");
  addCell(dims);
  
  const imgSpan=document.createElement("span");
  const imagePath = r.incidentImage || r.imageUrl || r.image;
  if(imagePath){
    const link=document.createElement("a");
    link.href="#";
    link.textContent="View";
    link.onclick=async (e)=>{
      e.preventDefault();
      const imgUrl = await getImageUrl(imagePath);
      if(!imgUrl) {
        alert("Could not load image");
        return;
      }
      const overlay=document.createElement("div");
      overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;";
      const img=document.createElement("img");
      img.src=imgUrl;
      img.style.cssText="width:min(800px, 90vw);height:min(600px, 80vh);object-fit:contain;border-radius:8px;background:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.3);";
      overlay.appendChild(img);
      overlay.onclick=()=>overlay.remove();
      document.body.appendChild(overlay);
    };
    imgSpan.appendChild(link);
  } else imgSpan.textContent="No";
  addCell(imgSpan);
  
  const coordsDiv = document.createElement("div");
  coordsDiv.className = "coords-vertical";
  const latSpan = document.createElement("span");
  latSpan.textContent = `Lat: ${r.latitude || "N/A"}`;
  const lngSpan = document.createElement("span");
  lngSpan.textContent = `Lng: ${r.longitude || "N/A"}`;
  coordsDiv.appendChild(latSpan);
  coordsDiv.appendChild(lngSpan);
  addCell(coordsDiv);
  
  addCell(formatTimestamp(r.timestamp||r.createdAt));
  
  let proposedBudget = r.proposedBudget || "Not Set";
  if(!r.proposedBudget && r.budgetMin && r.budgetMax) {
    proposedBudget = `₱${parseFloat(r.budgetMin).toLocaleString()} - ₱${parseFloat(r.budgetMax).toLocaleString()}`;
  }
  addCell(proposedBudget);
  
  const reporterPosition = await getReporterPosition(r.userId);
  addCell(reporterPosition);
  
  const reasonSpan = document.createElement("span");
  reasonSpan.className = "truncate";
  reasonSpan.textContent = r.declineReason || r.reason || "No reason provided";
  reasonSpan.title = r.declineReason || r.reason || "No reason provided";
  addCell(reasonSpan);
  
  const status=document.createElement("span");
  const s=(r.status||"Declined").toLowerCase();
  status.className=`status ${s}`;
  status.textContent=r.status||"Declined";
  addCell(status);
  
  const action=document.createElement("span");
  const viewBtn=document.createElement("button");
  viewBtn.className="btn-view";
  viewBtn.textContent="View";
  viewBtn.dataset.id=docSnap.id;
  viewBtn.onclick=openViewModal;
  action.appendChild(viewBtn);
  addCell(action,"action");
  
  return tr;
}

closeViewModal.onclick=()=>{ viewModal.style.display="none"; };
closeViewBtn.onclick=()=>{ viewModal.style.display="none"; };

profileToggle.addEventListener("click", (e) => {
  e.stopPropagation();
  dropdownMenu.classList.toggle("show");
  notificationMenu.classList.remove("show");
});

window.addEventListener("click", (e) => {
  if (!e.target.closest(".profile-dropdown")) {
    dropdownMenu.classList.remove("show");
  }
  if (!e.target.closest(".notification-menu") && e.target !== notificationBell) {
    notificationMenu.classList.remove("show");
  }
});

async function handleLogout() {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch(err) {
    alert("Error logging out: " + err.message);
  }
}

sidebarLogoutBtn.addEventListener("click", handleLogout);
navLogoutBtn.addEventListener("click", (e) => {
  e.preventDefault();
  handleLogout();
});

onAuthStateChanged(auth, async(user)=>{
  if(!user) {
    window.location.href="login.html";
    return;
  }
  try {
    const userDocRef = doc(db,"users",user.uid);
    onSnapshot(userDocRef, async (docSnap) => {
      if(!docSnap.exists()) {
        window.location.href="login.html";
        return;
      }
      const d=docSnap.data();
      if(d.position!=="Super Admin") {
        alert("Unauthorized. Only Super Admins can access this page.");
        window.location.href="login.html";
        return;
      }
      let fullName = "Unknown";
      if (d.firstName && d.lastName) {
        fullName = `${d.firstName} ${d.lastName}`;
      } else if (d.name) {
        fullName = d.name;
      } else if (d.firstName) {
        fullName = d.firstName;
      }
      navUsername.textContent = fullName;
      const photoURL = d.photoURL || d.profilePic || "image.png";
      updateAllProfilePhotos(photoURL);
      if (!reportsUnsub) {
        await setupRealtimeNotifications();
        const q=query(collection(db,"reports"),orderBy("createdAt","desc"));
        reportsUnsub=onSnapshot(q,async (snap)=>{
          const declinedReports = [];
          for (const docSnap of snap.docs) {
            const data=docSnap.data();
            const status=(data.status||"").toLowerCase().trim();
            if(status==="declined") {
              declinedReports.push({docSnap, data});
            }
          }
          declinedReports.sort((a, b) => {
            const barangayA = (a.data.barangay || "").toLowerCase();
            const barangayB = (b.data.barangay || "").toLowerCase();
            return barangayA.localeCompare(barangayB);
          });
          allDeclinedReports = declinedReports;
          populateFilterDropdowns();
          filteredDeclinedReports = [...allDeclinedReports];
          currentDeclinedPage = 1;
          await renderDeclinedTable();
        });
      }
    }, (error) => {
      console.error("Error in user snapshot:", error);
      window.location.href="login.html";
    });
  } catch(err) {
    console.error("Error loading user data:", err);
    alert("Error loading user data. Please try again.");
    window.location.href="login.html";
  }
});
  </script>
</body>
</html>