<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Reports | TayabaStrack Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333;overflow:hidden}
    
    /* SIDEBAR - IMPROVED VERSION */
    .sidebar{width:250px;min-width:250px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;height:100vh;overflow-y:auto;transition:left 0.3s ease}
    .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem;padding:0 1rem}
    .sidebar-header img{width:50px;height:50px;object-fit:contain}
    .sidebar-header h2{font-size:1.2rem;margin:0;font-weight:600}
    .sidebar-menu{list-style:none;padding-left:0;margin:0}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;color:#fff;text-decoration:none;transition:background .2s;border-left:4px solid transparent}
    .sidebar-menu a:hover,.sidebar-menu li.active a{background:#0756cc;border-left:4px solid #042f68}
    .sidebar-menu a i{width:20px;text-align:center;font-size:1rem}
    .sidebar-footer{text-align:center;padding:1rem;border-top:1px solid rgba(255,255,255,0.2);margin-top:auto}
    .logout-btn{background-color:#d9534f;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
    .logout-btn:hover{background-color:#c9302c}
    
    /* Submenu Styling */
    .sidebar-submenu {
      list-style: none;
      padding-left: 0;
      margin: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.1);
    }
    .sidebar-submenu.open {
      max-height: 500px;
    }
    .sidebar-submenu li {
      margin: 0;
    }
    .sidebar-submenu a {
      padding: 0.6rem 1.5rem 0.6rem 3rem !important;
      font-size: 0.9rem;
      border-left: 4px solid transparent;
    }
    .sidebar-submenu li.active a {
      background: #042f68;
      border-left: 4px solid #fff;
    }
    .has-submenu > a {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .has-submenu > a .fa-chevron-down {
      transition: transform 0.3s ease;
      margin-left: auto;
    }

    /* NAVBAR */
    .navbar{position:fixed;top:0;left:250px;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);z-index:40;transition:left 0.3s ease}
    .navbar h1{font-size:1.4rem;color:#004aad;margin:0}
    .navbar-left{display:flex;align-items:center;gap:1rem}
    .mobile-menu-btn{display:none;background:none;border:none;color:#004aad;font-size:1.5rem;cursor:pointer;padding:0.5rem}
    .profile{display:flex;align-items:center;gap:1rem}
    .fa-bell{font-size:1.2rem;position:relative;cursor:pointer;color:#333}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px;display:none;min-width:18px;text-align:center}
    .badge.show{display:flex;align-items:center;justify-content:center}
    
    /* Notification Menu */
    .notification-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.15);width:340px;max-height:420px;overflow:hidden;z-index:1000;font-family:"Segoe UI", Tahoma, sans-serif;animation:fadeIn 0.2s ease-in-out}
    .notification-menu.show{display:block}
    .notification-header{padding:0.9rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9}
    .notification-header h3{font-size:1rem;color:#333;margin:0;font-weight:600}
    .notification-actions{display:flex;gap:0.5rem;align-items:center}
    .action-icon-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1rem;padding:0.3rem;transition:color 0.2s ease;display:flex;align-items:center;justify-content:center}
    .action-icon-btn:hover{color:#004aad}
    .action-icon-btn i{font-size:0.95rem}
    
    .notification-filters{display:flex;justify-content:space-between;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid #eee;background:#fafafa}
    .filter-btn{flex:1;padding:0.4rem 0.6rem;font-size:0.8rem;background:#f2f2f2;border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all 0.25s ease;color:#333}
    .filter-btn:hover{background:#004aad;color:#fff}
    .filter-btn.active{background:#004aad;color:#fff;border-color:#004aad}
    
    .notification-list{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#ccc transparent}
    .notification-list::-webkit-scrollbar{width:6px}
    .notification-list::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
    .notification-list::-webkit-scrollbar-track{background:transparent}
    .notification-item{padding:0.8rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;align-items:flex-start;transition:background 0.2s;position:relative}
    .notification-item:hover{background:#f5f7ff}
    .notification-item.unread{background:#f0f7ff}
    .notification-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:#004aad;border-radius:0 4px 4px 0}
    .notification-icon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem}
    .notification-icon.user{background:#e3f2fd;color:#1976d2}
    .notification-icon.report{background:#fff3e0;color:#f57c00}
    .notification-content{flex:1}
    .notification-content p{margin:0;font-size:0.86rem;color:#333;line-height:1.3}
    .notification-content .time{color:#999;font-size:0.75rem;margin-top:0.25rem}
    .notification-empty{padding:2rem;text-align:center;color:#999;font-size:0.9rem}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
    
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:0.5rem;border-radius:8px;transition:background 0.2s}
    .profile-dropdown:hover{background:#f5f7fb}
    .avatar{width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #004aad}
    .username{font-weight:500;color:#333}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
    .dropdown-menu.show{display:block}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem;transition:background 0.2s}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}
    .dropdown-menu a i{margin-right:8px;width:20px;text-align:center}
    
    /* MAIN CONTENT */
    .main{margin-left:250px;margin-top:64px;flex:1;display:block;padding:20px 28px;height:calc(100vh - 64px);overflow-y:auto;overflow-x:hidden;transition:margin-left 0.3s ease}
    .reports-section{padding-bottom:40px;max-width:100%}
    .report-box{background:#fff;border-radius:10px;padding:16px;margin-bottom:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.04);overflow:visible}
    .report-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:12px}
    .report-box-header h2{color:#004aad;font-size:1.05rem}
    
    /* FILTER CONTROLS */
    .filter-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:8px}
    .filter-group{display:flex;align-items:center;gap:8px}
    .filter-group label{font-weight:600;color:#333;font-size:0.9rem;white-space:nowrap}
    .filter-select{padding:0.5rem 0.8rem;border:1px solid #e0e0e0;border-radius:6px;font-size:0.9rem;background:#fff;cursor:pointer;min-width:160px}
    .filter-select:focus{outline:none;border-color:#004aad}
    .clear-filters-btn{padding:0.5rem 1rem;background:#d9534f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:background 0.3s}
    .clear-filters-btn:hover{background:#c9302c}
    .active-filters{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .filter-tag{background:#004aad;color:#fff;padding:4px 10px;border-radius:16px;font-size:0.8rem;display:inline-flex;align-items:center;gap:6px}
    .filter-tag i{cursor:pointer;font-size:0.7rem}
    
    .report-actions input{padding:.4rem .75rem;border:1px solid #e0e0e0;border-radius:18px;font-size:.9rem;width:260px}
    .scroll-hint{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85rem;text-align:center;margin:10px 0 12px 0;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(0,74,173,0.2);flex-shrink:0}
    .scroll-hint i{animation:slideHint 2s ease-in-out infinite}
    @keyframes slideHint{0%,100%{transform:translateX(-4px)}50%{transform:translateX(4px)}}
    .table-card{overflow-x:auto;overflow-y:hidden;border-radius:10px;background:#fff;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);scroll-behavior:smooth;position:relative;margin-bottom:0;width:100%}
    .table-card::-webkit-scrollbar{height:10px}
    .table-card::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);border-radius:5px}
    table{width:100%;border-collapse:collapse;table-layout:auto;min-width:2200px}
    thead{background:#f5f8fb;color:#333}
    thead th{font-weight:700;padding:0.7rem 0.75rem;text-align:left;border-bottom:2px solid #e0e0e0;white-space:nowrap}
    th,td{text-align:left;padding:0.6rem 0.8rem;font-size:0.85rem;border-bottom:1px solid #f0f2f5;overflow:visible;white-space:nowrap}
    tbody tr:nth-child(even){background:#fbfdff}
    tbody tr:hover{background:#f1f8ff}
    .truncate{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle}
    .status{display:inline-block;padding:.25rem .5rem;border-radius:6px;color:#fff;font-weight:700;font-size:.75rem;min-width:80px;text-align:center}
    .pending{background:#f6c23e;color:#2b2b2b}
    .ongoing{background:#36b9cc;color:#fff}
    .repaired{background:#1cc88a;color:#fff}
    .completed{background:#1cc88a;color:#fff}
    .declined{background:#d9534f;color:#fff}
    
    /* CATEGORY & ISSUE BADGES */
    .category-badge, .issue-badge{display:inline-block;padding:0.3rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;white-space:nowrap}
    .category-badge{background:#e3f2fd;color:#1565c0;border:1px solid #90caf9}
    .issue-badge{background:#fff3e0;color:#e65100;border:1px solid #ffb74d}
    
    .action a{color:#004aad;text-decoration:none;font-weight:700;cursor:pointer;margin-right:8px}
    .action a.decline{color:#d9534f}
    td button{padding:0.3rem 0.6rem;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:4px}
    td button.btn-approve{background:#1cc88a;color:#fff}
    td button.btn-decline{background:#d9534f;color:#fff}
    td button.btn-edit{background:#004aad;color:#fff}
    td button:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
    .coords-vertical{display:flex;flex-direction:column;gap:2px;font-size:0.8rem}
    .coords-vertical span{white-space:nowrap}
    
    /* PAGINATION STYLES */
    .pagination{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;padding:12px}
    .pagination button{padding:0.5rem 0.8rem;border:1px solid #ddd;background:#fff;color:#004aad;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:500;transition:all 0.2s}
    .pagination button:hover:not(:disabled){background:#004aad;color:#fff}
    .pagination button:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
    .pagination button.active{background:#004aad;color:#fff;border-color:#004aad}
    .pagination-info{color:#666;font-size:0.85rem;margin:0 8px}
    
    .loading-overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);z-index:3000;display:none}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid #e9eef5;border-top-color:#004aad;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* MOBILE RESPONSIVE */
    @media (max-width:980px){
      .sidebar{left:-250px}
      .sidebar.mobile-open{left:0}
      .navbar{left:0}
      .main{margin-left:0}
      .mobile-menu-btn{display:block !important}
      .username{display:none}
      .report-actions input{width:100%}
      .filter-controls{flex-direction:column;align-items:stretch}
      .filter-group{flex-direction:column;align-items:stretch}
      .filter-select{width:100%}
    }
  </style>
</head>
<body>
 <aside class="sidebar" id="sidebar">
    <div>
      <div class="sidebar-header" style="display:flex;align-items:center;gap:12px;">
            <div style="width:50px;height:50px;border-radius:50%;background:#fff;display:inline-flex;align-items:center;justify-content:center;overflow:visible;">
                <img src="logo.png" alt="Logo" style="width:72px;height:72px;object-fit:contain;display:block;align-items:center;" />
            </div>
            <h2 style="margin:0;">TayabaStrack</h2>
            </div>
      <ul class="sidebar-menu">
        <li><a href="ad_dash.html"><i class="fa fa-home"></i> Dashboard</a></li>
        <li class="has-submenu">
                  <a href="#" onclick="toggleSubmenu(event)">
                    <span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
                    <i class="fa fa-chevron-down"></i>
                  </a>
                  <ul class="sidebar-submenu">
                    <li><a href="ad_repopend.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
                    <li><a href="ad_repon.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
                    <li><a href="ad_repcom.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
                    <li class="active"><a href="ad_repdec.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
                  </ul>
                </li>
        <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
        <li><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
        <li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn">
        <i class="fa fa-sign-out-alt"></i>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <nav class="navbar">
    <div class="navbar-left">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fa fa-bars"></i>
      </button>
      <h1>Manage Reports</h1>
    </div>
    <div class="profile">
      <div style="position:relative">
        <i class="fa fa-bell" id="notificationBell"></i>
        <span class="badge" id="notificationBadge">0</span>
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <div class="notification-actions">
              <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read"><i class="fa fa-check-double"></i></button>
              <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all"><i class="fa fa-trash-alt"></i></button>
            </div>
          </div>
          <div class="notification-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="report">Reports</button>
            <button class="filter-btn" data-filter="user">Users</button>
            <button class="filter-btn" data-filter="24h">Last 24h</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>
      
      <div class="profile-dropdown" id="profileToggle">
        <img src="image.png" alt="Profile" class="avatar" id="navAvatar">
        <span class="username" id="navUsername">---</span>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
        </div>
      </div>
    </div>
  </nav>


  <main class="main">
    <section class="reports-section">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
      </div>

      <div class="report-box">
        <div class="report-box-header">
          <h2>Declined Reports</h2>
          <div class="report-actions">
            <input id="searchDeclined" placeholder="Search declined...">
          </div>
        </div>
        
        <!-- FILTER CONTROLS -->
        <div class="filter-controls">
          <div class="filter-group">
            <label><i class="fa fa-filter"></i> Category:</label>
            <select id="categoryFilter" class="filter-select">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label><i class="fa fa-exclamation-triangle"></i> Issue:</label>
            <select id="issueFilter" class="filter-select">
              <option value="">All Issues</option>
            </select>
          </div>
          <button id="clearFiltersBtn" class="clear-filters-btn" style="display:none">
            <i class="fa fa-times"></i> Clear Filters
          </button>
          <div class="active-filters" id="activeFilters"></div>
        </div>
        
        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th>Project Name</th>
                <th>Category</th>
                <th>Issue</th>
                <th>Barangay</th>
                <th>Description</th>
                <th>Dimensions (W√óH)</th>
                <th>Image</th>
                <th>Coordinates</th>
                <th>Timestamp</th>
                <th>Proposed Budget</th>
                <th>Start Date & Deadline</th>
                <th>Reporter Position</th>
                <th>Status</th>
                <th>Decline Reason</th>
              </tr>
            </thead>
            <tbody id="declinedBody"></tbody>
          </table>
        </div>
        <div class="pagination" id="declinedPagination"></div>
      </div>
    </section>
  </main>
  
<script type="module">
  // ===== FIREBASE IMPORTS =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDoc, doc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  // ===== FIREBASE CONFIGURATION =====
  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.firebasestorage.app",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
   let isInternalNavigation = false;
let isLoggingOut = false;
let autoLogoutInitialized = false;

function setupAutoLogout(auth) {
  if (autoLogoutInitialized) {
    console.log("‚ö†Ô∏è Auto-logout already initialized");
    return;
  }
  autoLogoutInitialized = true;

  // ‚úÖ Track ALL link clicks (including profile links)
  document.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && link.href) {
      try {
        const linkUrl = new URL(link.href, window.location.href);
        const currentOrigin = window.location.origin;
        
        // Check if it's an internal link
        if (linkUrl.origin === currentOrigin) {
          isInternalNavigation = true;
          console.log("üîó Internal navigation detected:", link.href);
          
          // ‚úÖ LONGER timeout - 3 seconds to ensure navigation completes
          setTimeout(() => {
            isInternalNavigation = false;
          }, 3000);
        }
      } catch (err) {
        // If URL parsing fails, treat as internal navigation to be safe
        isInternalNavigation = true;
        setTimeout(() => {
          isInternalNavigation = false;
        }, 3000);
      }
    }
  }, true); // ‚úÖ Use capture phase to catch all clicks

  // ‚úÖ IMPROVED: Only logout on actual page close, not navigation
  window.addEventListener('beforeunload', (e) => {
    // Don't logout if it's internal navigation
    if (isInternalNavigation) {
      console.log("‚úÖ Internal navigation - NOT logging out");
      return;
    }
    
    // Only logout on actual tab/browser close
    if (!isLoggingOut) {
      console.log("üö™ Tab/browser closing - logging out");
      isLoggingOut = true;
      
      // Use synchronous approach for reliable logout on page close
      try {
        signOut(auth);
        sessionStorage.clear();
      } catch (error) {
        console.error("‚ùå Error during auto logout:", error);
      }
    }
  });

  // ‚úÖ Handle browser back/forward button
  window.addEventListener('popstate', async (e) => {
    if (!isInternalNavigation && !isLoggingOut) {
      console.log("‚¨ÖÔ∏è Browser back button detected - logging out");
      isLoggingOut = true;
      try {
        await signOut(auth);
        sessionStorage.clear();
        window.location.replace("login.html");
      } catch (error) {
        console.error("‚ùå Error during back navigation logout:", error);
      }
    }
  });

  console.log("‚úÖ Auto-logout functionality initialized");
}


  // ===== DOM ELEMENTS =====
  const declinedBody = document.getElementById("declinedBody");
  const searchDeclined = document.getElementById("searchDeclined");
  const categoryFilter = document.getElementById("categoryFilter");
  const issueFilter = document.getElementById("issueFilter");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");
  const activeFilters = document.getElementById("activeFilters");
  const navUsername = document.getElementById("navUsername");
  const navAvatar = document.getElementById("navAvatar");
  const sidebarLogoutBtn = document.getElementById("sidebarLogoutBtn");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const notificationBell = document.getElementById("notificationBell");
  const notificationMenu = document.getElementById("notificationMenu");
  const notificationBadge = document.getElementById("notificationBadge");
  const notificationList = document.getElementById("notificationList");
  const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
  const markAllReadBtn = document.getElementById("markAllReadBtn");
  const dropdownMenu = document.getElementById('dropdownMenu');
  const profileToggle = document.getElementById('profileToggle');

  // ===== GLOBAL VARIABLES =====
  let reportsUnsub = null;
  let currentFilter = "all";
  
  // PAGINATION VARIABLES
  let allDeclinedReports = [];
  let filteredDeclinedReports = [];
  let currentDeclinedPage = 1;
  const itemsPerPage = 10;

  // ===== PREDEFINED CATEGORIES AND ISSUES =====
  const CATEGORIES = [
    "Daan (Road)",
    "Tulay (Bridge)", 
    "Ilaw (Street Light)",
    "Kanal (Drainage)",
    "Basketbol Court (Basketball Court)",
    "Covered Court",
    "Barangay Hall",
    "Health Center",
    "Day Care Center",
    "Multi-Purpose Hall",
    "Waiting Shed",
    "Public Toilet",
    "Water System",
    "Others"
  ];

  const ISSUES = [
    "Sira (Broken)",
    "Butas (Has Holes)",
    "Gumuho (Collapsed)",
    "Hindi Gumagana (Not Working)",
    "Kailangan ng Pagkukumpuni (Needs Repair)",
    "Kailangan ng Pagpapalitan (Needs Replacement)",
    "Kailangan Ayusin (Needs Fixing)",
    "Walang (None/Missing)",
    "Others"
  ];

  // ===== AUDIT LOGGING FUNCTION =====
  async function logAuditEvent(action, actionType, module, description, additionalData = {}) {
    try {
      const user = auth.currentUser;
      if (!user) {
        console.warn("No authenticated user for audit log");
        return;
      }

      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        console.warn("User document not found for audit log");
        return;
      }
      
      const userData = userDoc.data();
      const userName = userData.name || `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || "Unknown User";

      const logData = {
        timestamp: new Date(),
        userId: user.uid,
        userName: userName,
        userRole: userData.position || userData.role || "User",
        action: action,
        actionType: (actionType || 'edit').toLowerCase(),
        module: module || 'Reports',
        description: description || 'No description provided',
        beforeValue: additionalData.beforeValue || null,
        afterValue: additionalData.afterValue || null,
        barangay: additionalData.barangay || null,
        reportId: additionalData.reportId || null,
        ...additionalData
      };

      await addDoc(collection(db, "auditLogs"), logData);
      console.log("‚úÖ Audit log created:", logData);

    } catch (error) {
      console.error("‚ùå Error logging audit event:", error);
    }
  }

  // ===== MOBILE MENU FUNCTIONS =====
  window.toggleMobileMenu = function() {
    document.getElementById('sidebar').classList.toggle('mobile-open');
  };

  document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    
    if (window.innerWidth <= 980 && 
        !sidebar.contains(e.target) && 
        !menuBtn.contains(e.target)) {
      sidebar.classList.remove('mobile-open');
    }
  });

  // ===== SUBMENU TOGGLE FUNCTION =====
  window.toggleSubmenu = function(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const parentLi = event.currentTarget.parentElement;
    const submenu = parentLi.querySelector('.sidebar-submenu');
    const chevron = event.currentTarget.querySelector('.fa-chevron-down');
    
    if (submenu) {
      const isOpen = submenu.classList.contains('open');
      
      document.querySelectorAll('.sidebar-submenu').forEach(sub => {
        if (sub !== submenu) {
          sub.classList.remove('open');
        }
      });
      
      document.querySelectorAll('.has-submenu > a .fa-chevron-down').forEach(chev => {
        if (chev !== chevron) {
          chev.style.transform = 'rotate(0deg)';
        }
      });
      
      if (isOpen) {
        submenu.classList.remove('open');
        if (chevron) {
          chevron.style.transform = 'rotate(0deg)';
        }
      } else {
        submenu.classList.add('open');
        if (chevron) {
          chevron.style.transform = 'rotate(180deg)';
        }
      }
    }
  };

  window.addEventListener('DOMContentLoaded', function() {
    const currentPage = window.location.pathname.split('/').pop();
    const submenuPages = {
      'ad_repopend.html': 'manage-reports',
      'ad_repon.html': 'manage-reports',
      'ad_repcom.html': 'manage-reports',
      'ad_repdec.html': 'manage-reports'
    };

    if (submenuPages[currentPage]) {
      const submenu = document.querySelector('.sidebar-submenu');
      const chevron = document.querySelector('.has-submenu > a .fa-chevron-down');
      
      if (submenu) {
        submenu.classList.add('open');
        if (chevron) {
          chevron.style.transform = 'rotate(180deg)';
        }
      }
      
      document.querySelectorAll('.sidebar-submenu a').forEach(link => {
        if (link.getAttribute('href') === currentPage) {
          link.parentElement.classList.add('active');
        }
      });
    }

    document.querySelectorAll('.sidebar-menu > li > a').forEach(link => {
      const href = link.getAttribute('href');
      if (href && href === currentPage) {
        link.parentElement.classList.add('active');
      }
    });
  });

  document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    if (sidebar && !e.target.closest('.has-submenu > a')) {
      const clickedInsideSidebar = sidebar.contains(e.target);
      const clickedSubmenuLink = e.target.closest('.sidebar-submenu a');
      
      if (clickedSubmenuLink) {
        return;
      }
      
      if (!clickedInsideSidebar && window.innerWidth <= 980) {
        document.querySelectorAll('.sidebar-submenu').forEach(sub => {
          sub.classList.remove('open');
        });
        document.querySelectorAll('.has-submenu > a .fa-chevron-down').forEach(chev => {
          chev.style.transform = 'rotate(0deg)';
        });
      }
    }
  });

  // ===== NOTIFICATION SYSTEM FUNCTIONS =====
  async function setupRealtimeNotifications(db) {
    // Initialize notifications array if it doesn't exist
    if (!localStorage.getItem('notifications')) {
      localStorage.setItem('notifications', '[]');
    }

    let allNotifications = [];

    // ===== LISTEN TO REPORTS =====
    const reportsRef = collection(db, "reports");
    const reportsQuery = query(reportsRef, orderBy("createdAt", "desc"), limit(50));

    onSnapshot(reportsQuery, (snapshot) => {
      const reportNotifications = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        
        // Handle timestamp
        let timestamp;
        if (data.createdAt && typeof data.createdAt.toDate === 'function') {
          timestamp = data.createdAt.toDate();
        } else if (data.timestamp && typeof data.timestamp === 'string') {
          timestamp = new Date(data.timestamp.replace(' ', 'T'));
        } else if (data.createdAt) {
          timestamp = new Date(data.createdAt);
        } else {
          timestamp = new Date();
        }
        
        const category = data.category || 'Report';
        const issue = data.issue || '';
        const barangay = data.barangay || data.userBarangay || 'Unknown Location';
        const status = data.status || 'Pending';
        const firstName = data.firstName || 'User';
        
        let title = `New ${category} Report`;
        let message = `${firstName} reported ${issue} in Brgy. ${barangay}`;
        
        if (status.toLowerCase() === 'repaired' || status.toLowerCase() === 'completed') {
          title = `‚úì ${category} Completed`;
          message = `${issue} in Brgy. ${barangay} has been ${status.toLowerCase()}`;
        } else if (status.toLowerCase() === 'ongoing') {
          title = `‚öô ${category} In Progress`;
          message = `${issue} in Brgy. ${barangay} is now ${status.toLowerCase()}`;
        }
        
        reportNotifications.push({
          id: 'report_' + doc.id,
          type: 'report',
          title: title,
          message: message,
          timestamp: timestamp.toISOString(),
          read: false,
          status: status,
          category: category,
          barangay: barangay,
          data: data
        });
      });

      // Merge with user notifications
      allNotifications = [...reportNotifications, ...allNotifications.filter(n => n.type === 'user')];
      
      // Sort by timestamp (newest first)
      allNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // Preserve read status from localStorage
      const existingNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      allNotifications = allNotifications.map(notification => {
        const existing = existingNotifications.find(n => n.id === notification.id);
        if (existing) {
          notification.read = existing.read;
        }
        return notification;
      });
      
      localStorage.setItem('notifications', JSON.stringify(allNotifications));
      updateNotificationUI();
    }, (error) => {
      console.error("Error listening to report notifications:", error);
    });

    // ===== LISTEN TO USERS =====
    const usersRef = collection(db, "users");
    const usersQuery = query(usersRef, orderBy("createdAt", "desc"), limit(50));

    onSnapshot(usersQuery, (snapshot) => {
      const userNotifications = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        
        // Handle timestamp - createdAt is a number (Unix timestamp in milliseconds)
        let timestamp;
        if (data.createdAt && typeof data.createdAt === 'number') {
          timestamp = new Date(data.createdAt);
        } else if (data.createdAt && typeof data.createdAt.toDate === 'function') {
          timestamp = data.createdAt.toDate();
        } else {
          timestamp = new Date();
        }
        
        const fullName = data.fullName || `${data.firstName || ''} ${data.surname || ''}`.trim() || 'New User';
        const position = data.position || 'User';
        const barangay = data.barangay || 'Unknown Barangay';
        const status = data.status || 'active';
        
        let title = `New User Registered`;
        let message = `${fullName} (${position}) from Brgy. ${barangay}`;
        
        // Customize based on status
        if (status === 'active') {
          title = `‚úì New User Active`;
        } else if (status === 'inactive') {
          title = `User Deactivated`;
          message = `${fullName} account is now inactive`;
        }
        
        userNotifications.push({
          id: 'user_' + doc.id,
          type: 'user',
          title: title,
          message: message,
          timestamp: timestamp.toISOString(),
          read: false,
          status: status,
          position: position,
          barangay: barangay,
          data: data
        });
      });

      // Merge with report notifications
      allNotifications = [...allNotifications.filter(n => n.type === 'report'), ...userNotifications];
      
      // Sort by timestamp (newest first)
      allNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // Preserve read status from localStorage
      const existingNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
      allNotifications = allNotifications.map(notification => {
        const existing = existingNotifications.find(n => n.id === notification.id);
        if (existing) {
          notification.read = existing.read;
        }
        return notification;
      });
      
      localStorage.setItem('notifications', JSON.stringify(allNotifications));
      updateNotificationUI();
    }, (error) => {
      console.error("Error listening to user notifications:", error);
    });
  }

  // Updated updateNotificationUI with proper icons for both types
  function updateNotificationUI() {
    const notificationsStr = localStorage.getItem('notifications') || '[]';
    let notifications = [];
    
    try {
      notifications = JSON.parse(notificationsStr);
    } catch (e) {
      console.error('Error parsing notifications:', e);
      notifications = [];
    }
    
    // Apply active filter
    const activeFilterBtn = document.querySelector('.filter-btn.active');
    const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
    let filteredNotifications = filterNotifications(notifications, activeFilter);
    
    // Update badge count (unread only)
    const unreadCount = notifications.filter(n => n && n.read === false).length;
    const badge = document.getElementById('notificationBadge');
    
    if (badge) {
      badge.textContent = unreadCount;
      if (unreadCount > 0) {
        badge.classList.add('show');
      } else {
        badge.classList.remove('show');
      }
    }
    
    // Update notification list
    const notificationList = document.getElementById('notificationList');
    
    if (!notificationList) {
      console.error('Notification list element not found');
      return;
    }
    
    if (filteredNotifications.length === 0) {
      notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
      return;
    }
    
    notificationList.innerHTML = filteredNotifications.map(notification => {
      if (!notification) return '';
      
      const timeAgo = getTimeAgo(notification.timestamp);
      const unreadClass = notification.read ? '' : 'unread';
      const title = notification.title || 'Notification';
      const message = notification.message || 'No details';
      const id = notification.id || '';
      
      // Determine icon and class based on type
      let iconClass = 'report';
      let iconName = 'fa-exclamation-triangle';
      
      if (notification.type === 'user') {
        iconClass = 'user';
        iconName = 'fa-user-plus';
        
        // Different icon based on user status
        if (notification.status === 'inactive') {
          iconName = 'fa-user-slash';
        }
      } else if (notification.type === 'report') {
        const status = (notification.status || '').toLowerCase();
        if (status === 'repaired' || status === 'completed') {
          iconName = 'fa-check-circle';
        } else if (status === 'ongoing') {
          iconName = 'fa-tools';
        } else {
          iconName = 'fa-exclamation-triangle';
        }
      }
      
      return `
        <div class="notification-item ${unreadClass}" data-id="${id}">
          <div class="notification-icon ${iconClass}">
            <i class="fa ${iconName}"></i>
          </div>
          <div class="notification-content">
            <p><strong>${title}</strong></p>
            <p>${message}</p>
            <div class="time">${timeAgo}</div>
          </div>
        </div>
      `;
    }).filter(html => html !== '').join('');
    
    // Add click listeners to mark as read
    document.querySelectorAll('.notification-item').forEach(item => {
      item.addEventListener('click', () => {
        const id = item.dataset.id;
        if (id) markAsRead(id);
      });
    });
  }

  // Filter notifications
  function filterNotifications(notifications, filter) {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    switch(filter) {
      case 'report':
        return notifications.filter(n => n.type === 'report');
      case 'user':
        return notifications.filter(n => n.type === 'user');
      case '24h':
        return notifications.filter(n => new Date(n.timestamp) > oneDayAgo);
      default:
        return notifications;
    }
  }

  // Mark single notification as read
  function markAsRead(notificationId) {
    const notificationsStr = localStorage.getItem('notifications') || '[]';
    let notifications = JSON.parse(notificationsStr);
    
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationUI();
    }
  }

  // Mark all as read
  function markAllAsRead() {
    const notificationsStr = localStorage.getItem('notifications') || '[]';
    let notifications = JSON.parse(notificationsStr);
    
    notifications.forEach(n => n.read = true);
    localStorage.setItem('notifications', JSON.stringify(notifications));
    updateNotificationUI();
  }

  // Clear all notifications
  function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications?')) {
      localStorage.setItem('notifications', '[]');
      updateNotificationUI();
    }
  }

  // Get time ago string
  function getTimeAgo(timestamp) {
    const date = new Date(timestamp);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInUnit);
      if (interval >= 1) {
        return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
      }
    }
    
    return 'Just now';
  }

  // ===== NOTIFICATION EVENT LISTENERS =====
  if (notificationBell) {
    notificationBell.addEventListener("click", (e) => {
      e.stopPropagation();
      notificationMenu.classList.toggle("show");
      if (dropdownMenu) dropdownMenu.classList.remove("show");
    });
  }

  if (clearNotificationsBtn) {
    clearNotificationsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      clearAllNotifications();
    });
  }

  if (markAllReadBtn) {
    markAllReadBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      markAllAsRead();
    });
  }

  document.querySelectorAll(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      e.target.classList.add("active");
      currentFilter = e.target.dataset.filter;
      updateNotificationUI();
    });
  });

  // ===== PROFILE DROPDOWN HANDLERS =====
  if (profileToggle) {
    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle("show");
      if (notificationMenu) notificationMenu.classList.remove("show");
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', () => {
    if (notificationMenu) notificationMenu.classList.remove('show');
    if (dropdownMenu) dropdownMenu.classList.remove('show');
  });

  // Prevent closing when clicking inside menus
  if (notificationMenu) {
    notificationMenu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  if (dropdownMenu) {
    dropdownMenu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  // ===== UTILITY FUNCTIONS =====
  function formatTimestamp(timestamp) {
    if (!timestamp) return "";
    let date;
    if (timestamp.toDate) date = timestamp.toDate();
    else if (typeof timestamp === 'string') date = new Date(timestamp);
    else return timestamp;
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const m = months[date.getMonth()];
    const d = String(date.getDate()).padStart(2,'0');
    const y = date.getFullYear();
    let h = date.getHours();
    const min = String(date.getMinutes()).padStart(2,'0');
    const ampm = h>=12?'PM':'AM';
    h = h%12||12;
    return `${m}/${d}/${y} | ${h}:${min} ${ampm}`;
  }

  function formatDate(timestamp) {
    if (!timestamp) return "Not Set";
    let date;
    if (timestamp.toDate) date = timestamp.toDate();
    else if (typeof timestamp === 'string') date = new Date(timestamp);
    else return "Not Set";
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const m = months[date.getMonth()];
    const d = String(date.getDate()).padStart(2,'0');
    const y = date.getFullYear();
    return `${m} ${d}, ${y}`;
  }

  async function getImageUrl(imagePath) {
    if (!imagePath) return null;
    if (imagePath.startsWith('http')) return imagePath;
    try {
      const url = await getDownloadURL(ref(storage, imagePath));
      return url;
    } catch (err) {
      console.error("Error getting image URL:", err);
      return null;
    }
  }

  async function getReporterPosition(userId) {
    if (!userId) return "Unknown";
    try {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        return userData.position || "User";
      }
    } catch (err) {
      console.error("Error getting user position:", err);
    }
    return "Unknown";
  }

  // ===== FILTER FUNCTIONS =====
  function populateFilterDropdowns() {
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    CATEGORIES.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categoryFilter.appendChild(option);
    });

    issueFilter.innerHTML = '<option value="">All Issues</option>';
    ISSUES.forEach(iss => {
      const option = document.createElement('option');
      option.value = iss;
      option.textContent = iss;
      issueFilter.appendChild(option);
    });
  }

  function applyFilters() {
    const searchTerm = searchDeclined.value.toLowerCase();
    const selectedCategory = categoryFilter.value;
    const selectedIssue = issueFilter.value;
    let hasActiveFilters = selectedCategory || selectedIssue;
    clearFiltersBtn.style.display = hasActiveFilters ? 'block' : 'none';

    activeFilters.innerHTML = '';
    if (selectedCategory) {
      const tag = document.createElement('span');
      tag.className = 'filter-tag';
      tag.innerHTML = `Category: ${selectedCategory} <i class="fa fa-times"></i>`;
      tag.querySelector('i').addEventListener('click', () => {
        categoryFilter.value = '';
        applyFilters();
      });
      activeFilters.appendChild(tag);
    }
    if (selectedIssue) {
      const tag = document.createElement('span');
      tag.className = 'filter-tag';
      tag.innerHTML = `Issue: ${selectedIssue} <i class="fa fa-times"></i>`;
      tag.querySelector('i').addEventListener('click', () => {
        issueFilter.value = '';
        applyFilters();
      });
      activeFilters.appendChild(tag);
    }

    // Filter the reports
    filteredDeclinedReports = allDeclinedReports.filter(item => {
      const data = item.data;
      const searchText = `${data.projectName || ''} ${data.barangay || ''} ${data.description || ''}`.toLowerCase();
      
      const matchesSearch = !searchTerm || searchText.includes(searchTerm);
      const matchesCategory = !selectedCategory || data.category === selectedCategory;
      const matchesIssue = !selectedIssue || data.issue === selectedIssue;
      
      return matchesSearch && matchesCategory && matchesIssue;
    });

    currentDeclinedPage = 1;
    renderDeclinedTable();
  }

  searchDeclined.addEventListener("keyup", applyFilters);
  categoryFilter.addEventListener("change", applyFilters);
  issueFilter.addEventListener("change", applyFilters);

  clearFiltersBtn.addEventListener("click", () => {
    categoryFilter.value = '';
    issueFilter.value = '';
    searchDeclined.value = '';
    applyFilters();
  });

  // ===== PAGINATION FUNCTIONS =====
  function renderPagination(paginationContainer, currentPage, totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }
    let html = '';

    // Previous button
    html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="window.changeDeclinedPage(${currentPage - 1})">
      <i class="fa fa-chevron-left"></i> Previous
    </button>`;

    // Showing X-Y of Z text
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);
    html += `<span class="pagination-info">Showing ${startItem}-${endItem} of ${totalItems}</span>`;

    // Page numbers with ellipsis
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // First page + ellipsis
    if (startPage > 1) {
      html += `<button onclick="window.changeDeclinedPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="pagination-info">...</span>`;
      }
    }

    // Page number buttons
    for (let i = startPage; i <= endPage; i++) {
      html += `<button class="${i === currentPage ? 'active' : ''}" onclick="window.changeDeclinedPage(${i})">${i}</button>`;
    }

    // Last page + ellipsis
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="pagination-info">...</span>`;
      }
      html += `<button onclick="window.changeDeclinedPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="window.changeDeclinedPage(${currentPage + 1})">
      Next <i class="fa fa-chevron-right"></i>
    </button>`;

    paginationContainer.innerHTML = html;
  }

  window.changeDeclinedPage = function(newPage) {
    currentDeclinedPage = newPage;
    renderDeclinedTable();
  };

  async function renderDeclinedTable() {
    declinedBody.innerHTML = "";
    const declinedPagination = document.getElementById("declinedPagination");
    const startIndex = (currentDeclinedPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = filteredDeclinedReports.slice(startIndex, endIndex);

    if (pageItems.length === 0 && filteredDeclinedReports.length === 0) {
      const emptyRow = document.createElement("tr");
      const emptyCell = document.createElement("td");
      emptyCell.colSpan = 14;
      emptyCell.style.textAlign = "center";
      emptyCell.style.padding = "2rem";
      emptyCell.style.color = "#999";
      emptyCell.textContent = "No declined reports found";
      emptyRow.appendChild(emptyCell);
      declinedBody.appendChild(emptyRow);
      declinedPagination.innerHTML = '';
      return;
    }

    for (const item of pageItems) {
      const row = await buildTableRow(item.docSnap);
      declinedBody.appendChild(row);
    }

    renderPagination(declinedPagination, currentDeclinedPage, filteredDeclinedReports.length);
  }

  // ===== BUILD TABLE ROW FUNCTION =====
  async function buildTableRow(docSnap) {
    const r = docSnap.data();
    const tr = document.createElement("tr");
    tr.dataset.category = r.category || '';
    tr.dataset.issue = r.issue || '';

    const addCell = (c, cls="")=>{
      const td=document.createElement("td");
      if(cls)td.className=cls;
      if(typeof c==="string")td.textContent=c;else td.appendChild(c);
      tr.appendChild(td);
    };

    addCell(r.projectName || r.reportId || "Unnamed Project");

    const categoryBadge = document.createElement("span");
    categoryBadge.className = "category-badge";
    categoryBadge.textContent = r.category || "N/A";
    addCell(categoryBadge);

    const issueBadge = document.createElement("span");
    issueBadge.className = "issue-badge";
    issueBadge.textContent = r.issue || "N/A";
    addCell(issueBadge);

    addCell(r.barangay||"");

    const desc=document.createElement("span");
    desc.className="truncate";
    desc.textContent=r.description||"";
    desc.title=r.description||"";
    addCell(desc);

    const dims=(r.width&&r.height)?`${r.width}√ó${r.height}`:(r.width||r.height||"");
    addCell(dims);

    const imgSpan=document.createElement("span");
    const imagePath = r.incidentImage || r.imageUrl || r.image;
    if(imagePath){
      const link=document.createElement("a");
      link.href="#";
      link.textContent="View";
      link.onclick=async (e)=>{
        e.preventDefault();
        const imgUrl = await getImageUrl(imagePath);
        if(!imgUrl) {
          alert("Could not load image");
          return;
        }
        
        // üî• LOG IMAGE VIEW
        await logAuditEvent(
          "Viewed Report Image",
          "view",
          "Reports",
          `Viewed image for declined report: ${r.projectName || r.reportId}`,
          {
            reportId: docSnap.id,
            barangay: r.barangay,
            projectName: r.projectName
          }
        );
        
        const overlay=document.createElement("div");
        overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;";
        const img=document.createElement("img");
        img.src=imgUrl;
        img.style.cssText="width:min(800px, 90vw);height:min(600px, 80vh);object-fit:contain;border-radius:8px;background:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.3);";
        overlay.appendChild(img);
        overlay.onclick=()=>overlay.remove();
        document.body.appendChild(overlay);
      };
      imgSpan.appendChild(link);
    } else imgSpan.textContent="No";
    addCell(imgSpan);

    const coordsDiv = document.createElement("div");
    coordsDiv.className = "coords-vertical";
    const latSpan = document.createElement("span");
    latSpan.textContent = `Lat: ${r.latitude || "N/A"}`;
    const lngSpan = document.createElement("span");
    lngSpan.textContent = `Lng: ${r.longitude || "N/A"}`;
    coordsDiv.appendChild(latSpan);
    coordsDiv.appendChild(lngSpan);
    addCell(coordsDiv);

    addCell(formatTimestamp(r.timestamp||r.createdAt));

    let proposedBudget = r.proposedBudget || "Not Set";
    if(!r.proposedBudget && r.budgetMin && r.budgetMax) {
      proposedBudget = `‚Ç±${parseFloat(r.budgetMin).toLocaleString()} - ‚Ç±${parseFloat(r.budgetMax).toLocaleString()}`;
    }
    addCell(proposedBudget);

    const startDeadlineDiv = document.createElement("div");
    startDeadlineDiv.style.cssText = "display:flex;gap:8px;align-items:center;white-space:nowrap";
    const startSpan = document.createElement("span");
    startSpan.textContent = formatDate(r.startDate);
    const dashSpan = document.createElement("span");
    dashSpan.textContent = "‚Äì";
    const deadlineSpan = document.createElement("span");
    deadlineSpan.textContent = formatDate(r.endDate || r.deadline);
    startDeadlineDiv.appendChild(startSpan);
    startDeadlineDiv.appendChild(dashSpan);
    startDeadlineDiv.appendChild(deadlineSpan);
    addCell(startDeadlineDiv);

    const reporterPosition = await getReporterPosition(r.userId);addCell(reporterPosition);

const status=document.createElement("span");
const s=(r.status||"Pending").toLowerCase();
status.className=`status ${s}`;
status.textContent=r.status||"Pending";
addCell(status);

const reasonSpan = document.createElement("span");
reasonSpan.className = "truncate";
reasonSpan.textContent = r.declineReason || "No reason provided";
reasonSpan.title = r.declineReason || "No reason provided";
addCell(reasonSpan);

return tr;
}
// ===== LOGOUT FUNCTION =====
async function handleLogout() {
try {
// üî• LOG LOGOUT ACTION
await logAuditEvent(
"Logged Out",
"logout",
"Authentication",
"Admin logged out from the system"
);
  await signOut(auth);
  window.location.href = "login.html";
} catch(err) {
  alert("Error logging out: " + err.message);
}
}
sidebarLogoutBtn.addEventListener("click", handleLogout);
// ===== AUTHENTICATION & REAL-TIME DATA LOADING =====
onAuthStateChanged(auth, async(user)=>{
if(!user) {
window.location.href="login.html";
return;
}
    setupAutoLogout(auth);

try {
const userDocRef = doc(db,"users",user.uid);
  onSnapshot(userDocRef, async(docSnap)=>{
    if(!docSnap.exists()) {
      alert("User data not found! Redirecting...");
      window.location.href="login.html";
      return;
    }
    
    const d = docSnap.data();
    
    if(d.position!=="Admin") {
      alert("Unauthorized access! Only Admins can access this page.");
      window.location.href="login.html";
      return;
    }
    
    navUsername.textContent = d.name || d.firstName || "Admin";
    const photoURL = d.photoURL || d.profilePic || "image.png";
    navAvatar.src = photoURL;
  });

  const q = query(
    collection(db,"reports"), 
    orderBy("createdAt","desc")
  );
  
  if(reportsUnsub) reportsUnsub();
  
  reportsUnsub = onSnapshot(q, async (snap)=>{
    allDeclinedReports = [];
    
    for (const docSnap of snap.docs) {
      const data = docSnap.data();
      const status = (data.status || "").toLowerCase().trim();
      
      if(status === "declined") {
        allDeclinedReports.push({ docSnap, data });
      }
    }
    
    // Sort by barangay alphabetically
    allDeclinedReports.sort((a, b) => {
      const barangayA = (a.data.barangay || "").toLowerCase();
      const barangayB = (b.data.barangay || "").toLowerCase();
      return barangayA.localeCompare(barangayB);
    });
    
    populateFilterDropdowns();
    filteredDeclinedReports = [...allDeclinedReports];
    currentDeclinedPage = 1;
    await renderDeclinedTable();
    
    // üî• LOG PAGE VIEW (only log once when page loads)
    if (!window.declinedPageLogged) {
      window.declinedPageLogged = true;
      await logAuditEvent(
        "Viewed Declined Reports Page",
        "view",
        "Reports",
        `Accessed declined reports page (${allDeclinedReports.length} declined reports)`
      );
    }
  });

  await setupRealtimeNotifications(db);

} catch(err) {
  console.error("Error loading user data:", err);
  alert("Error loading user data. Please try again.");
  window.location.href="login.html";
}
});
</script>
</body>
</html>
