<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Reports | TayabaStrack Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI', Tahoma, sans-serif;display:flex;min-height:100vh;background:#f5f7fb;color:#333;overflow:hidden}
    
    /* SIDEBAR - IMPROVED VERSION */
    .sidebar{width:250px;min-width:250px;background:#004aad;color:#fff;display:flex;flex-direction:column;justify-content:space-between;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;height:100vh;overflow-y:auto;transition:left 0.3s ease}
    .sidebar-header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:2rem;padding:0 1rem}
    .sidebar-header img{width:50px;height:50px;object-fit:contain}
    .sidebar-header h2{font-size:1.2rem;margin:0;font-weight:600}
    .sidebar-menu{list-style:none;padding-left:0;margin:0}
    .sidebar-menu li{margin:0.5rem 0}
    .sidebar-menu a{display:flex;align-items:center;gap:10px;padding:0.8rem 1.5rem;color:#fff;text-decoration:none;transition:background .2s;border-left:4px solid transparent}
    .sidebar-menu a:hover,.sidebar-menu li.active a{background:#0756cc;border-left:4px solid #042f68}
    .sidebar-menu a i{width:20px;text-align:center;font-size:1rem}
    .sidebar-footer{text-align:center;padding:1rem;border-top:1px solid rgba(255,255,255,0.2);margin-top:auto}
    .logout-btn{background-color:#d9534f;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
    .logout-btn:hover{background-color:#c9302c}
    /* Submenu Styling - Add this to your existing CSS */
.sidebar-submenu {
  list-style: none;
  padding-left: 0;
  margin: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: rgba(0, 0, 0, 0.1);
}

.sidebar-submenu.open {
  max-height: 500px; /* Adjust based on number of items */
}

.sidebar-submenu li {
  margin: 0;
}

.sidebar-submenu a {
  padding: 0.6rem 1.5rem 0.6rem 3rem !important;
  font-size: 0.9rem;
  border-left: 4px solid transparent;
}

.sidebar-submenu li.active a {
  background: #042f68;
  border-left: 4px solid #fff;
}

.has-submenu > a {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.has-submenu > a .fa-chevron-down {
  transition: transform 0.3s ease;
  margin-left: auto;
}
    
    /* NAVBAR - IMPROVED VERSION */
    .navbar{position:fixed;top:0;left:250px;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);z-index:40;transition:left 0.3s ease}
    .navbar h1{font-size:1.4rem;color:#004aad;margin:0}
    .navbar-left{display:flex;align-items:center;gap:1rem}
    .mobile-menu-btn{display:none;background:none;border:none;color:#004aad;font-size:1.5rem;cursor:pointer;padding:0.5rem}
    .profile{display:flex;align-items:center;gap:1rem}
    .fa-bell{font-size:1.2rem;position:relative;cursor:pointer;color:#333}
    .badge{background:red;color:#fff;font-size:.7rem;border-radius:50%;padding:3px 6px;position:absolute;top:-8px;right:-8px;display:none;min-width:18px;text-align:center}
    .badge.show{display:flex;align-items:center;justify-content:center}
    
    /* Notification Menu */
    .notification-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.15);width:340px;max-height:420px;overflow:hidden;z-index:1000;font-family:"Segoe UI", Tahoma, sans-serif;animation:fadeIn 0.2s ease-in-out}
    .notification-menu.show{display:block}
    .notification-header{padding:0.9rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#f9f9f9}
    .notification-header h3{font-size:1rem;color:#333;margin:0;font-weight:600}
    .notification-actions{display:flex;gap:0.5rem;align-items:center}
    .action-icon-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1rem;padding:0.3rem;transition:color 0.2s ease;display:flex;align-items:center;justify-content:center}
    .action-icon-btn:hover{color:#004aad}
    .action-icon-btn i{font-size:0.95rem}
    
    .notification-filters{display:flex;justify-content:space-between;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid #eee;background:#fafafa}
    .filter-btn{flex:1;padding:0.4rem 0.6rem;font-size:0.8rem;background:#f2f2f2;border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all 0.25s ease;color:#333}
    .filter-btn:hover{background:#004aad;color:#fff}
    .filter-btn.active{background:#004aad;color:#fff;border-color:#004aad}
    
    .notification-list{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#ccc transparent}
    .notification-list::-webkit-scrollbar{width:6px}
    .notification-list::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
    .notification-list::-webkit-scrollbar-track{background:transparent}
    .notification-item{padding:0.8rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;gap:0.8rem;align-items:flex-start;transition:background 0.2s;position:relative}
    .notification-item:hover{background:#f5f7ff}
    .notification-item.unread{background:#f0f7ff}
    .notification-item.unread::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:#004aad;border-radius:0 4px 4px 0}
    .notification-icon{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem}
    .notification-icon.user{background:#e3f2fd;color:#1976d2}
    .notification-icon.report{background:#fff3e0;color:#f57c00}
    .notification-content{flex:1}
    .notification-content p{margin:0;font-size:0.86rem;color:#333;line-height:1.3}
    .notification-content .time{color:#999;font-size:0.75rem;margin-top:0.25rem}
    .notification-empty{padding:2rem;text-align:center;color:#999;font-size:0.9rem}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
    
    .profile-dropdown{position:relative;display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:0.5rem;border-radius:8px;transition:background 0.2s}
    .profile-dropdown:hover{background:#f5f7fb}
    .avatar{width:35px;height:35px;border-radius:50%;object-fit:cover;border:2px solid #004aad}
    .username{font-weight:500;color:#333}
    .dropdown-menu{display:none;position:absolute;top:120%;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,.15);min-width:200px;z-index:1000}
    .dropdown-menu.show{display:block}
    .dropdown-menu a{display:block;padding:.6rem 1rem;text-decoration:none;color:#333;font-size:.9rem;transition:background 0.2s}
    .dropdown-menu a:hover{background:#f0f0f0;color:#004aad}
    .dropdown-menu a i{margin-right:8px;width:20px;text-align:center}
    
    /* MAIN CONTENT */
    .main{margin-left:250px;margin-top:64px;flex:1;display:block;padding:20px 28px;height:calc(100vh - 64px);overflow-y:auto;overflow-x:hidden;transition:margin-left 0.3s ease}
    .reports-section{padding-bottom:40px;max-width:100%}
    .report-box{background:#fff;border-radius:10px;padding:16px;margin-bottom:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.04);overflow:visible}
    .report-box-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .report-box-header h2{color:#004aad;font-size:1.05rem}
    .report-actions input{padding:.4rem .75rem;border:1px solid #e0e0e0;border-radius:18px;font-size:.9rem;width:260px}
    .scroll-hint{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85rem;text-align:center;margin:10px 0 12px 0;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 2px 8px rgba(0,74,173,0.2);flex-shrink:0}
    .scroll-hint i{animation:slideHint 2s ease-in-out infinite}
    @keyframes slideHint{0%,100%{transform:translateX(-4px)}50%{transform:translateX(4px)}}
    .table-card{overflow-x:auto;overflow-y:hidden;border-radius:10px;background:#fff;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);scroll-behavior:smooth;position:relative;margin-bottom:0;width:100%}
    .table-card::-webkit-scrollbar{height:10px}
    .table-card::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#004aad 0%,#0066cc 100%);border-radius:5px}
    table{width:100%;border-collapse:collapse;table-layout:auto;min-width:2000px}
    thead{background:#f5f8fb;color:#333}
    thead th{font-weight:700;padding:0.7rem 0.75rem;text-align:left;border-bottom:2px solid #e0e0e0;white-space:nowrap}
    th,td{text-align:left;padding:0.6rem 0.8rem;font-size:0.85rem;border-bottom:1px solid #f0f2f5;overflow:visible;white-space:nowrap}
    tbody tr:nth-child(even){background:#fbfdff}
    tbody tr:hover{background:#f1f8ff}
    .truncate{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle}
    .status{display:inline-block;padding:.25rem .5rem;border-radius:6px;color:#fff;font-weight:700;font-size:.75rem;min-width:80px;text-align:center}
    .pending{background:#f6c23e;color:#2b2b2b}
    .ongoing{background:#36b9cc;color:#fff}
    .repaired{background:#1cc88a;color:#fff}
    .completed{background:#1cc88a;color:#fff}
    .declined{background:#d9534f;color:#fff}
    .action a{color:#004aad;text-decoration:none;font-weight:700;cursor:pointer;margin-right:8px}
    .action a.decline{color:#d9534f}
    td button{padding:0.3rem 0.6rem;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:4px}
    td button.btn-approve{background:#1cc88a;color:#fff}
    td button.btn-decline{background:#d9534f;color:#fff}
    td button.btn-edit{background:#004aad;color:#fff}
    td button:disabled{background:#ccc;cursor:not-allowed;opacity:0.6}
    .coords-vertical{display:flex;flex-direction:column;gap:2px;font-size:0.8rem}
    .coords-vertical span{white-space:nowrap}
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);justify-content:center;align-items:center;padding:18px}
    .modal-content{background:#fff;width:100%;max-width:980px;border-radius:12px;padding:18px;max-height:92vh;overflow:auto}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .modal-header h2{color:#004aad;font-size:1.1rem;margin:0}
    .close-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#444}
    .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .modal-row{display:flex;flex-direction:column}
    .modal-row label{font-weight:700;font-size:.9rem;margin-bottom:6px;color:#333}
    .modal-row input[type="text"],.modal-row input[type="number"],.modal-row input[type="date"],.modal-row textarea,.modal-row select{padding:8px;border:1px solid #e0e0e0;border-radius:8px;font-size:.95rem}
    .modal-row textarea{min-height:80px;resize:vertical}
    .modal-row.full-width{grid-column:1 / -1}
    .img-preview{width:100%;max-height:280px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-top:6px}
    .modal-footer{text-align:right;margin-top:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer;margin-left:8px}
    .btn-save{background:#004aad;color:#fff}
    .btn-cancel{background:#9e9e9e;color:#fff}
    .btn-delete{background:#d9534f;color:#fff}
    .decline-modal{display:none;position:fixed;z-index:3000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;padding:18px}
    .decline-modal-content{background:#fff;width:100%;max-width:600px;border-radius:12px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto}
    .decline-modal-header{margin-bottom:20px}
    .decline-modal-header h3{color:#d9534f;font-size:1.3rem;margin:0}
    .decline-form-group{margin-bottom:18px}
    .decline-form-group label{display:block;font-weight:600;margin-bottom:8px;color:#333;font-size:0.95rem}
    .decline-form-group label .required{color:#d9534f;margin-left:3px}
    .decline-form-group textarea{width:100%;min-height:100px;padding:10px;border:1px solid #e0e0e0;border-radius:8px;font-size:0.95rem;resize:vertical;font-family:inherit}
    .decline-form-group input:focus,.decline-form-group textarea:focus{outline:none;border-color:#004aad;box-shadow:0 0 0 3px rgba(0,74,173,0.1)}
    .decline-modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid #e0e0e0}
    .loading-overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);z-index:3000;display:none}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid #e9eef5;border-top-color:#004aad;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* MOBILE RESPONSIVE */
    @media (max-width:980px){
      .sidebar{left:-250px}
      .sidebar.mobile-open{left:0}
      .navbar{left:0}
      .main{margin-left:0}
      .mobile-menu-btn{display:block !important}
      .username{display:none}
      .modal-grid{grid-template-columns:1fr}
      .report-actions input{width:100%}
    }
  </style>
</head>
<body>
 <aside class="sidebar" id="sidebar">
    <div>
      <div class="sidebar-header" style="display:flex;align-items:center;gap:12px;">
            <div style="width:50px;height:50px;border-radius:50%;background:#fff;display:inline-flex;align-items:center;justify-content:center;overflow:visible;">
                <img src="logo.png" alt="Logo" style="width:72px;height:72px;object-fit:contain;display:block;align-items:center;" />
            </div>
            <h2 style="margin:0;">TayabaStrack</h2>
            </div>
      <ul class="sidebar-menu">
        <li><a href="ad_dash.html"><i class="fa fa-home"></i> Dashboard</a></li>
        <li class="has-submenu">
                  <a href="#" onclick="toggleSubmenu(event)">
                    <span><i class="fa fa-tasks"></i>&nbsp; Manage Reports</span>
                    <i class="fa fa-chevron-down"></i>
                  </a>
                  <ul class="sidebar-submenu">
                    <li><a href="ad_repopend.html"><i class="fa fa-clock"></i>&nbsp; Pending Reports</a></li>
                    <li><a href="ad_repon.html"><i class="fa fa-spinner"></i>&nbsp; Ongoing Reports</a></li>
                    <li class="active"><a href="ad_repcom.html"><i class="fa fa-check-circle"></i>&nbsp; Completed Reports</a></li>
                    <li><a href="ad_repdec.html"><i class="fa fa-times-circle"></i>&nbsp; Declined Reports</a></li>
                  </ul>
                </li>
        <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
        <li><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
        <li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
      </ul>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" id="sidebarLogoutBtn">
        <i class="fa fa-sign-out-alt"></i>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <nav class="navbar">
    <div class="navbar-left">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fa fa-bars"></i>
      </button>
      <h1>Manage Reports</h1>
    </div>
    <div class="profile">
      <div style="position:relative">
        <i class="fa fa-bell" id="notificationBell"></i>
        <span class="badge" id="notificationBadge">0</span>
        <div class="notification-menu" id="notificationMenu">
          <div class="notification-header">
            <h3>Notifications</h3>
            <div class="notification-actions">
              <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read"><i class="fa fa-check-double"></i></button>
              <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all"><i class="fa fa-trash-alt"></i></button>
            </div>
          </div>
          <div class="notification-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="report">Reports</button>
            <button class="filter-btn" data-filter="user">Users</button>
            <button class="filter-btn" data-filter="24h">Last 24h</button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>
      
      <div class="profile-dropdown" id="profileToggle">
        <img src="image.png" alt="Profile" class="avatar" id="navAvatar">
        <span class="username" id="navUsername">---</span>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
        </div>
      </div>
    </div>
  </nav>

<main class="main">
  <section class="reports-section">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>

    <div class="report-box">
      <div class="report-box-header">
        <h2>Completed Reports (Repaired)</h2>
        <div class="report-actions">
          <input id="searchCompleted" placeholder="Search completed...">
        </div>
      </div>
      <div class="scroll-hint">
        <i class="fas fa-arrows-alt-h"></i>
        <span>Scroll horizontally to view all columns</span>
      </div>
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Project Name</th>
              <th>Barangay</th>
              <th>Description</th>
              <th>Dimensions (W×H)</th>
              <th>Image</th>
              <th>Coordinates</th>
              <th>Timestamp</th>
              <th>Proposed Budget</th>
              <th>Allocated Budget</th>
              <th>Start Date & Deadline</th>
              <th>Contractor & Supplier</th>
              <th>Completion Date</th>
              <th>Penalties</th>
              <th>Reporter Position</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="completedBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<div class="modal" id="editCompletedModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="editCompletedTitle">
    <div class="modal-header">
      <h2 id="editCompletedTitle">Edit Completion & View Progress</h2>
      <button class="close-btn" id="closeCompletedModal" title="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="modal-row">
          <label>Project Name</label>
          <input type="text" id="editCompletedProjectName" disabled>
        </div>
        <div class="modal-row">
          <label for="editCompletionDate">Completion Date</label>
          <input type="date" id="editCompletionDate">
        </div>
        <div class="modal-row">
          <label for="editTargetDate">Target/Deadline Date</label>
          <input type="date" id="editTargetDate">
        </div>
        <div class="modal-row">
          <label for="editAdditionalExtension">Additional Extension (Days)</label>
          <input type="number" id="editAdditionalExtension" min="0" value="0" placeholder="0">
        </div>
        <div class="modal-row">
          <label for="editUndeliveredPercent">Undelivered Percentage (%)</label>
          <input type="number" id="editUndeliveredPercent" min="0" max="100" value="0" step="0.01" placeholder="0.00">
        </div>
        <div class="modal-row">
          <label>Actual Duration (Days)</label>
          <input type="text" id="editActualDuration" disabled>
        </div>
        <div class="modal-row full-width">
          <label for="editPenalties">Penalties (Liquidated Damages)</label>
          <textarea id="editPenalties" placeholder="Liquidated Damages will appear here automatically..." disabled></textarea>
        </div>
        <div class="modal-row full-width">
          <label>Progress Report (View Only)</label>
          <textarea id="viewProgressReport" disabled style="min-height:120px"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" id="cancelCompletedEdit">Cancel</button>
      <button class="btn btn-save" id="saveCompletedChanges">Save Changes</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, onSnapshot, getDoc, doc, updateDoc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
    authDomain: "tayabastrack-23b95.firebaseapp.com",
    projectId: "tayabastrack-23b95",
    storageBucket: "tayabastrack-23b95.firebasestorage.app",
    messagingSenderId: "674055915366",
    appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM Elements
  const completedBody = document.getElementById("completedBody");
  const searchCompleted = document.getElementById("searchCompleted");
  const editCompletedModal = document.getElementById("editCompletedModal");
  const closeCompletedModal = document.getElementById("closeCompletedModal");
  const cancelCompletedEdit = document.getElementById("cancelCompletedEdit");
  const saveCompletedChanges = document.getElementById("saveCompletedChanges");
  const sidebarLogoutBtn = document.getElementById("sidebarLogoutBtn");
  const profileToggle = document.getElementById("profileToggle");
  const dropdownMenu = document.getElementById("dropdownMenu");
  const notificationBell = document.getElementById("notificationBell");
  const notificationBadge = document.getElementById("notificationBadge");
  const notificationMenu = document.getElementById("notificationMenu");
  const notificationList = document.getElementById("notificationList");

  let currentDocId = null;
  let reportsUnsub = null;
  let notificationsUnsub = null;
  let currentFilter = 'all';

  // ============================================
  // UTILITY FUNCTIONS
  // ============================================

  function formatDateForInput(timestamp) {
    if (!timestamp) return "";
    let date;
    if (timestamp.toDate) date = timestamp.toDate();
    else if (typeof timestamp === 'string') date = new Date(timestamp);
    else if (timestamp instanceof Date) date = timestamp;
    else return "";
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function formatDateForDisplay(timestamp) {
    if (!timestamp) return "";
    let date;
    if (timestamp.toDate) date = timestamp.toDate();
    else if (typeof timestamp === 'string') date = new Date(timestamp);
    else if (timestamp instanceof Date) date = timestamp;
    else return "";
    
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  }

  function timeAgo(timestamp) {
    if (!timestamp) return "";
    let date;
    if (timestamp.toDate) date = timestamp.toDate();
    else if (typeof timestamp === 'string') date = new Date(timestamp);
    else if (timestamp instanceof Date) date = timestamp;
    else return "";

    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
  }

  // ============================================
  // PROJECT COST RETRIEVAL
  // ============================================

  async function getProjectCost(reportId) {
    try {
      const snap = await getDoc(doc(db, "reports", reportId));
      if (!snap.exists()) return 0;
      const data = snap.data();
      
      // Try to get allocated budget first, then proposed budget
      let cost = 0;
      if (data.allocatedBudget) {
        cost = parseFloat(data.allocatedBudget.replace(/[₱,]/g, ''));
      } else if (data.proposedBudget) {
        cost = parseFloat(data.proposedBudget.replace(/[₱,]/g, ''));
      }
      
      return cost || 0;
    } catch (err) {
      console.error("Error getting project cost:", err);
      return 0;
    }
  }

  // ============================================
  // LIQUIDATED DAMAGES CALCULATION
  // ============================================

  async function computeLiquidatedDamages(reportId, completionDate, targetDate, additionalExtension = 0, undeliveredPercent = 0) {
    try {
      // Get project cost
      const projectCost = await getProjectCost(reportId);
      if (!projectCost || projectCost === 0) {
        return { 
          amount: 0, 
          days: 0, 
          details: "No project cost available" 
        };
      }

      // Convert dates to Date objects
      const completedDate = completionDate instanceof Date ? completionDate : new Date(completionDate);
      const deadlineDate = targetDate instanceof Date ? targetDate : new Date(targetDate);

      // Validate dates
      if (isNaN(completedDate.getTime()) || isNaN(deadlineDate.getTime())) {
        return {
          amount: 0,
          days: 0,
          details: "Invalid dates provided"
        };
      }

      // Calculate adjusted deadline with extensions
      const adjustedDeadline = new Date(deadlineDate);
      adjustedDeadline.setDate(adjustedDeadline.getDate() + parseInt(additionalExtension || 0));

      // Calculate days of delay
      const timeDiff = completedDate - adjustedDeadline;
      const daysOfDelay = Math.max(0, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)));

      // If no delay, no liquidated damages
      if (daysOfDelay === 0) {
        return { 
          amount: 0, 
          days: 0, 
          details: "Completed on time - No penalties" 
        };
      }

      // Calculate undelivered cost
      const undeliveredPercentValue = parseFloat(undeliveredPercent) || 0;
      const undeliveredCost = projectCost * (undeliveredPercentValue / 100);

      // If 0% undelivered, no penalties
      if (undeliveredCost === 0) {
        return {
          amount: 0,
          days: daysOfDelay,
          details: `${daysOfDelay} day(s) delay but 0% undelivered - No penalties`
        };
      }

      // LD Formula: 0.1% (1/10 of 1%) per day of delay on undelivered cost
      // LD = Undelivered Cost × 0.001 × Days of Delay
      const ldAmount = undeliveredCost * 0.001 * daysOfDelay;

      return {
        amount: ldAmount,
        days: daysOfDelay,
        undeliveredCost: undeliveredCost,
        projectCost: projectCost,
        details: `${daysOfDelay} day(s) × ₱${undeliveredCost.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${undeliveredPercentValue}% undelivered) × 0.1%`
      };

    } catch (err) {
      console.error("Error computing LD:", err);
      return { 
        amount: 0, 
        days: 0, 
        details: "Calculation error: " + err.message 
      };
    }
  }

  // ============================================
  // AUTO-UPDATE LD DISPLAY
  // ============================================

  async function updateLiquidatedDamages() {
    if (!currentDocId) return;

    const completionDate = document.getElementById("editCompletionDate").value;
    const targetDate = document.getElementById("editTargetDate").value;
    const additionalExtension = document.getElementById("editAdditionalExtension").value || 0;
    const undeliveredPercent = document.getElementById("editUndeliveredPercent").value || 0;

    if (!completionDate || !targetDate) {
      document.getElementById("editPenalties").value = "Please enter both completion and target dates";
      return;
    }

    // Show loading state
    document.getElementById("editPenalties").value = "Calculating...";

    const result = await computeLiquidatedDamages(
      currentDocId,
      completionDate,
      targetDate,
      additionalExtension,
      undeliveredPercent
    );

    // Format the penalties display
    let penaltiesText = "";
    if (result.amount > 0) {
      penaltiesText = `₱${result.amount.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n\n`;
      penaltiesText += `Details: ${result.details}`;
    } else {
      penaltiesText = result.details;
    }

    document.getElementById("editPenalties").value = penaltiesText;
  }

  // ============================================
  // MODAL FUNCTIONS
  // ============================================

  async function openEditCompletedModal(e) {
    e.preventDefault();
    const id = e.currentTarget.dataset.id;
    currentDocId = id;

    const snap = await getDoc(doc(db, "reports", id));
    if (!snap.exists()) {
      alert("Report not found");
      return;
    }

    const data = snap.data();

    // Fill basic fields
    document.getElementById("editCompletedProjectName").value = data.projectName || "";
    document.getElementById("editCompletionDate").value = formatDateForInput(data.completionDate);
    document.getElementById("editTargetDate").value = formatDateForInput(data.endDate || data.targetDate);
    document.getElementById("editAdditionalExtension").value = data.additionalExtension || 0;
    document.getElementById("editUndeliveredPercent").value = data.undeliveredPercent || 0;
    document.getElementById("viewProgressReport").value = data.progressReport || "No progress report available";

    // Calculate actual duration
    if (data.startDate && data.completionDate) {
      const start = data.startDate.toDate ? data.startDate.toDate() : new Date(data.startDate);
      const completed = data.completionDate.toDate ? data.completionDate.toDate() : new Date(data.completionDate);
      const duration = Math.ceil((completed - start) / (1000 * 60 * 60 * 24));
      document.getElementById("editActualDuration").value = `${duration} days`;
    } else {
      document.getElementById("editActualDuration").value = "N/A";
    }

    // Calculate and display liquidated damages
    await updateLiquidatedDamages();

    editCompletedModal.style.display = "flex";
  }

  function closeModal() {
    editCompletedModal.style.display = "none";
    currentDocId = null;
  }

  // ============================================
  // SAVE CHANGES
  // ============================================

  async function saveChanges() {
    if (!currentDocId) return;

    const completionDate = document.getElementById("editCompletionDate").value;
    const targetDate = document.getElementById("editTargetDate").value;
    const additionalExtension = document.getElementById("editAdditionalExtension").value || 0;
    const undeliveredPercent = document.getElementById("editUndeliveredPercent").value || 0;
    const penalties = document.getElementById("editPenalties").value;

    if (!completionDate) {
      alert("Please select a completion date.");
      return;
    }
    if (!targetDate) {
      alert("Please select a target/deadline date.");
      return;
    }

    // Calculate actual duration
    let actualDuration = 0;
    const snap = await getDoc(doc(db, "reports", currentDocId));
    if (snap.exists()) {
      const data = snap.data();
      if (data.startDate) {
        const start = data.startDate.toDate ? data.startDate.toDate() : new Date(data.startDate);
        const completed = new Date(completionDate);
        actualDuration = Math.ceil((completed - start) / (1000 * 60 * 60 * 24));
      }
    }

    try {
      const reportRef = doc(db, "reports", currentDocId);
      await updateDoc(reportRef, {
        completionDate: new Date(completionDate),
        targetDate: new Date(targetDate),
        additionalExtension: parseInt(additionalExtension),
        undeliveredPercent: parseFloat(undeliveredPercent),
        actualDuration: actualDuration,
        penalties: penalties,
        updatedAt: new Date()
      });

      alert("Completion details and liquidated damages saved successfully!");
      closeModal();
    } catch (err) {
      console.error("Save error:", err);
      alert("Save failed: " + err.message);
    }
  }

  // ============================================
  // BUILD TABLE ROW
  // ============================================

  async function buildTableRow(docSnap) {
    const r = docSnap.data();
    const tr = document.createElement("tr");
    
    const addCell = (content) => {
      const td = document.createElement("td");
      if (typeof content === "string") {
        td.textContent = content;
      } else {
        td.appendChild(content);
      }
      tr.appendChild(td);
    };

    // Project Name
    addCell(r.projectName || "N/A");

    // Barangay
    addCell(r.barangay || "N/A");

    // Description
    const descCell = document.createElement("span");
    descCell.className = "truncate";
    descCell.textContent = r.description || "N/A";
    descCell.title = r.description || "";
    addCell(descCell);

    // Dimensions
    addCell(r.width && r.height ? `${r.width}×${r.height}` : "N/A");

    // Image
    const imgCell = document.createElement("a");
    imgCell.href = "#";
    imgCell.textContent = "View";
    imgCell.style.color = "#004aad";
    imgCell.onclick = async (e) => {
      e.preventDefault();
      if (r.imageUrl) {
        window.open(r.imageUrl, '_blank');
      } else {
        alert("No image available");
      }
    };
    addCell(imgCell);

    // Coordinates
    const coordDiv = document.createElement("div");
    coordDiv.className = "coords-vertical";
    const latSpan = document.createElement("span");
    latSpan.textContent = `Lat: ${r.latitude || "N/A"}`;
    const lngSpan = document.createElement("span");
    lngSpan.textContent = `Lng: ${r.longitude || "N/A"}`;
    coordDiv.appendChild(latSpan);
    coordDiv.appendChild(lngSpan);
    addCell(coordDiv);

    // Timestamp
    addCell(formatDateForDisplay(r.timestamp || r.createdAt));

    // Proposed Budget
    addCell(r.proposedBudget || "₱0");

    // Allocated Budget
    addCell(r.allocatedBudget || "₱0");

    // Start Date & Deadline (with extension info)
    let deadlineText = `${formatDateForDisplay(r.startDate) || "N/A"} – ${formatDateForDisplay(r.endDate || r.targetDate) || "N/A"}`;
    if (r.additionalExtension && r.additionalExtension > 0) {
      deadlineText += ` (+${r.additionalExtension}d ext)`;
    }
    addCell(deadlineText);

    // Contractor & Supplier
    addCell(`C: ${r.contractor || "N/A"}, S: ${r.supplier || "N/A"}`);

    // Completion Date
    addCell(formatDateForDisplay(r.completionDate) || "Not set");

    // Penalties column - show calculated LD
    const penaltiesText = r.penalties || "Not calculated";
    addCell(penaltiesText);

    // Reporter Position
    addCell(r.reporterPosition || r.userId || "N/A");

    // Status
    const statusSpan = document.createElement("span");
    statusSpan.className = `status ${(r.status || "").toLowerCase()}`;
    statusSpan.textContent = r.status || "N/A";
    addCell(statusSpan);

    // Action
    const actionCell = document.createElement("td");
    actionCell.className = "action";
    const editBtn = document.createElement("button");
    editBtn.className = "btn-edit";
    editBtn.textContent = "View/Edit";
    editBtn.dataset.id = docSnap.id;
    editBtn.onclick = openEditCompletedModal;
    actionCell.appendChild(editBtn);
    tr.appendChild(actionCell);

    return tr;
  }

  // ============================================
  // NOTIFICATION SYSTEM
  // ============================================

  async function setupNotifications() {
    const notificationsRef = collection(db, "notifications");
    const q = query(notificationsRef, orderBy("timestamp", "desc"));

    notificationsUnsub = onSnapshot(q, (snapshot) => {
      const notifications = [];
      let unreadCount = 0;

      snapshot.forEach((doc) => {
        const data = doc.data();
        notifications.push({ id: doc.id, ...data });
        if (!data.read) unreadCount++;
      });

      // Update badge
      notificationBadge.textContent = unreadCount;
      if (unreadCount > 0) {
        notificationBadge.classList.add('show');
      } else {
        notificationBadge.classList.remove('show');
      }

      // Render notifications
      renderNotifications(notifications);
    });
  }

  function renderNotifications(notifications) {
    notificationList.innerHTML = '';

    if (notifications.length === 0) {
      notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
      return;
    }

    // Filter notifications based on current filter
    let filtered = notifications;
    const now = new Date();
    const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);

    if (currentFilter === 'report') {
      filtered = notifications.filter(n => n.type === 'report');
    } else if (currentFilter === 'user') {
      filtered = notifications.filter(n => n.type === 'user');
    } else if (currentFilter === '24h') {
      filtered = notifications.filter(n => {
        const timestamp = n.timestamp?.toDate() || new Date(n.timestamp);
        return timestamp >= oneDayAgo;
      });
    }

    if (filtered.length === 0) {
      notificationList.innerHTML = '<div class="notification-empty">No notifications for this filter</div>';
      return;
    }

    filtered.forEach(notif => {
      const item = document.createElement('div');
      item.className = `notification-item ${!notif.read ? 'unread' : ''}`;
      
      const iconType = notif.type === 'user' ? 'user' : 'report';
      const iconClass = notif.type === 'user' ? 'fa-user' : 'fa-file-alt';
      
      item.innerHTML = `
        <div class="notification-icon ${iconType}">
          <i class="fa ${iconClass}"></i>
        </div>
        <div class="notification-content">
          <p>${notif.message}</p>
          <span class="time">${timeAgo(notif.timestamp)}</span>
        </div>
      `;
      
      item.onclick = async () => {
        if (!notif.read) {
          await updateDoc(doc(db, "notifications", notif.id), { read: true });
        }
        if (notif.link) {
          window.location.href = notif.link;
        }
      };
      
      notificationList.appendChild(item);
    });
  }

  // Notification bell click
  if (notificationBell) {
    notificationBell.addEventListener('click', (e) => {
      e.stopPropagation();
      notificationMenu.classList.toggle('show');
    });
  }

  // Close notification menu when clicking outside
  document.addEventListener('click', (e) => {
    if (notificationMenu && !notificationMenu.contains(e.target) && e.target !== notificationBell) {
      notificationMenu.classList.remove('show');
    }
  });

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentFilter = this.dataset.filter;
      
      // Re-fetch and render with new filter
      const notificationsRef = collection(db, "notifications");
      const q = query(notificationsRef, orderBy("timestamp", "desc"));
      getDocs(q).then(snapshot => {
        const notifications = [];
        snapshot.forEach(doc => {
          notifications.push({ id: doc.id, ...doc.data() });
        });
        renderNotifications(notifications);
      });
    });
  });

  // Mark all as read
  const markAllReadBtn = document.getElementById('markAllReadBtn');
  if (markAllReadBtn) {
    markAllReadBtn.addEventListener('click', async () => {
      const notificationsRef = collection(db, "notifications");
      const q = query(notificationsRef, where("read", "==", false));
      const snapshot = await getDocs(q);
      
      const promises = [];
      snapshot.forEach(doc => {
        promises.push(updateDoc(doc.ref, { read: true }));
      });
      
      await Promise.all(promises);
    });
  }

  // Clear all notifications
  const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
  if (clearNotificationsBtn) {
    clearNotificationsBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear all notifications?')) {
        const notificationsRef = collection(db, "notifications");
        const snapshot = await getDocs(notificationsRef);
        
        const promises = [];
        snapshot.forEach(doc => {
          promises.push(updateDoc(doc.ref, { read: true }));
        });
        
        await Promise.all(promises);
      }
    });
  }

  // ============================================
  // SEARCH FUNCTIONALITY
  // ============================================

  searchCompleted.addEventListener("keyup", () => {
    const val = searchCompleted.value.toLowerCase();
    [...completedBody.rows].forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(val) ? "" : "none";
    });
  });

  // ============================================
  // EVENT LISTENERS
  // ============================================

  closeCompletedModal.onclick = closeModal;
  cancelCompletedEdit.onclick = closeModal;
  saveCompletedChanges.onclick = saveChanges;

  // Auto-calculate LD when fields change
  document.getElementById("editCompletionDate").addEventListener("change", updateLiquidatedDamages);
  document.getElementById("editTargetDate").addEventListener("change", updateLiquidatedDamages);
  document.getElementById("editAdditionalExtension").addEventListener("input", updateLiquidatedDamages);
  document.getElementById("editUndeliveredPercent").addEventListener("input", updateLiquidatedDamages);

  // Logout functionality
  if (sidebarLogoutBtn) {
    sidebarLogoutBtn.addEventListener("click", async () => {
      if (confirm("Are you sure you want to logout?")) {
        try {
          await signOut(auth);
          window.location.href = "logout.html";
        } catch (err) {
          console.error("Logout error:", err);
          alert("Error logging out: " + err.message);
        }
      }
    });
  }

  // Profile dropdown toggle
  if (profileToggle && dropdownMenu) {
    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle("show");
    });

    document.addEventListener("click", () => {
      dropdownMenu.classList.remove("show");
    });
  }

  // Mobile menu toggle
  window.toggleMobileMenu = function() {
    const sidebar = document.getElementById("sidebar");
    if (sidebar) {
      sidebar.classList.toggle("mobile-open");
    }
  };

  // Submenu toggle
  window.toggleSubmenu = function(event) {
    event.preventDefault();
    const submenu = event.currentTarget.nextElementSibling;
    const chevron = event.currentTarget.querySelector('.fa-chevron-down');

    if (submenu) {
      submenu.classList.toggle('open');
    }
    if (chevron) {
      chevron.style.transform = submenu.classList.contains('open') 
        ? 'rotate(180deg)' 
        : 'rotate(0deg)';
    }
  };

  // ============================================
  // AUTHENTICATION & DATA LOADING
  // ============================================

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "logout.html";
      return;
    }

    try {
      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userDocRef);

      if (!userSnap.exists()) {
        alert("User data not found! Redirecting...");
        window.location.href = "logout.html";
        return;
      }

      const userData = userSnap.data();

      // Check if user is Admin
      if (userData.position !== "Admin") {
        alert("Unauthorized access! Only Admins can access this page.");
        window.location.href = "logout.html";
        return;
      }

      // Update navbar profile info
      const navUsername = document.getElementById("navUsername");
      const navAvatar = document.getElementById("navAvatar");

      if (navUsername) {
        navUsername.textContent = userData.name || userData.firstName || "Admin";
      }
      if (navAvatar) {
        navAvatar.src = userData.photoURL || userData.profilePic || "image.png";
      }

      // Setup real-time profile updates
      onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const d = docSnap.data();
          if (navUsername) navUsername.textContent = d.name || d.firstName || "Admin";
          if (navAvatar) navAvatar.src = d.photoURL || d.profilePic || "image.png";
        }
      });

      // Setup notifications
      await setupNotifications();

      // Load completed reports with real-time updates
      const q = query(collection(db, "reports"), orderBy("createdAt", "desc"));

      if (reportsUnsub) reportsUnsub();

      reportsUnsub = onSnapshot(q, async (snap) => {
        completedBody.innerHTML = "";

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const status = (data.status || "").toLowerCase().trim();

          // Only show completed/repaired reports
          if (status === "repaired" || status === "posted" || status === "completed") {
            const row = await buildTableRow(docSnap);
            completedBody.appendChild(row);
          }
        }

        // Show message if no completed reports
        if (completedBody.children.length === 0) {
          const emptyRow = document.createElement("tr");
          const emptyCell = document.createElement("td");
          emptyCell.colSpan = 16;
          emptyCell.style.textAlign = "center";
          emptyCell.style.padding = "2rem";
          emptyCell.style.color = "#999";
          emptyCell.textContent = "No completed reports found";
          emptyRow.appendChild(emptyCell);
          completedBody.appendChild(emptyRow);
        }
      });

    } catch (err) {
      console.error("Error loading user data:", err);
      alert("Error loading user data: " + err.message);
    }
  });
</script>
</body>
</html>
