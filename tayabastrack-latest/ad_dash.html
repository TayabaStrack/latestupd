<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | TayabaStrack</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; min-height: 100vh; background: #f5f7fb; color: #333; overflow: hidden; }

        /* SIDEBAR - IMPROVED VERSION */
        .sidebar {
            width: 250px;
            min-width: 250px;
            background: #004aad;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 50;
            height: 100vh;
            overflow-y: auto;
            transition: left 0.3s ease;
        }
        .sidebar-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 2rem; padding: 0 1rem; }
        .sidebar-header img{width:50px;height:50px;object-fit:contain}
        .sidebar-header h2 { font-size: 1.2rem; margin: 0; font-weight: 600; }
        .sidebar-menu { list-style: none; padding-left: 0; margin: 0; }
        .sidebar-menu li { margin: 0.5rem 0; }
        .sidebar-menu a { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 0.8rem 1.5rem; 
            text-decoration: none; 
            color: #fff; 
            transition: background 0.2s;
            border-left: 4px solid transparent;
        }
        .sidebar-menu a:hover,
        .sidebar-menu li.active a { background: #0756cc; border-left: 4px solid #042f68; }
        .sidebar-menu a i { width: 20px; text-align: center; font-size: 1rem; }
        .sidebar-footer { text-align: center; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.2); margin-top: auto; }
        .logout-btn { 
            background-color: #d9534f; 
            color: #fff; 
            border: none; 
            padding: 0.6rem 1.2rem; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: background 0.3s; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .logout-btn:hover { background-color: #c9302c; }

        /* NAVBAR - IMPROVED VERSION */
        .navbar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,.05);
            z-index: 40;
            transition: left 0.3s ease;
        }
        .navbar h1 { font-size: 1.4rem; color: #004aad; margin: 0; }
        .navbar-left { display: flex; align-items: center; gap: 1rem; }
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #004aad;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        .profile { display: flex; align-items: center; gap: 1rem; }
        
        /* Notification Bell */
        .fa-bell { font-size: 1.2rem; position: relative; cursor: pointer; color: #333; }
        .badge { background: red; color: #fff; font-size: .7rem; border-radius: 50%; padding: 3px 6px; position: absolute; top: -8px; right: -8px; display: none; min-width: 18px; text-align: center; }
        .badge.show { display: flex; align-items: center; justify-content: center; }

        /* Notification Menu */
        .notification-menu { display: none; position: absolute; top: 120%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 340px; max-height: 420px; overflow: hidden; z-index: 1000; font-family: "Segoe UI", Tahoma, sans-serif; animation: fadeIn 0.2s ease-in-out; }
        .notification-menu.show { display: block; }
        .notification-header { padding: 0.9rem 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; }
        .notification-header h3 { font-size: 1rem; color: #333; margin: 0; font-weight: 600; }
        .notification-actions { display: flex; gap: 0.5rem; align-items: center; }
        .action-icon-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.3rem; transition: color 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .action-icon-btn:hover { color: #004aad; }
        .action-icon-btn i { font-size: 0.95rem; }
        
        .notification-filters { display: flex; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; background: #fafafa; }
        .filter-btn { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.8rem; background: #f2f2f2; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.25s ease; color: #333; }
        .filter-btn:hover { background: #004aad; color: #fff; }
        .filter-btn.active { background: #004aad; color: #fff; border-color: #004aad; }
        
        .notification-list { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ccc transparent; }
        .notification-list::-webkit-scrollbar { width: 6px; }
        .notification-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .notification-list::-webkit-scrollbar-track { background: transparent; }
        .notification-item { padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0; display: flex; gap: 0.8rem; align-items: flex-start; transition: background 0.2s; position: relative; }
        .notification-item:hover { background: #f5f7ff; }
        .notification-item.unread { background: #f0f7ff; }
        .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: #004aad; border-radius: 0 4px 4px 0; }
        .notification-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
        .notification-icon.user { background: #e3f2fd; color: #1976d2; }
        .notification-icon.report { background: #fff3e0; color: #f57c00; }
        .notification-content { flex: 1; }
        .notification-content p { margin: 0; font-size: 0.86rem; color: #333; line-height: 1.3; }
        .notification-content .time { color: #999; font-size: 0.75rem; margin-top: 0.25rem; }
        .notification-empty { padding: 2rem; text-align: center; color: #999; font-size: 0.9rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .profile-dropdown { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .profile-dropdown:hover { background: #f5f7fb; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #004aad; }
        .username { font-weight: 500; color: #333; }
        
        .dropdown-menu { 
            display: none; 
            position: absolute; 
            top: 120%; 
            right: 0; 
            background: #fff; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            min-width: 200px; 
            z-index: 1000; 
        }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a { 
            display: block; 
            padding: 0.6rem 1rem; 
            text-decoration: none; 
            color: #333; 
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .dropdown-menu a:hover { background: #f0f0f0; color: #004aad; }
        .dropdown-menu a i { margin-right: 8px; width: 20px; text-align: center; }

        /* MAIN CONTENT */
        .main { 
            margin-left: 250px; 
            margin-top: 64px;
            flex: 1; 
            display: flex; 
            flex-direction: column;
            min-width: 0;
            height: calc(100vh - 64px);
            overflow-y: auto;
            overflow-x: hidden;
            transition: margin-left 0.3s ease;
        }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem; }
        .card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .card i { font-size: 1.8rem; color: #004aad; }
        .card p { font-size: 0.9rem; color: #666; }
        .card h2 { font-size: 1.5rem; font-weight: bold; }

        .bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; }
        .reports, .map { background: #fff; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .reports h3, .map h3 { margin-bottom: 1rem; color: #004aad; }
        canvas { width: 100% !important; height: 250px !important; }
        #miniMap { height: 250px !important; border-radius: 10px; width: 100%; }

        .images { padding: 1.5rem; }
        .images h3 { color: #004aad; margin-bottom: 1rem; }
        .image-gallery { display: flex; gap: 1rem; flex-wrap: wrap; }
        .image-gallery img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* MOBILE RESPONSIVE */
        @media (max-width: 980px) {
            .sidebar { left: -250px; }
            .sidebar.mobile-open { left: 0; }
            .navbar { left: 0; }
            .main { margin-left: 0; }
            .mobile-menu-btn { display: block !important; }
            .username { display: none; }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="logo" />
                <h2>TayabaStrack</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="active"><a href="ad_dash.html"><i class="fa fa-home"></i> Dashboard</a></li>
                <li><a href="ad_reports.html"><i class="fa fa-tasks"></i> Manage Reports</a></li>
                <li><a href="ad_map.html"><i class="fa fa-map-marker-alt"></i> Map</a></li>
                <li><a href="ad_usermanagement.html"><i class="fa fa-users"></i> User Management</a></li>
                <li><a href="ad_bulletin.html"><i class="fa fa-bullhorn"></i> Report Bulletin</a></li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fa fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <nav class="navbar">
            <div class="navbar-left">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <i class="fa fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
            </div>
            <div class="profile">
                <div style="position:relative">
                    <i class="fa fa-bell" id="notificationBell"></i>
                    <span class="badge" id="notificationBadge">0</span>
                    <div class="notification-menu" id="notificationMenu">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <button class="action-icon-btn" id="markAllReadBtn" title="Mark all as read"><i class="fa fa-check-double"></i></button>
                                <button class="action-icon-btn" id="clearNotificationsBtn" title="Clear all"><i class="fa fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="notification-filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="report">Reports</button>
                            <button class="filter-btn" data-filter="user">Users</button>
                            <button class="filter-btn" data-filter="24h">Last 24h</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No new notifications</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-dropdown" id="profileToggle">
                    <img src="image.png" alt="Profile" class="avatar" id="navAvatar" />
                    <span class="username" id="navUsername">---</span>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="ad_profile.html"><i class="fa fa-user"></i> Profile</a>
                    </div>
                </div>
            </div>
        </nav>

        <section class="stats">
            <div class="card"><i class="fa fa-chart-bar"></i><div><p>Total Reports</p><h2 id="totalReports">0</h2></div></div>
            <div class="card"><i class="fa fa-clock"></i><div><p>Pending</p><h2 id="pendingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-sync"></i><div><p>Ongoing</p><h2 id="ongoingReports">0</h2></div></div>
            <div class="card"><i class="fa fa-check-circle"></i><div><p>Completed</p><h2 id="completedReports">0</h2></div></div>
        </section>

        <section class="bottom">
            <div class="reports">
                <h3>Total Reports</h3>
                <canvas id="dashboardChart"></canvas>
            </div>

            <div class="map">
                <h3>Map</h3>
                <div id="miniMap"></div>
            </div>
        </section>

        <section class="images">
            <h3>Recent Report Images</h3>
            <div class="image-gallery" id="reportImages"></div>
        </section>
    </main>

    <!-- Google Maps -->
    <script>
        let miniMap;
        window.reportLocations = [];

        function initMiniMap() {
            const tayabasRizalPark = { lat: 14.0167747, lng: 121.5857253 };
            miniMap = new google.maps.Map(document.getElementById("miniMap"), {
                zoom: 13,
                center: tayabasRizalPark,
                mapTypeId: 'roadmap'
            });

            new google.maps.Marker({
                position: tayabasRizalPark,
                map: miniMap,
                title: "Tayabas City - Rizal Park",
                icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
            });

            addReportMarkers();
        }

        function addReportMarkers() {
            if (!miniMap || !window.reportLocations) return;
            window.reportLocations.forEach((report) => {
                let markerColor = "red";
                if (report.status === "resolved" || report.status === "completed") markerColor = "green";
                else if (report.status === "ongoing" || report.status === "in-progress") markerColor = "yellow";

                new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: miniMap,
                    title: report.type,
                    icon: { url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png` }
                });
            });
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 980 && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJkfi59FibsnD-dxAdyYUohj36N_bOtfE&callback=initMiniMap"></script>

    <!-- Notification System -->
    <script>
    let notificationsList = [];
    let seenNotificationIds = new Set();
    let trackedUserStatuses = {};
    let trackedReportIds = new Set();
    let currentFilter = "all";

    function normalizeStatus(status) { 
        return (status || "").toLowerCase().trim(); 
    }

    function isBarangayPosition(position) {
        if (!position) return false;
        const pos = position.toLowerCase();
        return pos.includes("barangay") || pos.includes("brgy") || pos.includes("brgy.");
    }

    // Save notification to Firestore
    async function saveNotificationToFirestore(db, notification) {
        const { collection, addDoc, serverTimestamp } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        try {
            await addDoc(collection(db, "notifications"), {
                type: notification.type,
                message: notification.message,
                detail: notification.detail,
                timestamp: serverTimestamp(),
                read: false
            });
        } catch (error) {
            console.error("Error saving notification:", error);
        }
    }

    // Load notifications from Firestore
    async function loadNotificationsFromFirestore(db) {
        const { collection, getDocs, query, orderBy, limit } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        try {
            const q = query(
                collection(db, "notifications"),
                orderBy("timestamp", "desc"),
                limit(100) // Load last 100 notifications
            );
            const snapshot = await getDocs(q);
            
            notificationsList = [];
            seenNotificationIds.clear();
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const notification = {
                    id: doc.id,
                    type: data.type,
                    message: data.message,
                    detail: data.detail,
                    timestamp: data.timestamp?.toDate() || new Date(),
                    read: data.read || false
                };
                notificationsList.push(notification);
                seenNotificationIds.add(notification.id);
            });
            
            updateNotificationUI();
        } catch (error) {
            console.error("Error loading notifications:", error);
        }
    }

    // Update notification read status in Firestore
    async function markNotificationAsRead(db, notificationId) {
        const { doc, updateDoc } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        try {
            await updateDoc(doc(db, "notifications", notificationId), {
                read: true
            });
        } catch (error) {
            console.error("Error marking notification as read:", error);
        }
    }

    // Clear all notifications from Firestore
    async function clearAllNotificationsFromFirestore(db) {
        const { collection, getDocs, deleteDoc, doc } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        try {
            const snapshot = await getDocs(collection(db, "notifications"));
            const deletePromises = snapshot.docs.map(docSnap => 
                deleteDoc(doc(db, "notifications", docSnap.id))
            );
            await Promise.all(deletePromises);
        } catch (error) {
            console.error("Error clearing notifications:", error);
        }
    }

    // Modified addNotification function
    async function addNotification(type, message, detail, db) {
        const cleanMsg = (message || "").trim();
        const cleanDetail = (detail || "").trim();
        const timestamp = new Date();
        const id = `${type}-${cleanMsg}-${cleanDetail}-${timestamp.getTime()}`;
        
        if (seenNotificationIds.has(id)) return;
        seenNotificationIds.add(id);
        
        const notification = {
            id,
            type,
            message: cleanMsg,
            detail: cleanDetail,
            timestamp: timestamp,
            read: false
        };
        
        notificationsList.unshift(notification);
        
        // Save to Firestore
        if (db) {
            await saveNotificationToFirestore(db, notification);
        }
        
        updateNotificationUI();
    }

    function updateNotificationUI() {
        let filtered = [...notificationsList];
        if (currentFilter === "report") {
            filtered = filtered.filter((n) => n.type === "report");
        } else if (currentFilter === "user") {
            filtered = filtered.filter((n) => n.type === "user");
        } else if (currentFilter === "24h") {
            const ago = Date.now() - 24 * 60 * 60 * 1000;
            filtered = filtered.filter((n) => n.timestamp.getTime() > ago);
        }
        filtered.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
        
        const unreadCount = notificationsList.filter(n => !n.read).length;
        const notificationBadge = document.getElementById("notificationBadge");
        if (unreadCount > 0) {
            notificationBadge.textContent = unreadCount;
            notificationBadge.classList.add("show");
        } else {
            notificationBadge.textContent = "";
            notificationBadge.classList.remove("show");
        }
        
        const notificationList = document.getElementById("notificationList");
        if (filtered.length === 0) {
            notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
        } else {
            notificationList.innerHTML = filtered.map((n) => `
                <div class="notification-item ${n.read ? '' : 'unread'}">
                    <div class="notification-icon ${n.type}">
                        ${n.type === "user" ? '<i class="fa fa-user"></i>' : '<i class="fa fa-flag"></i>'}
                    </div>
                    <div class="notification-content">
                        <p><strong>${n.message}</strong></p>
                        <p>${n.detail}</p>
                        <span class="time">${n.timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                    </div>
                </div>
            `).join("");
        }
    }

    const notificationBell = document.getElementById("notificationBell");
    const notificationMenu = document.getElementById("notificationMenu");
    const clearNotificationsBtn = document.getElementById("clearNotificationsBtn");
    const markAllReadBtn = document.getElementById("markAllReadBtn");

    // Store db reference globally
    let globalDb = null;

    notificationBell.addEventListener("click", (e) => {
        e.stopPropagation();
        notificationMenu.classList.toggle("show");
        document.getElementById("dropdownMenu").classList.remove("show");
    });

    clearNotificationsBtn.addEventListener("click", async () => {
        if (globalDb) {
            await clearAllNotificationsFromFirestore(globalDb);
        }
        notificationsList = [];
        seenNotificationIds.clear();
        updateNotificationUI();
    });

    markAllReadBtn.addEventListener("click", async () => {
        const { doc, updateDoc } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        // Update local state
        notificationsList.forEach(n => n.read = true);
        
        // Update Firestore
        if (globalDb) {
            const updatePromises = notificationsList.map(n => {
                if (n.id && !n.id.includes('-')) { // Only update Firestore documents
                    try {
                        return updateDoc(doc(globalDb, "notifications", n.id), { read: true });
                    } catch (error) {
                        console.error("Error updating notification:", error);
                        return Promise.resolve();
                    }
                }
                return Promise.resolve();
            });
            await Promise.all(updatePromises);
        }
        
        updateNotificationUI();
    });

    document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            currentFilter = e.target.dataset.filter;
            updateNotificationUI();
        });
    });

    async function setupRealtimeNotifications(db) {
        globalDb = db; // Store db reference
        
        const { collection, getDocs, onSnapshot } = await import(
            "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
        );
        
        // Load existing notifications from Firestore first
        await loadNotificationsFromFirestore(db);
        
        // Track existing users
        const userSnap = await getDocs(collection(db, "users"));
        userSnap.forEach((docSnap) => {
            const userId = docSnap.id;
            const data = docSnap.data();
            const status = normalizeStatus(data.status);
            trackedUserStatuses[userId] = status;
        });
        
        // Listen for user changes
        onSnapshot(collection(db, "users"), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const userId = change.doc.id;
                const data = change.doc.data();
                const currentStatus = normalizeStatus(data.status);
                const fullName = data.name || `${data.firstName || ""} ${data.lastName || ""}`.trim() || "Unknown User";
                const position = data.position || "User";
                
                if (change.type === "added") {
                    trackedUserStatuses[userId] = currentStatus;
                    if (currentStatus === "active" && isBarangayPosition(position)) {
                        addNotification("user", `New user approved: ${fullName}`, `Position: ${position}`, db);
                    }
                }
                if (change.type === "modified") {
                    const oldStatus = trackedUserStatuses[userId];
                    if (oldStatus !== "active" && currentStatus === "active" && isBarangayPosition(position)) {
                        addNotification("user", `User approved: ${fullName}`, `Position: ${position}`, db);
                    }
                    trackedUserStatuses[userId] = currentStatus;
                }
            });
        });
        
        // Track existing reports
        const reportSnap = await getDocs(collection(db, "reports"));
        reportSnap.forEach((docSnap) => {
            trackedReportIds.add(docSnap.id);
        });
        
        // Listen for new reports
        onSnapshot(collection(db, "reports"), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const id = change.doc.id;
                const data = change.doc.data();
                if (change.type === "added" && !trackedReportIds.has(id)) {
                    trackedReportIds.add(id);
                    const barangay = data.barangay || data.location || "Unknown location";
                    const type = data.reportType || data.type || data.projectName || "Report";
                    addNotification("report", "New report submitted", `${type} in ${barangay}`, db);
                }
            });
        });
        
        updateNotificationUI();
    }

    const dropdownMenu = document.getElementById('dropdownMenu');
    const profileToggle = document.getElementById('profileToggle');

    profileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("show");
        notificationMenu.classList.remove("show");
    });

    window.addEventListener('click', (e) => {
        if (!e.target.closest('.profile-dropdown')) {
            dropdownMenu.classList.remove("show");
        }
        if (!e.target.closest('.notification-menu') && e.target !== notificationBell) {
            notificationMenu.classList.remove("show");
        }
    });
</script>

    <!-- Firebase + Chart -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB06vfES5thZQi3Yd11vkooHVH-d5d4Y3o",
            authDomain: "tayabastrack-23b95.firebaseapp.com",
            projectId: "tayabastrack-23b95",
            storageBucket: "tayabastrack-23b95.firebasestorage.app",
            messagingSenderId: "674055915366",
            appId: "1:674055915366:web:aa560336c1f8b504eeaaa7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        window.db = db;

        const totalReportsEl = document.getElementById("totalReports");
        const pendingEl = document.getElementById("pendingReports");
        const ongoingEl = document.getElementById("ongoingReports");
        const completedEl = document.getElementById("completedReports");

        async function getImageUrl(imagePath) {
            try {
                if (!imagePath) return null;
                if (imagePath.startsWith('http')) return imagePath;
                const url = await getDownloadURL(ref(storage, imagePath));
                return url;
            } catch (error) {
                console.error("Error getting image URL:", error);
                return null;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) return (window.location.href = "logout.html");

            const { onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const userDocRef = doc(db, "users", user.uid);
            onSnapshot(userDocRef, async (userDoc) => {
                if (!userDoc.exists()) {
                    alert("User data not found! Redirecting...");
                    return (window.location.href = "logout.html");
                }

                const data = userDoc.data();
                
                if (data.position !== "Admin") {
                    alert("Unauthorized access! Redirecting...");
                    return (window.location.href = "logout.html");
                }

                document.getElementById("navUsername").textContent = data.name || data.firstName || "Admin";
                const photoURL = data.photoURL || "image.png";
                document.getElementById("navAvatar").src = photoURL;
            });

            await loadDashboardData();
            await setupRealtimeNotifications(db);
        });

        document.getElementById("logoutBtn").addEventListener("click", async () => {
            if (confirm("Are you sure you want to logout?")) {
                await signOut(auth);
                window.location.href = "logout.html";
            }
        });

        async function loadDashboardData() {
            const snapshot = await getDocs(collection(db, "reports"));
            let total = 0, pending = 0, ongoing = 0, completed = 0;
            window.reportLocations = [];

            snapshot.forEach(docSnap => {
                const report = docSnap.data();
                total++;
                const status = report.status?.toLowerCase();
                if (status === "pending") pending++;
                else if (status === "ongoing" || status === "in-progress") ongoing++;
                else if (status === "resolved" || status === "completed" || status === "repaired" || status === "posted") completed++;

                const lat = report.latitude || report.lat || report.location?.latitude;
                const lng = report.longitude || report.lng || report.location?.longitude;

                if (lat && lng) {
                    window.reportLocations.push({
                        lat: parseFloat(lat),
                        lng: parseFloat(lng),
                        type: report.reportType || report.type || "Unknown",
                        status: status || "pending"
                    });
                }
            });

            totalReportsEl.textContent = total;
            pendingEl.textContent = pending;
            ongoingEl.textContent = ongoing;
            completedEl.textContent = completed;
            updateChart(completed, ongoing, pending);
            if (window.miniMap) addReportMarkers();
            loadReportImages();
        }

        let chart;
        function updateChart(completed, ongoing, pending) {
            const ctx = document.getElementById("dashboardChart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Completed", "Ongoing", "Pending"],
                    datasets: [{
                        label: "Reports",
                        data: [completed, ongoing, pending],
                        backgroundColor: ["#1cc88a", "#36b9cc", "#f6c23e"]
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        async function loadReportImages() {
            const gallery = document.getElementById("reportImages");
            gallery.innerHTML = "";
            const snapshot = await getDocs(collection(db, "reports"));
            let count = 0;
            
            for (const docSnap of snapshot.docs) {
                if (count >= 6) break;
                
                const report = docSnap.data();
                const imagePath = report.incidentImage || report.imageUrl || report.image;
                
                if (imagePath) {
                    const imageUrl = await getImageUrl(imagePath);
                    if (imageUrl) {
                        const img = document.createElement("img");
                        img.src = imageUrl;
                        img.onerror = function() { this.style.display = "none"; };
                        gallery.appendChild(img);
                        count++;
                    }
                }
            }
        }
    </script>
</body>
</html>